---
title: "03_strain_analysis"
title-block-banner: true
author:
  - name: Gong Yuhang
date: 2026-01-02
toc: true
toc-depth: 4
number-sections: true
code-fold: true
code-line-numbers: true
code-tools: true
format:
  html:
    embed-resources: true
    smooth-scroll: true
    page-layout: full
reference-location: section
citation-location: document
params:
  name: "03_strain_analysis"
---

**Updated: `r format(Sys.time(), '%Y-%m-%d %H:%M:%S', tz = 'CET')` CET.**

The purpose of this document is:
本文档是项目 pc047 (vCagAepitope) 的**株系水平分析模块**。

**核心问题**：CagA依赖性感染是否影响了肠道微生物的**株系多样性**？

**分析逻辑**：
- 01文档回答了"Who is there?"（物种组成）→ 发现细菌Beta多样性显著改变
- 02文档回答了"What are they capable of?"（功能潜力）→ 功能差异分析
- 本文档回答"Which strains are there?"（株系水平差异）→ 更精细的分辨率分析

**关于数据说明**：
本文档原计划使用bioBakery 3的StrainPhlAn 3工具进行株系水平分析（参考elife-65088-v1.pdf协议）。
然而，StrainPhlAn需要MetaPhlAn 3从原始FASTQ文件生成的marker比对数据，而当前项目仅有Kraken2/Bracken物种水平数据。

**替代方案**：使用Kraken2/Bracken的物种级数据进行**属内物种多样性分析(Intra-genus Species Diversity)**，
这种方法可以揭示属内物种组成差异，作为真正株系分析的近似。

**分析大纲**：
1. Part 1: StrainPhlAn方法论说明（文档参考）
2. Part 2: 数据导入与属内物种识别
3. Part 3: 属内物种多样性分析
4. Part 4: 物种共现模式分析
5. Part 5: 关键属的物种组成差异

```{r}
#| label: params
#| eval: !expr interactive()
#| include: false
params <- list(name = "03_strain_analysis")
```

```{r}
#| label: setup
#| message: false
#| include: false
#| warning: false
wd <- "analyses"
if (basename(getwd()) != wd) {
  setwd(here::here(wd))
}
here::i_am(paste0(params$name, ".qmd"), uuid = "a3f8c912-7b4d-4e56-9c8a-3d5f6a1b2c4e")
projthis::proj_create_dir_target(params$name, clean = FALSE)
path_target <- projthis::proj_path_target(params$name)
path_source <- projthis::proj_path_source(params$name)
path_raw <- path_source("00-raw")
path_resource <- here::here(path_raw, "d00-resource")
path_data <- here::here(path_raw, paste0("d", params$name))
dir.create(path_raw, recursive = TRUE, showWarnings = FALSE)
dir.create(path_data, recursive = TRUE, showWarnings = FALSE)
dir.create(path_resource, recursive = TRUE, showWarnings = FALSE)
```

## Packages
```{r}
#| label: packages
#| message: false
suppressPackageStartupMessages({
  library(here)
  library(conflicted)
  library(tidyverse)
  library(data.table)
  library(mia)
  library(TreeSummarizedExperiment)
  library(readxl)
  library(miaViz)
  library(scuttle)
  library(patchwork)
  library(MatrixGenerics)
  library(stringr)
  library(ggpubr)
  library(scater)
  library(vegan)
  library(ggplot2)
  library(RColorBrewer)
  library(pheatmap)
  library(igraph)
  library(ggraph)
  devtools::load_all()
})
set.seed(20261)
```

# Part 1: StrainPhlAn方法论说明

## 1.1 bioBakery 3工具套件概述

根据bioBakery 3协议 (Beghini et al., 2021, eLife)，株系水平分析流程包括：

**工具链**：
1. **MetaPhlAn 3**: 高精度物种水平分类 → 生成marker基因比对
2. **StrainPhlAn 3**: 从MetaPhlAn marker重建样本特异性共识序列
3. **PhyloPhlAn 3**: 构建株系系统发育树

**StrainPhlAn工作原理**：
- 使用MetaPhlAn的物种特异性marker基因（~200 markers/species）
- 从比对文件提取样本特异性SNP
- 重建consensus序列用于系统发育分析
- 支持与参考基因组比较

**数据要求**：
- 原始FASTQ测序文件
- MetaPhlAn profiling输出（.bowtie2.bz2比对文件）
- 足够的测序深度（建议 >1M reads/sample）

::: {.callout-warning}
## 当前数据限制
本项目目前仅有Kraken2/Bracken物种水平报告，缺少：
- 原始FASTQ测序数据
- MetaPhlAn marker比对文件

因此无法运行StrainPhlAn分析。当原始数据可用时，可按照bioBakery 3协议补充此分析。
:::

## 1.2 替代策略：属内物种多样性

虽然无法进行真正的株系水平分析，但Kraken2/Bracken数据可以提供**物种级**分辨率。
我们可以分析：

1. **属内物种丰富度(Intra-genus Species Richness)**: 每个属内检测到的物种数量
2. **属内物种均匀度(Intra-genus Species Evenness)**: 属内物种丰度分布的均匀程度
3. **物种共现模式**: 哪些物种倾向于共同出现
4. **命名物种 vs 未命名物种**: "sp." 条目代表未完全表征的类群

这种分析可以揭示CagA感染对微生物群落精细结构的影响。

# Part 2: 数据导入与属内物种识别

## 2.1 导入Bracken物种数据

```{r}
#| label: load-bracken-species
#| message: false

# 使用01文档中相同的数据路径
path_bracken_std <- here::here(path_raw, "d01_alpha_beta_diversity_analysis", "bracken_standard")

# 导入物种级数据
read_bracken_species <- function(path) {
  files <- list.files(path, pattern = "_S\\.tsv$", full.names = TRUE)

  bracken_list <- lapply(files, function(f) {
    dt <- fread(f, header = TRUE)
    sample_name <- gsub("_brackenstd_S\\.tsv$", "", basename(f))
    dt[, sample_id := sample_name]
    return(dt)
  })

  rbindlist(bracken_list)
}

bracken_species <- read_bracken_species(path_bracken_std)

cat("=== Bracken Species Data ===\n")
cat("Total entries:", nrow(bracken_species), "\n")
cat("Unique species:", length(unique(bracken_species$name)), "\n")
cat("Samples:", length(unique(bracken_species$sample_id)), "\n")
```

## 2.2 解析物种分类信息

```{r}
#| label: parse-taxonomy
#| message: false

# 从物种名提取属信息
bracken_species[, genus := str_extract(name, "^[A-Z][a-z]+")]

# 识别命名物种 vs 未命名物种 (sp.)
bracken_species[, species_type := ifelse(
  str_detect(name, " sp\\.| sp "),
  "Unnamed (sp.)",
  "Named"
)]

# 统计
cat("=== Species Classification ===\n")
cat("Unique genera:", length(unique(bracken_species$genus)), "\n\n")

species_type_summary <- bracken_species[, .(
  n_entries = .N,
  n_unique = length(unique(name))
), by = species_type]
print(species_type_summary)
```

## 2.3 构建样本元数据

```{r}
#| label: create-metadata

# 创建样本元数据
sample_ids <- unique(bracken_species$sample_id)
sample_metadata <- data.frame(
  sample_id = sample_ids,
  group = ifelse(grepl("^ca", sample_ids), "CA", "IC"),
  stringsAsFactors = FALSE
)

# CA = ApcMUT_HpWT (CagA+感染组)
# IC = ApcMUT_HpKO (对照组)
sample_metadata$group <- factor(sample_metadata$group, levels = c("IC", "CA"))

cat("=== Sample Groups ===\n")
print(table(sample_metadata$group))
```

## 2.4 构建物种丰度矩阵

```{r}
#| label: species-abundance-matrix
#| message: false

# 创建宽格式丰度矩阵
species_wide <- dcast(
  bracken_species,
  name ~ sample_id,
  value.var = "new_est_reads",
  fill = 0
)

# 转换为矩阵
species_names <- species_wide$name
species_mat <- as.matrix(species_wide[, -1, with = FALSE])
rownames(species_mat) <- species_names

# 计算相对丰度
species_relabund <- sweep(species_mat, 2, colSums(species_mat), "/") * 100

cat("=== Species Abundance Matrix ===\n")
cat("Dimensions:", nrow(species_mat), "species x", ncol(species_mat), "samples\n")
cat("Total reads range:", format(min(colSums(species_mat)), big.mark = ","), "-",
    format(max(colSums(species_mat)), big.mark = ","), "\n")
```

# Part 3: 属内物种多样性分析

## 3.1 识别主要属

```{r}
#| label: identify-major-genera
#| fig-width: 10
#| fig-height: 6

# 计算每个属的总丰度和物种数
genus_summary <- bracken_species[, .(
  total_reads = sum(new_est_reads),
  n_species = length(unique(name)),
  mean_relabund = sum(new_est_reads) / sum(bracken_species$new_est_reads) * 100
), by = genus]

# 排序
genus_summary <- genus_summary[order(-total_reads)]

# Top 20属
top_genera <- head(genus_summary, 20)

# 可视化
p_genus <- ggplot(top_genera, aes(x = reorder(genus, total_reads), y = n_species)) +
  geom_bar(stat = "identity", aes(fill = log10(total_reads + 1))) +
  geom_text(aes(label = n_species), hjust = -0.2, size = 3) +
  coord_flip() +
  scale_fill_viridis_c(option = "plasma", name = "log10(reads)") +
  labs(
    title = "Top 20 Genera: Species Richness",
    x = "Genus",
    y = "Number of Species Detected"
  ) +
  theme_bw() +
  theme(axis.text.y = element_text(face = "italic"))

print(p_genus)
```

## 3.2 属内物种丰富度比较（组间）

```{r}
#| label: intragenus-richness-comparison
#| fig-width: 12
#| fig-height: 8

# 选择高丰度且多物种的属进行分析
target_genera <- genus_summary[n_species >= 5 & mean_relabund > 0.1]$genus
cat("Analyzing", length(target_genera), "genera with >=5 species and >0.1% abundance\n")

# 计算每个样本在每个属内检测到的物种数
calculate_intragenus_diversity <- function(species_data, metadata, min_reads = 10) {
  # 筛选目标属
  target_data <- species_data[genus %in% target_genera]

  # 按样本和属计算指标
  diversity_metrics <- target_data[new_est_reads >= min_reads, .(
    species_richness = length(unique(name)),
    total_reads = sum(new_est_reads),
    dominant_species = name[which.max(new_est_reads)],
    dominance = max(new_est_reads) / sum(new_est_reads)
  ), by = .(sample_id, genus)]

  # 合并元数据
  diversity_metrics <- merge(diversity_metrics, metadata, by = "sample_id")

  return(diversity_metrics)
}

intragenus_div <- calculate_intragenus_diversity(bracken_species, sample_metadata)

# 选择有足够数据的属进行可视化
genus_with_data <- intragenus_div[, .(n_samples = .N), by = genus][n_samples >= 20]$genus
intragenus_div_plot <- intragenus_div[genus %in% head(genus_with_data, 12)]

# 可视化：属内物种丰富度
p_richness <- ggplot(intragenus_div_plot, aes(x = group, y = species_richness, fill = group)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.5, size = 1) +
  facet_wrap(~ genus, scales = "free_y", ncol = 4) +
  scale_fill_manual(values = c("IC" = "#3498db", "CA" = "#e74c3c")) +
  stat_compare_means(method = "wilcox.test", label = "p.signif",
                     label.x = 1.5, label.y.npc = "top") +
  labs(
    title = "Intra-genus Species Richness by Group",
    subtitle = "Number of species detected within each genus",
    x = "Group",
    y = "Species Richness"
  ) +
  theme_bw() +
  theme(
    strip.text = element_text(face = "italic"),
    legend.position = "bottom"
  )

print(p_richness)
```

## 3.3 属内优势度分析

```{r}
#| label: intragenus-dominance
#| fig-width: 12
#| fig-height: 8

# 可视化：属内优势度（最丰富物种占比）
p_dominance <- ggplot(intragenus_div_plot, aes(x = group, y = dominance, fill = group)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.5, size = 1) +
  facet_wrap(~ genus, scales = "free_y", ncol = 4) +
  scale_fill_manual(values = c("IC" = "#3498db", "CA" = "#e74c3c")) +
  stat_compare_means(method = "wilcox.test", label = "p.signif",
                     label.x = 1.5, label.y.npc = "top") +
  labs(
    title = "Intra-genus Dominance by Group",
    subtitle = "Proportion of reads from the most abundant species",
    x = "Group",
    y = "Dominance Index"
  ) +
  theme_bw() +
  theme(
    strip.text = element_text(face = "italic"),
    legend.position = "bottom"
  )

print(p_dominance)
```

## 3.4 属内Shannon多样性

```{r}
#| label: intragenus-shannon
#| fig-width: 12
#| fig-height: 8

# 计算属内Shannon多样性
calculate_intragenus_shannon <- function(species_data, metadata, target_genera, min_reads = 10) {

  results_list <- list()

  for (g in target_genera) {
    genus_data <- species_data[genus == g & new_est_reads >= min_reads]

    for (sid in unique(genus_data$sample_id)) {
      sample_data <- genus_data[sample_id == sid]

      if (nrow(sample_data) > 0) {
        # 计算Shannon指数
        props <- sample_data$new_est_reads / sum(sample_data$new_est_reads)
        shannon <- -sum(props * log(props))

        results_list[[paste(g, sid, sep = "_")]] <- data.frame(
          genus = g,
          sample_id = sid,
          shannon = shannon,
          n_species = nrow(sample_data)
        )
      }
    }
  }

  results <- do.call(rbind, results_list)
  results <- merge(results, metadata, by = "sample_id")
  return(results)
}

intragenus_shannon <- calculate_intragenus_shannon(
  bracken_species,
  sample_metadata,
  head(genus_with_data, 12)
)

# 可视化
p_shannon <- ggplot(intragenus_shannon, aes(x = group, y = shannon, fill = group)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.5, size = 1) +
  facet_wrap(~ genus, scales = "free_y", ncol = 4) +
  scale_fill_manual(values = c("IC" = "#3498db", "CA" = "#e74c3c")) +
  stat_compare_means(method = "wilcox.test", label = "p.signif",
                     label.x = 1.5, label.y.npc = "top") +
  labs(
    title = "Intra-genus Shannon Diversity by Group",
    subtitle = "Diversity of species within each genus",
    x = "Group",
    y = "Shannon Index"
  ) +
  theme_bw() +
  theme(
    strip.text = element_text(face = "italic"),
    legend.position = "bottom"
  )

print(p_shannon)
```

# Part 4: 物种共现模式分析

## 4.1 构建物种共现网络

```{r}
#| label: species-cooccurrence
#| fig-width: 12
#| fig-height: 10

# 筛选高丰度物种用于共现分析
min_prevalence <- 0.3  # 至少30%样本中出现
min_abundance <- 0.01  # 至少0.01%平均相对丰度

# 计算prevalence和mean abundance
species_stats <- data.frame(
  species = rownames(species_relabund),
  prevalence = rowMeans(species_relabund > 0),
  mean_abund = rowMeans(species_relabund)
)

filtered_species <- species_stats$species[
  species_stats$prevalence >= min_prevalence &
  species_stats$mean_abund >= min_abundance
]

cat("Species passing filters:", length(filtered_species), "\n")

# 使用筛选后的物种计算相关性
if (length(filtered_species) >= 10) {
  species_filtered <- species_relabund[filtered_species, ]

  # 计算Spearman相关
  cor_matrix <- cor(t(species_filtered), method = "spearman")

  # 设置阈值构建网络
  cor_threshold <- 0.6
  cor_matrix[abs(cor_matrix) < cor_threshold] <- 0
  diag(cor_matrix) <- 0

  # 构建igraph网络
  graph <- graph_from_adjacency_matrix(
    cor_matrix,
    mode = "undirected",
    weighted = TRUE
  )

  # 只保留有边的节点
  isolated <- which(degree(graph) == 0)
  if (length(isolated) > 0) {
    graph <- delete.vertices(graph, isolated)
  }

  if (vcount(graph) > 0 && ecount(graph) > 0) {
    # 添加节点属性
    V(graph)$genus <- str_extract(V(graph)$name, "^[A-Z][a-z]+")
    V(graph)$size <- species_stats$mean_abund[match(V(graph)$name, species_stats$species)]

    # 边的颜色：正相关蓝色，负相关红色
    E(graph)$color <- ifelse(E(graph)$weight > 0, "#3498db", "#e74c3c")
    E(graph)$width <- abs(E(graph)$weight) * 2

    # 可视化
    p_network <- ggraph(graph, layout = "fr") +
      geom_edge_link(aes(color = I(color), width = width), alpha = 0.5) +
      geom_node_point(aes(size = log10(size + 1) + 1), color = "#2c3e50", alpha = 0.8) +
      geom_node_text(aes(label = str_trunc(name, 25)), size = 2.5, repel = TRUE) +
      scale_edge_width(range = c(0.5, 2), guide = "none") +
      labs(
        title = "Species Co-occurrence Network",
        subtitle = paste0("Spearman |r| >= ", cor_threshold, ", ",
                         vcount(graph), " species, ", ecount(graph), " edges"),
        caption = "Blue = positive correlation, Red = negative correlation"
      ) +
      theme_void() +
      theme(
        plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5)
      )

    print(p_network)
  } else {
    cat("No edges remaining after filtering\n")
  }
} else {
  cat("Not enough species passing filters for network analysis\n")
}
```

## 4.2 组特异性共现模式

```{r}
#| label: group-specific-cooccurrence
#| fig-width: 14
#| fig-height: 6

if (length(filtered_species) >= 10) {
  # 分组计算相关性
  ca_samples <- sample_metadata$sample_id[sample_metadata$group == "CA"]
  ic_samples <- sample_metadata$sample_id[sample_metadata$group == "IC"]

  cor_ca <- cor(t(species_filtered[, ca_samples]), method = "spearman")
  cor_ic <- cor(t(species_filtered[, ic_samples]), method = "spearman")

  # 计算相关性差异
  cor_diff <- cor_ca - cor_ic

  # 热图可视化（仅显示top物种）
  top_n <- min(30, nrow(species_filtered))
  top_species <- names(sort(rowMeans(species_filtered), decreasing = TRUE)[1:top_n])

  # CA组热图
  pheatmap(
    cor_ca[top_species, top_species],
    main = "CA Group: Species Correlation",
    color = colorRampPalette(c("#2166ac", "white", "#b2182b"))(100),
    breaks = seq(-1, 1, length.out = 101),
    fontsize = 7,
    fontsize_row = 6,
    fontsize_col = 6,
    angle_col = 45,
    show_rownames = TRUE,
    show_colnames = TRUE,
    treeheight_row = 30,
    treeheight_col = 30
  )
}
```

# Part 5: 关键属的物种组成差异

## 5.1 识别差异显著的属

```{r}
#| label: differential-genera
#| fig-width: 10
#| fig-height: 6

# 统计每个属在每组的总丰度
genus_by_group <- bracken_species[, .(
  total_reads = sum(new_est_reads)
), by = .(genus, sample_id)]

genus_by_group <- merge(genus_by_group, sample_metadata, by = "sample_id")

# 计算每个属的组间差异
genus_test <- genus_by_group[, {
  if (.N >= 4) {
    test <- wilcox.test(total_reads ~ group, data = .SD)
    list(
      p_value = test$p.value,
      ca_median = median(total_reads[group == "CA"]),
      ic_median = median(total_reads[group == "IC"])
    )
  } else {
    list(p_value = NA, ca_median = NA, ic_median = NA)
  }
}, by = genus]

genus_test <- genus_test[!is.na(p_value)]
genus_test[, padj := p.adjust(p_value, method = "BH")]
genus_test[, log2fc := log2((ca_median + 1) / (ic_median + 1))]

# 显著差异的属
sig_genera <- genus_test[padj < 0.1][order(padj)]
cat("Genera with significant differential abundance (padj < 0.1):", nrow(sig_genera), "\n\n")

if (nrow(sig_genera) > 0) {
  print(head(sig_genera, 10))
}
```

## 5.2 差异属的物种组成热图

```{r}
#| label: species-composition-heatmap
#| fig-width: 14
#| fig-height: 10

# 选择top差异属或高丰度属
if (nrow(sig_genera) >= 3) {
  target_genera_plot <- head(sig_genera$genus, 6)
} else {
  target_genera_plot <- head(genus_summary$genus, 6)
}

# 提取这些属的物种
species_in_target <- bracken_species[genus %in% target_genera_plot]

# 为每个属创建物种组成可视化
for (g in target_genera_plot) {
  genus_species <- species_in_target[genus == g]

  # 取top 10物种
  top_species_in_genus <- genus_species[, .(
    total = sum(new_est_reads)
  ), by = name][order(-total)][1:min(10, .N)]$name

  genus_species_top <- genus_species[name %in% top_species_in_genus]

  # 计算相对丰度
  genus_species_top <- genus_species_top[, .(
    rel_abund = sum(new_est_reads)
  ), by = .(name, sample_id)]

  genus_species_top <- merge(genus_species_top, sample_metadata, by = "sample_id")

  # 堆叠条形图
  p <- ggplot(genus_species_top, aes(x = sample_id, y = rel_abund, fill = name)) +
    geom_bar(stat = "identity", position = "fill") +
    facet_grid(~ group, scales = "free_x", space = "free_x") +
    scale_fill_brewer(palette = "Set3", name = "Species") +
    labs(
      title = paste0("Species Composition within ", g),
      x = "Sample",
      y = "Relative Abundance"
    ) +
    theme_bw() +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 7),
      legend.text = element_text(face = "italic", size = 8),
      strip.text = element_text(face = "bold")
    )

  print(p)
}
```

## 5.3 物种级差异分析（选定属内）

```{r}
#| label: species-differential-within-genus
#| fig-width: 12
#| fig-height: 8

# 对差异属内的物种进行统计检验
species_diff_results <- list()

for (g in head(target_genera_plot, 4)) {
  genus_species <- bracken_species[genus == g]

  # 获取该属内所有物种
  species_in_genus <- unique(genus_species$name)

  for (sp in species_in_genus) {
    sp_data <- genus_species[name == sp, .(reads = sum(new_est_reads)), by = sample_id]
    sp_data <- merge(sp_data, sample_metadata, by = "sample_id", all.y = TRUE)
    sp_data[is.na(reads), reads := 0]

    # Wilcoxon检验
    if (sum(sp_data$reads > 0) >= 3) {
      test <- wilcox.test(reads ~ group, data = sp_data)

      species_diff_results[[paste(g, sp, sep = "::")]] <- data.frame(
        genus = g,
        species = sp,
        p_value = test$p.value,
        ca_mean = mean(sp_data$reads[sp_data$group == "CA"]),
        ic_mean = mean(sp_data$reads[sp_data$group == "IC"]),
        prevalence = mean(sp_data$reads > 0)
      )
    }
  }
}

species_diff_df <- do.call(rbind, species_diff_results)
species_diff_df$padj <- p.adjust(species_diff_df$p_value, method = "BH")
species_diff_df$log2fc <- log2((species_diff_df$ca_mean + 1) / (species_diff_df$ic_mean + 1))

# 显示显著结果
sig_species <- species_diff_df[species_diff_df$padj < 0.1, ]
sig_species <- sig_species[order(sig_species$padj), ]

cat("Significant species within target genera (padj < 0.1):", nrow(sig_species), "\n\n")

if (nrow(sig_species) > 0) {
  print(head(sig_species, 15))
}
```

## 5.4 差异物种可视化

```{r}
#| label: differential-species-volcano
#| fig-width: 10
#| fig-height: 8

# 火山图
species_diff_df$significance <- ifelse(
  species_diff_df$padj < 0.1,
  ifelse(species_diff_df$log2fc > 0, "Up in CA", "Down in CA"),
  "Not significant"
)

p_volcano <- ggplot(species_diff_df, aes(x = log2fc, y = -log10(padj))) +
  geom_point(aes(color = significance), alpha = 0.6, size = 2) +
  geom_hline(yintercept = -log10(0.1), linetype = "dashed", color = "gray50") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50") +
  scale_color_manual(values = c(
    "Up in CA" = "#e74c3c",
    "Down in CA" = "#3498db",
    "Not significant" = "gray70"
  )) +
  labs(
    title = "Species-level Differential Abundance",
    subtitle = "Within selected genera",
    x = "log2 Fold Change (CA vs IC)",
    y = "-log10(adjusted p-value)"
  ) +
  theme_bw() +
  theme(legend.position = "bottom")

# 添加标签
if (nrow(sig_species) > 0) {
  top_sig <- head(sig_species, 10)
  p_volcano <- p_volcano +
    ggrepel::geom_text_repel(
      data = species_diff_df[species_diff_df$species %in% top_sig$species, ],
      aes(label = species),
      size = 2.5,
      max.overlaps = 15
    )
}

print(p_volcano)
```

# Summary

## 分析总结

```{r}
#| label: summary
#| echo: false

cat("=== 属内物种多样性分析总结 ===\n\n")

cat("1. 数据概况:\n")
cat("   - 总物种数:", length(unique(bracken_species$name)), "\n")
cat("   - 总属数:", length(unique(bracken_species$genus)), "\n")
cat("   - 样本数:", length(unique(bracken_species$sample_id)), "\n\n")

cat("2. 属级差异:\n")
cat("   - 显著差异属数 (padj < 0.1):", nrow(sig_genera), "\n\n")

cat("3. 物种级差异 (在选定属内):\n")
cat("   - 显著差异物种数 (padj < 0.1):", nrow(sig_species), "\n\n")

cat("4. 局限性说明:\n")
cat("   - 本分析基于Kraken2/Bracken物种级数据\n")
cat("   - 无法达到真正的株系水平分辨率\n")
cat("   - StrainPhlAn分析需要MetaPhlAn原始数据\n")
```

## 后续分析建议

::: {.callout-note}
## 当原始数据可用时

1. **运行MetaPhlAn profiling**：从FASTQ生成marker比对文件
2. **运行StrainPhlAn**：提取株系特异性序列
3. **株系系统发育分析**：使用PhyloPhlAn构建株系树
4. **株系-表型关联**：关联株系与CagA感染结局

参考：bioBakery 3 protocol (Beghini et al., 2021, eLife 10:e65088)
:::

```{r}
#| label: session-info
#| echo: false
sessionInfo()
```
