---
title: "03_singlem_diversity_analysis"
title-block-banner: true
author:
  - name: Gong Yuhang
date: 2025-01-07
toc: true
toc-depth: 4
number-sections: true
code-fold: true
code-line-numbers: true
code-tools: true
format:
  html:
    embed-resources: true
    smooth-scroll: true
    page-layout: full
reference-location: section
citation-location: document
params:
  name: "03_singlem_diversity_analysis"
---

**Updated: `r format(Sys.time(), '%Y-%m-%d %H:%M:%S', tz = 'CET')` CET.**

本文档是项目 pc047 (vCagAepitope) 的 SingleM/Lyrebird 分析模块。

**分析目的**：
使用 SingleM（细菌/古菌）和 Lyrebird（噬菌体）的 OTU-based 分类结果，评估 CagA 依赖性感染对肠道微生物组的影响。

**相比 01 分析（Kraken2/Bracken）的优势**：
1. **系统发育树**：可计算 UniFrac 距离（考虑进化关系）
2. **新物种检测**：能识别数据库中未收录的物种
3. **OTU分辨率**：更高的分类精度

```{r}
#| label: params
#| eval: !expr interactive()
#| include: false
params = list(name = "03_singlem_diversity_analysis")
```

```{r}
#| label: setup
#| message: false
#| include: false
#| warning: false
wd <- "analyses"
if (basename(getwd()) != wd) {
  setwd(here::here(wd))
}
here::i_am(paste0(params$name, ".qmd"), uuid = "afa4f8be-7482-4ada-828a-4a541866dfe6")
projthis::proj_create_dir_target(params$name, clean = FALSE)
path_target <- projthis::proj_path_target(params$name)
path_source <- projthis::proj_path_source(params$name)
path_raw <- path_source("00-raw")
path_resource <- here::here(path_raw, "d00-resource")
path_data <- here::here(path_raw, paste0("d", params$name))
dir.create(path_raw, recursive = TRUE, showWarnings = FALSE)
dir.create(path_data, recursive = TRUE, showWarnings = FALSE)
dir.create(path_resource, recursive = TRUE, showWarnings = FALSE)
```

```{r}
#| label: packages
#| message: false
suppressPackageStartupMessages({
  library(here)
  library(conflicted)
  library(tidyverse)
  library(data.table)
  library(mia)
  library(TreeSummarizedExperiment)
  library(readxl)
  library(miaViz)
  library(scuttle)
  library(patchwork)
  library(MatrixGenerics)
  library(stringr)
  library(ggpubr)

  library(scater)
  library(vegan)
  library(ggplot2)
  library(ANCOMBC)
  library(ALDEx2)
  library(ape) # 用于读取系统发育树
  library(phyloseq) # UniFrac 计算的稳定实现
  devtools::load_all()
})

# 解决命名空间冲突
conflicts_prefer(base::setdiff)
conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::select)
conflicts_prefer(dplyr::lag)
conflicts_prefer(dplyr::first)
conflicts_prefer(dplyr::left_join)
conflicts_prefer(ggplot2::annotate)
conflicts_prefer(base::intersect)

set.seed(20261)
```

# Part 1: SingleM 细菌/古菌分析

## 1. 数据导入与 TSE 构建

根据 SingleM Protocol，我们使用以下分析就绪文件：
- `*_OTU_abundance.tsv`: OTU 丰度矩阵（相对丰度 %）
- `*_OTU_taxonomy.tsv`: OTU 分类信息
- `*_OTU_tree.nwk`: 系统发育树（用于 UniFrac 计算）

```{r}
#| label: singlem-data-import

# ==============================================================================
# Step 1: 定义数据路径
# ==============================================================================
singlem_data_path <- here::here(
  "data", "00-raw", "d03_singlem_diversity_analysis", "pc047-rst_singleM"
)

# ==============================================================================
# Step 2: 读取 OTU 丰度矩阵
# ==============================================================================
# SingleM 输出的是相对丰度（百分比），我们将其转换为比例（0-1）
otu_abundance <- read_tsv(
  file.path(singlem_data_path, "pc047-singleM_OTU_abundance.tsv"),
  show_col_types = FALSE
) |>
  column_to_rownames("otu_id") |>
  as.matrix()

# 将百分比转换为比例
otu_abundance <- otu_abundance / 100

cat("OTU 矩阵维度:", dim(otu_abundance), "\n")
cat("样本数:", ncol(otu_abundance), "\n")
cat("OTU 数:", nrow(otu_abundance), "\n")

# ==============================================================================
# Step 3: 读取 OTU 分类信息
# ==============================================================================
otu_taxonomy <- read_tsv(
  file.path(singlem_data_path, "pc047-singleM_OTU_taxonomy.tsv"),
  show_col_types = FALSE
) |>
  column_to_rownames("otu_id") |>
  DataFrame()

# 查看分类层级
cat("分类层级:", colnames(otu_taxonomy), "\n")

# ==============================================================================
# Step 4: 读取系统发育树
# ==============================================================================
otu_tree <- ape::read.tree(
  file.path(singlem_data_path, "pc047-singleM_OTU_tree.nwk")
)

cat("系统发育树 tip 数:", length(otu_tree$tip.label), "\n")

# ==============================================================================
# Step 5: 构建 TreeSummarizedExperiment 对象
# ==============================================================================
# 确保 OTU ID 顺序一致
common_otus <- intersect(rownames(otu_abundance), rownames(otu_taxonomy))
common_otus <- intersect(common_otus, otu_tree$tip.label)

cat("共同 OTU 数:", length(common_otus), "\n")

# 子集化数据
otu_abundance <- otu_abundance[common_otus, ]
otu_taxonomy <- otu_taxonomy[common_otus, ]
otu_tree <- ape::keep.tip(otu_tree, common_otus)

# 创建 TSE 对象
# 注意：SingleM 输出是相对丰度，我们将其乘以 10000 作为伪计数以便后续分析
tse_singlem <- TreeSummarizedExperiment(
  assays = list(
    relabundance = otu_abundance,
    counts = round(otu_abundance * 10000) # 伪计数用于某些需要整数的分析
  ),
  rowData = otu_taxonomy,
  rowTree = otu_tree
)

tse_singlem
```

```{r}
#| label: singlem-add-metadata

# ==============================================================================
# Step 6: 绑定样本元数据
# ==============================================================================
metadata <- readxl::read_xlsx(
  here::here("data", "metadata", "pc047-metadata.xlsx")
) |>
  column_to_rownames("sample_id")

# 匹配样本名
common_samples <- intersect(colnames(tse_singlem), rownames(metadata))
cat("匹配的样本数:", length(common_samples), "\n")

tse_singlem <- tse_singlem[, common_samples]
colData(tse_singlem) <- DataFrame(metadata[common_samples, ])

# ==============================================================================
# Step 7: 创建 Caecum 子集
# ==============================================================================
# 本项目主要分析 caecum（盲肠）样本
tse_singlem_ca <- tse_singlem[, tse_singlem$source_organ == "caecum"]

cat("Caecum 样本数:", ncol(tse_singlem_ca), "\n")
cat("各实验组样本分布:\n")
print(table(tse_singlem_ca$treatment_group))

tse_singlem_ca
```

## 2. 数据探索与质量控制 (QC)

### 2.1 第一遍清洗：数据探索

```{r}
#| label: singlem-qc-round1

# ==============================================================================
# 1. 计算文库大小（基于伪计数）
# ==============================================================================
tse_singlem_ca_1 <- tse_singlem_ca
tse_singlem_ca_1 <- addPerCellQCMetrics(tse_singlem_ca_1, assay.type = "counts")

# 可视化文库大小分布
p1 <- plotHistogram(tse_singlem_ca_1, col.var = "total") +
  labs(title = "SingleM: Library Size Distribution", x = "Total Pseudo-counts")
p1

ggsave(
  filename = here::here("data", params$name, "01_qc_library_size_singlem.png"),
  plot = p1, width = 8, height = 6, dpi = 300
)

# ==============================================================================
# 2. Prevalence 分析
# ==============================================================================
tse_singlem_ca_1 <- addPrevalence(
  tse_singlem_ca_1,
  assay.type = "relabundance",
  detection = 0,
  as.relative = FALSE # 已经是相对丰度
)

rowData(tse_singlem_ca_1)$prevalence <- as.numeric(rowData(tse_singlem_ca_1)$prevalence)
summary(rowData(tse_singlem_ca_1)$prevalence)

p2 <- plotHistogram(tse_singlem_ca_1, row.var = "prevalence") +
  labs(title = "SingleM: OTU Prevalence Distribution", x = "Prevalence (Fraction of Samples)")
p2

ggsave(
  filename = here::here("data", params$name, "02_qc_prevalence_singlem.png"),
  plot = p2, width = 8, height = 6, dpi = 300
)

# ==============================================================================
# 3. 查看丰度最高的 OTU
# ==============================================================================
top_otus <- getTop(tse_singlem_ca_1, top = 10, assay.type = "relabundance")
cat("Top 10 OTUs:\n")
print(top_otus)

# 查看对应的分类信息
cat("\nTop 10 OTU 分类信息:\n")
print(rowData(tse_singlem_ca_1)[top_otus, ])
```

### 2.2 第二遍清洗：去除异常样本

```{r}
#| label: singlem-qc-round2

# ==============================================================================
# 1. 检查是否有异常样本（如 ca08 在 01 分析中被识别为污染）
# ==============================================================================
tse_singlem_ca_2 <- tse_singlem_ca

# 查看 ca08 的情况
if ("ca08" %in% colnames(tse_singlem_ca_2)) {
  ca08_top <- sort(assay(tse_singlem_ca_2[, "ca08"], "relabundance"), decreasing = TRUE)[1:5]
  cat("ca08 样本 Top 5 OTU 丰度:\n")
  print(ca08_top)

  # 根据 01 分析结果，ca08 存在 E. coli 异常高丰度，考虑移除
  cat("\n根据 01 分析结果，移除 ca08 样本\n")
  tse_singlem_ca_2 <- tse_singlem_ca_2[, colnames(tse_singlem_ca_2) != "ca08"]
}

cat("清洗后样本数:", ncol(tse_singlem_ca_2), "\n")

# ==============================================================================
# 2. Prevalence 过滤（保留 >10% 样本中出现的 OTU）
# ==============================================================================
tse_singlem_ca_2 <- addPrevalence(
  tse_singlem_ca_2,
  assay.type = "relabundance",
  detection = 0,
  as.relative = FALSE
)

cat("过滤前 OTU 数:", nrow(tse_singlem_ca_2), "\n")
tse_singlem_ca_2 <- subsetByPrevalent(tse_singlem_ca_2, prevalence = 0.1)
cat("过滤后 OTU 数:", nrow(tse_singlem_ca_2), "\n")

# ==============================================================================
# 3. 更新 QC 指标
# ==============================================================================
tse_singlem_ca_2 <- addPerCellQCMetrics(tse_singlem_ca_2, assay.type = "counts")

p3 <- plotHistogram(tse_singlem_ca_2, col.var = "total") +
  labs(title = "SingleM: Library Size (After Cleaning)", x = "Total Pseudo-counts")
p3

ggsave(
  filename = here::here("data", params$name, "03_qc_library_size_cleaned_singlem.png"),
  plot = p3, width = 8, height = 6, dpi = 300
)
```

### 2.3 清洗后数据整理

```{r}
#| label: singlem-cleaned-data

# ==============================================================================
# 保存清洗后的 TSE 对象
# ==============================================================================
tse_singlem_ca_cleaned <- tse_singlem_ca_2

# 查看分类层级
cat("可用的分类层级:\n")
print(taxonomyRanks(tse_singlem_ca_cleaned))

# 保存清洗后的数据
saveRDS(
  tse_singlem_ca_cleaned,
  file = here::here("data", params$name, "tse_singlem_ca_cleaned.rds")
)

tse_singlem_ca_cleaned
```

## 3. 群落组成可视化

```{r}
#| label: singlem-composition
#| fig-width: 12
#| fig-height: 8

# ==============================================================================
# 1. Top 10 OTU 组成图
# ==============================================================================
top_otus_cleaned <- getTop(tse_singlem_ca_cleaned, top = 10, assay.type = "relabundance")

# 创建用于绘图的 TSE 副本
tse_plot <- tse_singlem_ca_cleaned

# 将非 Top 10 的 OTU 标记为 "Other"
rowData(tse_plot)$OTU_Top10 <- ifelse(
  rownames(tse_plot) %in% top_otus_cleaned,
  paste0(rownames(tse_plot), " (", rowData(tse_plot)$Family, ")"),
  "Other"
)

# 聚合
tse_plot_agg <- agglomerateByVariable(tse_plot, by = "rows", f = "OTU_Top10")

# 绘图
p_comp <- plotAbundance(
  tse_plot_agg,
  assay.type = "relabundance",
  order.row.by = "abund",
  order.col.by = "Other"
) +
  labs(
    title = "SingleM: Top 10 OTU Composition (Caecum)",
    subtitle = "Non-top OTUs grouped as 'Other'"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))

p_comp

ggsave(
  filename = here::here("data", params$name, "04_composition_top10_singlem.png"),
  plot = p_comp, width = 14, height = 8, dpi = 300
)

# ==============================================================================
# 2. 按 Phylum 聚合的组成图
# ==============================================================================
# 检查是否有 Phylum 列
if ("Phylum" %in% colnames(rowData(tse_singlem_ca_cleaned))) {
  tse_phylum <- agglomerateByRank(tse_singlem_ca_cleaned, rank = "Phylum")

  p_phylum <- plotAbundance(
    tse_phylum,
    assay.type = "relabundance",
    order.row.by = "abund"
  ) +
    labs(title = "SingleM: Phylum-level Composition") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))

  p_phylum

  ggsave(
    filename = here::here("data", params$name, "05_composition_phylum_singlem.png"),
    plot = p_phylum, width = 14, height = 8, dpi = 300
  )
}
```

## 4. Alpha 多样性分析

```{r}
#| label: singlem-alpha-diversity

# ==============================================================================
# 1. 计算 Alpha 多样性指数
# ==============================================================================
tse_singlem_ca_cleaned <- addAlpha(
  tse_singlem_ca_cleaned,
  assay.type = "counts",
  index = c("shannon", "observed"),
  name = c("shannon_index", "observed_richness")
)

cat("Alpha 多样性指数已计算\n")

# ==============================================================================
# 2. 提取核心比较组 (ApcMUT_HpWT vs ApcMUT_HpKO)
# ==============================================================================
tse_singlem_corepair <- tse_singlem_ca_cleaned[
  , tse_singlem_ca_cleaned$treatment_group %in% c("ApcMUT_HpWT", "ApcMUT_HpKO")
]
tse_singlem_corepair$treatment_group <- factor(tse_singlem_corepair$treatment_group)

cat("核心比较组样本数:\n")
print(table(tse_singlem_corepair$treatment_group))

# ==============================================================================
# 3. 统计检验 (Wilcoxon 秩和检验)
# ==============================================================================
# Shannon 指数检验
wilcox_shannon <- wilcox.test(
  shannon_index ~ treatment_group,
  data = colData(tse_singlem_corepair)
)
cat("\nShannon 指数 Wilcoxon 检验 P 值:", round(wilcox_shannon$p.value, 4), "\n")

# Observed richness 检验
wilcox_observed <- wilcox.test(
  observed_richness ~ treatment_group,
  data = colData(tse_singlem_corepair)
)
cat("Observed Richness Wilcoxon 检验 P 值:", round(wilcox_observed$p.value, 4), "\n")

# ==============================================================================
# 4. 可视化
# ==============================================================================
plot_alpha <- function(tse, y_var, title) {
  plotColData(tse,
    x = "treatment_group", y = y_var,
    colour_by = "treatment_group",
    show_boxplot = TRUE
  ) +
    stat_compare_means(
      comparisons = list(c("ApcMUT_HpKO", "ApcMUT_HpWT")),
      method = "wilcox.test", label = "p.format"
    ) +
    labs(title = title, x = "Group", y = "Index Value") +
    theme_bw() +
    theme(legend.position = "none")
}

p_shannon <- plot_alpha(tse_singlem_corepair, "shannon_index", "SingleM: Shannon Diversity")
p_observed <- plot_alpha(tse_singlem_corepair, "observed_richness", "SingleM: Observed OTU Richness")

p_alpha_combined <- p_shannon + p_observed +
  plot_annotation(title = "SingleM Alpha Diversity: ApcMUT_HpWT vs ApcMUT_HpKO")
p_alpha_combined

ggsave(
  filename = here::here("data", params$name, "06_alpha_diversity_singlem.png"),
  plot = p_alpha_combined, width = 12, height = 6, dpi = 300
)
```

## 5. Beta 多样性分析

### 5.1 Bray-Curtis 距离

```{r}
#| label: singlem-beta-bray

# ==============================================================================
# 1. PCoA (Bray-Curtis)
# ==============================================================================
tse_singlem_corepair <- runMDS(
  tse_singlem_corepair,
  FUN = vegan::vegdist,
  method = "bray",
  assay.type = "relabundance",
  name = "PCoA_Bray"
)

# 提取特征值
eig_bray <- attr(reducedDim(tse_singlem_corepair, "PCoA_Bray"), "eig")
rel_eig_bray <- eig_bray / sum(eig_bray[eig_bray > 0])

# 可视化
p_pcoa_bray <- plotReducedDim(
  tse_singlem_corepair,
  "PCoA_Bray",
  colour_by = "treatment_group"
) +
  theme_bw() +
  labs(
    title = "SingleM: PCoA (Bray-Curtis)",
    x = paste0("PCoA 1 (", round(100 * rel_eig_bray[1], 1), "%)"),
    y = paste0("PCoA 2 (", round(100 * rel_eig_bray[2], 1), "%)")
  )
p_pcoa_bray

ggsave(
  filename = here::here("data", params$name, "07_beta_pcoa_bray_singlem.png"),
  plot = p_pcoa_bray, width = 8, height = 6, dpi = 300
)

# ==============================================================================
# 2. PERMANOVA 检验 (Bray-Curtis)
# ==============================================================================
permanova_bray <- getPERMANOVA(
  tse_singlem_corepair,
  assay.type = "relabundance",
  formula = x ~ treatment_group
)

cat("\n=== PERMANOVA (Bray-Curtis) ===\n")
print(permanova_bray$permanova)

write.csv(
  permanova_bray$permanova,
  file = here::here("data", params$name, "08_permanova_bray_singlem.csv"),
  row.names = TRUE
)
```

### 5.2 UniFrac 距离（利用系统发育树）

::: {.callout-important}
## UniFrac 分析的重要性

UniFrac 是 SingleM 数据的**核心优势**：
- **Bray-Curtis** 只比较丰度数值，忽略进化关系
- **UniFrac** 通过系统发育树比较"演化家谱"，能识别**株系级遗传偏移**

对于 pc047 项目，UniFrac 可以揭示 HpWT 组是否整体向特定"致病演化支"偏移。
:::

```{r}
#| label: singlem-beta-unifrac-diagnose

# ==============================================================================
# Step 1: 诊断树和 OTU 矩阵的匹配情况
# ==============================================================================
cat("=== UniFrac 计算前诊断 ===\n\n")

# 获取树和 OTU 信息
tree <- rowTree(tse_singlem_corepair)
otu_names <- rownames(tse_singlem_corepair)
tree_tips <- tree$tip.label

cat("OTU 矩阵中的 OTU 数量:", length(otu_names), "\n")
cat("系统发育树的 tip 数量:", length(tree_tips), "\n")

# 检查匹配情况
in_both <- intersect(otu_names, tree_tips)
only_in_otu <- setdiff(otu_names, tree_tips)
only_in_tree <- setdiff(tree_tips, otu_names)

cat("两者共有的 OTU:", length(in_both), "\n")
cat("仅在 OTU 矩阵中:", length(only_in_otu), "\n")
cat("仅在树中:", length(only_in_tree), "\n")

if (length(only_in_otu) > 0) {
  cat("\n警告: 以下 OTU 不在树中:\n")
  print(head(only_in_otu, 10))
}

# 检查树是否有效
cat("\n树结构检查:\n")
cat("  - 是否为二叉树:", ape::is.binary(tree), "\n")
cat("  - 是否有根:", ape::is.rooted(tree), "\n")

# 检查边长
if (!is.null(tree$edge.length) && length(tree$edge.length) > 0) {
  valid_edges <- tree$edge.length[is.finite(tree$edge.length)]
  if (length(valid_edges) > 0) {
    cat("  - 有效边长范围:", range(valid_edges), "\n")
  } else {
    cat("  - 有效边长范围: 无有效边长!\n")
  }
  cat("  - 总边数:", length(tree$edge.length), "\n")
  cat("  - NA 边长数量:", sum(is.na(tree$edge.length)), "\n")
  cat("  - Inf 边长数量:", sum(is.infinite(tree$edge.length)), "\n")
  cat("  - 负数边长数量:", sum(tree$edge.length < 0, na.rm = TRUE), "\n")
} else {
  cat("  - 边长信息: 树没有边长信息!\n")
}
```

```{r}
#| label: singlem-beta-unifrac-fix-tree

# ==============================================================================
# Step 2: 修复树的边长问题
# ==============================================================================
cat("\n=== 修复树的边长 ===\n")

# 获取原始树
tree_original <- rowTree(tse_singlem_corepair)

# 复制树进行修复
tree_fixed <- tree_original

# 检查并修复边长
if (is.null(tree_fixed$edge.length) || length(tree_fixed$edge.length) == 0) {
  # 如果完全没有边长，创建默认边长（全部设为 1）
  cat("树没有边长信息，创建默认边长...\n")
  tree_fixed$edge.length <- rep(1, nrow(tree_fixed$edge))
} else {
  # 统计问题边长
  n_na <- sum(is.na(tree_fixed$edge.length))
  n_inf <- sum(is.infinite(tree_fixed$edge.length))
  n_neg <- sum(tree_fixed$edge.length < 0, na.rm = TRUE)
  n_zero <- sum(tree_fixed$edge.length == 0, na.rm = TRUE)

  cat("发现问题边长:\n")
  cat("  - NA:", n_na, "\n")
  cat("  - Inf:", n_inf, "\n")
  cat("  - 负数:", n_neg, "\n")
  cat("  - 零:", n_zero, "\n")

  # 修复异常值：替换为极小的正数
  small_value <- 1e-6

  # 替换 NA
  tree_fixed$edge.length[is.na(tree_fixed$edge.length)] <- small_value

  # 替换 Inf
  tree_fixed$edge.length[is.infinite(tree_fixed$edge.length)] <- small_value

  # 替换负数
  tree_fixed$edge.length[tree_fixed$edge.length < 0] <- small_value

  # 替换零（某些算法不能处理零边长）
  tree_fixed$edge.length[tree_fixed$edge.length == 0] <- small_value

  cat("\n修复后边长范围:", range(tree_fixed$edge.length), "\n")
}

# 更新 TSE 对象中的树
rowTree(tse_singlem_corepair) <- tree_fixed

cat("树修复完成!\n")
```

```{r}
#| label: singlem-beta-unifrac-compute

# ==============================================================================
# Step 3: 使用 mia 原生函数计算 UniFrac（OMA 推荐）
# ==============================================================================
cat("\n=== 使用 mia 计算 UniFrac 距离 ===\n")

unifrac_success <- FALSE

tryCatch({
  # 确保使用修复后的树
  tree_for_unifrac <- rowTree(tse_singlem_corepair)

  # 确保 OTU 和树完全匹配
  common_taxa <- intersect(rownames(tse_singlem_corepair), tree_for_unifrac$tip.label)
  cat("使用", length(common_taxa), "个共同 OTU 进行 UniFrac 计算\n")

  # 子集化 TSE 对象以确保匹配
  tse_for_unifrac <- tse_singlem_corepair[common_taxa, ]

  # 修剪树
  tree_pruned <- ape::keep.tip(tree_for_unifrac, common_taxa)
  rowTree(tse_for_unifrac) <- tree_pruned

  # 使用 mia::getDissimilarity 计算 UniFrac
  cat("\n计算 Weighted UniFrac...\n")
  wunifrac_dist <- getDissimilarity(
    tse_for_unifrac,
    method = "unifrac",
    weighted = TRUE,
    assay.type = "counts"
  )
  cat("Weighted UniFrac 完成!\n")

  cat("计算 Unweighted UniFrac...\n")
  uwunifrac_dist <- getDissimilarity(
    tse_for_unifrac,
    method = "unifrac",
    weighted = FALSE,
    assay.type = "counts"
  )
  cat("Unweighted UniFrac 完成!\n")

  unifrac_success <- TRUE
  cat("\nUniFrac 计算成功!\n")

}, error = function(e) {
  cat("\nUniFrac 计算失败!\n")
  cat("错误信息:", conditionMessage(e), "\n")
  cat("\n调试信息:\n")
  cat("请检查树的边长是否已正确修复\n")
})

# 如果失败，创建占位变量
if (!unifrac_success) {
  p_pcoa_wunifrac <- NULL
  p_pcoa_uwunifrac <- NULL
  permanova_wunifrac <- data.frame(`Pr(>F)` = NA, check.names = FALSE)
  permanova_uwunifrac <- data.frame(`Pr(>F)` = NA, check.names = FALSE)
}
```

```{r}
#| label: singlem-beta-unifrac-viz
#| eval: !expr unifrac_success

# ==============================================================================
# Step 3: UniFrac PCoA 可视化
# ==============================================================================
cat("\n=== UniFrac PCoA 可视化 ===\n")

# Weighted UniFrac PCoA
pcoa_wuf <- cmdscale(wunifrac_dist, k = min(ncol(tse_singlem_corepair) - 1, 10), eig = TRUE)
reducedDim(tse_singlem_corepair, "PCoA_wUniFrac") <- pcoa_wuf$points

eig_wuf <- pcoa_wuf$eig
rel_eig_wuf <- eig_wuf / sum(eig_wuf[eig_wuf > 0])

p_pcoa_wunifrac <- plotReducedDim(tse_singlem_corepair, "PCoA_wUniFrac", colour_by = "treatment_group") +
  theme_bw() +
  labs(title = "SingleM: PCoA (Weighted UniFrac)",
       subtitle = "进化谱系加权距离 - 识别株系级遗传偏移",
       x = paste0("PCoA 1 (", round(100 * rel_eig_wuf[1], 1), "%)"),
       y = paste0("PCoA 2 (", round(100 * rel_eig_wuf[2], 1), "%)"))
p_pcoa_wunifrac

ggsave(here::here("data", params$name, "09_beta_pcoa_wunifrac_singlem.png"),
       p_pcoa_wunifrac, width = 8, height = 6, dpi = 300)

# Unweighted UniFrac PCoA
pcoa_uwuf <- cmdscale(uwunifrac_dist, k = min(ncol(tse_singlem_corepair) - 1, 10), eig = TRUE)
reducedDim(tse_singlem_corepair, "PCoA_uwUniFrac") <- pcoa_uwuf$points

eig_uwuf <- pcoa_uwuf$eig
rel_eig_uwuf <- eig_uwuf / sum(eig_uwuf[eig_uwuf > 0])

p_pcoa_uwunifrac <- plotReducedDim(tse_singlem_corepair, "PCoA_uwUniFrac", colour_by = "treatment_group") +
  theme_bw() +
  labs(title = "SingleM: PCoA (Unweighted UniFrac)",
       subtitle = "进化谱系存在/缺失距离 - 识别稀有株系差异",
       x = paste0("PCoA 1 (", round(100 * rel_eig_uwuf[1], 1), "%)"),
       y = paste0("PCoA 2 (", round(100 * rel_eig_uwuf[2], 1), "%)"))
p_pcoa_uwunifrac

ggsave(here::here("data", params$name, "10_beta_pcoa_uwunifrac_singlem.png"),
       p_pcoa_uwunifrac, width = 8, height = 6, dpi = 300)

# ==============================================================================
# Step 4: PERMANOVA 检验 (UniFrac)
# ==============================================================================
permanova_wunifrac <- vegan::adonis2(
  wunifrac_dist ~ treatment_group,
  data = data.frame(colData(tse_singlem_corepair)),
  permutations = 999
)

permanova_uwunifrac <- vegan::adonis2(
  uwunifrac_dist ~ treatment_group,
  data = data.frame(colData(tse_singlem_corepair)),
  permutations = 999
)

cat("\n=== PERMANOVA (Weighted UniFrac) ===\n")
print(permanova_wunifrac)
cat("\n=== PERMANOVA (Unweighted UniFrac) ===\n")
print(permanova_uwunifrac)

write.csv(as.data.frame(permanova_wunifrac),
          here::here("data", params$name, "11_permanova_wunifrac_singlem.csv"), row.names = TRUE)
write.csv(as.data.frame(permanova_uwunifrac),
          here::here("data", params$name, "12_permanova_uwunifrac_singlem.csv"), row.names = TRUE)
```

```{r}
#| label: singlem-beta-combined

# ==============================================================================
# Step 5: Beta 多样性结果汇总图
# ==============================================================================
if (unifrac_success && !is.null(p_pcoa_wunifrac)) {
  p_beta_combined <- (p_pcoa_bray | p_pcoa_wunifrac | p_pcoa_uwunifrac) +
    plot_annotation(
      title = "SingleM Beta Diversity: ApcMUT_HpWT vs ApcMUT_HpKO",
      subtitle = "Bray-Curtis (丰度) vs UniFrac (进化谱系) 距离比较"
    )

  ggsave(here::here("data", params$name, "13_beta_diversity_combined_singlem.png"),
         p_beta_combined, width = 18, height = 6, dpi = 300)
} else {
  # 仅显示 Bray-Curtis
  p_beta_combined <- p_pcoa_bray +
    plot_annotation(
      title = "SingleM Beta Diversity: ApcMUT_HpWT vs ApcMUT_HpKO",
      subtitle = "Bray-Curtis distance (UniFrac 计算失败)"
    )

  ggsave(here::here("data", params$name, "13_beta_diversity_combined_singlem.png"),
         p_beta_combined, width = 8, height = 6, dpi = 300)
}

p_beta_combined
```

## 6. 差异丰度分析 (DAA)

```{r}
#| label: singlem-daa

# ==============================================================================
# 使用 ANCOM-BC 进行差异丰度分析
# ==============================================================================
# 准备数据
tse_daa <- tse_singlem_corepair

# 运行 ANCOM-BC
ancombc_result <- ancombc2(
  data = tse_daa,
  assay_name = "counts",
  fix_formula = "treatment_group",
  p_adj_method = "BH",
  prv_cut = 0.1,
  lib_cut = 0,
  group = "treatment_group",
  struc_zero = TRUE,
  neg_lb = TRUE,
  alpha = 0.05,
  global = FALSE
)

# 提取结果
ancombc_res <- ancombc_result$res

# 查看结果结构和列名
cat("ANCOM-BC 结果列名:\n")
print(colnames(ancombc_res))

# 动态识别 lfc 和 q 值列名（适应不同的因子水平）
lfc_col <- grep("^lfc_treatment_group", colnames(ancombc_res), value = TRUE)[1]
q_col <- grep("^q_treatment_group", colnames(ancombc_res), value = TRUE)[1]

cat("使用的列名:\n")
cat("  LFC 列:", lfc_col, "\n")
cat("  Q 值列:", q_col, "\n")

# 添加分类信息
ancombc_res <- ancombc_res |>
  dplyr::left_join(
    rowData(tse_daa) |> as.data.frame() |> rownames_to_column("taxon"),
    by = "taxon"
  )

# 按 q 值排序并取 Top 20
ancombc_top20 <- ancombc_res |>
  arrange(.data[[q_col]]) |>
  head(20)

cat("\n=== ANCOM-BC Top 20 差异 OTU ===\n")
print(ancombc_top20 |> dplyr::select(taxon, Phylum, Family, all_of(c(lfc_col, q_col))))

# 保存结果
write.csv(
  ancombc_res,
  file = here::here("data", params$name, "14_daa_ancombc_singlem_full.csv"),
  row.names = FALSE
)

write.csv(
  ancombc_top20,
  file = here::here("data", params$name, "15_daa_ancombc_singlem_top20.csv"),
  row.names = FALSE
)

# ==============================================================================
# 火山图
# ==============================================================================
p_volcano <- ggplot(ancombc_res, aes(
  x = .data[[lfc_col]],
  y = -log10(.data[[q_col]])
)) +
  geom_point(aes(color = .data[[q_col]] < 0.05), alpha = 0.6) +
  scale_color_manual(values = c("grey50", "red"), labels = c("NS", "q < 0.05")) +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "blue") +
  theme_bw() +
  labs(
    title = "SingleM: Differential Abundance (ANCOM-BC)",
    subtitle = "ApcMUT_HpWT vs ApcMUT_HpKO",
    x = "Log2 Fold Change",
    y = "-log10(q-value)",
    color = "Significance"
  )
p_volcano

ggsave(
  filename = here::here("data", params$name, "16_volcano_daa_singlem.png"),
  plot = p_volcano, width = 10, height = 8, dpi = 300
)
```


# Part 2: Lyrebird 噬菌体分析

Lyrebird 是 SingleM 框架内专门用于分析 dsDNA 噬菌体（Caudoviricetes）的模块。

## 7. Lyrebird 数据导入与 TSE 构建

```{r}
#| label: lyrebird-data-import

# ==============================================================================
# Step 1: 定义数据路径
# ==============================================================================
lyrebird_data_path <- here::here(
  "data", "00-raw", "d03_singlem_diversity_analysis", "pc047-rst_lyrebird"
)

# ==============================================================================
# Step 2: 读取 OTU 丰度矩阵
# ==============================================================================
lyrebird_abundance <- read_tsv(
  file.path(lyrebird_data_path, "pc047-lyrebird_OTU_abundance.tsv"),
  show_col_types = FALSE
) |>
  column_to_rownames("otu_id") |>
  as.matrix()

# 将百分比转换为比例
lyrebird_abundance <- lyrebird_abundance / 100

cat("Lyrebird OTU 矩阵维度:", dim(lyrebird_abundance), "\n")

# ==============================================================================
# Step 3: 读取 OTU 分类信息
# ==============================================================================
lyrebird_taxonomy <- read_tsv(
  file.path(lyrebird_data_path, "pc047-lyrebird_OTU_taxonomy.tsv"),
  show_col_types = FALSE
) |>
  column_to_rownames("otu_id") |>
  DataFrame()

cat("Lyrebird 分类层级:", colnames(lyrebird_taxonomy), "\n")

# ==============================================================================
# Step 4: 读取系统发育树
# ==============================================================================
lyrebird_tree <- ape::read.tree(
  file.path(lyrebird_data_path, "pc047-lyrebird_OTU_tree.nwk")
)

cat("Lyrebird 系统发育树 tip 数:", length(lyrebird_tree$tip.label), "\n")

# ==============================================================================
# Step 5: 构建 TSE 对象
# ==============================================================================
common_otus_lyrebird <- intersect(rownames(lyrebird_abundance), rownames(lyrebird_taxonomy))
common_otus_lyrebird <- intersect(common_otus_lyrebird, lyrebird_tree$tip.label)

cat("Lyrebird 共同 OTU 数:", length(common_otus_lyrebird), "\n")

lyrebird_abundance <- lyrebird_abundance[common_otus_lyrebird, ]
lyrebird_taxonomy <- lyrebird_taxonomy[common_otus_lyrebird, ]
lyrebird_tree <- ape::keep.tip(lyrebird_tree, common_otus_lyrebird)

tse_lyrebird <- TreeSummarizedExperiment(
  assays = list(
    relabundance = lyrebird_abundance,
    counts = round(lyrebird_abundance * 10000)
  ),
  rowData = lyrebird_taxonomy,
  rowTree = lyrebird_tree
)

# 绑定元数据
common_samples_lyrebird <- intersect(colnames(tse_lyrebird), rownames(metadata))
tse_lyrebird <- tse_lyrebird[, common_samples_lyrebird]
colData(tse_lyrebird) <- DataFrame(metadata[common_samples_lyrebird, ])

# 创建 Caecum 子集
tse_lyrebird_ca <- tse_lyrebird[, tse_lyrebird$source_organ == "caecum"]

cat("Lyrebird Caecum 样本数:", ncol(tse_lyrebird_ca), "\n")

tse_lyrebird_ca
```

## 8. Lyrebird 数据清洗

```{r}
#| label: lyrebird-qc

# ==============================================================================
# 1. 移除异常样本 (与 SingleM 保持一致)
# ==============================================================================
if ("ca08" %in% colnames(tse_lyrebird_ca)) {
  tse_lyrebird_ca <- tse_lyrebird_ca[, colnames(tse_lyrebird_ca) != "ca08"]
}

# ==============================================================================
# 2. Prevalence 过滤
# ==============================================================================
tse_lyrebird_ca <- addPrevalence(
  tse_lyrebird_ca,
  assay.type = "relabundance",
  detection = 0,
  as.relative = FALSE
)

cat("Lyrebird 过滤前 OTU 数:", nrow(tse_lyrebird_ca), "\n")
tse_lyrebird_ca <- subsetByPrevalent(tse_lyrebird_ca, prevalence = 0.1)
cat("Lyrebird 过滤后 OTU 数:", nrow(tse_lyrebird_ca), "\n")

# 保存清洗后的数据
tse_lyrebird_ca_cleaned <- tse_lyrebird_ca
saveRDS(
  tse_lyrebird_ca_cleaned,
  file = here::here("data", params$name, "tse_lyrebird_ca_cleaned.rds")
)
```

## 9. Lyrebird 群落组成与多样性

```{r}
#| label: lyrebird-diversity
#| fig-width: 12
#| fig-height: 8

# ==============================================================================
# 1. 噬菌体组成图
# ==============================================================================
top_phages <- getTop(tse_lyrebird_ca_cleaned, top = 10, assay.type = "relabundance")

tse_lyrebird_plot <- tse_lyrebird_ca_cleaned
rowData(tse_lyrebird_plot)$Phage_Top10 <- ifelse(
  rownames(tse_lyrebird_plot) %in% top_phages,
  paste0(rownames(tse_lyrebird_plot), " (", rowData(tse_lyrebird_plot)$Family, ")"),
  "Other"
)

tse_lyrebird_plot_agg <- agglomerateByVariable(tse_lyrebird_plot, by = "rows", f = "Phage_Top10")

p_lyrebird_comp <- plotAbundance(
  tse_lyrebird_plot_agg,
  assay.type = "relabundance",
  order.row.by = "abund"
) +
  labs(
    title = "Lyrebird: Top 10 Phage OTU Composition (Caecum)",
    subtitle = "dsDNA Phage (Caudoviricetes) communities"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))

p_lyrebird_comp

ggsave(
  filename = here::here("data", params$name, "17_composition_top10_lyrebird.png"),
  plot = p_lyrebird_comp, width = 14, height = 8, dpi = 300
)

# ==============================================================================
# 2. Alpha 多样性
# ==============================================================================
tse_lyrebird_ca_cleaned <- addAlpha(
  tse_lyrebird_ca_cleaned,
  assay.type = "counts",
  index = c("shannon", "observed"),
  name = c("shannon_index", "observed_richness")
)

# 提取核心比较组
tse_lyrebird_corepair <- tse_lyrebird_ca_cleaned[
  , tse_lyrebird_ca_cleaned$treatment_group %in% c("ApcMUT_HpWT", "ApcMUT_HpKO")
]
tse_lyrebird_corepair$treatment_group <- factor(tse_lyrebird_corepair$treatment_group)

# Wilcoxon 检验
wilcox_lyrebird_shannon <- wilcox.test(
  shannon_index ~ treatment_group,
  data = colData(tse_lyrebird_corepair)
)
cat("\nLyrebird Shannon Wilcoxon P 值:", round(wilcox_lyrebird_shannon$p.value, 4), "\n")

# 可视化
p_lyrebird_shannon <- plot_alpha(tse_lyrebird_corepair, "shannon_index", "Lyrebird: Shannon Diversity")
p_lyrebird_observed <- plot_alpha(tse_lyrebird_corepair, "observed_richness", "Lyrebird: Observed Phage OTUs")

p_lyrebird_alpha <- p_lyrebird_shannon + p_lyrebird_observed +
  plot_annotation(title = "Lyrebird (Phage) Alpha Diversity")
p_lyrebird_alpha

ggsave(
  filename = here::here("data", params$name, "18_alpha_diversity_lyrebird.png"),
  plot = p_lyrebird_alpha, width = 12, height = 6, dpi = 300
)

# ==============================================================================
# 3. Beta 多样性 (Bray-Curtis)
# ==============================================================================
tse_lyrebird_corepair <- runMDS(
  tse_lyrebird_corepair,
  FUN = vegan::vegdist,
  method = "bray",
  assay.type = "relabundance",
  name = "PCoA_Bray"
)

eig_lyrebird_bray <- attr(reducedDim(tse_lyrebird_corepair, "PCoA_Bray"), "eig")
rel_eig_lyrebird_bray <- eig_lyrebird_bray / sum(eig_lyrebird_bray[eig_lyrebird_bray > 0])

p_lyrebird_pcoa <- plotReducedDim(
  tse_lyrebird_corepair,
  "PCoA_Bray",
  colour_by = "treatment_group"
) +
  theme_bw() +
  labs(
    title = "Lyrebird: PCoA (Bray-Curtis)",
    subtitle = "Phage community structure",
    x = paste0("PCoA 1 (", round(100 * rel_eig_lyrebird_bray[1], 1), "%)"),
    y = paste0("PCoA 2 (", round(100 * rel_eig_lyrebird_bray[2], 1), "%)")
  )
p_lyrebird_pcoa

ggsave(
  filename = here::here("data", params$name, "19_beta_pcoa_bray_lyrebird.png"),
  plot = p_lyrebird_pcoa, width = 8, height = 6, dpi = 300
)

# PERMANOVA
permanova_lyrebird <- getPERMANOVA(
  tse_lyrebird_corepair,
  assay.type = "relabundance",
  formula = x ~ treatment_group
)

cat("\n=== Lyrebird PERMANOVA (Bray-Curtis) ===\n")
print(permanova_lyrebird$permanova)

write.csv(
  permanova_lyrebird$permanova,
  file = here::here("data", params$name, "20_permanova_bray_lyrebird.csv"),
  row.names = TRUE
)
```

## 10. Lyrebird UniFrac 分析

借鉴 Part 1 的经验，Lyrebird 的系统发育树也可能存在边长问题，需要先诊断和修复。

```{r}
#| label: lyrebird-unifrac-diagnose

# ==============================================================================
# Step 1: 诊断 Lyrebird 树和 OTU 矩阵的匹配情况
# ==============================================================================
cat("=== Lyrebird UniFrac 计算前诊断 ===\n\n")

# 获取树和 OTU 信息
tree_lyrebird <- rowTree(tse_lyrebird_corepair)
otu_names_lyrebird <- rownames(tse_lyrebird_corepair)
tree_tips_lyrebird <- tree_lyrebird$tip.label

cat("OTU 矩阵中的 OTU 数量:", length(otu_names_lyrebird), "\n")
cat("系统发育树的 tip 数量:", length(tree_tips_lyrebird), "\n")

# 检查匹配情况
in_both_lyrebird <- intersect(otu_names_lyrebird, tree_tips_lyrebird)
cat("两者共有的 OTU:", length(in_both_lyrebird), "\n")

# 检查树结构
cat("\n树结构检查:\n")
cat("  - 是否为二叉树:", ape::is.binary(tree_lyrebird), "\n")
cat("  - 是否有根:", ape::is.rooted(tree_lyrebird), "\n")

# 检查边长
if (!is.null(tree_lyrebird$edge.length) && length(tree_lyrebird$edge.length) > 0) {
  valid_edges_lyrebird <- tree_lyrebird$edge.length[is.finite(tree_lyrebird$edge.length)]
  if (length(valid_edges_lyrebird) > 0) {
    cat("  - 有效边长范围:", range(valid_edges_lyrebird), "\n")
  } else {
    cat("  - 有效边长范围: 无有效边长!\n")
  }
  cat("  - 总边数:", length(tree_lyrebird$edge.length), "\n")
  cat("  - NA 边长数量:", sum(is.na(tree_lyrebird$edge.length)), "\n")
  cat("  - Inf 边长数量:", sum(is.infinite(tree_lyrebird$edge.length)), "\n")
  cat("  - 负数边长数量:", sum(tree_lyrebird$edge.length < 0, na.rm = TRUE), "\n")
} else {
  cat("  - 边长信息: 树没有边长信息!\n")
}
```

```{r}
#| label: lyrebird-unifrac-fix-tree

# ==============================================================================
# Step 2: 修复 Lyrebird 树的边长问题
# ==============================================================================
cat("\n=== 修复 Lyrebird 树的边长 ===\n")

tree_lyrebird_original <- rowTree(tse_lyrebird_corepair)
tree_lyrebird_fixed <- tree_lyrebird_original

if (is.null(tree_lyrebird_fixed$edge.length) || length(tree_lyrebird_fixed$edge.length) == 0) {
  cat("树没有边长信息，创建默认边长...\n")
  tree_lyrebird_fixed$edge.length <- rep(1, nrow(tree_lyrebird_fixed$edge))
} else {
  # 统计问题边长
  n_na <- sum(is.na(tree_lyrebird_fixed$edge.length))
  n_inf <- sum(is.infinite(tree_lyrebird_fixed$edge.length))
  n_neg <- sum(tree_lyrebird_fixed$edge.length < 0, na.rm = TRUE)
  n_zero <- sum(tree_lyrebird_fixed$edge.length == 0, na.rm = TRUE)

  cat("发现问题边长:\n")
  cat("  - NA:", n_na, "\n")
  cat("  - Inf:", n_inf, "\n")
  cat("  - 负数:", n_neg, "\n")
  cat("  - 零:", n_zero, "\n")

  # 修复异常值
  small_value <- 1e-6
  tree_lyrebird_fixed$edge.length[is.na(tree_lyrebird_fixed$edge.length)] <- small_value
  tree_lyrebird_fixed$edge.length[is.infinite(tree_lyrebird_fixed$edge.length)] <- small_value
  tree_lyrebird_fixed$edge.length[tree_lyrebird_fixed$edge.length < 0] <- small_value
  tree_lyrebird_fixed$edge.length[tree_lyrebird_fixed$edge.length == 0] <- small_value

  cat("\n修复后边长范围:", range(tree_lyrebird_fixed$edge.length), "\n")
}

rowTree(tse_lyrebird_corepair) <- tree_lyrebird_fixed
cat("Lyrebird 树修复完成!\n")
```

```{r}
#| label: lyrebird-unifrac-compute

# ==============================================================================
# Step 3: 使用 mia 计算 Lyrebird UniFrac
# ==============================================================================
cat("\n=== 使用 mia 计算 Lyrebird UniFrac 距离 ===\n")

lyrebird_unifrac_success <- FALSE

tryCatch({
  tree_for_unifrac_lyrebird <- rowTree(tse_lyrebird_corepair)
  common_taxa_lyrebird <- intersect(rownames(tse_lyrebird_corepair), tree_for_unifrac_lyrebird$tip.label)
  cat("使用", length(common_taxa_lyrebird), "个共同 OTU 进行 UniFrac 计算\n")

  tse_for_unifrac_lyrebird <- tse_lyrebird_corepair[common_taxa_lyrebird, ]
  tree_pruned_lyrebird <- ape::keep.tip(tree_for_unifrac_lyrebird, common_taxa_lyrebird)
  rowTree(tse_for_unifrac_lyrebird) <- tree_pruned_lyrebird

  cat("\n计算 Weighted UniFrac...\n")
  wunifrac_dist_lyrebird <- getDissimilarity(
    tse_for_unifrac_lyrebird,
    method = "unifrac",
    weighted = TRUE,
    assay.type = "counts"
  )
  cat("Weighted UniFrac 完成!\n")

  cat("计算 Unweighted UniFrac...\n")
  uwunifrac_dist_lyrebird <- getDissimilarity(
    tse_for_unifrac_lyrebird,
    method = "unifrac",
    weighted = FALSE,
    assay.type = "counts"
  )
  cat("Unweighted UniFrac 完成!\n")

  lyrebird_unifrac_success <- TRUE
  cat("\nLyrebird UniFrac 计算成功!\n")

}, error = function(e) {
  cat("\nLyrebird UniFrac 计算失败!\n")
  cat("错误信息:", conditionMessage(e), "\n")
})

if (!lyrebird_unifrac_success) {
  p_pcoa_wunifrac_lyrebird <- NULL
  p_pcoa_uwunifrac_lyrebird <- NULL
  permanova_wunifrac_lyrebird <- data.frame(`Pr(>F)` = NA, check.names = FALSE)
  permanova_uwunifrac_lyrebird <- data.frame(`Pr(>F)` = NA, check.names = FALSE)
}
```

```{r}
#| label: lyrebird-unifrac-viz
#| eval: !expr lyrebird_unifrac_success
#| fig-width: 14
#| fig-height: 6

# ==============================================================================
# Step 4: Lyrebird UniFrac PCoA 可视化
# ==============================================================================

# Weighted UniFrac PCoA
pcoa_wunifrac_lyrebird <- cmdscale(wunifrac_dist_lyrebird, eig = TRUE, k = 2)
eig_wunifrac_lyrebird <- pcoa_wunifrac_lyrebird$eig
rel_eig_wunifrac_lyrebird <- eig_wunifrac_lyrebird / sum(eig_wunifrac_lyrebird[eig_wunifrac_lyrebird > 0])

pcoa_df_wunifrac_lyrebird <- data.frame(
  PCoA1 = pcoa_wunifrac_lyrebird$points[, 1],
  PCoA2 = pcoa_wunifrac_lyrebird$points[, 2],
  treatment_group = colData(tse_lyrebird_corepair)$treatment_group
)

p_pcoa_wunifrac_lyrebird <- ggplot(pcoa_df_wunifrac_lyrebird, aes(x = PCoA1, y = PCoA2, color = treatment_group)) +
  geom_point(size = 3) +
  theme_bw() +
  labs(
    title = "Lyrebird: PCoA (Weighted UniFrac)",
    x = paste0("PCoA 1 (", round(100 * rel_eig_wunifrac_lyrebird[1], 1), "%)"),
    y = paste0("PCoA 2 (", round(100 * rel_eig_wunifrac_lyrebird[2], 1), "%)")
  )

# Unweighted UniFrac PCoA
pcoa_uwunifrac_lyrebird <- cmdscale(uwunifrac_dist_lyrebird, eig = TRUE, k = 2)
eig_uwunifrac_lyrebird <- pcoa_uwunifrac_lyrebird$eig
rel_eig_uwunifrac_lyrebird <- eig_uwunifrac_lyrebird / sum(eig_uwunifrac_lyrebird[eig_uwunifrac_lyrebird > 0])

pcoa_df_uwunifrac_lyrebird <- data.frame(
  PCoA1 = pcoa_uwunifrac_lyrebird$points[, 1],
  PCoA2 = pcoa_uwunifrac_lyrebird$points[, 2],
  treatment_group = colData(tse_lyrebird_corepair)$treatment_group
)

p_pcoa_uwunifrac_lyrebird <- ggplot(pcoa_df_uwunifrac_lyrebird, aes(x = PCoA1, y = PCoA2, color = treatment_group)) +
  geom_point(size = 3) +
  theme_bw() +
  labs(
    title = "Lyrebird: PCoA (Unweighted UniFrac)",
    x = paste0("PCoA 1 (", round(100 * rel_eig_uwunifrac_lyrebird[1], 1), "%)"),
    y = paste0("PCoA 2 (", round(100 * rel_eig_uwunifrac_lyrebird[2], 1), "%)")
  )

# 组合图
p_lyrebird_unifrac_combined <- p_pcoa_wunifrac_lyrebird + p_pcoa_uwunifrac_lyrebird +
  plot_annotation(title = "Lyrebird (Phage) UniFrac Beta Diversity")
p_lyrebird_unifrac_combined

ggsave(
  filename = here::here("data", params$name, "21_beta_pcoa_unifrac_lyrebird.png"),
  plot = p_lyrebird_unifrac_combined, width = 14, height = 6, dpi = 300
)

# PERMANOVA
cat("\n=== Lyrebird PERMANOVA (Weighted UniFrac) ===\n")
permanova_wunifrac_lyrebird <- vegan::adonis2(
  wunifrac_dist_lyrebird ~ treatment_group,
  data = as.data.frame(colData(tse_lyrebird_corepair)),
  permutations = 999
)
print(permanova_wunifrac_lyrebird)

cat("\n=== Lyrebird PERMANOVA (Unweighted UniFrac) ===\n")
permanova_uwunifrac_lyrebird <- vegan::adonis2(
  uwunifrac_dist_lyrebird ~ treatment_group,
  data = as.data.frame(colData(tse_lyrebird_corepair)),
  permutations = 999
)
print(permanova_uwunifrac_lyrebird)

write.csv(
  permanova_wunifrac_lyrebird,
  file = here::here("data", params$name, "22_permanova_wunifrac_lyrebird.csv"),
  row.names = TRUE
)
write.csv(
  permanova_uwunifrac_lyrebird,
  file = here::here("data", params$name, "23_permanova_uwunifrac_lyrebird.csv"),
  row.names = TRUE
)
```

## 11. Lyrebird 差异丰度分析 (ANCOM-BC)

识别在 CagA 野生型 vs CagA 敲除组之间差异丰富的噬菌体 OTU。

```{r}
#| label: lyrebird-ancombc

# ==============================================================================
# ANCOM-BC2 差异丰度分析
# ==============================================================================
cat("=== Lyrebird ANCOM-BC2 差异丰度分析 ===\n")

# 准备数据：需要 counts assay
tse_daa_lyrebird <- tse_lyrebird_corepair

# 运行 ANCOM-BC2
ancombc_output_lyrebird <- ancombc2(
  data = tse_daa_lyrebird,
  assay.type = "counts",
  fix_formula = "treatment_group",
  p_adj_method = "fdr",
  prv_cut = 0.1,
  lib_cut = 0,
  group = "treatment_group",
  struc_zero = TRUE,
  neg_lb = TRUE,
  alpha = 0.05,
  global = FALSE,
  verbose = TRUE
)

# 提取结果
ancombc_res_lyrebird <- ancombc_output_lyrebird$res

# 动态查找列名
lfc_col_lyrebird <- grep("^lfc_", colnames(ancombc_res_lyrebird), value = TRUE)[1]
q_col_lyrebird <- grep("^q_", colnames(ancombc_res_lyrebird), value = TRUE)[1]

cat("使用的列名:\n")
cat("  LFC 列:", lfc_col_lyrebird, "\n")
cat("  Q 值列:", q_col_lyrebird, "\n")

# 添加分类信息
ancombc_res_lyrebird <- ancombc_res_lyrebird |>
  dplyr::left_join(
    rowData(tse_daa_lyrebird) |> as.data.frame() |> rownames_to_column("taxon"),
    by = "taxon"
  )

# 按 q 值排序并取 Top 20
ancombc_top20_lyrebird <- ancombc_res_lyrebird |>
  arrange(.data[[q_col_lyrebird]]) |>
  head(20)

cat("\n=== Lyrebird ANCOM-BC Top 20 差异噬菌体 OTU ===\n")
print(ancombc_top20_lyrebird |> dplyr::select(taxon, Family, all_of(c(lfc_col_lyrebird, q_col_lyrebird))))

# 保存完整结果
write.csv(
  ancombc_res_lyrebird,
  file = here::here("data", params$name, "24_ancombc_lyrebird_full.csv"),
  row.names = FALSE
)
```

```{r}
#| label: lyrebird-ancombc-volcano
#| fig-width: 10
#| fig-height: 8

# ==============================================================================
# 火山图可视化
# ==============================================================================

# 准备火山图数据
volcano_data_lyrebird <- ancombc_res_lyrebird |>
  mutate(
    sig = .data[[q_col_lyrebird]] < 0.05,
    direction = case_when(
      .data[[q_col_lyrebird]] < 0.05 & .data[[lfc_col_lyrebird]] > 0 ~ "Up in HpWT",
      .data[[q_col_lyrebird]] < 0.05 & .data[[lfc_col_lyrebird]] < 0 ~ "Up in HpKO",
      TRUE ~ "NS"
    )
  )

# 统计差异 OTU 数量
n_sig_up_lyrebird <- sum(volcano_data_lyrebird$direction == "Up in HpWT", na.rm = TRUE)
n_sig_down_lyrebird <- sum(volcano_data_lyrebird$direction == "Up in HpKO", na.rm = TRUE)
cat("\n差异噬菌体 OTU 统计:\n")
cat("  Up in HpWT (CagA+):", n_sig_up_lyrebird, "\n")
cat("  Up in HpKO (CagA-):", n_sig_down_lyrebird, "\n")

p_volcano_lyrebird <- ggplot(volcano_data_lyrebird, aes(x = .data[[lfc_col_lyrebird]], y = -log10(.data[[q_col_lyrebird]]))) +
  geom_point(aes(color = direction), alpha = 0.6, size = 2) +
  scale_color_manual(values = c("Up in HpWT" = "#E41A1C", "Up in HpKO" = "#377EB8", "NS" = "grey60")) +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "grey40") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey40") +
  theme_bw() +
  labs(
    title = "Lyrebird: Differential Phage Abundance (ANCOM-BC2)",
    subtitle = paste0("Up in HpWT: ", n_sig_up_lyrebird, " | Up in HpKO: ", n_sig_down_lyrebird),
    x = "Log Fold Change (HpWT vs HpKO)",
    y = "-log10(Q-value)",
    color = "Direction"
  )

p_volcano_lyrebird

ggsave(
  filename = here::here("data", params$name, "25_volcano_ancombc_lyrebird.png"),
  plot = p_volcano_lyrebird, width = 10, height = 8, dpi = 300
)
```

# Part 3: 结果汇总

## 12. 完整结果汇总表

```{r}
#| label: summary-comparison

# ==============================================================================
# 创建完整结果汇总表（SingleM + Lyrebird + Bracken）
# ==============================================================================

# 安全提取 P 值的辅助函数
get_unifrac_p <- function(permanova_result) {
  if (is.null(permanova_result) || is.na(permanova_result$`Pr(>F)`[1])) {
    return(NA)
  }
  return(round(permanova_result$`Pr(>F)`[1], 4))
}

get_lyrebird_unifrac_p <- function(permanova_result) {
  tryCatch({
    if (is.null(permanova_result)) return(NA)
    return(round(permanova_result$`Pr(>F)`[1], 4))
  }, error = function(e) NA)
}

# 完整结果汇总表
summary_table <- data.frame(
  Analysis = c(
    "Alpha: Shannon (Wilcoxon)",
    "Alpha: Observed (Wilcoxon)",
    "Beta: Bray-Curtis (PERMANOVA)",
    "Beta: Weighted UniFrac (PERMANOVA)",
    "Beta: Unweighted UniFrac (PERMANOVA)"
  ),
  SingleM = c(
    round(wilcox_shannon$p.value, 4),
    round(wilcox_observed$p.value, 4),
    round(permanova_bray$permanova$`Pr(>F)`[1], 4),
    get_unifrac_p(permanova_wunifrac),
    get_unifrac_p(permanova_uwunifrac)
  ),
  Lyrebird = c(
    round(wilcox_lyrebird_shannon$p.value, 4),
    NA,  # Lyrebird 没有单独计算 Observed 的 Wilcoxon
    round(permanova_lyrebird$permanova$`Pr(>F)`[1], 4),
    get_lyrebird_unifrac_p(permanova_wunifrac_lyrebird),
    get_lyrebird_unifrac_p(permanova_uwunifrac_lyrebird)
  ),
  Bracken = c(
    0.73,
    0.29,
    0.012,
    NA,
    NA
  )
)

cat("\n=== 完整结果汇总 (P 值) ===\n")
cat("比较组: ApcMUT_HpWT vs ApcMUT_HpKO\n\n")
print(summary_table)

# 添加显著性标记
summary_table_sig <- summary_table |>
  mutate(
    SingleM_sig = case_when(
      SingleM < 0.001 ~ "***",
      SingleM < 0.01 ~ "**",
      SingleM < 0.05 ~ "*",
      TRUE ~ ""
    ),
    Lyrebird_sig = case_when(
      Lyrebird < 0.001 ~ "***",
      Lyrebird < 0.01 ~ "**",
      Lyrebird < 0.05 ~ "*",
      is.na(Lyrebird) ~ "-",
      TRUE ~ ""
    ),
    Bracken_sig = case_when(
      Bracken < 0.001 ~ "***",
      Bracken < 0.01 ~ "**",
      Bracken < 0.05 ~ "*",
      is.na(Bracken) ~ "-",
      TRUE ~ ""
    )
  )

write.csv(
  summary_table,
  file = here::here("data", params$name, "26_full_results_comparison.csv"),
  row.names = FALSE
)
```

## 13. 结果可视化总结

```{r}
#| label: summary-visualization
#| fig-width: 12
#| fig-height: 8

# ==============================================================================
# P 值热图
# ==============================================================================

# 准备热图数据
heatmap_data <- summary_table |>
  pivot_longer(cols = c(SingleM, Lyrebird, Bracken),
               names_to = "Method", values_to = "P_value") |>
  mutate(
    neg_log_p = -log10(P_value),
    neg_log_p = ifelse(is.infinite(neg_log_p), 4, neg_log_p),  # 处理极小 P 值
    sig_label = case_when(
      is.na(P_value) ~ "NA",
      P_value < 0.001 ~ "***",
      P_value < 0.01 ~ "**",
      P_value < 0.05 ~ "*",
      TRUE ~ "ns"
    ),
    Method = factor(Method, levels = c("SingleM", "Lyrebird", "Bracken"))
  )

p_heatmap <- ggplot(heatmap_data, aes(x = Method, y = Analysis, fill = neg_log_p)) +
  geom_tile(color = "white", linewidth = 0.5) +
  geom_text(aes(label = sig_label), size = 5) +
  scale_fill_gradient2(
    low = "white", mid = "lightyellow", high = "red",
    midpoint = 1.3,  # -log10(0.05) ≈ 1.3
    na.value = "grey90",
    name = "-log10(P)"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 12, face = "bold"),
    axis.text.y = element_text(size = 10),
    panel.grid = element_blank()
  ) +
  labs(
    title = "Statistical Significance Heatmap",
    subtitle = "ApcMUT_HpWT vs ApcMUT_HpKO | *P<0.05, **P<0.01, ***P<0.001",
    x = "", y = ""
  )

# ==============================================================================
# P 值条形图
# ==============================================================================

bar_data <- summary_table |>
  pivot_longer(cols = c(SingleM, Lyrebird, Bracken),
               names_to = "Method", values_to = "P_value") |>
  filter(!is.na(P_value)) |>
  mutate(
    neg_log_p = -log10(P_value),
    Method = factor(Method, levels = c("SingleM", "Lyrebird", "Bracken")),
    sig = P_value < 0.05
  )

p_barplot <- ggplot(bar_data, aes(x = Analysis, y = neg_log_p, fill = Method)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.7) +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "red", linewidth = 0.8) +
  annotate("text", x = 0.5, y = -log10(0.05) + 0.15, label = "P=0.05", color = "red", hjust = 0, size = 3) +
  scale_fill_brewer(palette = "Set2") +
  coord_flip() +
  theme_bw() +
  labs(
    title = "Statistical Significance by Method",
    subtitle = "Higher bars = more significant (bars above red line: P < 0.05)",
    x = "", y = "-log10(P-value)"
  )

# 组合图
p_summary_combined <- p_heatmap + p_barplot +
  plot_layout(widths = c(1, 1.2)) +
  plot_annotation(
    title = "Part 3: Results Summary",
    theme = theme(plot.title = element_text(size = 16, face = "bold"))
  )

p_summary_combined

ggsave(
  filename = here::here("data", params$name, "27_results_summary_visualization.png"),
  plot = p_summary_combined, width = 14, height = 8, dpi = 300
)
```

## 14. Host-Virus 关联分析

探索细菌（SingleM）和噬菌体（Lyrebird）群落之间的关联，这是 SingleM/Lyrebird 框架的独特优势。

```{r}
#| label: host-virus-correlation
#| fig-width: 12
#| fig-height: 10

# ==============================================================================
# 1. 样本级别的多样性关联
# ==============================================================================
cat("=== Host-Virus 关联分析 ===\n\n")

# 获取共同样本
common_samples_hv <- intersect(
  colnames(tse_singlem_corepair),
  colnames(tse_lyrebird_corepair)
)
cat("共同样本数:", length(common_samples_hv), "\n")

# 提取 Alpha 多样性数据
diversity_data <- data.frame(
  sample = common_samples_hv,
  bacteria_shannon = colData(tse_singlem_corepair)[common_samples_hv, "shannon_index"],
  phage_shannon = colData(tse_lyrebird_corepair)[common_samples_hv, "shannon_index"],
  treatment_group = colData(tse_singlem_corepair)[common_samples_hv, "treatment_group"]
)

# Spearman 相关性
cor_test <- cor.test(
  diversity_data$bacteria_shannon,
  diversity_data$phage_shannon,
  method = "spearman"
)

cat("\n细菌-噬菌体 Shannon 多样性相关性:\n")
cat("  Spearman rho:", round(cor_test$estimate, 3), "\n")
cat("  P-value:", round(cor_test$p.value, 4), "\n")

# 可视化
p_diversity_cor <- ggplot(diversity_data, aes(x = bacteria_shannon, y = phage_shannon)) +
  geom_point(aes(color = treatment_group), size = 3) +
  geom_smooth(method = "lm", se = TRUE, color = "grey40", linetype = "dashed") +
  theme_bw() +
  labs(
    title = "Host-Virus Alpha Diversity Correlation",
    subtitle = paste0("Spearman ρ = ", round(cor_test$estimate, 3),
                     ", P = ", round(cor_test$p.value, 4)),
    x = "Bacteria Shannon Diversity (SingleM)",
    y = "Phage Shannon Diversity (Lyrebird)",
    color = "Treatment"
  )

# ==============================================================================
# 2. Procrustes 分析：Beta 多样性关联
# ==============================================================================
cat("\n\n=== Procrustes 分析 (Beta 多样性关联) ===\n")

# 获取 Bray-Curtis 距离矩阵
bacteria_dist <- vegan::vegdist(
  t(assay(tse_singlem_corepair[, common_samples_hv], "relabundance")),
  method = "bray"
)
phage_dist <- vegan::vegdist(
  t(assay(tse_lyrebird_corepair[, common_samples_hv], "relabundance")),
  method = "bray"
)

# PCoA
bacteria_pcoa <- cmdscale(bacteria_dist, k = 2)
phage_pcoa <- cmdscale(phage_dist, k = 2)

# Procrustes 分析
procrustes_result <- vegan::protest(bacteria_pcoa, phage_pcoa, permutations = 999)

cat("Procrustes 相关性 (m²):", round(procrustes_result$ss, 4), "\n")
cat("相关系数:", round(sqrt(1 - procrustes_result$ss), 4), "\n")
cat("P-value:", round(procrustes_result$signif, 4), "\n")

# Procrustes 可视化
procrustes_df <- data.frame(
  X1_bacteria = bacteria_pcoa[, 1],
  Y1_bacteria = bacteria_pcoa[, 2],
  X2_phage = procrustes_result$Yrot[, 1],
  Y2_phage = procrustes_result$Yrot[, 2],
  sample = common_samples_hv,
  treatment = diversity_data$treatment_group
)

p_procrustes <- ggplot(procrustes_df) +
  geom_segment(aes(x = X1_bacteria, y = Y1_bacteria,
                   xend = X2_phage, yend = Y2_phage),
               color = "grey60", alpha = 0.6) +
  geom_point(aes(x = X1_bacteria, y = Y1_bacteria, color = treatment),
             size = 3, shape = 16) +
  geom_point(aes(x = X2_phage, y = Y2_phage, color = treatment),
             size = 3, shape = 17) +
  theme_bw() +
  labs(
    title = "Procrustes Analysis: Bacteria vs Phage Communities",
    subtitle = paste0("Correlation = ", round(sqrt(1 - procrustes_result$ss), 3),
                     ", P = ", round(procrustes_result$signif, 4),
                     " | ● Bacteria, ▲ Phage"),
    x = "PCoA 1", y = "PCoA 2",
    color = "Treatment"
  )

# ==============================================================================
# 3. Mantel 检验：距离矩阵相关性
# ==============================================================================
cat("\n\n=== Mantel 检验 ===\n")

mantel_result <- vegan::mantel(bacteria_dist, phage_dist, method = "spearman", permutations = 999)

cat("Mantel 统计量 (r):", round(mantel_result$statistic, 4), "\n")
cat("P-value:", round(mantel_result$signif, 4), "\n")

# ==============================================================================
# 组合图
# ==============================================================================
p_host_virus <- p_diversity_cor + p_procrustes +
  plot_annotation(
    title = "Host-Virus (Bacteria-Phage) Community Associations",
    subtitle = paste0("Mantel test: r = ", round(mantel_result$statistic, 3),
                     ", P = ", round(mantel_result$signif, 4)),
    theme = theme(plot.title = element_text(size = 14, face = "bold"))
  )

p_host_virus

ggsave(
  filename = here::here("data", params$name, "28_host_virus_association.png"),
  plot = p_host_virus, width = 14, height = 6, dpi = 300
)

# 保存关联分析结果
host_virus_summary <- data.frame(
  Analysis = c("Alpha Diversity Correlation", "Procrustes Analysis", "Mantel Test"),
  Statistic = c(
    paste0("Spearman ρ = ", round(cor_test$estimate, 3)),
    paste0("Correlation = ", round(sqrt(1 - procrustes_result$ss), 3)),
    paste0("Mantel r = ", round(mantel_result$statistic, 3))
  ),
  P_value = c(
    round(cor_test$p.value, 4),
    round(procrustes_result$signif, 4),
    round(mantel_result$signif, 4)
  )
)

cat("\n\n=== Host-Virus 关联分析汇总 ===\n")
print(host_virus_summary)

write.csv(
  host_virus_summary,
  file = here::here("data", params$name, "29_host_virus_association_summary.csv"),
  row.names = FALSE
)
```

## 15. 分析小结

```{r}
#| label: analysis-summary
#| results: asis

# 构建 SingleM UniFrac 结果文本
unifrac_text <- if (unifrac_success) {
  paste0(
    "3. **Beta 多样性 (Weighted UniFrac)**: PERMANOVA P=", get_unifrac_p(permanova_wunifrac), "\n",
    "4. **Beta 多样性 (Unweighted UniFrac)**: PERMANOVA P=", get_unifrac_p(permanova_uwunifrac)
  )
} else {
  "3. **Beta 多样性 (UniFrac)**: 计算未成功"
}

# 构建 Lyrebird UniFrac 结果文本
lyrebird_unifrac_text <- if (lyrebird_unifrac_success) {
  paste0(
    "3. **Beta 多样性 (Weighted UniFrac)**: PERMANOVA P=", round(permanova_wunifrac_lyrebird$`Pr(>F)`[1], 4), "\n",
    "4. **Beta 多样性 (Unweighted UniFrac)**: PERMANOVA P=", round(permanova_uwunifrac_lyrebird$`Pr(>F)`[1], 4)
  )
} else {
  "3. **Beta 多样性 (UniFrac)**: 计算未成功"
}

cat("
## SingleM/Lyrebird 分析小结

### Part 1: SingleM 细菌/古菌分析

**数据概况**:
- 清洗后 OTU 数: ", nrow(tse_singlem_ca_cleaned), "
- 样本数: ", ncol(tse_singlem_ca_cleaned), "
- 核心比较组: ApcMUT_HpWT (n=", sum(tse_singlem_corepair$treatment_group == 'ApcMUT_HpWT'), ") vs ApcMUT_HpKO (n=", sum(tse_singlem_corepair$treatment_group == 'ApcMUT_HpKO'), ")

**关键发现**:
1. **Alpha 多样性**: Shannon P=", round(wilcox_shannon$p.value, 4), ", Observed P=", round(wilcox_observed$p.value, 4), "
2. **Beta 多样性 (Bray-Curtis)**: PERMANOVA P=", round(permanova_bray$permanova$`Pr(>F)`[1], 4), "
", unifrac_text, "
5. **差异丰度 (ANCOM-BC2)**: 见火山图

### Part 2: Lyrebird 噬菌体分析

**数据概况**:
- 清洗后噬菌体 OTU 数: ", nrow(tse_lyrebird_ca_cleaned), "
- 样本数: ", ncol(tse_lyrebird_ca_cleaned), "
- 核心比较组样本数: ", ncol(tse_lyrebird_corepair), "

**关键发现**:
1. **Alpha 多样性**: Shannon P=", round(wilcox_lyrebird_shannon$p.value, 4), "
2. **Beta 多样性 (Bray-Curtis)**: PERMANOVA P=", round(permanova_lyrebird$permanova$`Pr(>F)`[1], 4), "
", lyrebird_unifrac_text, "
5. **差异丰度 (ANCOM-BC2)**: Up in HpWT=", n_sig_up_lyrebird, ", Up in HpKO=", n_sig_down_lyrebird, "

### Part 3: Host-Virus 关联分析

**核心发现**:
1. **Alpha 多样性关联**: 细菌与噬菌体 Shannon 多样性 Spearman ρ=", round(cor_test$estimate, 3), ", P=", round(cor_test$p.value, 4), "
2. **Beta 多样性关联 (Procrustes)**: 相关系数=", round(sqrt(1 - procrustes_result$ss), 3), ", P=", round(procrustes_result$signif, 4), "
3. **Mantel 检验**: r=", round(mantel_result$statistic, 3), ", P=", round(mantel_result$signif, 4), "

### SingleM/Lyrebird 相比 Bracken 的优势

1. **UniFrac 距离**: 提供系统发育树，可计算考虑进化关系的 UniFrac 距离
2. **新物种检测**: 基于标记基因 HMM，能检测数据库中未收录的物种
3. **OTU 分辨率**: 更细粒度的群落结构分析
4. **噬菌体分析**: Lyrebird 专门针对 dsDNA 噬菌体，Bracken 无此功能
5. **Host-Virus 关联**: 可同时分析细菌和噬菌体，探索宿主-病毒互作
")
```

```{r}
#| label: save-rds-for-downstream

# ==============================================================================
# 保存关键数据供下游分析（如 03b_virome_function_integration）使用
# ==============================================================================

cat("=== 保存数据供下游分析 ===\n\n")

# 保存 Lyrebird 噬菌体 TSE 对象（核心比较组）
saveRDS(
  tse_lyrebird_corepair,
  file = here::here("data", params$name, "tse_lyrebird_corepair.rds")
)
cat("已保存: tse_lyrebird_corepair.rds\n")
cat("  - 样本数:", ncol(tse_lyrebird_corepair), "\n")
cat("  - 噬菌体 OTU 数:", nrow(tse_lyrebird_corepair), "\n")

# 保存 SingleM 细菌 TSE 对象（核心比较组）
saveRDS(
  tse_singlem_corepair,
  file = here::here("data", params$name, "tse_singlem_corepair.rds")
)
cat("\n已保存: tse_singlem_corepair.rds\n")
cat("  - 样本数:", ncol(tse_singlem_corepair), "\n")
cat("  - 细菌 OTU 数:", nrow(tse_singlem_corepair), "\n")
```

---

## Files written

These files have been written to the target directory, `r paste0("data/", params$name)`:

```{r}
#| label: list-files-target
#| include: false
projthis::proj_dir_info(path_target(), tz = "CET")
```
