{
  "hash": "a8f1cad64356a8bf33ee6c26070d327d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Part 4: Network Analysis\"\nsubtitle: \"PC047 vCagAepitope - Co-occurrence网络与跨域互作分析\"\nauthor:\n  - name: Gong Yuhang\ndate: today\ntoc: true\ntoc-depth: 4\nnumber-sections: true\ncode-fold: true\ncode-line-numbers: true\ncode-tools: true\nformat:\n  html:\n    embed-resources: true\n    smooth-scroll: true\n    page-layout: full\n    fig-width: 7.2\n    fig-height: 5\n    fig-dpi: 300\nexecute:\n  warning: false\n  message: false\nreference-location: section\ncitation-location: document\nparams:\n  name: \"04_network_analysis\"\n---\n\n# 研究问题 {#sec-question}\n\n> **核心问题**：CagA感染如何改变肠道微生物组的生态网络结构？\n>\n> **假说**：CagA感染会重塑物种间的共生/竞争关系，导致网络拓扑特性（如模块度、连通性）发生变化。\n\n## 分析背景\n\nCo-occurrence网络分析用于评估物种间的共生/竞争关系，以及CagA感染如何改变这些关系。\n\n**分析内容**：\n\n1. **细菌-细菌网络**：评估细菌间共生/竞争关系\n2. **细菌-噬菌体跨域网络**：宿主-噬菌体特异性互作\n3. **网络拓扑比较**：不同处理组的网络结构差异\n\n**方法**：Spearman相关性（组成型数据的稳健替代方案）\n\n---\n\n\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nsuppressPackageStartupMessages({\n  library(here)\n  library(conflicted)\n  library(tidyverse)\n  library(data.table)\n  library(TreeSummarizedExperiment)\n  library(mia)\n  library(igraph)\n  library(ggraph)\n  library(ggrepel)\n  library(scales)\n  library(corrplot)\n  library(patchwork)\n  devtools::load_all()\n})\n\n# 解决命名空间冲突\nconflicts_prefer(base::setdiff)\nconflicts_prefer(dplyr::filter)\nconflicts_prefer(dplyr::select)\nconflicts_prefer(dplyr::lag)\nconflicts_prefer(base::intersect)\nconflicts_prefer(igraph::degree)\nconflicts_prefer(igraph::betweenness)\nconflicts_prefer(igraph::closeness)\n\nset.seed(20261)\n```\n:::\n\n\n# Part 1: 数据准备 {#sec-part1}\n\n## 1.1 加载细菌数据 (01分析)\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# 读取清洗后的细菌TSE\ntse_bacteria <- readRDS(here::here(\"data\", \"01_alpha_beta_diversity_analysis\",\n                                    \"tse_standard_species_ca_cleaned.rds\"))\n\ncat(\"细菌TSE:\\n\")\n#> 细菌TSE:\ncat(\"- 物种数:\", nrow(tse_bacteria), \"\\n\")\n#> - 物种数: 11210\ncat(\"- 样本数:\", ncol(tse_bacteria), \"\\n\")\n#> - 样本数: 27\n\n# 获取元数据\nmetadata <- as.data.frame(colData(tse_bacteria))\nprint(table(metadata$treatment_group))\n#> \n#> ApcMUT_Ctrl ApcMUT_HpKO ApcMUT_HpWT  ApcWT_Ctrl  ApcWT_HpKO  ApcWT_HpWT \n#>           3           4           5           5           5           5\n```\n:::\n\n\n## 1.2 加载噬菌体数据 (03分析)\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# 检查噬菌体TSE是否存在\nphage_file <- here::here(\"data\", \"03_singlem_diversity_analysis\",\n                          \"tse_lyrebird_corepair.rds\")\n\nif (file.exists(phage_file)) {\n  tse_phage <- readRDS(phage_file)\n  cat(\"\\n噬菌体TSE:\\n\")\n  cat(\"- OTU数:\", nrow(tse_phage), \"\\n\")\n  cat(\"- 样本数:\", ncol(tse_phage), \"\\n\")\n  has_phage <- TRUE\n} else {\n  cat(\"\\n噬菌体TSE不存在，将只进行细菌网络分析\\n\")\n  has_phage <- FALSE\n}\n#> \n#> 噬菌体TSE:\n#> - OTU数: 878 \n#> - 样本数: 9\n```\n:::\n\n\n## 1.3 找共同样本\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nif (has_phage) {\n  common_samples <- base::intersect(colnames(tse_bacteria), colnames(tse_phage))\n  cat(\"细菌-噬菌体共同样本数:\", length(common_samples), \"\\n\")\n} else {\n  common_samples <- colnames(tse_bacteria)\n}\n#> 细菌-噬菌体共同样本数: 9\n```\n:::\n\n\n# Part 2: 细菌-细菌 Co-occurrence 网络 {#sec-part2}\n\n## 2.1 准备丰度矩阵\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# 获取counts矩阵\nbacteria_counts <- assay(tse_bacteria, \"counts\")\n\n# 过滤低丰度物种 (至少在20%样本中存在)\nprevalence <- rowSums(bacteria_counts > 0) / ncol(bacteria_counts)\nbacteria_filtered <- bacteria_counts[prevalence >= 0.2, ]\n\ncat(\"Prevalence过滤后物种数:\", nrow(bacteria_filtered), \"\\n\")\n#> Prevalence过滤后物种数: 10595\n\n# 转换为相对丰度\nbacteria_relab_all <- sweep(bacteria_filtered, 2, colSums(bacteria_filtered), \"/\")\n\n# 只保留Top 100高丰度物种用于网络分析\nmax_species_network <- 100\nmean_abundance <- rowMeans(bacteria_relab_all)\ntop_species <- names(sort(mean_abundance, decreasing = TRUE))[1:min(max_species_network, length(mean_abundance))]\nbacteria_relab <- bacteria_relab_all[top_species, , drop = FALSE]\n\ncat(\"网络分析使用Top\", nrow(bacteria_relab), \"高丰度物种\\n\")\n#> 网络分析使用Top 100 高丰度物种\n```\n:::\n\n\n## 2.2 计算Spearman相关性\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# 使用Spearman相关性（对组成型数据更稳健）\ncor_matrix <- cor(t(bacteria_relab), method = \"spearman\")\n\ncat(\"相关矩阵维度:\", dim(cor_matrix), \"\\n\")\n#> 相关矩阵维度: 100 100\n```\n:::\n\n\n## 2.3 构建全样本网络\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# 设置相关性阈值\ncor_threshold <- 0.75\np_threshold <- 0.05\n\n# 计算p值\nn_samples <- ncol(bacteria_relab)\ncor_to_t <- function(r, n) {\n  r * sqrt((n - 2) / (1 - r^2))\n}\nt_values <- cor_to_t(cor_matrix, n_samples)\np_values <- 2 * pt(-abs(t_values), df = n_samples - 2)\n\n# 显著且强相关的边\nadj_matrix <- abs(cor_matrix) >= cor_threshold & p_values < p_threshold\ndiag(adj_matrix) <- FALSE\n\n# 创建igraph对象\ng_all <- igraph::graph_from_adjacency_matrix(adj_matrix, mode = \"undirected\")\n\n# 添加边权重（相关系数）\nedge_list <- which(adj_matrix, arr.ind = TRUE)\nedge_list <- edge_list[edge_list[,1] < edge_list[,2], ]\n\nif (nrow(edge_list) > 0) {\n  igraph::E(g_all)$weight <- sapply(1:nrow(edge_list), function(i) {\n    cor_matrix[edge_list[i,1], edge_list[i,2]]\n  })\n  igraph::E(g_all)$sign <- ifelse(igraph::E(g_all)$weight > 0, \"positive\", \"negative\")\n}\n\ncat(\"\\n全样本细菌网络:\\n\")\n#> \n#> 全样本细菌网络:\ncat(\"- 节点数:\", igraph::vcount(g_all), \"\\n\")\n#> - 节点数: 100\ncat(\"- 边数:\", igraph::ecount(g_all), \"\\n\")\n#> - 边数: 530\ncat(\"- 正相关边:\", sum(igraph::E(g_all)$sign == \"positive\", na.rm = TRUE), \"\\n\")\n#> - 正相关边: 498\ncat(\"- 负相关边:\", sum(igraph::E(g_all)$sign == \"negative\", na.rm = TRUE), \"\\n\")\n#> - 负相关边: 32\n```\n:::\n\n\n## 2.4 按处理组构建网络\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# 定义要比较的组\ngroups_to_compare <- c(\"ApcMUT_HpKO\", \"ApcMUT_HpWT\")\n\nnetwork_stats <- list()\n\nfor (grp in groups_to_compare) {\n  grp_samples <- rownames(metadata)[metadata$treatment_group == grp]\n\n  if (length(grp_samples) < 3) {\n    cat(sprintf(\"\\n%s: 样本数不足，跳过\\n\", grp))\n    next\n  }\n\n  grp_relab <- bacteria_relab[, grp_samples]\n\n  # 过滤掉标准差为0的物种\n  row_sds <- apply(grp_relab, 1, sd)\n  grp_relab_filtered <- grp_relab[row_sds > 0, , drop = FALSE]\n\n  # 只保留Top 50高丰度物种\n  max_species <- min(nrow(grp_relab_filtered), 50)\n  mean_abundance_grp <- rowMeans(grp_relab_filtered)\n  top_species_grp <- names(sort(mean_abundance_grp, decreasing = TRUE))[1:max_species]\n  grp_relab_top <- grp_relab_filtered[top_species_grp, , drop = FALSE]\n\n  cat(sprintf(\"\\n%s: 原始%d → 非恒定%d → Top %d高丰度物种\\n\",\n              grp, nrow(grp_relab), nrow(grp_relab_filtered), nrow(grp_relab_top)))\n\n  if (nrow(grp_relab_top) < 3) {\n    cat(sprintf(\"  物种数不足，跳过网络构建\\n\"))\n    next\n  }\n\n  grp_cor <- cor(t(grp_relab_top), method = \"spearman\")\n  grp_cor[is.na(grp_cor)] <- 0\n\n  grp_adj <- abs(grp_cor) >= cor_threshold\n  diag(grp_adj) <- FALSE\n\n  g_grp <- igraph::graph_from_adjacency_matrix(grp_adj, mode = \"undirected\")\n\n  # 计算网络拓扑参数\n  stats <- list(\n    group = grp,\n    n_samples = length(grp_samples),\n    n_nodes = igraph::vcount(g_grp),\n    n_edges = igraph::ecount(g_grp),\n    density = igraph::edge_density(g_grp),\n    transitivity = igraph::transitivity(g_grp, type = \"global\"),\n    avg_path_length = if (igraph::is_connected(g_grp)) igraph::mean_distance(g_grp) else NA,\n    modularity = if (igraph::ecount(g_grp) > 0) igraph::modularity(igraph::cluster_louvain(g_grp)) else NA\n  )\n\n  network_stats[[grp]] <- stats\n\n  cat(sprintf(\"\\n%s 网络统计:\\n\", grp))\n  cat(sprintf(\"  节点: %d, 边: %d\\n\", stats$n_nodes, stats$n_edges))\n  cat(sprintf(\"  密度: %.4f\\n\", stats$density))\n  cat(sprintf(\"  聚类系数: %.4f\\n\", stats$transitivity))\n  cat(sprintf(\"  模块度: %.4f\\n\", stats$modularity))\n}\n#> \n#> ApcMUT_HpKO: 原始100 → 非恒定100 → Top 50高丰度物种\n#> \n#> ApcMUT_HpKO 网络统计:\n#>   节点: 50, 边: 416\n#>   密度: 0.3396\n#>   聚类系数: 0.6281\n#>   模块度: 0.3932\n#> \n#> ApcMUT_HpWT: 原始100 → 非恒定100 → Top 50高丰度物种\n#> \n#> ApcMUT_HpWT 网络统计:\n#>   节点: 50, 边: 360\n#>   密度: 0.2939\n#>   聚类系数: 0.7672\n#>   模块度: 0.2367\n\n# 汇总表\nnetwork_stats_df <- bind_rows(network_stats)\nprint(network_stats_df)\n#> # A tibble: 2 × 8\n#>   group       n_samples n_nodes n_edges density transitivity avg_path_length\n#>   <chr>           <int>   <dbl>   <dbl>   <dbl>        <dbl>           <dbl>\n#> 1 ApcMUT_HpKO         4      50     416   0.340        0.628            1.90\n#> 2 ApcMUT_HpWT         5      50     360   0.294        0.767           NA   \n#> # ℹ 1 more variable: modularity <dbl>\n\nwrite.csv(network_stats_df,\n          file = here::here(\"data\", params$name, \"01_bacteria_network_stats.csv\"),\n          row.names = FALSE)\n```\n:::\n\n\n## 2.5 网络可视化\n\n### 2.5.1 全样本网络\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nif (igraph::ecount(g_all) > 0 && igraph::ecount(g_all) < 500) {\n  set.seed(42)\n  layout <- igraph::layout_with_fr(g_all)\n\n  igraph::V(g_all)$size <- igraph::degree(g_all) + 3\n  igraph::E(g_all)$color <- ifelse(igraph::E(g_all)$sign == \"positive\", \"steelblue\", \"tomato\")\n\n  par(mfrow = c(1, 1), mar = c(1, 1, 3, 1))\n  plot(g_all,\n       layout = layout,\n       vertex.label = NA,\n       vertex.color = \"lightblue\",\n       edge.width = abs(igraph::E(g_all)$weight) * 2,\n       main = \"细菌Co-occurrence网络\\n(蓝=正相关, 红=负相关)\")\n\n} else if (igraph::ecount(g_all) >= 500) {\n  cat(\"边数过多 (\", igraph::ecount(g_all), \")，跳过全网络可视化\\n\")\n} else {\n  cat(\"网络无边，跳过可视化\\n\")\n}\n#> 边数过多 ( 530 )，跳过全网络可视化\n```\n:::\n\n\n### 2.5.2 分组网络对比\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nviz_cor_threshold <- 0.75\n\npng(here::here(\"data\", params$name, \"02_network_comparison.png\"),\n    width = 1400, height = 700, res = 150)\n\npar(mfrow = c(1, 2), mar = c(2, 2, 4, 2))\n\nfor (grp in groups_to_compare) {\n  grp_samples <- rownames(metadata)[metadata$treatment_group == grp]\n  grp_relab <- bacteria_relab[, grp_samples]\n\n  row_sds <- apply(grp_relab, 1, sd)\n  grp_relab_filtered <- grp_relab[row_sds > 0, , drop = FALSE]\n\n  max_species <- min(50, nrow(grp_relab_filtered))\n  mean_abundance_grp <- rowMeans(grp_relab_filtered)\n  top_species_grp <- names(sort(mean_abundance_grp, decreasing = TRUE))[1:max_species]\n  grp_relab_top <- grp_relab_filtered[top_species_grp, , drop = FALSE]\n\n  grp_cor <- cor(t(grp_relab_top), method = \"spearman\")\n  grp_cor[is.na(grp_cor)] <- 0\n\n  grp_adj <- abs(grp_cor) >= viz_cor_threshold\n  diag(grp_adj) <- FALSE\n\n  g_grp <- igraph::graph_from_adjacency_matrix(grp_adj, mode = \"undirected\")\n  mod_value <- if (igraph::ecount(g_grp) > 0) igraph::modularity(igraph::cluster_louvain(g_grp)) else 0\n\n  if (igraph::ecount(g_grp) > 0) {\n    set.seed(42)\n    layout_grp <- igraph::layout_with_fr(g_grp)\n\n    deg <- igraph::degree(g_grp)\n    igraph::V(g_grp)$size <- deg / max(deg) * 12 + 4\n\n    communities <- igraph::cluster_louvain(g_grp)\n    igraph::V(g_grp)$color <- rainbow(max(igraph::membership(communities)))[igraph::membership(communities)]\n\n    plot(g_grp,\n         layout = layout_grp,\n         vertex.label = NA,\n         edge.color = \"gray60\",\n         edge.width = 0.5,\n         main = sprintf(\"%s\\nNodes: %d | Edges: %d | Modularity: %.3f\",\n                       grp, igraph::vcount(g_grp), igraph::ecount(g_grp), mod_value))\n  } else {\n    plot.new()\n    text(0.5, 0.5, paste(grp, \"\\nNo edges at threshold\", viz_cor_threshold))\n  }\n}\n\ndev.off()\n#> png \n#>   2\ncat(\"网络对比图已保存: 02_network_comparison.png\\n\")\n#> 网络对比图已保存: 02_network_comparison.png\n```\n:::\n\n\n### 2.5.3 网络统计柱状图\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nif (nrow(network_stats_df) >= 2) {\n  stats_for_plot <- network_stats_df %>%\n    dplyr::select(group, n_nodes, n_edges, modularity) %>%\n    pivot_longer(cols = -group, names_to = \"metric\", values_to = \"value\") %>%\n    mutate(metric = factor(metric,\n                          levels = c(\"n_nodes\", \"n_edges\", \"modularity\"),\n                          labels = c(\"Nodes\", \"Edges\", \"Modularity\")))\n\n  ctrl_mod <- network_stats_df$modularity[network_stats_df$group == \"ApcMUT_HpKO\"]\n  caga_mod <- network_stats_df$modularity[network_stats_df$group == \"ApcMUT_HpWT\"]\n  mod_change <- round((caga_mod - ctrl_mod) / ctrl_mod * 100, 0)\n\n  p_stats <- ggplot(stats_for_plot, aes(x = metric, y = value, fill = group)) +\n    geom_bar(stat = \"identity\", position = position_dodge(width = 0.8), width = 0.7) +\n    geom_text(aes(label = round(value, 3)),\n              position = position_dodge(width = 0.8), vjust = -0.5, size = 3.5) +\n    theme_bw(base_size = 14) +\n    labs(title = \"Network Topology Changes: CagA Effect\",\n         subtitle = sprintf(\"Modularity change: %d%% (from %.3f to %.3f)\",\n                           mod_change, ctrl_mod, caga_mod),\n         x = NULL, y = \"Value\",\n         fill = \"Group\") +\n    scale_fill_manual(values = c(\"ApcMUT_HpKO\" = \"#66c2a5\", \"ApcMUT_HpWT\" = \"#fc8d62\"),\n                      labels = c(\"Control (HpKO)\", \"CagA+ (HpWT)\")) +\n    facet_wrap(~metric, scales = \"free_y\", nrow = 1) +\n    theme(legend.position = \"bottom\")\n\n  print(p_stats)\n\n  ggsave(here::here(\"data\", params$name, \"03_network_stats_barplot.png\"),\n         plot = p_stats, width = 12, height = 5, dpi = 300)\n}\n```\n\n::: {.cell-output-display}\n![](04_network_analysis_files/figure-html/part2-stats-barplot-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\n## 2.6 Hub物种识别\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nif (igraph::ecount(g_all) > 0) {\n  degree_cent <- igraph::degree(g_all)\n  betweenness_cent <- igraph::betweenness(g_all, weights = NA)\n  closeness_cent <- igraph::closeness(g_all, weights = NA)\n\n  hub_df <- data.frame(\n    species = igraph::V(g_all)$name,\n    degree = degree_cent,\n    betweenness = betweenness_cent,\n    closeness = closeness_cent\n  ) %>%\n    arrange(desc(degree))\n\n  cat(\"\\nTop 10 Hub物种 (按度排序):\\n\\n\")\n  print(head(hub_df, 10))\n\n  write.csv(hub_df,\n            file = here::here(\"data\", params$name, \"04_bacteria_hub_species.csv\"),\n            row.names = FALSE)\n}\n#> \n#> Top 10 Hub物种 (按度排序):\n#> \n#>                                                   species degree betweenness\n#> Marvinbryantia formatexigens Marvinbryantia formatexigens     30    64.39925\n#> Blautia parvula                           Blautia parvula     29   159.12282\n#> Sellimonas catena                       Sellimonas catena     28    35.63975\n#> Agathobacter rectalis               Agathobacter rectalis     27    55.17001\n#> Hungatella hathewayi                 Hungatella hathewayi     26   107.49917\n#> Roseburia hominis                       Roseburia hominis     26    56.46658\n#> Blautia obeum                               Blautia obeum     25   128.10765\n#> Hungatella sp. SB206                 Hungatella sp. SB206     25    15.96324\n#> Clostridium sp. M62/1               Clostridium sp. M62/1     24   207.21707\n#> [Clostridium] hylemonae           [Clostridium] hylemonae     23   124.80287\n#>                                closeness\n#> Marvinbryantia formatexigens 0.006329114\n#> Blautia parvula              0.007142857\n#> Sellimonas catena            0.006211180\n#> Agathobacter rectalis        0.006097561\n#> Hungatella hathewayi         0.006993007\n#> Roseburia hominis            0.006211180\n#> Blautia obeum                0.007092199\n#> Hungatella sp. SB206         0.006060606\n#> Clostridium sp. M62/1        0.006993007\n#> [Clostridium] hylemonae      0.006896552\n```\n:::\n\n\n## 2.7 网络稳定性分析 (Bootstrap)\n\nBootstrap重采样评估网络边的可靠性：在多次重采样中稳定出现的边更可信。\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Bootstrap参数\nn_bootstrap <- 500  # 重采样次数（生产环境建议1000）\nstability_threshold <- 0.7  # 边稳定性阈值\n\ncat(\"====== Bootstrap网络稳定性分析 ======\\n\")\n#> ====== Bootstrap网络稳定性分析 ======\ncat(\"重采样次数:\", n_bootstrap, \"\\n\")\n#> 重采样次数: 500\ncat(\"稳定性阈值:\", stability_threshold, \"\\n\\n\")\n#> 稳定性阈值: 0.7\n\n# 初始化边计数矩阵\nn_species <- nrow(bacteria_relab)\nedge_counts <- matrix(0, nrow = n_species, ncol = n_species,\n                      dimnames = list(rownames(bacteria_relab), rownames(bacteria_relab)))\n\nset.seed(42)\n\n# Bootstrap循环\npb_interval <- floor(n_bootstrap / 10)\nfor (b in 1:n_bootstrap) {\n  # 有放回重采样样本\n\nboot_samples <- sample(ncol(bacteria_relab), replace = TRUE)\n  boot_data <- bacteria_relab[, boot_samples]\n\n  # 计算相关性\n  boot_cor <- cor(t(boot_data), method = \"spearman\")\n  boot_cor[is.na(boot_cor)] <- 0\n\n  # 识别显著边\n  boot_adj <- abs(boot_cor) >= cor_threshold\n  diag(boot_adj) <- FALSE\n\n # 累加边计数\n  edge_counts <- edge_counts + boot_adj\n\n  if (b %% pb_interval == 0) {\n    cat(sprintf(\"  进度: %d/%d (%.0f%%)\\n\", b, n_bootstrap, 100*b/n_bootstrap))\n  }\n}\n#>   进度: 50/500 (10%)\n#>   进度: 100/500 (20%)\n#>   进度: 150/500 (30%)\n#>   进度: 200/500 (40%)\n#>   进度: 250/500 (50%)\n#>   进度: 300/500 (60%)\n#>   进度: 350/500 (70%)\n#>   进度: 400/500 (80%)\n#>   进度: 450/500 (90%)\n#>   进度: 500/500 (100%)\n\n# 计算边稳定性\nedge_stability <- edge_counts / n_bootstrap\n\n# 统计稳定边\nstable_edges <- edge_stability >= stability_threshold\ndiag(stable_edges) <- FALSE\nn_stable_edges <- sum(stable_edges) / 2  # 无向图，除以2\n\ncat(\"\\n====== 稳定性分析结果 ======\\n\")\n#> \n#> ====== 稳定性分析结果 ======\ncat(\"原始网络边数:\", igraph::ecount(g_all), \"\\n\")\n#> 原始网络边数: 530\ncat(sprintf(\"稳定边数 (稳定性≥%.0f%%): %d\\n\", stability_threshold*100, n_stable_edges))\n#> 稳定边数 (稳定性≥70%): 379\ncat(sprintf(\"边保留率: %.1f%%\\n\", 100 * n_stable_edges / max(igraph::ecount(g_all), 1)))\n#> 边保留率: 71.5%\n```\n:::\n\n\n### 2.7.1 边稳定性分布\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# 提取上三角的稳定性值（排除对角线）\nupper_tri_stability <- edge_stability[upper.tri(edge_stability)]\nnonzero_stability <- upper_tri_stability[upper_tri_stability > 0]\n\nif (length(nonzero_stability) > 0) {\n  # 稳定性分布直方图\n  p_hist <- ggplot(data.frame(stability = nonzero_stability), aes(x = stability)) +\n    geom_histogram(binwidth = 0.05, fill = \"steelblue\", color = \"white\", alpha = 0.8) +\n    geom_vline(xintercept = stability_threshold, color = \"red\", linetype = \"dashed\", linewidth = 1) +\n    annotate(\"text\", x = stability_threshold + 0.05, y = Inf, vjust = 2,\n             label = sprintf(\"Threshold: %.0f%%\", stability_threshold*100),\n             color = \"red\", fontface = \"bold\") +\n    scale_x_continuous(labels = scales::percent, limits = c(0, 1)) +\n    labs(\n      title = \"Edge Stability Distribution (Bootstrap)\",\n      subtitle = sprintf(\"%d bootstrap iterations | %d stable edges (≥%.0f%%)\",\n                        n_bootstrap, n_stable_edges, stability_threshold*100),\n      x = \"Edge Stability (proportion of bootstrap samples)\",\n      y = \"Count\"\n    ) +\n    theme_bw(base_size = 12) +\n    theme(plot.title = element_text(face = \"bold\"))\n\n  # 稳定性分类饼图\n  stability_categories <- cut(nonzero_stability,\n                              breaks = c(0, 0.3, 0.5, 0.7, 0.9, 1.0),\n                              labels = c(\"<30%\", \"30-50%\", \"50-70%\", \"70-90%\", \">90%\"),\n                              include.lowest = TRUE)\n\n  pie_data <- as.data.frame(table(stability_categories)) %>%\n    mutate(prop = Freq / sum(Freq),\n           label = sprintf(\"%s\\n(n=%d)\", stability_categories, Freq))\n\n  p_pie <- ggplot(pie_data, aes(x = \"\", y = Freq, fill = stability_categories)) +\n    geom_bar(stat = \"identity\", width = 1) +\n    coord_polar(\"y\") +\n    scale_fill_manual(values = c(\"<30%\" = \"#d73027\", \"30-50%\" = \"#fc8d59\",\n                                  \"50-70%\" = \"#fee090\", \"70-90%\" = \"#91cf60\",\n                                  \">90%\" = \"#1a9850\"),\n                      name = \"Stability\") +\n    labs(title = \"Edge Stability Categories\") +\n    theme_void(base_size = 12) +\n    theme(plot.title = element_text(face = \"bold\", hjust = 0.5),\n          legend.position = \"right\")\n\n  print(p_hist + p_pie + plot_layout(widths = c(2, 1)))\n\n  ggsave(here::here(\"data\", params$name, \"05_edge_stability_distribution.png\"),\n         plot = p_hist + p_pie + plot_layout(widths = c(2, 1)),\n         width = 10, height = 4, dpi = 300)\n}\n```\n\n::: {.cell-output-display}\n![](04_network_analysis_files/figure-html/part2-stability-distribution-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\n### 2.7.2 构建稳健网络\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# 基于稳定性构建稳健网络\ng_robust <- igraph::graph_from_adjacency_matrix(stable_edges, mode = \"undirected\")\n\n# 添加稳定性作为边权重\nif (igraph::ecount(g_robust) > 0) {\n  edge_list_robust <- igraph::as_edgelist(g_robust)\n  edge_stab_values <- sapply(1:nrow(edge_list_robust), function(i) {\n    edge_stability[edge_list_robust[i,1], edge_list_robust[i,2]]\n  })\n  igraph::E(g_robust)$stability <- edge_stab_values\n\n  # 添加原始相关系数\n  edge_cor_values <- sapply(1:nrow(edge_list_robust), function(i) {\n    cor_matrix[edge_list_robust[i,1], edge_list_robust[i,2]]\n  })\n  igraph::E(g_robust)$correlation <- edge_cor_values\n  igraph::E(g_robust)$sign <- ifelse(edge_cor_values > 0, \"positive\", \"negative\")\n}\n\ncat(\"\\n====== 稳健网络统计 ======\\n\")\n#> \n#> ====== 稳健网络统计 ======\ncat(\"原始网络: 节点\", igraph::vcount(g_all), \", 边\", igraph::ecount(g_all), \"\\n\")\n#> 原始网络: 节点 100 , 边 530\ncat(\"稳健网络: 节点\", igraph::vcount(g_robust), \", 边\", igraph::ecount(g_robust), \"\\n\")\n#> 稳健网络: 节点 100 , 边 379\n\nif (igraph::ecount(g_robust) > 0) {\n  cat(\"\\n稳健网络边的稳定性:\\n\")\n  cat(\"  平均:\", round(mean(igraph::E(g_robust)$stability), 3), \"\\n\")\n  cat(\"  最小:\", round(min(igraph::E(g_robust)$stability), 3), \"\\n\")\n  cat(\"  最大:\", round(max(igraph::E(g_robust)$stability), 3), \"\\n\")\n\n  # 可视化稳健网络\n  if (igraph::ecount(g_robust) < 300) {\n    set.seed(42)\n    layout_robust <- igraph::layout_with_fr(g_robust)\n\n    # 节点大小 = 度\n    igraph::V(g_robust)$size <- igraph::degree(g_robust) + 3\n\n    # 边颜色 = 正/负相关\n    igraph::E(g_robust)$color <- ifelse(igraph::E(g_robust)$sign == \"positive\",\n                                         \"#3498db\", \"#e74c3c\")\n\n    # 边宽度 = 稳定性\n    igraph::E(g_robust)$width <- igraph::E(g_robust)$stability * 3\n\n    par(mar = c(1, 1, 3, 1))\n    plot(g_robust,\n         layout = layout_robust,\n         vertex.label = NA,\n         vertex.color = \"lightgray\",\n         main = sprintf(\"Robust Network (stability ≥ %.0f%%)\\nNodes: %d | Edges: %d\",\n                       stability_threshold*100,\n                       igraph::vcount(g_robust),\n                       igraph::ecount(g_robust)))\n    legend(\"bottomright\",\n           legend = c(\"Positive correlation\", \"Negative correlation\"),\n           col = c(\"#3498db\", \"#e74c3c\"),\n           lwd = 2, bty = \"n\", cex = 0.8)\n\n  } else {\n    cat(\"\\n边数过多，跳过可视化\\n\")\n  }\n}\n#> \n#> 稳健网络边的稳定性:\n#>   平均: 0.918 \n#>   最小: 0.7 \n#>   最大: 1 \n#> \n#> 边数过多，跳过可视化\n```\n:::\n\n\n### 2.7.3 稳健网络Hub物种\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nif (igraph::ecount(g_robust) > 0) {\n  # 计算稳健网络的中心性\n  robust_degree <- igraph::degree(g_robust)\n  robust_betweenness <- igraph::betweenness(g_robust, weights = NA)\n\n  robust_hub_df <- data.frame(\n    species = names(robust_degree),\n    degree = robust_degree,\n    betweenness = robust_betweenness\n  ) %>%\n    filter(degree > 0) %>%\n    arrange(desc(degree))\n\n  cat(\"\\n====== 稳健网络Top 10 Hub物种 ======\\n\\n\")\n  print(head(robust_hub_df, 10))\n\n  # 与原始网络Hub比较\n  if (exists(\"hub_df\")) {\n    original_top10 <- head(hub_df$species, 10)\n    robust_top10 <- head(robust_hub_df$species, 10)\n    overlap <- length(base::intersect(original_top10, robust_top10))\n\n    cat(sprintf(\"\\n原始网络 vs 稳健网络 Top10 Hub重叠: %d/10 (%.0f%%)\\n\",\n                overlap, overlap * 10))\n  }\n\n  write.csv(robust_hub_df,\n            file = here::here(\"data\", params$name, \"06_robust_hub_species.csv\"),\n            row.names = FALSE)\n}\n#> \n#> ====== 稳健网络Top 10 Hub物种 ======\n#> \n#>                                                   species degree betweenness\n#> Blautia parvula                           Blautia parvula     26   65.243735\n#> Marvinbryantia formatexigens Marvinbryantia formatexigens     24   39.024702\n#> Roseburia hominis                       Roseburia hominis     24   45.988082\n#> Sellimonas catena                       Sellimonas catena     23   35.308671\n#> Hungatella hathewayi                 Hungatella hathewayi     19   19.280935\n#> Agathobacter rectalis               Agathobacter rectalis     19   22.865958\n#> Sellimonas intestinalis           Sellimonas intestinalis     18   24.606817\n#> Hungatella sp. SB206                 Hungatella sp. SB206     18   11.281932\n#> Blautia pseudococcoides           Blautia pseudococcoides     17   41.583523\n#> Blautia obeum                               Blautia obeum     17    7.639665\n#> \n#> 原始网络 vs 稳健网络 Top10 Hub重叠: 8/10 (80%)\n```\n:::\n\n\n## 2.8 Keystone Species识别 (Zi-Pi分析)\n\nZi-Pi分析通过模块内连接度(Zi)和参与系数(Pi)识别网络中的关键物种：\n\n- **Zi (Within-module degree)**: 节点在其模块内的标准化连接度\n- **Pi (Participation coefficient)**: 节点连接分布于不同模块的均匀程度\n\n根据Guimerà & Amaral (2005)的分类标准：\n\n| 类型 | Zi | Pi | 生态意义 |\n|------|----|----|----------|\n| Module hub | > 2.5 | ≤ 0.62 | 模块内关键物种 |\n| Network hub | > 2.5 | > 0.62 | 连接不同模块的超级连接者 |\n| Connector | ≤ 2.5 | > 0.62 | 跨模块连接者 |\n| Peripheral | ≤ 2.5 | ≤ 0.62 | 边缘物种 |\n\n**Keystone species** = Module hubs + Network hubs\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# 定义Zi-Pi计算函数\ncalculate_zi <- function(graph, membership) {\n  # Within-module degree z-score\n  nodes <- igraph::V(graph)$name\n  zi_values <- numeric(length(nodes))\n  names(zi_values) <- nodes\n\n  for (i in seq_along(nodes)) {\n    node <- nodes[i]\n    node_module <- membership[node]\n\n    # 获取同模块节点\n    module_nodes <- names(membership)[membership == node_module]\n\n    # 计算模块内度\n    neighbors <- names(igraph::neighbors(graph, node))\n    ki <- sum(neighbors %in% module_nodes)\n\n    # 计算模块内平均度和标准差\n    module_degrees <- sapply(module_nodes, function(n) {\n      n_neighbors <- names(igraph::neighbors(graph, n))\n      sum(n_neighbors %in% module_nodes)\n    })\n\n    mean_k <- mean(module_degrees)\n    sd_k <- sd(module_degrees)\n\n    # 计算Zi (处理 NA 值，当模块只有1个节点时 sd 返回 NA)\n    if (!is.na(sd_k) && sd_k > 0) {\n      zi_values[i] <- (ki - mean_k) / sd_k\n    } else {\n      zi_values[i] <- 0\n    }\n  }\n\n  return(zi_values)\n}\n\ncalculate_pi <- function(graph, membership) {\n  # Participation coefficient\n  nodes <- igraph::V(graph)$name\n  pi_values <- numeric(length(nodes))\n  names(pi_values) <- nodes\n\n  modules <- unique(membership)\n\n  for (i in seq_along(nodes)) {\n    node <- nodes[i]\n    ki <- igraph::degree(graph, node)\n\n    if (ki == 0) {\n      pi_values[i] <- 0\n      next\n    }\n\n    neighbors <- names(igraph::neighbors(graph, node))\n\n    # 计算到各模块的连接比例\n    sum_squared <- 0\n    for (m in modules) {\n      module_nodes <- names(membership)[membership == m]\n      kis <- sum(neighbors %in% module_nodes)\n      sum_squared <- sum_squared + (kis / ki)^2\n    }\n\n    pi_values[i] <- 1 - sum_squared\n  }\n\n  return(pi_values)\n}\n\n# 节点分类函数\nclassify_nodes <- function(zi, pi, zi_threshold = 2.5, pi_threshold = 0.62) {\n  classification <- character(length(zi))\n\n  for (i in seq_along(zi)) {\n    if (zi[i] > zi_threshold && pi[i] <= pi_threshold) {\n      classification[i] <- \"Module hub\"\n    } else if (zi[i] > zi_threshold && pi[i] > pi_threshold) {\n      classification[i] <- \"Network hub\"\n    } else if (zi[i] <= zi_threshold && pi[i] > pi_threshold) {\n      classification[i] <- \"Connector\"\n    } else {\n      classification[i] <- \"Peripheral\"\n    }\n  }\n\n  return(classification)\n}\n```\n:::\n\n\n### 2.8.1 全样本网络Zi-Pi分析\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nif (igraph::ecount(g_all) > 0) {\n  cat(\"====== Zi-Pi分析 ======\\n\\n\")\n\n  # 模块检测 (使用 weights=NA 因为 cluster_louvain 不支持负权重)\n  communities <- igraph::cluster_louvain(g_all, weights = NA)\n  membership <- igraph::membership(communities)\n  names(membership) <- igraph::V(g_all)$name\n\n  cat(\"检测到模块数:\", max(membership), \"\\n\")\n  cat(\"模块度:\", round(igraph::modularity(communities), 4), \"\\n\\n\")\n\n  # 计算Zi和Pi\n  zi_values <- calculate_zi(g_all, membership)\n  pi_values <- calculate_pi(g_all, membership)\n\n  # 分类节点\n  node_class <- classify_nodes(zi_values, pi_values)\n\n  # 构建结果数据框\n  zi_pi_df <- data.frame(\n    species = names(zi_values),\n    module = as.integer(membership[names(zi_values)]),\n    degree = igraph::degree(g_all)[names(zi_values)],\n    Zi = zi_values,\n    Pi = pi_values,\n    role = node_class,\n    stringsAsFactors = FALSE\n  ) %>%\n    arrange(desc(Zi))\n\n  # 统计各类节点数量\n  role_counts <- table(zi_pi_df$role)\n  cat(\"节点角色分布:\\n\")\n  print(role_counts)\n\n  # 识别keystone species\n  keystone_species <- zi_pi_df %>%\n    filter(role %in% c(\"Module hub\", \"Network hub\"))\n\n  cat(sprintf(\"\\n====== Keystone Species (n=%d) ======\\n\\n\", nrow(keystone_species)))\n  if (nrow(keystone_species) > 0) {\n    print(keystone_species)\n  } else {\n    cat(\"未检测到严格定义的keystone species (Zi > 2.5)\\n\")\n    cat(\"显示Top 10高Zi值物种:\\n\\n\")\n    print(head(zi_pi_df, 10))\n  }\n\n  # 保存结果\n  write.csv(zi_pi_df,\n            file = here::here(\"data\", params$name, \"07_zi_pi_analysis.csv\"),\n            row.names = FALSE)\n}\n#> ====== Zi-Pi分析 ======\n#> \n#> 检测到模块数: 20 \n#> 模块度: 0.5595 \n#> \n#> 节点角色分布:\n#> \n#> Peripheral \n#>        100 \n#> \n#> ====== Keystone Species (n=0) ======\n#> \n#> 未检测到严格定义的keystone species (Zi > 2.5)\n#> 显示Top 10高Zi值物种:\n#> \n#>                                                   species module degree\n#> Duncaniella dubosii                   Duncaniella dubosii      1      6\n#> Marvinbryantia formatexigens Marvinbryantia formatexigens      5     30\n#> Sellimonas catena                       Sellimonas catena      5     28\n#> Agathobacter rectalis               Agathobacter rectalis      5     27\n#> Blautia parvula                           Blautia parvula      5     29\n#> Oscillibacter hominis               Oscillibacter hominis      4     18\n#> Oscillibacter sp. PEA192         Oscillibacter sp. PEA192      4     18\n#> Vescimonas coprocola                 Vescimonas coprocola      4     18\n#> Pusillibacter faecalis             Pusillibacter faecalis      4     17\n#> Roseburia hominis                       Roseburia hominis      5     26\n#>                                    Zi         Pi       role\n#> Duncaniella dubosii          2.000000 0.00000000 Peripheral\n#> Marvinbryantia formatexigens 1.575793 0.06444444 Peripheral\n#> Sellimonas catena            1.441177 0.00000000 Peripheral\n#> Agathobacter rectalis        1.306562 0.00000000 Peripheral\n#> Blautia parvula              1.306562 0.12841855 Peripheral\n#> Oscillibacter hominis        1.306520 0.00000000 Peripheral\n#> Oscillibacter sp. PEA192     1.306520 0.00000000 Peripheral\n#> Vescimonas coprocola         1.306520 0.00000000 Peripheral\n#> Pusillibacter faecalis       1.103480 0.00000000 Peripheral\n#> Roseburia hominis            1.037331 0.07396450 Peripheral\n```\n:::\n\n\n### 2.8.2 Zi-Pi散点图\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nif (exists(\"zi_pi_df\") && nrow(zi_pi_df) > 0) {\n  # 定义颜色\n  role_colors <- c(\n    \"Module hub\" = \"#e74c3c\",\n    \"Network hub\" = \"#9b59b6\",\n    \"Connector\" = \"#3498db\",\n    \"Peripheral\" = \"#95a5a6\"\n  )\n\n  # 确保role是因子并设置顺序\n  zi_pi_df$role <- factor(zi_pi_df$role,\n                          levels = c(\"Network hub\", \"Module hub\", \"Connector\", \"Peripheral\"))\n\n  # 标记要显示名称的物种 (keystone + top connectors)\n  top_species_label <- zi_pi_df %>%\n    group_by(role) %>%\n    slice_max(Zi, n = 3) %>%\n    ungroup() %>%\n    filter(role != \"Peripheral\") %>%\n    pull(species)\n\n  zi_pi_df$label <- ifelse(zi_pi_df$species %in% top_species_label,\n                            gsub(\"_\", \" \", zi_pi_df$species), \"\")\n\n  # 绘制Zi-Pi图\n  p_zi_pi <- ggplot(zi_pi_df, aes(x = Pi, y = Zi, color = role, size = degree)) +\n    # 添加分类阈值线\n    geom_hline(yintercept = 2.5, linetype = \"dashed\", color = \"gray40\", linewidth = 0.8) +\n    geom_vline(xintercept = 0.62, linetype = \"dashed\", color = \"gray40\", linewidth = 0.8) +\n    # 添加区域标签\n    annotate(\"text\", x = 0.31, y = max(zi_pi_df$Zi) * 0.95,\n             label = \"Module\\nhubs\", color = \"#e74c3c\", fontface = \"bold\", size = 3.5) +\n    annotate(\"text\", x = 0.81, y = max(zi_pi_df$Zi) * 0.95,\n             label = \"Network\\nhubs\", color = \"#9b59b6\", fontface = \"bold\", size = 3.5) +\n    annotate(\"text\", x = 0.81, y = min(zi_pi_df$Zi) + 0.5,\n             label = \"Connectors\", color = \"#3498db\", fontface = \"bold\", size = 3.5) +\n    annotate(\"text\", x = 0.31, y = min(zi_pi_df$Zi) + 0.5,\n             label = \"Peripherals\", color = \"#95a5a6\", fontface = \"bold\", size = 3.5) +\n    # 绑制点\n    geom_point(alpha = 0.7) +\n    # 添加物种标签\n    ggrepel::geom_text_repel(\n      aes(label = label),\n      size = 2.5,\n      max.overlaps = 15,\n      segment.color = \"gray60\",\n      segment.size = 0.3\n    ) +\n    scale_color_manual(values = role_colors, name = \"Node Role\") +\n    scale_size_continuous(range = c(2, 10), name = \"Degree\") +\n    labs(\n      title = \"Zi-Pi Plot: Keystone Species Identification\",\n      subtitle = sprintf(\"Modules: %d | Keystone species: %d (Module hub: %d, Network hub: %d)\",\n                        max(membership),\n                        sum(role_counts[c(\"Module hub\", \"Network hub\")], na.rm = TRUE),\n                        role_counts[\"Module hub\"] %||% 0,\n                        role_counts[\"Network hub\"] %||% 0),\n      x = \"Participation Coefficient (Pi)\",\n      y = \"Within-module Degree (Zi)\"\n    ) +\n    theme_bw(base_size = 12) +\n    theme(\n      plot.title = element_text(face = \"bold\", size = 14),\n      plot.subtitle = element_text(size = 11, color = \"gray30\"),\n      legend.position = \"right\",\n      panel.grid.minor = element_blank()\n    )\n\n  print(p_zi_pi)\n\n  ggsave(here::here(\"data\", params$name, \"08_zi_pi_plot.png\"),\n         plot = p_zi_pi, width = 10, height = 8, dpi = 300)\n}\n```\n\n::: {.cell-output-display}\n![](04_network_analysis_files/figure-html/part2-zi-pi-plot-1.png){fig-align='center' width=100%}\n:::\n:::\n\n### 2.8.3 分组Zi-Pi比较\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# 对两个处理组分别进行Zi-Pi分析\nzi_pi_by_group <- list()\n\nfor (grp in groups_to_compare) {\n  grp_samples <- rownames(metadata)[metadata$treatment_group == grp]\n\n  if (length(grp_samples) < 3) next\n\n  grp_relab <- bacteria_relab[, grp_samples]\n  row_sds <- apply(grp_relab, 1, sd)\n  grp_relab_filtered <- grp_relab[row_sds > 0, , drop = FALSE]\n\n  max_species <- min(50, nrow(grp_relab_filtered))\n  mean_abundance_grp <- rowMeans(grp_relab_filtered)\n  top_species_grp <- names(sort(mean_abundance_grp, decreasing = TRUE))[1:max_species]\n  grp_relab_top <- grp_relab_filtered[top_species_grp, , drop = FALSE]\n\n  grp_cor <- cor(t(grp_relab_top), method = \"spearman\")\n  grp_cor[is.na(grp_cor)] <- 0\n\n  grp_adj <- abs(grp_cor) >= cor_threshold\n  diag(grp_adj) <- FALSE\n\n  g_grp <- igraph::graph_from_adjacency_matrix(grp_adj, mode = \"undirected\")\n\n  if (igraph::ecount(g_grp) < 5) {\n    cat(sprintf(\"%s: 边数不足，跳过Zi-Pi分析\\n\", grp))\n    next\n  }\n\n  # 模块检测\n  comm_grp <- igraph::cluster_louvain(g_grp)\n  memb_grp <- igraph::membership(comm_grp)\n  names(memb_grp) <- igraph::V(g_grp)$name\n\n  # 计算Zi-Pi\n  zi_grp <- calculate_zi(g_grp, memb_grp)\n  pi_grp <- calculate_pi(g_grp, memb_grp)\n  class_grp <- classify_nodes(zi_grp, pi_grp)\n\n  zi_pi_by_group[[grp]] <- data.frame(\n    species = names(zi_grp),\n    group = grp,\n    Zi = zi_grp,\n    Pi = pi_grp,\n    role = class_grp,\n    stringsAsFactors = FALSE\n  )\n}\n\n# 合并并可视化\nif (length(zi_pi_by_group) == 2) {\n  zi_pi_combined <- bind_rows(zi_pi_by_group)\n  zi_pi_combined$group <- factor(zi_pi_combined$group,\n                                  levels = c(\"ApcMUT_HpKO\", \"ApcMUT_HpWT\"),\n                                  labels = c(\"Control (HpKO)\", \"CagA+ (HpWT)\"))\n  zi_pi_combined$role <- factor(zi_pi_combined$role,\n                                 levels = c(\"Network hub\", \"Module hub\", \"Connector\", \"Peripheral\"))\n\n  # 分组Zi-Pi图\n  p_zi_pi_group <- ggplot(zi_pi_combined, aes(x = Pi, y = Zi, color = role)) +\n    geom_hline(yintercept = 2.5, linetype = \"dashed\", color = \"gray40\") +\n    geom_vline(xintercept = 0.62, linetype = \"dashed\", color = \"gray40\") +\n    geom_point(alpha = 0.7, size = 3) +\n    scale_color_manual(values = c(\n      \"Module hub\" = \"#e74c3c\",\n      \"Network hub\" = \"#9b59b6\",\n      \"Connector\" = \"#3498db\",\n      \"Peripheral\" = \"#95a5a6\"\n    ), name = \"Node Role\") +\n    facet_wrap(~group) +\n    labs(\n      title = \"Zi-Pi Analysis by Treatment Group\",\n      subtitle = \"Comparing network roles between Control and CagA+ groups\",\n      x = \"Participation Coefficient (Pi)\",\n      y = \"Within-module Degree (Zi)\"\n    ) +\n    theme_bw(base_size = 12) +\n    theme(\n      plot.title = element_text(face = \"bold\"),\n      strip.background = element_rect(fill = \"gray90\"),\n      strip.text = element_text(face = \"bold\", size = 11)\n    )\n\n  print(p_zi_pi_group)\n\n  ggsave(here::here(\"data\", params$name, \"09_zi_pi_by_group.png\"),\n         plot = p_zi_pi_group, width = 12, height = 6, dpi = 300)\n\n  # 角色分布对比\n  role_summary <- zi_pi_combined %>%\n    group_by(group, role) %>%\n    summarise(count = n(), .groups = \"drop\") %>%\n    group_by(group) %>%\n    mutate(proportion = count / sum(count))\n\n  cat(\"\\n====== 分组角色分布对比 ======\\n\\n\")\n  print(as.data.frame(role_summary))\n\n  write.csv(zi_pi_combined,\n            file = here::here(\"data\", params$name, \"10_zi_pi_by_group.csv\"),\n            row.names = FALSE)\n}\n```\n\n::: {.cell-output-display}\n![](04_network_analysis_files/figure-html/part2-zi-pi-by-group-1.png){fig-align='center' width=100%}\n:::\n\n```\n#> \n#> ====== 分组角色分布对比 ======\n#> \n#>            group       role count proportion\n#> 1 Control (HpKO)  Connector     7       0.14\n#> 2 Control (HpKO) Peripheral    43       0.86\n#> 3   CagA+ (HpWT) Peripheral    50       1.00\n```\n:::\n\n\n## 2.9 SparCC组成型数据相关性 (可选)\n\n**背景**：Spearman相关性在组成型数据（相对丰度）上存在偏差，因为各物种丰度总和恒为1，导致假性负相关。\nSparCC (Sparse Correlations for Compositional data) 专门解决这一问题。\n\n**方法**：使用`SpiecEasi`包实现SparCC，迭代估计真实相关性。\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# 检查SpiecEasi是否安装\nsparcc_available <- requireNamespace(\"SpiecEasi\", quietly = TRUE)\n\nif (!sparcc_available) {\n  cat(\"====== SparCC分析 ======\\n\\n\")\n  cat(\"SpiecEasi包未安装，跳过SparCC分析。\\n\")\n  cat(\"安装方法:\\n\")\n  cat(\"  # 从Bioconductor安装\\n\")\n  cat(\"  BiocManager::install('SpiecEasi')\\n\")\n  cat(\"\\n或从GitHub安装:\\n\")\n  cat(\"  devtools::install_github('zdk123/SpiecEasi')\\n\")\n} else {\n  cat(\"SpiecEasi包已安装，将进行SparCC分析。\\n\")\n}\n#> SpiecEasi包已安装，将进行SparCC分析。\n```\n:::\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nif (sparcc_available) {\n  library(SpiecEasi)\n\n  cat(\"\\n====== SparCC分析 ======\\n\\n\")\n\n  # 准备counts数据（SparCC需要整数counts）\n  # 使用原始counts而非相对丰度\n  bacteria_counts_filtered <- assay(tse_bacteria, \"counts\")\n\n  # 过滤低丰度物种\n  prevalence_counts <- rowSums(bacteria_counts_filtered > 0) / ncol(bacteria_counts_filtered)\n  bacteria_counts_filtered <- bacteria_counts_filtered[prevalence_counts >= 0.2, ]\n\n  # 取Top 50高丰度物种（SparCC计算密集）\n  mean_counts <- rowMeans(bacteria_counts_filtered)\n  top_species_sparcc <- names(sort(mean_counts, decreasing = TRUE))[1:min(50, length(mean_counts))]\n  bacteria_counts_sparcc <- bacteria_counts_filtered[top_species_sparcc, ]\n\n  cat(\"SparCC分析物种数:\", nrow(bacteria_counts_sparcc), \"\\n\")\n  cat(\"样本数:\", ncol(bacteria_counts_sparcc), \"\\n\\n\")\n\n  # 运行SparCC（使用较少迭代以节省时间）\n  cat(\"运行SparCC（这可能需要几分钟）...\\n\")\n\n  sparcc_result <- tryCatch({\n    SpiecEasi::sparcc(t(bacteria_counts_sparcc), iter = 20, inner_iter = 10)\n  }, error = function(e) {\n    cat(\"SparCC计算出错:\", conditionMessage(e), \"\\n\")\n    NULL\n  })\n\n  if (!is.null(sparcc_result)) {\n    sparcc_cor <- sparcc_result$Cor\n    rownames(sparcc_cor) <- rownames(bacteria_counts_sparcc)\n    colnames(sparcc_cor) <- rownames(bacteria_counts_sparcc)\n\n    cat(\"SparCC相关矩阵计算完成\\n\")\n    cat(\"相关系数范围:\", round(min(sparcc_cor), 3), \"到\", round(max(sparcc_cor[sparcc_cor < 1]), 3), \"\\n\")\n  }\n}\n#> \n#> ====== SparCC分析 ======\n#> \n#> SparCC分析物种数: 50 \n#> 样本数: 27 \n#> \n#> 运行SparCC（这可能需要几分钟）...\n#> SparCC相关矩阵计算完成\n#> 相关系数范围: -1 到 0.995\n```\n:::\n\n\n### 2.9.1 SparCC vs Spearman对比\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nif (exists(\"sparcc_cor\") && !is.null(sparcc_cor)) {\n  # 获取共同物种\n  common_species <- base::intersect(rownames(sparcc_cor), rownames(cor_matrix))\n\n  if (length(common_species) >= 10) {\n    sparcc_sub <- sparcc_cor[common_species, common_species]\n    spearman_sub <- cor_matrix[common_species, common_species]\n\n    # 提取上三角相关系数\n    sparcc_values <- sparcc_sub[upper.tri(sparcc_sub)]\n    spearman_values <- spearman_sub[upper.tri(spearman_sub)]\n\n    comparison_df <- data.frame(\n      Spearman = spearman_values,\n      SparCC = sparcc_values\n    )\n\n    # 相关性散点图\n    p_scatter <- ggplot(comparison_df, aes(x = Spearman, y = SparCC)) +\n      geom_point(alpha = 0.5, color = \"steelblue\") +\n      geom_abline(slope = 1, intercept = 0, linetype = \"dashed\", color = \"red\") +\n      geom_smooth(method = \"lm\", se = TRUE, color = \"darkblue\", linewidth = 0.8) +\n      labs(\n        title = \"SparCC vs Spearman Correlation\",\n        subtitle = sprintf(\"Pearson r = %.3f | %d species pairs\",\n                          cor(sparcc_values, spearman_values),\n                          length(sparcc_values)),\n        x = \"Spearman Correlation\",\n        y = \"SparCC Correlation\"\n      ) +\n      theme_bw(base_size = 12) +\n      theme(plot.title = element_text(face = \"bold\"))\n\n    # 差异分布\n    comparison_df$difference <- comparison_df$SparCC - comparison_df$Spearman\n\n    p_diff <- ggplot(comparison_df, aes(x = difference)) +\n      geom_histogram(binwidth = 0.05, fill = \"steelblue\", color = \"white\", alpha = 0.8) +\n      geom_vline(xintercept = 0, linetype = \"dashed\", color = \"red\") +\n      geom_vline(xintercept = mean(comparison_df$difference), color = \"darkblue\", linewidth = 1) +\n      annotate(\"text\", x = mean(comparison_df$difference), y = Inf, vjust = 2,\n               label = sprintf(\"Mean diff: %.3f\", mean(comparison_df$difference)),\n               color = \"darkblue\", fontface = \"bold\") +\n      labs(\n        title = \"SparCC - Spearman Difference\",\n        subtitle = \"Positive = SparCC shows stronger correlation\",\n        x = \"Difference (SparCC - Spearman)\",\n        y = \"Count\"\n      ) +\n      theme_bw(base_size = 12) +\n      theme(plot.title = element_text(face = \"bold\"))\n\n    print(p_scatter + p_diff)\n\n    ggsave(here::here(\"data\", params$name, \"11_sparcc_vs_spearman.png\"),\n           plot = p_scatter + p_diff, width = 12, height = 5, dpi = 300)\n\n    # 统计总结\n    cat(\"\\n====== SparCC vs Spearman 对比 ======\\n\\n\")\n    cat(\"共同物种数:\", length(common_species), \"\\n\")\n    cat(\"物种对数:\", length(sparcc_values), \"\\n\")\n    cat(\"Spearman-SparCC相关性:\", round(cor(sparcc_values, spearman_values), 4), \"\\n\")\n    cat(\"平均差异 (SparCC - Spearman):\", round(mean(comparison_df$difference), 4), \"\\n\")\n    cat(\"差异标准差:\", round(sd(comparison_df$difference), 4), \"\\n\")\n\n    # 分类比较\n    spearman_strong <- sum(abs(spearman_values) >= 0.7)\n    sparcc_strong <- sum(abs(sparcc_values) >= 0.7)\n    cat(\"\\n强相关 (|r| ≥ 0.7):\\n\")\n    cat(\"  Spearman:\", spearman_strong, \"\\n\")\n    cat(\"  SparCC:\", sparcc_strong, \"\\n\")\n  }\n}\n```\n\n::: {.cell-output-display}\n![](04_network_analysis_files/figure-html/part2-sparcc-comparison-1.png){fig-align='center' width=100%}\n:::\n\n```\n#> \n#> ====== SparCC vs Spearman 对比 ======\n#> \n#> 共同物种数: 50 \n#> 物种对数: 1225 \n#> Spearman-SparCC相关性: 0.924 \n#> 平均差异 (SparCC - Spearman): -0.0503 \n#> 差异标准差: 0.1758 \n#> \n#> 强相关 (|r| ≥ 0.7):\n#>   Spearman: 138 \n#>   SparCC: 168\n```\n:::\n\n\n### 2.9.2 SparCC网络构建\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nif (exists(\"sparcc_cor\") && !is.null(sparcc_cor)) {\n  # 使用相同阈值构建SparCC网络\n  sparcc_threshold <- 0.5  # SparCC通常使用较低阈值\n\n  sparcc_adj <- abs(sparcc_cor) >= sparcc_threshold\n  diag(sparcc_adj) <- FALSE\n\n  g_sparcc <- igraph::graph_from_adjacency_matrix(sparcc_adj, mode = \"undirected\")\n\n  # 添加边权重\n  if (igraph::ecount(g_sparcc) > 0) {\n    edge_list_sp <- igraph::as_edgelist(g_sparcc)\n    edge_weights_sp <- sapply(1:nrow(edge_list_sp), function(i) {\n      sparcc_cor[edge_list_sp[i,1], edge_list_sp[i,2]]\n    })\n    igraph::E(g_sparcc)$weight <- edge_weights_sp\n    igraph::E(g_sparcc)$sign <- ifelse(edge_weights_sp > 0, \"positive\", \"negative\")\n  }\n\n  cat(\"\\n====== SparCC网络统计 ======\\n\\n\")\n  cat(\"相关性阈值:\", sparcc_threshold, \"\\n\")\n  cat(\"节点数:\", igraph::vcount(g_sparcc), \"\\n\")\n  cat(\"边数:\", igraph::ecount(g_sparcc), \"\\n\")\n\n  if (igraph::ecount(g_sparcc) > 0) {\n    pos_edges <- sum(igraph::E(g_sparcc)$sign == \"positive\")\n    neg_edges <- sum(igraph::E(g_sparcc)$sign == \"negative\")\n    cat(\"正相关边:\", pos_edges, sprintf(\"(%.1f%%)\", 100*pos_edges/igraph::ecount(g_sparcc)), \"\\n\")\n    cat(\"负相关边:\", neg_edges, sprintf(\"(%.1f%%)\", 100*neg_edges/igraph::ecount(g_sparcc)), \"\\n\")\n\n    # 与Spearman网络比较\n    cat(\"\\n与Spearman网络对比:\\n\")\n    cat(\"  Spearman网络边数:\", igraph::ecount(g_all), \"\\n\")\n    cat(\"  SparCC网络边数:\", igraph::ecount(g_sparcc), \"\\n\")\n\n    # 可视化\n    if (igraph::ecount(g_sparcc) < 300) {\n      set.seed(42)\n      layout_sparcc <- igraph::layout_with_fr(g_sparcc)\n\n      igraph::V(g_sparcc)$size <- igraph::degree(g_sparcc) + 3\n      igraph::E(g_sparcc)$color <- ifelse(igraph::E(g_sparcc)$sign == \"positive\",\n                                           \"#3498db\", \"#e74c3c\")\n\n      par(mar = c(1, 1, 3, 1))\n      plot(g_sparcc,\n           layout = layout_sparcc,\n           vertex.label = NA,\n           vertex.color = \"lightgray\",\n           edge.width = abs(igraph::E(g_sparcc)$weight) * 2,\n           main = sprintf(\"SparCC Network (threshold ≥ %.2f)\\nNodes: %d | Edges: %d | Blue=Positive, Red=Negative\",\n                         sparcc_threshold, igraph::vcount(g_sparcc), igraph::ecount(g_sparcc)))\n    }\n\n    # 保存SparCC相关矩阵\n    write.csv(as.data.frame(sparcc_cor),\n              file = here::here(\"data\", params$name, \"12_sparcc_correlation_matrix.csv\"))\n\n    # 保存网络统计\n    sparcc_stats <- data.frame(\n      method = c(\"Spearman\", \"SparCC\"),\n      threshold = c(cor_threshold, sparcc_threshold),\n      n_nodes = c(igraph::vcount(g_all), igraph::vcount(g_sparcc)),\n      n_edges = c(igraph::ecount(g_all), igraph::ecount(g_sparcc)),\n      density = c(igraph::edge_density(g_all), igraph::edge_density(g_sparcc))\n    )\n\n    write.csv(sparcc_stats,\n              file = here::here(\"data\", params$name, \"13_spearman_vs_sparcc_stats.csv\"),\n              row.names = FALSE)\n\n    cat(\"\\nSparCC结果已保存\\n\")\n  }\n}\n#> \n#> ====== SparCC网络统计 ======\n#> \n#> 相关性阈值: 0.5 \n#> 节点数: 50 \n#> 边数: 409 \n#> 正相关边: 242 (59.2%) \n#> 负相关边: 167 (40.8%) \n#> \n#> 与Spearman网络对比:\n#>   Spearman网络边数: 530 \n#>   SparCC网络边数: 409 \n#> \n#> SparCC结果已保存\n```\n:::\n\n\n# Part 3: 细菌-噬菌体跨域网络 {#sec-part3}\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nif (has_phage) {\n  cat(\"\\n====== 细菌-噬菌体跨域网络分析 ======\\n\\n\")\n\n  # 获取共同样本的数据\n  bacteria_common <- bacteria_relab[, common_samples]\n  phage_counts <- assay(tse_phage[, common_samples], \"counts\")\n\n  # 过滤噬菌体\n  phage_prev <- rowSums(phage_counts > 0) / ncol(phage_counts)\n  phage_filtered <- phage_counts[phage_prev >= 0.2, ]\n  phage_relab <- sweep(phage_filtered, 2, colSums(phage_filtered) + 1, \"/\")\n\n  cat(\"过滤后细菌数:\", nrow(bacteria_common), \"\\n\")\n  cat(\"过滤后噬菌体数:\", nrow(phage_filtered), \"\\n\")\n\n  # 计算细菌-噬菌体相关性\n  cross_cor <- cor(t(bacteria_common), t(phage_relab), method = \"spearman\")\n\n  cat(\"跨域相关矩阵维度:\", dim(cross_cor), \"\\n\")\n\n  # 识别显著关联\n  cross_threshold <- 0.5\n  sig_pairs <- which(abs(cross_cor) >= cross_threshold, arr.ind = TRUE)\n\n  if (nrow(sig_pairs) > 0) {\n    cross_pairs_df <- data.frame(\n      bacteria = rownames(cross_cor)[sig_pairs[,1]],\n      phage = colnames(cross_cor)[sig_pairs[,2]],\n      correlation = sapply(1:nrow(sig_pairs), function(i) {\n        cross_cor[sig_pairs[i,1], sig_pairs[i,2]]\n      })\n    ) %>%\n      arrange(desc(abs(correlation)))\n\n    cat(\"\\nTop 20 细菌-噬菌体关联:\\n\\n\")\n    print(head(cross_pairs_df, 20))\n\n    write.csv(cross_pairs_df,\n              file = here::here(\"data\", params$name, \"14_bacteria_phage_associations.csv\"),\n              row.names = FALSE)\n  } else {\n    cat(\"未发现显著的细菌-噬菌体关联 (阈值:\", cross_threshold, \")\\n\")\n  }\n}\n#> \n#> ====== 细菌-噬菌体跨域网络分析 ======\n#> \n#> 过滤后细菌数: 100 \n#> 过滤后噬菌体数: 571 \n#> 跨域相关矩阵维度: 100 571 \n#> \n#> Top 20 细菌-噬菌体关联:\n#> \n#>                           bacteria   phage correlation\n#> 1              Wansuia hejianensis OTU_117  -0.9833333\n#> 2  Pseudoflavonifractor gallinarum OTU_354   0.9833333\n#> 3        Mediterraneibacter gnavus OTU_412   0.9833333\n#> 4                 Blautia wexlerae OTU_429   0.9833333\n#> 5             Sporofaciens musculi OTU_493   0.9833333\n#> 6         Sodaliphilus pleomorphus OTU_565   0.9833333\n#> 7                Dorea longicatena  OTU_64   0.9790881\n#> 8         Oscillibacter sp. PEA192   OTU_4  -0.9666667\n#> 9            Enterococcus faecalis OTU_146   0.9666667\n#> 10           Enterococcus faecalis OTU_412   0.9666667\n#> 11           Clostridium sp. M62/1 OTU_446  -0.9666667\n#> 12        Sodaliphilus pleomorphus OTU_447   0.9666667\n#> 13       Mediterraneibacter gnavus OTU_464   0.9666667\n#> 14           Clostridium sp. M62/1 OTU_464   0.9666667\n#> 15          [Clostridium] innocuum OTU_465   0.9666667\n#> 16    Faecalibacterium prausnitzii OTU_465   0.9666667\n#> 17        Enterocloster lavalensis OTU_465   0.9666667\n#> 18          [Clostridium] scindens OTU_561  -0.9666667\n#> 19             Claveliimonas bilis  OTU_64   0.9623515\n#> 20            Sporofaciens musculi OTU_289   0.9623515\n```\n:::\n\n\n# Part 4: 细菌-噬菌体网络结构对比 {#sec-part4}\n\n## 4.1 构建分组网络\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nif (has_phage) {\n  cat(\"\\n====== Part 4: 细菌-噬菌体网络对比 ======\\n\")\n\n  # 定义网络构建函数\n  build_network_for_group <- function(tse, samples, top_n = 50, cor_threshold = 0.6) {\n    counts <- assay(tse, \"counts\")[, samples, drop = FALSE]\n    grp_relab <- sweep(counts, 2, colSums(counts) + 1, \"/\")\n\n    row_sds <- apply(grp_relab, 1, sd)\n    grp_relab <- grp_relab[row_sds > 0, , drop = FALSE]\n\n    n_species <- min(top_n, nrow(grp_relab))\n    mean_abund <- rowMeans(grp_relab)\n    top_species_net <- names(sort(mean_abund, decreasing = TRUE))[1:n_species]\n    grp_relab <- grp_relab[top_species_net, , drop = FALSE]\n\n    cor_mat <- cor(t(grp_relab), method = \"spearman\")\n    cor_mat[is.na(cor_mat)] <- 0\n\n    adj_mat <- abs(cor_mat) >= cor_threshold\n    diag(adj_mat) <- FALSE\n\n    g <- igraph::graph_from_adjacency_matrix(adj_mat, mode = \"undirected\")\n\n    if (igraph::ecount(g) > 0) {\n      comm <- igraph::cluster_louvain(g)\n      mod <- igraph::modularity(comm)\n    } else {\n      mod <- 0\n    }\n\n    return(list(\n      n_nodes = igraph::vcount(g),\n      n_edges = igraph::ecount(g),\n      modularity = mod,\n      graph = g\n    ))\n  }\n\n  # 获取样本分组\n  phage_meta <- as.data.frame(colData(tse_phage))\n  phage_hpko <- rownames(phage_meta)[phage_meta$treatment_group == \"ApcMUT_HpKO\"]\n  phage_hpwt <- rownames(phage_meta)[phage_meta$treatment_group == \"ApcMUT_HpWT\"]\n\n  # 构建网络\n  cat(\"构建细菌网络...\\n\")\n  bact_net_hpko <- build_network_for_group(tse_bacteria,\n                                            rownames(metadata)[metadata$treatment_group == \"ApcMUT_HpKO\"])\n  bact_net_hpwt <- build_network_for_group(tse_bacteria,\n                                            rownames(metadata)[metadata$treatment_group == \"ApcMUT_HpWT\"])\n\n  cat(\"构建噬菌体网络...\\n\")\n  phage_net_hpko <- build_network_for_group(tse_phage, phage_hpko)\n  phage_net_hpwt <- build_network_for_group(tse_phage, phage_hpwt)\n\n  # 汇总统计\n  bact_phage_stats_df <- data.frame(\n    data_type = c(\"Bacteria\", \"Bacteria\", \"Phage\", \"Phage\"),\n    group = c(\"Control (HpKO)\", \"CagA+ (HpWT)\", \"Control (HpKO)\", \"CagA+ (HpWT)\"),\n    group_short = c(\"Control\", \"CagA+\", \"Control\", \"CagA+\"),\n    nodes = c(bact_net_hpko$n_nodes, bact_net_hpwt$n_nodes,\n              phage_net_hpko$n_nodes, phage_net_hpwt$n_nodes),\n    edges = c(bact_net_hpko$n_edges, bact_net_hpwt$n_edges,\n              phage_net_hpko$n_edges, phage_net_hpwt$n_edges),\n    modularity = c(bact_net_hpko$modularity, bact_net_hpwt$modularity,\n                   phage_net_hpko$modularity, phage_net_hpwt$modularity)\n  )\n\n  print(bact_phage_stats_df)\n\n  # 计算变化百分比\n  bact_mod_change <- (bact_net_hpwt$modularity - bact_net_hpko$modularity) /\n                     bact_net_hpko$modularity * 100\n\n  phage_mod_change <- (phage_net_hpwt$modularity - phage_net_hpko$modularity) /\n                      phage_net_hpko$modularity * 100\n\n  cat(\"\\n细菌网络模块度变化:\", round(bact_mod_change, 1), \"%\\n\")\n  cat(\"噬菌体网络模块度变化:\", round(phage_mod_change, 1), \"%\\n\")\n\n  write.csv(bact_phage_stats_df,\n            file = here::here(\"data\", params$name, \"15_bacteria_phage_network_stats.csv\"),\n            row.names = FALSE)\n}\n#> \n#> ====== Part 4: 细菌-噬菌体网络对比 ======\n#> 构建细菌网络...\n#> 构建噬菌体网络...\n#>   data_type          group group_short nodes edges modularity\n#> 1  Bacteria Control (HpKO)     Control    50   511  0.4325026\n#> 2  Bacteria   CagA+ (HpWT)       CagA+    50   512  0.1595383\n#> 3     Phage Control (HpKO)     Control    50   593  0.3647259\n#> 4     Phage   CagA+ (HpWT)       CagA+    50   381  0.2553613\n#> \n#> 细菌网络模块度变化: -63.1 %\n#> 噬菌体网络模块度变化: -30 %\n```\n:::\n\n\n## 4.2 模块度对比可视化\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nif (has_phage) {\n  bact_phage_stats_df$group_short <- factor(bact_phage_stats_df$group_short,\n                                             levels = c(\"Control\", \"CagA+\"))\n  bact_phage_stats_df$data_type <- factor(bact_phage_stats_df$data_type,\n                                           levels = c(\"Bacteria\", \"Phage\"))\n\n  p_modularity_comparison <- ggplot(bact_phage_stats_df,\n                                     aes(x = group_short, y = modularity, fill = group_short)) +\n    geom_col(width = 0.6, alpha = 0.85) +\n    geom_text(aes(label = sprintf(\"%.3f\", modularity)), vjust = -0.5, size = 4.5, fontface = \"bold\") +\n    facet_wrap(~data_type) +\n    scale_fill_manual(values = c(\"Control\" = \"#3498db\", \"CagA+\" = \"#e74c3c\")) +\n    scale_y_continuous(limits = c(0, max(bact_phage_stats_df$modularity) * 1.2)) +\n    labs(\n      title = \"Network Modularity: Bacteria vs Phage\",\n      subtitle = sprintf(\"Both show change under CagA (Bacteria: %.0f%%, Phage: %.0f%%)\",\n                         bact_mod_change, phage_mod_change),\n      x = NULL,\n      y = \"Modularity\",\n      fill = \"Group\"\n    ) +\n    theme_bw(base_size = 12) +\n    theme(\n      plot.title = element_text(face = \"bold\", size = 14),\n      plot.subtitle = element_text(size = 11, color = \"gray30\"),\n      legend.position = \"none\",\n      strip.background = element_rect(fill = \"gray90\"),\n      strip.text = element_text(face = \"bold\", size = 12)\n    )\n\n  print(p_modularity_comparison)\n\n  ggsave(\n    filename = here::here(\"data\", params$name, \"16_bacteria_phage_modularity_comparison.png\"),\n    plot = p_modularity_comparison,\n    width = 8, height = 5, dpi = 300\n  )\n}\n```\n\n::: {.cell-output-display}\n![](04_network_analysis_files/figure-html/part4-modularity-comparison-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\n## 4.3 2x2 网络可视化\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nif (has_phage) {\n  get_colors <- function(n) {\n    if (n <= 8) {\n      return(c(\"#e74c3c\", \"#3498db\", \"#2ecc71\", \"#f39c12\", \"#9b59b6\", \"#1abc9c\", \"#e67e22\", \"#34495e\")[1:n])\n    } else {\n      return(rainbow(n, s = 0.7, v = 0.8))\n    }\n  }\n\n  png(here::here(\"data\", params$name, \"17_bacteria_phage_network_2x2.png\"),\n      width = 1600, height = 1600, res = 150)\n\n  par(mfrow = c(2, 2), mar = c(1, 1, 4, 1))\n\n  set.seed(42)\n\n  # --- 细菌 Control ---\n  g <- bact_net_hpko$graph\n  if (igraph::ecount(g) > 0) {\n    comm <- igraph::cluster_louvain(g)\n    igraph::V(g)$community <- igraph::membership(comm)\n    n_comm <- max(igraph::V(g)$community)\n    colors <- get_colors(n_comm)[igraph::V(g)$community]\n    igraph::V(g)$degree <- igraph::degree(g)\n    layout_bact <- igraph::layout_with_fr(g)\n\n    plot(g,\n         layout = layout_bact,\n         vertex.color = colors,\n         vertex.size = 3 + sqrt(igraph::V(g)$degree) * 2,\n         vertex.label = NA,\n         edge.color = rgb(0.5, 0.5, 0.5, 0.3),\n         edge.width = 0.5,\n         main = sprintf(\"Bacteria - Control (HpKO)\\nEdges: %d | Modularity: %.3f\",\n                        bact_net_hpko$n_edges, bact_net_hpko$modularity))\n  }\n\n  # --- 细菌 CagA+ ---\n  g <- bact_net_hpwt$graph\n  if (igraph::ecount(g) > 0) {\n    comm <- igraph::cluster_louvain(g)\n    igraph::V(g)$community <- igraph::membership(comm)\n    n_comm <- max(igraph::V(g)$community)\n    colors <- get_colors(n_comm)[igraph::V(g)$community]\n    igraph::V(g)$degree <- igraph::degree(g)\n\n    plot(g,\n         layout = layout_bact,\n         vertex.color = colors,\n         vertex.size = 3 + sqrt(igraph::V(g)$degree) * 2,\n         vertex.label = NA,\n         edge.color = rgb(0.5, 0.5, 0.5, 0.3),\n         edge.width = 0.5,\n         main = sprintf(\"Bacteria - CagA+ (HpWT)\\nEdges: %d | Modularity: %.3f\",\n                        bact_net_hpwt$n_edges, bact_net_hpwt$modularity))\n  }\n\n  set.seed(42)\n\n  # --- 噬菌体 Control ---\n  g <- phage_net_hpko$graph\n  if (igraph::ecount(g) > 0) {\n    comm <- igraph::cluster_louvain(g)\n    igraph::V(g)$community <- igraph::membership(comm)\n    n_comm <- max(igraph::V(g)$community)\n    colors <- get_colors(n_comm)[igraph::V(g)$community]\n    igraph::V(g)$degree <- igraph::degree(g)\n    layout_phage <- igraph::layout_with_fr(g)\n\n    plot(g,\n         layout = layout_phage,\n         vertex.color = colors,\n         vertex.size = 3 + sqrt(igraph::V(g)$degree) * 2,\n         vertex.label = NA,\n         edge.color = rgb(0.5, 0.5, 0.5, 0.3),\n         edge.width = 0.5,\n         main = sprintf(\"Phage - Control (HpKO)\\nEdges: %d | Modularity: %.3f\",\n                        phage_net_hpko$n_edges, phage_net_hpko$modularity))\n  }\n\n  # --- 噬菌体 CagA+ ---\n  g <- phage_net_hpwt$graph\n  if (igraph::ecount(g) > 0) {\n    comm <- igraph::cluster_louvain(g)\n    igraph::V(g)$community <- igraph::membership(comm)\n    n_comm <- max(igraph::V(g)$community)\n    colors <- get_colors(n_comm)[igraph::V(g)$community]\n    igraph::V(g)$degree <- igraph::degree(g)\n\n    plot(g,\n         layout = layout_phage,\n         vertex.color = colors,\n         vertex.size = 3 + sqrt(igraph::V(g)$degree) * 2,\n         vertex.label = NA,\n         edge.color = rgb(0.5, 0.5, 0.5, 0.3),\n         edge.width = 0.5,\n         main = sprintf(\"Phage - CagA+ (HpWT)\\nEdges: %d | Modularity: %.3f\",\n                        phage_net_hpwt$n_edges, phage_net_hpwt$modularity))\n  }\n\n  dev.off()\n\n  cat(\"2x2 网络对比图已保存: 17_bacteria_phage_network_2x2.png\\n\")\n}\n#> 2x2 网络对比图已保存: 17_bacteria_phage_network_2x2.png\n```\n:::\n\n\n# Part 5: 结果汇总 {#sec-part5}\n\n## 5.1 关键发现\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncat(\"\\n## 细菌网络\\n\\n\")\n```\n\n\n## 细菌网络\n\n```{.r .cell-code}\nif (exists(\"g_all\") && igraph::ecount(g_all) > 0) {\n  cat(sprintf(\"- 全样本网络: %d节点, %d边\\n\", igraph::vcount(g_all), igraph::ecount(g_all)))\n  pos_edges <- sum(igraph::E(g_all)$sign == \"positive\", na.rm = TRUE)\n  neg_edges <- sum(igraph::E(g_all)$sign == \"negative\", na.rm = TRUE)\n  cat(sprintf(\"- 正相关边: %d (%.1f%%), 负相关边: %d (%.1f%%)\\n\",\n              pos_edges, 100*pos_edges/igraph::ecount(g_all),\n              neg_edges, 100*neg_edges/igraph::ecount(g_all)))\n}\n```\n\n- 全样本网络: 100节点, 530边\n- 正相关边: 498 (94.0%), 负相关边: 32 (6.0%)\n\n```{.r .cell-code}\n\nif (exists(\"hub_df\") && nrow(hub_df) > 0) {\n  cat(\"\\n## Hub物种 (Top 5)\\n\\n\")\n  for (i in 1:min(5, nrow(hub_df))) {\n    cat(sprintf(\"%d. %s (度=%d)\\n\", i, hub_df$species[i], hub_df$degree[i]))\n  }\n}\n```\n\n\n## Hub物种 (Top 5)\n\n1. Marvinbryantia formatexigens (度=30)\n2. Blautia parvula (度=29)\n3. Sellimonas catena (度=28)\n4. Agathobacter rectalis (度=27)\n5. Hungatella hathewayi (度=26)\n\n```{.r .cell-code}\n\nif (exists(\"g_robust\") && igraph::ecount(g_robust) > 0) {\n  cat(\"\\n## Bootstrap稳健网络\\n\\n\")\n  cat(sprintf(\"- 稳定性阈值: %.0f%%\\n\", stability_threshold * 100))\n  cat(sprintf(\"- 稳健边数: %d (原始边数: %d)\\n\", igraph::ecount(g_robust), igraph::ecount(g_all)))\n  cat(sprintf(\"- 边保留率: %.1f%%\\n\", 100 * igraph::ecount(g_robust) / max(igraph::ecount(g_all), 1)))\n}\n```\n\n\n## Bootstrap稳健网络\n\n- 稳定性阈值: 70%\n- 稳健边数: 379 (原始边数: 530)\n- 边保留率: 71.5%\n\n```{.r .cell-code}\n\nif (exists(\"zi_pi_df\") && nrow(zi_pi_df) > 0) {\n  cat(\"\\n## Keystone Species (Zi-Pi分析)\\n\\n\")\n  role_counts <- table(zi_pi_df$role)\n  cat(sprintf(\"- Module hubs: %d\\n\", role_counts[\"Module hub\"] %||% 0))\n  cat(sprintf(\"- Network hubs: %d\\n\", role_counts[\"Network hub\"] %||% 0))\n  cat(sprintf(\"- Connectors: %d\\n\", role_counts[\"Connector\"] %||% 0))\n  cat(sprintf(\"- Peripherals: %d\\n\", role_counts[\"Peripheral\"] %||% 0))\n}\n```\n\n\n## Keystone Species (Zi-Pi分析)\n\n- Module hubs: 0\n- Network hubs: 0\n- Connectors: 0\n- Peripherals: 100\n\n```{.r .cell-code}\n\nif (exists(\"sparcc_available\") && sparcc_available && exists(\"g_sparcc\")) {\n  cat(\"\\n## SparCC组成型数据网络\\n\\n\")\n  cat(sprintf(\"- SparCC网络边数: %d\\n\", igraph::ecount(g_sparcc)))\n  cat(sprintf(\"- Spearman网络边数: %d\\n\", igraph::ecount(g_all)))\n  cat(\"- 方法改进: 校正组成型数据假性负相关\\n\")\n}\n```\n\n\n## SparCC组成型数据网络\n\n- SparCC网络边数: 409\n- Spearman网络边数: 530\n- 方法改进: 校正组成型数据假性负相关\n\n```{.r .cell-code}\n\nif (exists(\"network_stats_df\") && nrow(network_stats_df) >= 2) {\n  cat(\"\\n## 网络拓扑比较: CagA效应\\n\\n\")\n\n  if (\"ApcMUT_HpWT\" %in% network_stats_df$group && \"ApcMUT_HpKO\" %in% network_stats_df$group) {\n    hpwt <- network_stats_df[network_stats_df$group == \"ApcMUT_HpWT\", ]\n    hpko <- network_stats_df[network_stats_df$group == \"ApcMUT_HpKO\", ]\n\n    cat(\"| 指标 | HpKO (对照) | HpWT (CagA+) | 变化 |\\n\")\n    cat(\"|------|-------------|--------------|------|\\n\")\n    cat(sprintf(\"| 边数 | %d | %d | %+d |\\n\",\n                hpko$n_edges, hpwt$n_edges, hpwt$n_edges - hpko$n_edges))\n    cat(sprintf(\"| 密度 | %.4f | %.4f | %+.4f |\\n\",\n                hpko$density, hpwt$density, hpwt$density - hpko$density))\n    cat(sprintf(\"| 模块度 | %.4f | %.4f | %+.4f |\\n\",\n                hpko$modularity, hpwt$modularity,\n                hpwt$modularity - hpko$modularity))\n  }\n}\n```\n\n\n## 网络拓扑比较: CagA效应\n\n| 指标 | HpKO (对照) | HpWT (CagA+) | 变化 |\n|------|-------------|--------------|------|\n| 边数 | 416 | 360 | -56 |\n| 密度 | 0.3396 | 0.2939 | -0.0457 |\n| 模块度 | 0.3932 | 0.2367 | -0.1565 |\n\n```{.r .cell-code}\n\ncat(\"\\n## 后续分析建议\\n\\n\")\n```\n\n\n## 后续分析建议\n\n```{.r .cell-code}\ncat(\"1. 差异网络分析（NetShift）量化组间网络重构\\n\")\n```\n\n1. 差异网络分析（NetShift）量化组间网络重构\n\n```{.r .cell-code}\ncat(\"2. 整合功能数据进行三方网络分析\\n\")\n```\n\n2. 整合功能数据进行三方网络分析\n\n```{.r .cell-code}\ncat(\"3. 网络稳健性分析（节点移除模拟）\\n\")\n```\n\n3. 网络稳健性分析（节点移除模拟）\n:::\n\n\n## 5.2 输出文件列表\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncat(\"\\n分析结果已保存:\\n\")\n#> \n#> 分析结果已保存:\ncat(\"  - 01_bacteria_network_stats.csv\\n\")\n#>   - 01_bacteria_network_stats.csv\ncat(\"  - 02_network_comparison.png\\n\")\n#>   - 02_network_comparison.png\ncat(\"  - 03_network_stats_barplot.png\\n\")\n#>   - 03_network_stats_barplot.png\ncat(\"  - 04_bacteria_hub_species.csv\\n\")\n#>   - 04_bacteria_hub_species.csv\ncat(\"  - 05_edge_stability_distribution.png\\n\")\n#>   - 05_edge_stability_distribution.png\ncat(\"  - 06_robust_hub_species.csv\\n\")\n#>   - 06_robust_hub_species.csv\ncat(\"  - 07_zi_pi_analysis.csv\\n\")\n#>   - 07_zi_pi_analysis.csv\ncat(\"  - 08_zi_pi_plot.png\\n\")\n#>   - 08_zi_pi_plot.png\ncat(\"  - 09_zi_pi_by_group.png\\n\")\n#>   - 09_zi_pi_by_group.png\ncat(\"  - 10_zi_pi_by_group.csv\\n\")\n#>   - 10_zi_pi_by_group.csv\nif (sparcc_available && exists(\"sparcc_cor\")) {\n  cat(\"  - 11_sparcc_vs_spearman.png\\n\")\n  cat(\"  - 12_sparcc_correlation_matrix.csv\\n\")\n  cat(\"  - 13_spearman_vs_sparcc_stats.csv\\n\")\n}\n#>   - 11_sparcc_vs_spearman.png\n#>   - 12_sparcc_correlation_matrix.csv\n#>   - 13_spearman_vs_sparcc_stats.csv\nif (has_phage) {\n  cat(\"  - 14_bacteria_phage_associations.csv\\n\")\n  cat(\"  - 15_bacteria_phage_network_stats.csv\\n\")\n  cat(\"  - 16_bacteria_phage_modularity_comparison.png\\n\")\n  cat(\"  - 17_bacteria_phage_network_2x2.png\\n\")\n}\n#>   - 14_bacteria_phage_associations.csv\n#>   - 15_bacteria_phage_network_stats.csv\n#>   - 16_bacteria_phage_modularity_comparison.png\n#>   - 17_bacteria_phage_network_2x2.png\n```\n:::\n\n\n---\n\n## Files written\n\nThese files have been written to the target directory, data/04_network_analysis:\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncat(\"\\n【分析环境信息】\\n\")\n#> \n#> 【分析环境信息】\ncat(\"R版本:\", R.version.string, \"\\n\")\n#> R版本: R version 4.5.2 (2025-10-31 ucrt)\ncat(\"分析日期:\", format(Sys.time(), \"%Y-%m-%d %H:%M:%S\"), \"\\n\")\n#> 分析日期: 2026-01-28 05:14:24\n```\n:::\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}