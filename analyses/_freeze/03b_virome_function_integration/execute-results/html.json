{
  "hash": "d41dfa43fa4be4aecc62d9a45b06e4f3",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"03b_virome_function_integration\"\ntitle-block-banner: true\nauthor: Gong Yuhang\ndate: \"2026-01-10\"\ntoc: true\ntoc-depth: 4\nnumber-sections: true\ncode-fold: true\ncode-line-numbers: true\ncode-tools: true\nformat:\n  html:\n    embed-resources: true\n    smooth-scroll: true\n    page-layout: full\n    theme: cosmo\nreference-location: section\ncitation-location: document\nparams:\n  name: \"03b_virome_function_integration\"\n---\n\n**Updated: 2026-01-20 13:31:07 CET.**\n\n本文档是项目 pc047 (vCagAepitope) 的 **病毒组-功能整合分析** 模块。\n\n**分析目的**：\n整合 03 分析（SingleM/Lyrebird）和 02 分析（HUMAnN功能）的结果，探索：\n\n1. **噬菌体-功能关联**：噬菌体OTU丰度与KO/Pathway丰度的相关性\n2. **三角互作网络**：细菌-噬菌体-功能的联合分析\n\n**科学意义**：\n噬菌体通过裂解/溶原影响细菌群落，可能间接调控菌群的代谢功能。这类分析在肿瘤微生物组研究中较为少见。\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsuppressPackageStartupMessages({\n  library(here)\n  library(conflicted)\n  library(tidyverse)\n  library(data.table)\n  library(mia)\n  library(TreeSummarizedExperiment)\n  library(patchwork)\n  library(ggplot2)\n  library(pheatmap)\n  library(vegan)\n  library(igraph)\n  library(ggraph)\n  library(Hmisc)  # OMA风格：高效相关性计算\n  devtools::load_all()\n})\n\n# 解决命名空间冲突\nconflicts_prefer(base::setdiff)\nconflicts_prefer(dplyr::filter)\nconflicts_prefer(dplyr::select)\nconflicts_prefer(dplyr::lag)\nconflicts_prefer(dplyr::first)\nconflicts_prefer(dplyr::left_join)\nconflicts_prefer(base::intersect)\n\nset.seed(20261)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================================================================\n# OMA风格辅助函数：跨矩阵Spearman相关性计算\n# ==============================================================================\n\n#' 计算两个矩阵之间的Spearman相关性（向量化）\n#'\n#' @param mat_x 矩阵X (样本×特征A)\n#' @param mat_y 矩阵Y (样本×特征B)，样本数需与mat_x一致\n#' @return 列表包含：r (相关系数矩阵), P (p值矩阵), n (样本数)\ncross_rcorr <- function(mat_x, mat_y) {\n  # 确保行数（样本数）一致\n  stopifnot(nrow(mat_x) == nrow(mat_y))\n\n  n <- nrow(mat_x)\n  nx <- ncol(mat_x)\n  ny <- ncol(mat_y)\n\n  # 合并矩阵后使用Hmisc::rcorr\n  combined <- cbind(mat_x, mat_y)\n  rcorr_result <- rcorr(as.matrix(combined), type = \"spearman\")\n\n  # 提取跨矩阵部分\n  r_matrix <- rcorr_result$r[1:nx, (nx+1):(nx+ny)]\n  p_matrix <- rcorr_result$P[1:nx, (nx+1):(nx+ny)]\n\n  # 恢复行列名\n  rownames(r_matrix) <- colnames(mat_x)\n  colnames(r_matrix) <- colnames(mat_y)\n  rownames(p_matrix) <- colnames(mat_x)\n  colnames(p_matrix) <- colnames(mat_y)\n\n  list(r = r_matrix, P = p_matrix, n = n)\n}\n\n#' 将相关性结果转换为长格式数据框\n#'\n#' @param cor_result cross_rcorr()的返回值\n#' @param name_x X矩阵特征名称列名\n#' @param name_y Y矩阵特征名称列名\n#' @return 数据框包含：feature_x, feature_y, correlation, pvalue, qvalue, abs_cor\ncorr_to_df <- function(cor_result, name_x = \"feature_x\", name_y = \"feature_y\") {\n  df <- expand.grid(\n    feature_x = rownames(cor_result$r),\n    feature_y = colnames(cor_result$r),\n    stringsAsFactors = FALSE\n  )\n  names(df)[1:2] <- c(name_x, name_y)\n\n  df$correlation <- as.vector(cor_result$r)\n  df$pvalue <- as.vector(cor_result$P)\n  df$qvalue <- p.adjust(df$pvalue, method = \"BH\")\n  df$abs_cor <- abs(df$correlation)\n\n  df\n}\n\n#' 从相关性结果创建网络边\n#'\n#' @param cor_result cross_rcorr()的返回值\n#' @param cor_threshold 相关系数绝对值阈值\n#' @param fdr_threshold FDR阈值\n#' @param edge_type 边类型标签\n#' @return 边数据框\ncorr_to_edges <- function(cor_result, cor_threshold = 0.5, fdr_threshold = 0.25, edge_type = \"Association\") {\n  df <- corr_to_df(cor_result)\n\n  df |>\n    dplyr::filter(abs_cor > cor_threshold, qvalue < fdr_threshold) |>\n    transmute(\n      from = .data[[names(df)[1]]],\n      to = .data[[names(df)[2]]],\n      weight = correlation,\n      type = edge_type\n    )\n}\n```\n:::\n\n\n# Part 1: 数据导入\n\n从 02 和 03 分析的产出读取预处理好的数据。\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncat(\"=== 数据导入 ===\\n\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n=== 数据导入 ===\n```\n\n\n:::\n\n```{.r .cell-code}\n# ------------------------------------------------------------------------------\n# 从 02 分析导入功能数据\n# ------------------------------------------------------------------------------\ntse_ko <- readRDS(here::here(\"data\", \"02_functional_profiling\", \"tse_ko_corepair.rds\"))\ntse_pathway <- readRDS(here::here(\"data\", \"02_functional_profiling\", \"tse_humann_pathway_corepair.rds\"))\n\ncat(\"02 分析数据:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n02 分析数据:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  KO TSE: \", ncol(tse_ko), \" 样本, \", nrow(tse_ko), \" KOs\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  KO TSE:  9  样本,  3947  KOs\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  Pathway TSE: \", ncol(tse_pathway), \" 样本, \", nrow(tse_pathway), \" Pathways\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Pathway TSE:  9  样本,  640  Pathways\n```\n\n\n:::\n\n```{.r .cell-code}\n# ------------------------------------------------------------------------------\n# 从 03 分析导入噬菌体和细菌数据\n# ------------------------------------------------------------------------------\ntse_lyrebird <- readRDS(here::here(\"data\", \"03_singlem_diversity_analysis\", \"tse_lyrebird_corepair.rds\"))\ntse_singlem <- readRDS(here::here(\"data\", \"03_singlem_diversity_analysis\", \"tse_singlem_corepair.rds\"))\n\ncat(\"\\n03 分析数据:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n03 分析数据:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  Lyrebird (噬菌体) TSE: \", ncol(tse_lyrebird), \" 样本, \", nrow(tse_lyrebird), \" OTUs\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Lyrebird (噬菌体) TSE:  9  样本,  878  OTUs\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  SingleM (细菌) TSE: \", ncol(tse_singlem), \" 样本, \", nrow(tse_singlem), \" OTUs\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  SingleM (细菌) TSE:  9  样本,  465  OTUs\n```\n\n\n:::\n\n```{.r .cell-code}\n# ------------------------------------------------------------------------------\n# 找到共同样本\n# ------------------------------------------------------------------------------\ncommon_samples <- Reduce(intersect, list(\n  colnames(tse_ko),\n  colnames(tse_pathway),\n  colnames(tse_lyrebird),\n  colnames(tse_singlem)\n))\n\ncat(\"\\n共同样本数: \", length(common_samples), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n共同样本数:  9 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"样本列表: \", paste(common_samples, collapse = \", \"), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n样本列表:  ca16, ca17, ca18, ca19, ca20, ca26, ca28, ca29, ca30 \n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 子集化到共同样本\ntse_ko <- tse_ko[, common_samples]\ntse_pathway <- tse_pathway[, common_samples]\ntse_lyrebird <- tse_lyrebird[, common_samples]\ntse_singlem <- tse_singlem[, common_samples]\n\n# 获取处理组信息\ntreatment_groups <- colData(tse_ko)$treatment_group\ncat(\"\\n处理组分布:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n处理组分布:\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(table(treatment_groups))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\ntreatment_groups\nApcMUT_HpKO ApcMUT_HpWT \n          4           5 \n```\n\n\n:::\n:::\n\n\n# Part 2: 噬菌体-KO 关联分析 (方案A)\n\n计算噬菌体OTU丰度与KO丰度的Spearman相关性，类似于02分析中的物种-KO关联。\n\n## 2.1 提取丰度矩阵\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ------------------------------------------------------------------------------\n# 提取噬菌体丰度矩阵\n# ------------------------------------------------------------------------------\n# 使用相对丰度\nif (\"relabundance\" %in% assayNames(tse_lyrebird)) {\n  phage_abundance <- as.matrix(assay(tse_lyrebird, \"relabundance\"))\n} else {\n  # 如果没有relabundance，计算相对丰度\n  phage_counts <- as.matrix(assay(tse_lyrebird, \"counts\"))\n  phage_abundance <- sweep(phage_counts, 2, colSums(phage_counts), \"/\")\n}\n\n# 过滤低丰度噬菌体（至少在20%样本中存在）\nphage_prevalence <- rowSums(phage_abundance > 0) / ncol(phage_abundance)\nphage_abundant <- phage_prevalence >= 0.2\nphage_abundance_filtered <- phage_abundance[phage_abundant, ]\n\ncat(\"噬菌体过滤:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n噬菌体过滤:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  原始 OTU 数:\", nrow(phage_abundance), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  原始 OTU 数: 878 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  过滤后 OTU 数 (prevalence >= 20%):\", nrow(phage_abundance_filtered), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  过滤后 OTU 数 (prevalence >= 20%): 571 \n```\n\n\n:::\n\n```{.r .cell-code}\n# ------------------------------------------------------------------------------\n# 提取 KO 丰度矩阵\n# ------------------------------------------------------------------------------\nif (\"cpm\" %in% assayNames(tse_ko)) {\n  ko_abundance <- as.matrix(assay(tse_ko, \"cpm\"))\n} else {\n  ko_counts <- as.matrix(assay(tse_ko, \"counts\"))\n  ko_abundance <- sweep(ko_counts, 2, colSums(ko_counts), \"/\") * 1e6\n}\n\n# 过滤低丰度 KO\nko_prevalence <- rowSums(ko_abundance > 0) / ncol(ko_abundance)\nko_abundant <- ko_prevalence >= 0.2\nko_abundance_filtered <- ko_abundance[ko_abundant, ]\n\ncat(\"\\nKO 过滤:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nKO 过滤:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  原始 KO 数:\", nrow(ko_abundance), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  原始 KO 数: 3947 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  过滤后 KO 数 (prevalence >= 20%):\", nrow(ko_abundance_filtered), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  过滤后 KO 数 (prevalence >= 20%): 3947 \n```\n\n\n:::\n:::\n\n\n## 2.2 计算噬菌体-KO 相关性 (OMA风格)\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncat(\"=== 计算噬菌体-KO Spearman 相关性 (Hmisc::rcorr) ===\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n=== 计算噬菌体-KO Spearman 相关性 (Hmisc::rcorr) ===\n```\n\n\n:::\n\n```{.r .cell-code}\n# 转置矩阵（样本为行）\nphage_t <- t(phage_abundance_filtered)\nko_t <- t(ko_abundance_filtered)\n\nn_phage <- ncol(phage_t)\nn_ko <- ncol(ko_t)\n\ncat(\"矩阵大小:\", n_phage, \"噬菌体 ×\", n_ko, \"KOs\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n矩阵大小: 571 噬菌体 × 3947 KOs\n```\n\n\n:::\n\n```{.r .cell-code}\n# OMA风格：使用cross_rcorr一次性计算所有相关性\ncor_phage_ko <- cross_rcorr(phage_t, ko_t)\n\n# 转换为长格式数据框（自动FDR校正）\nphage_ko_pairs <- corr_to_df(cor_phage_ko, \"phage\", \"ko\")\n\n# 统计显著关联\nn_sig_005 <- sum(phage_ko_pairs$qvalue < 0.05, na.rm = TRUE)\nn_sig_010 <- sum(phage_ko_pairs$qvalue < 0.10, na.rm = TRUE)\nn_sig_025 <- sum(phage_ko_pairs$qvalue < 0.25, na.rm = TRUE)\n\ncat(\"\\n=== 噬菌体-KO 关联统计 ===\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== 噬菌体-KO 关联统计 ===\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"显著关联数 (FDR < 0.05):\", n_sig_005, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n显著关联数 (FDR < 0.05): 2877 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"显著关联数 (FDR < 0.10):\", n_sig_010, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n显著关联数 (FDR < 0.10): 3349 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"显著关联数 (FDR < 0.25):\", n_sig_025, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n显著关联数 (FDR < 0.25): 6604 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Top 20\ncat(\"\\n=== Top 20 噬菌体-KO 关联对 ===\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== Top 20 噬菌体-KO 关联对 ===\n```\n\n\n:::\n\n```{.r .cell-code}\ntop_pairs <- phage_ko_pairs |> arrange(qvalue, desc(abs_cor)) |> head(20)\nprint(top_pairs |> dplyr::select(phage, ko, correlation, qvalue))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      phage     ko correlation qvalue\n1   OTU_983 K00060           1      0\n2   OTU_792 K00109           1      0\n3  OTU_1330 K00163           1      0\n4   OTU_257 K00236           1      0\n5   OTU_983 K00289           1      0\n6    OTU_60 K00366           1      0\n7   OTU_443 K00366           1      0\n8  OTU_1030 K00366           1      0\n9    OTU_60 K00371           1      0\n10  OTU_443 K00371           1      0\n11 OTU_1030 K00371           1      0\n12   OTU_60 K00375           1      0\n13  OTU_443 K00375           1      0\n14 OTU_1030 K00375           1      0\n15  OTU_378 K00478           1      0\n16  OTU_892 K00478           1      0\n17  OTU_906 K00478           1      0\n18 OTU_1016 K00478           1      0\n19 OTU_1176 K00478           1      0\n20  OTU_378 K00586           1      0\n```\n\n\n:::\n\n```{.r .cell-code}\n# 保存结果\nwrite.csv(phage_ko_pairs |> arrange(qvalue),\n          file = path_target(\"01_phage_ko_correlation_all.csv\"), row.names = FALSE)\n\nsig_pairs <- phage_ko_pairs |> dplyr::filter(qvalue < 0.25)\nif (nrow(sig_pairs) > 0) {\n  write.csv(sig_pairs |> arrange(qvalue),\n            file = path_target(\"02_phage_ko_correlation_significant.csv\"), row.names = FALSE)\n}\n```\n:::\n\n\n## 2.3 噬菌体-KO 关联热图\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 从相关性结果提取矩阵\ncor_matrix_phage_ko <- cor_phage_ko$r\n\n# 创建qvalue矩阵用于显著性标记\nqval_matrix_phage_ko <- matrix(\n  phage_ko_pairs$qvalue,\n  nrow = n_phage, ncol = n_ko,\n  dimnames = list(rownames(cor_matrix_phage_ko), colnames(cor_matrix_phage_ko))\n)\n\n# 选择Top特征\nphage_max_cor <- apply(abs(cor_matrix_phage_ko), 1, max, na.rm = TRUE)\ntop_phage <- names(sort(phage_max_cor, decreasing = TRUE))[1:min(30, n_phage)]\n\nko_max_cor <- apply(abs(cor_matrix_phage_ko), 2, max, na.rm = TRUE)\ntop_ko <- names(sort(ko_max_cor, decreasing = TRUE))[1:min(40, n_ko)]\n\n# 子集化并简化名称\ncor_subset <- cor_matrix_phage_ko[top_phage, top_ko]\nqval_subset <- qval_matrix_phage_ko[top_phage, top_ko]\n\nrownames(cor_subset) <- stringr::str_trunc(rownames(cor_subset), 35)\ncolnames(cor_subset) <- stringr::str_trunc(colnames(cor_subset), 15)\n\n# 显著性标记\nsig_marks <- ifelse(qval_subset < 0.05, \"**\",\n                    ifelse(qval_subset < 0.10, \"*\",\n                           ifelse(qval_subset < 0.25, \".\", \"\")))\n\n# 热图\np_heatmap_phage_ko <- pheatmap(\n  cor_subset,\n  color = colorRampPalette(c(\"#2166AC\", \"#F7F7F7\", \"#B2182B\"))(100),\n  breaks = seq(-1, 1, length.out = 101),\n  cluster_rows = TRUE, cluster_cols = TRUE,\n  fontsize_row = 7, fontsize_col = 8, angle_col = 45,\n  main = \"Phage-KO Correlation Heatmap (Spearman)\",\n  display_numbers = sig_marks, number_color = \"black\", fontsize_number = 6,\n  silent = TRUE\n)\n\nprint(p_heatmap_phage_ko)\n```\n\n::: {.cell-output-display}\n![](03b_virome_function_integration_files/figure-html/phage-ko-heatmap-1.png){width=1344}\n:::\n\n```{.r .cell-code}\npng(path_target(\"03_phage_ko_correlation_heatmap.png\"),\n    width = 14, height = 10, units = \"in\", res = 300)\nprint(p_heatmap_phage_ko)\ndev.off()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\npng \n  2 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"\\n** = FDR < 0.05, * = FDR < 0.10, . = FDR < 0.25\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n** = FDR < 0.05, * = FDR < 0.10, . = FDR < 0.25\n```\n\n\n:::\n:::\n\n\n# Part 3: 噬菌体-Pathway 关联分析\n\n类似地分析噬菌体与代谢通路的关联。\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 提取 Pathway 丰度矩阵\nif (\"relabundance\" %in% assayNames(tse_pathway)) {\n  pathway_abundance <- as.matrix(assay(tse_pathway, \"relabundance\"))\n} else {\n  pathway_counts <- as.matrix(assay(tse_pathway, \"abundance\"))\n  pathway_abundance <- sweep(pathway_counts, 2, colSums(pathway_counts), \"/\")\n}\n\n# 过滤低丰度通路\npathway_prevalence <- rowSums(pathway_abundance > 0) / ncol(pathway_abundance)\npathway_abundance_filtered <- pathway_abundance[pathway_prevalence >= 0.2, ]\npathway_t <- t(pathway_abundance_filtered)\nn_pathway <- ncol(pathway_t)\n\ncat(\"Pathway 过滤:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPathway 过滤:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  原始通路数:\", nrow(pathway_abundance), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  原始通路数: 640 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  过滤后通路数 (prevalence >= 20%):\", n_pathway, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  过滤后通路数 (prevalence >= 20%): 567 \n```\n\n\n:::\n\n```{.r .cell-code}\n# OMA风格：使用cross_rcorr计算相关性\ncor_phage_pathway <- cross_rcorr(phage_t, pathway_t)\nphage_pathway_pairs <- corr_to_df(cor_phage_pathway, \"phage\", \"pathway\")\n\n# 统计\nn_sig_pathway_005 <- sum(phage_pathway_pairs$qvalue < 0.05, na.rm = TRUE)\nn_sig_pathway_010 <- sum(phage_pathway_pairs$qvalue < 0.10, na.rm = TRUE)\nn_sig_pathway_025 <- sum(phage_pathway_pairs$qvalue < 0.25, na.rm = TRUE)\n\ncat(\"\\n=== 噬菌体-Pathway 关联统计 ===\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== 噬菌体-Pathway 关联统计 ===\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"显著关联数 (FDR < 0.05):\", n_sig_pathway_005, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n显著关联数 (FDR < 0.05): 337 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"显著关联数 (FDR < 0.10):\", n_sig_pathway_010, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n显著关联数 (FDR < 0.10): 978 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"显著关联数 (FDR < 0.25):\", n_sig_pathway_025, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n显著关联数 (FDR < 0.25): 5338 \n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncor_matrix_phage_pathway <- cor_phage_pathway$r\nqval_matrix_phage_pathway <- matrix(\n  phage_pathway_pairs$qvalue,\n  nrow = n_phage, ncol = n_pathway,\n  dimnames = list(rownames(cor_matrix_phage_pathway), colnames(cor_matrix_phage_pathway))\n)\n\n# 选择Top特征\nphage_max_cor_pw <- apply(abs(cor_matrix_phage_pathway), 1, max, na.rm = TRUE)\ntop_phage_pw <- names(sort(phage_max_cor_pw, decreasing = TRUE))[1:min(25, n_phage)]\n\npathway_max_cor <- apply(abs(cor_matrix_phage_pathway), 2, max, na.rm = TRUE)\ntop_pathway <- names(sort(pathway_max_cor, decreasing = TRUE))[1:min(30, n_pathway)]\n\ncor_pw_subset <- cor_matrix_phage_pathway[top_phage_pw, top_pathway]\nqval_pw_subset <- qval_matrix_phage_pathway[top_phage_pw, top_pathway]\n\n# 简化名称\nrownames(cor_pw_subset) <- stringr::str_trunc(rownames(cor_pw_subset), 35)\ncolnames(cor_pw_subset) <- stringr::str_replace(colnames(cor_pw_subset), \".*: \", \"\") |>\n  stringr::str_trunc(40)\n\nsig_marks_pw <- ifelse(qval_pw_subset < 0.05, \"**\",\n                       ifelse(qval_pw_subset < 0.10, \"*\",\n                              ifelse(qval_pw_subset < 0.25, \".\", \"\")))\n\np_heatmap_phage_pathway <- pheatmap(\n  cor_pw_subset,\n  color = colorRampPalette(c(\"#2166AC\", \"#F7F7F7\", \"#B2182B\"))(100),\n  breaks = seq(-1, 1, length.out = 101),\n  cluster_rows = TRUE, cluster_cols = TRUE,\n  fontsize_row = 7, fontsize_col = 7, angle_col = 45,\n  main = \"Phage-Pathway Correlation Heatmap (Spearman)\",\n  display_numbers = sig_marks_pw, number_color = \"black\", fontsize_number = 5,\n  silent = TRUE\n)\n\nprint(p_heatmap_phage_pathway)\n```\n\n::: {.cell-output-display}\n![](03b_virome_function_integration_files/figure-html/phage-pathway-heatmap-1.png){width=1344}\n:::\n\n```{.r .cell-code}\npng(path_target(\"04_phage_pathway_correlation_heatmap.png\"),\n    width = 14, height = 10, units = \"in\", res = 300)\nprint(p_heatmap_phage_pathway)\ndev.off()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\npng \n  2 \n```\n\n\n:::\n:::\n\n\n# Part 4: 三角互作网络分析 (方案B)\n\n整合细菌-噬菌体、细菌-KO、噬菌体-KO三种关联，构建三角互作网络。\n\n## 4.1 计算细菌-KO 和 细菌-噬菌体 关联\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncat(\"=== 计算细菌(SingleM) 关联 ===\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n=== 计算细菌(SingleM) 关联 ===\n```\n\n\n:::\n\n```{.r .cell-code}\n# 提取细菌丰度\nif (\"relabundance\" %in% assayNames(tse_singlem)) {\n  bacteria_abundance <- as.matrix(assay(tse_singlem, \"relabundance\"))\n} else {\n  bacteria_counts <- as.matrix(assay(tse_singlem, \"counts\"))\n  bacteria_abundance <- sweep(bacteria_counts, 2, colSums(bacteria_counts), \"/\")\n}\n\n# 过滤\nbacteria_prevalence <- rowSums(bacteria_abundance > 0) / ncol(bacteria_abundance)\nbacteria_abundance_filtered <- bacteria_abundance[bacteria_prevalence >= 0.2, ]\nbacteria_t <- t(bacteria_abundance_filtered)\nn_bacteria <- ncol(bacteria_t)\n\ncat(\"细菌过滤:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n细菌过滤:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  原始 OTU 数:\", nrow(bacteria_abundance), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  原始 OTU 数: 465 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  过滤后 OTU 数:\", n_bacteria, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  过滤后 OTU 数: 323 \n```\n\n\n:::\n\n```{.r .cell-code}\n# OMA风格：使用cross_rcorr计算细菌-KO和细菌-噬菌体相关性\ncor_bacteria_ko <- cross_rcorr(bacteria_t, ko_t)\ncor_bacteria_phage <- cross_rcorr(bacteria_t, phage_t)\n\nbacteria_ko_pairs <- corr_to_df(cor_bacteria_ko, \"bacteria\", \"ko\")\nbacteria_phage_pairs <- corr_to_df(cor_bacteria_phage, \"bacteria\", \"phage\")\n\nn_sig_bac_ko <- sum(bacteria_ko_pairs$qvalue < 0.25, na.rm = TRUE)\nn_sig_bac_phage <- sum(bacteria_phage_pairs$qvalue < 0.25, na.rm = TRUE)\n\ncat(\"\\n细菌-KO 显著关联数 (FDR < 0.25):\", n_sig_bac_ko, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n细菌-KO 显著关联数 (FDR < 0.25): 3700 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"细菌-噬菌体 显著关联数 (FDR < 0.25):\", n_sig_bac_phage, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n细菌-噬菌体 显著关联数 (FDR < 0.25): 7544 \n```\n\n\n:::\n:::\n\n\n## 4.2 构建三角互作网络\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncat(\"\\n=== 构建三角互作网络 ===\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== 构建三角互作网络 ===\n```\n\n\n:::\n\n```{.r .cell-code}\n# 阈值设置\ncor_threshold <- 0.5\nfdr_threshold <- 0.25\n\n# OMA风格：使用corr_to_edges向量化创建边列表\nedges_bacteria_ko <- corr_to_edges(cor_bacteria_ko, cor_threshold, fdr_threshold, \"Bacteria-KO\")\nedges_bacteria_phage <- corr_to_edges(cor_bacteria_phage, cor_threshold, fdr_threshold, \"Bacteria-Phage\")\nedges_phage_ko <- corr_to_edges(cor_phage_ko, cor_threshold, fdr_threshold, \"Phage-KO\")\n\n# 合并所有边\nedges_df <- bind_rows(edges_bacteria_ko, edges_bacteria_phage, edges_phage_ko)\n\nif (nrow(edges_df) > 0) {\n  cat(\"网络边数:\\n\")\n  cat(\"  细菌-KO:\", nrow(edges_bacteria_ko), \"\\n\")\n  cat(\"  细菌-噬菌体:\", nrow(edges_bacteria_phage), \"\\n\")\n  cat(\"  噬菌体-KO:\", nrow(edges_phage_ko), \"\\n\")\n  cat(\"  总计:\", nrow(edges_df), \"\\n\")\n\n  write.csv(edges_df, path_target(\"05_tripartite_network_edges.csv\"), row.names = FALSE)\n} else {\n  cat(\"当前阈值下没有足够的边，尝试降低阈值...\\n\")\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n网络边数:\n  细菌-KO: 3700 \n  细菌-噬菌体: 7544 \n  噬菌体-KO: 6604 \n  总计: 17848 \n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nif (nrow(edges_df) > 0) {\n\n  # 创建节点列表并确定类型\n  all_nodes <- unique(c(edges_df$from, edges_df$to))\n\n  # 使用cross_rcorr结果的行列名判断节点类型\n  bacteria_names <- rownames(cor_bacteria_ko$r)\n  phage_names <- rownames(cor_phage_ko$r)\n  ko_names <- colnames(cor_bacteria_ko$r)\n\n  node_type <- case_when(\n    all_nodes %in% bacteria_names ~ \"Bacteria\",\n    all_nodes %in% phage_names ~ \"Phage\",\n    all_nodes %in% ko_names ~ \"KO\",\n    TRUE ~ \"Unknown\"\n  )\n\n  nodes_df <- data.frame(\n    name = all_nodes,\n    type = node_type,\n    label = stringr::str_trunc(all_nodes, 20),\n    stringsAsFactors = FALSE\n  )\n\n  # 创建igraph对象\n  g <- graph_from_data_frame(edges_df, directed = FALSE, vertices = nodes_df)\n\n  # 重要：为布局算法创建正权重\n  E(g)$layout_weight <- abs(E(g)$weight)\n\n  # 绘制网络\n  p_network <- ggraph(g, layout = \"fr\", weights = E(g)$layout_weight) +\n    geom_edge_link(\n      aes(color = type, width = abs(weight),\n          linetype = ifelse(weight > 0, \"positive\", \"negative\")),\n      alpha = 0.6\n    ) +\n    geom_node_point(aes(color = type), size = 5) +\n    geom_node_text(aes(label = label), repel = TRUE, size = 2.5) +\n    scale_edge_color_manual(\n      values = c(\"Bacteria-KO\" = \"#1B9E77\",\n                 \"Bacteria-Phage\" = \"#D95F02\",\n                 \"Phage-KO\" = \"#7570B3\")\n    ) +\n    scale_edge_linetype_manual(\n      values = c(\"positive\" = \"solid\", \"negative\" = \"dashed\"),\n      name = \"Correlation\"\n    ) +\n    scale_color_manual(\n      values = c(\"Bacteria\" = \"#66C2A5\", \"Phage\" = \"#FC8D62\", \"KO\" = \"#8DA0CB\")\n    ) +\n    theme_void() +\n    labs(\n      title = \"Tripartite Interaction Network\",\n      subtitle = \"Bacteria - Phage - KO associations (|r| > 0.5, FDR < 0.25)\\nSolid = positive, Dashed = negative\",\n      edge_color = \"Edge Type\", color = \"Node Type\"\n    ) +\n    theme(plot.title = element_text(size = 14, face = \"bold\"), legend.position = \"right\")\n\n  print(p_network)\n\n  ggsave(path_target(\"06_tripartite_network.png\"), p_network, width = 14, height = 12, dpi = 300)\n\n} else {\n  cat(\"边数不足，无法绘制网络图\\n\")\n}\n```\n\n::: {.cell-output-display}\n![](03b_virome_function_integration_files/figure-html/network-visualization-1.png){width=1344}\n:::\n:::\n\n\n# Part 5: 结果汇总\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncat(\"\n================================================================================\n                    03b 病毒组-功能整合分析 结果汇总\n================================================================================\n\n【数据概况】\n- 共同样本数: \", length(common_samples), \"\n- 噬菌体 OTU 数 (过滤后): \", nrow(phage_abundance_filtered), \"\n- 细菌 OTU 数 (过滤后): \", nrow(bacteria_abundance_filtered), \"\n- KO 数 (过滤后): \", nrow(ko_abundance_filtered), \"\n- Pathway 数 (过滤后): \", nrow(pathway_abundance_filtered), \"\n\n【噬菌体-KO 关联分析】\n- 显著关联数 (FDR < 0.05): \", n_sig_005, \"\n- 显著关联数 (FDR < 0.10): \", n_sig_010, \"\n- 显著关联数 (FDR < 0.25): \", n_sig_025, \"\n\n【噬菌体-Pathway 关联分析】\n- 显著关联数 (FDR < 0.05): \", n_sig_pathway_005, \"\n- 显著关联数 (FDR < 0.10): \", n_sig_pathway_010, \"\n- 显著关联数 (FDR < 0.25): \", n_sig_pathway_025, \"\n\n【三角互作网络】\n- 细菌-KO 显著关联: \", n_sig_bac_ko, \" (FDR < 0.25)\n- 细菌-噬菌体 显著关联: \", n_sig_bac_phage, \" (FDR < 0.25)\n- 噬菌体-KO 显著关联: \", n_sig_025, \" (FDR < 0.25)\n\n【科学意义】\n1. 噬菌体-功能关联揭示了噬菌体可能通过影响细菌群落间接调控代谢功能\n2. 三角互作网络展示了 CagA 感染环境下细菌-噬菌体-功能的协同变化模式\n3. 这些发现补充了 02 分析中的物种-功能关联，提供了病毒组视角\n\n================================================================================\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n================================================================================\n                    03b 病毒组-功能整合分析 结果汇总\n================================================================================\n\n【数据概况】\n- 共同样本数:  9 \n- 噬菌体 OTU 数 (过滤后):  571 \n- 细菌 OTU 数 (过滤后):  323 \n- KO 数 (过滤后):  3947 \n- Pathway 数 (过滤后):  567 \n\n【噬菌体-KO 关联分析】\n- 显著关联数 (FDR < 0.05):  2877 \n- 显著关联数 (FDR < 0.10):  3349 \n- 显著关联数 (FDR < 0.25):  6604 \n\n【噬菌体-Pathway 关联分析】\n- 显著关联数 (FDR < 0.05):  337 \n- 显著关联数 (FDR < 0.10):  978 \n- 显著关联数 (FDR < 0.25):  5338 \n\n【三角互作网络】\n- 细菌-KO 显著关联:  3700  (FDR < 0.25)\n- 细菌-噬菌体 显著关联:  7544  (FDR < 0.25)\n- 噬菌体-KO 显著关联:  6604  (FDR < 0.25)\n\n【科学意义】\n1. 噬菌体-功能关联揭示了噬菌体可能通过影响细菌群落间接调控代谢功能\n2. 三角互作网络展示了 CagA 感染环境下细菌-噬菌体-功能的协同变化模式\n3. 这些发现补充了 02 分析中的物种-功能关联，提供了病毒组视角\n\n================================================================================\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncat(\"\\n【分析环境信息】\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n【分析环境信息】\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"R版本:\", R.version.string, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nR版本: R version 4.5.2 (2025-10-31 ucrt) \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"分析日期:\", format(Sys.time(), \"%Y-%m-%d %H:%M:%S\"), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n分析日期: 2026-01-20 13:38:03 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"工作目录:\", getwd(), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n工作目录: C:/Users/36094/Desktop/pc047oma/analyses \n```\n\n\n:::\n:::\n\n\n# Part 6: 科学结论与讨论\n\n## 6.1 主要发现\n\n本分析整合了病毒组（Lyrebird噬菌体）与功能组（HUMAnN KO/Pathway）数据，构建了细菌-噬菌体-功能的三角互作网络。\n\n**核心发现：**\n\n1. **噬菌体-功能关联广泛存在**\n   - 噬菌体与KO之间存在大量显著相关（FDR<0.05: 2877对），表明噬菌体丰度变化与宿主菌群的代谢功能密切相关\n   - 噬菌体与代谢通路的关联相对较少（FDR<0.05: 337对），可能反映了通路水平的功能冗余性\n\n2. **细菌-噬菌体协同模式**\n   - 细菌-噬菌体显著关联数量最多，反映了噬菌体与其潜在宿主细菌之间的共变化模式\n   - 正相关可能代表溶原状态下的共存关系，负相关可能反映裂解周期的捕食关系\n\n3. **三角互作网络特征**\n   - 网络高度连通，显示CagA感染环境下微生物组各层次之间的紧密联系\n   - 噬菌体同时与细菌和功能模块相关联，支持\"噬菌体通过调控细菌群落间接影响功能\"的假说\n\n## 6.2 与前期分析的整合\n\n| 分析模块 | 主要发现 | 03b的补充 |\n|----------|----------|-----------|\n| 01 物种多样性 | CagA+组物种组成显著变化 | 噬菌体也呈现类似的组间差异模式 |\n| 02 功能分析 | 特定KO/Pathway与CagA状态关联 | 这些功能变化部分可由噬菌体-宿主互作解释 |\n| 03 SingleM/Lyrebird | 噬菌体多样性与处理组相关 | 噬菌体多样性变化与功能组变化存在关联 |\n\n## 6.3 研究局限性\n\n1. **样本量限制**：仅9个共同样本，导致：\n   - 部分相关系数达到极端值（r=1或-1）\n   - 统计检验力有限，可能存在假阳性\n   - 建议后续研究扩大样本量验证\n\n2. **因果关系推断**：相关性分析无法确定因果方向\n   - 噬菌体变化可能是因（主动调控），也可能是果（响应细菌变化）\n   - 需要实验验证或时间序列数据支持\n\n3. **功能注释局限**：噬菌体OTU缺乏详细的分类学和功能注释\n\n## 6.4 科学意义\n\n本分析首次在pc047项目中系统性地整合了病毒组与功能组数据，主要贡献包括：\n\n1. **方法学创新**：建立了噬菌体-细菌-功能三角互作分析框架，可应用于其他微生物组研究\n2. **机制提示**：CagA感染可能通过调控噬菌体-细菌平衡间接影响菌群功能\n3. **数据资源**：生成了完整的相关性矩阵和网络边列表，为后续深入分析提供基础\n\n---\n\n## Files written\n\nThese files have been written to the target directory, data/03b_virome_function_integration:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprojthis::proj_dir_info(path_target(), tz = \"CET\") |> knitr::kable()\n```\n\n::: {.cell-output-display}\n\n\n|path                                     |type | size|modification_time   |\n|:----------------------------------------|:----|----:|:-------------------|\n|01_phage_ko_correlation_all.csv          |file | 193M|2026-01-20 13:31:39 |\n|02_phage_ko_correlation_significant.csv  |file | 525K|2026-01-20 13:31:39 |\n|03_phage_ko_correlation_heatmap.png      |file | 191K|2026-01-20 13:31:40 |\n|04_phage_pathway_correlation_heatmap.png |file | 188K|2026-01-20 13:31:41 |\n|05_tripartite_network_edges.csv          |file | 850K|2026-01-20 13:31:49 |\n|06_tripartite_network.png                |file | 183K|2026-01-20 13:35:13 |\n\n\n:::\n:::\n\n",
    "supporting": [
      "03b_virome_function_integration_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}