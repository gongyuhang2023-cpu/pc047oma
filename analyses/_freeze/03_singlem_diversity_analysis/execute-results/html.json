{
  "hash": "4a543fba3322d9ee1901ee33c4a8c80a",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"03_singlem_diversity_analysis\"\ntitle-block-banner: true\nauthor:\n  - name: Gong Yuhang\ndate: 2025-01-07\ntoc: true\ntoc-depth: 4\nnumber-sections: true\ncode-fold: true\ncode-line-numbers: true\ncode-tools: true\nformat:\n  html:\n    embed-resources: true\n    smooth-scroll: true\n    page-layout: full\nreference-location: section\ncitation-location: document\nparams:\n  name: \"03_singlem_diversity_analysis\"\n---\n\n**Updated: 2026-01-12 16:23:42 CET.**\n\n本文档是项目 pc047 (vCagAepitope) 的 SingleM/Lyrebird 分析模块。\n\n**分析目的**：\n使用 SingleM（细菌/古菌）和 Lyrebird（噬菌体）的 OTU-based 分类结果，评估 CagA 依赖性感染对肠道微生物组的影响。\n\n**相比 01 分析（Kraken2/Bracken）的优势**：\n1. **系统发育树**：可计算 UniFrac 距离（考虑进化关系）\n2. **新物种检测**：能识别数据库中未收录的物种\n3. **OTU分辨率**：更高的分类精度\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsuppressPackageStartupMessages({\n  library(here)\n  library(conflicted)\n  library(tidyverse)\n  library(data.table)\n  library(mia)\n  library(TreeSummarizedExperiment)\n  library(readxl)\n  library(miaViz)\n  library(scuttle)\n  library(patchwork)\n  library(MatrixGenerics)\n  library(stringr)\n  library(ggpubr)\n\n  library(scater)\n  library(vegan)\n  library(ggplot2)\n  library(ANCOMBC)\n  library(ALDEx2)\n  library(ape) # 用于读取系统发育树\n  library(phyloseq) # UniFrac 计算的稳定实现\n  devtools::load_all()\n})\n\n# 解决命名空间冲突\nconflicts_prefer(base::setdiff)\nconflicts_prefer(dplyr::filter)\nconflicts_prefer(dplyr::select)\nconflicts_prefer(dplyr::lag)\nconflicts_prefer(dplyr::first)\nconflicts_prefer(dplyr::left_join)\nconflicts_prefer(ggplot2::annotate)\nconflicts_prefer(base::intersect)\n\nset.seed(20261)\n```\n:::\n\n\n# Part 1: SingleM 细菌/古菌分析\n\n## 1. 数据导入与 TSE 构建\n\n根据 SingleM Protocol，我们使用以下分析就绪文件：\n- `*_OTU_abundance.tsv`: OTU 丰度矩阵（相对丰度 %）\n- `*_OTU_taxonomy.tsv`: OTU 分类信息\n- `*_OTU_tree.nwk`: 系统发育树（用于 UniFrac 计算）\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================================================================\n# Step 1: 定义数据路径\n# ==============================================================================\nsinglem_data_path <- here::here(\n  \"data\", \"00-raw\", \"d03_singlem_diversity_analysis\", \"pc047-rst_singleM\"\n)\n\n# ==============================================================================\n# Step 2: 读取 OTU 丰度矩阵\n# ==============================================================================\n# SingleM 输出的是相对丰度（百分比），我们将其转换为比例（0-1）\notu_abundance <- read_tsv(\n  file.path(singlem_data_path, \"pc047-singleM_OTU_abundance.tsv\"),\n  show_col_types = FALSE\n) |>\n  column_to_rownames(\"otu_id\") |>\n  as.matrix()\n\n# 将百分比转换为比例\notu_abundance <- otu_abundance / 100\n\ncat(\"OTU 矩阵维度:\", dim(otu_abundance), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nOTU 矩阵维度: 640 33 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"样本数:\", ncol(otu_abundance), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n样本数: 33 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"OTU 数:\", nrow(otu_abundance), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nOTU 数: 640 \n```\n\n\n:::\n\n```{.r .cell-code}\n# ==============================================================================\n# Step 3: 读取 OTU 分类信息\n# ==============================================================================\notu_taxonomy <- read_tsv(\n  file.path(singlem_data_path, \"pc047-singleM_OTU_taxonomy.tsv\"),\n  show_col_types = FALSE\n) |>\n  column_to_rownames(\"otu_id\") |>\n  DataFrame()\n\n# 查看分类层级\ncat(\"分类层级:\", colnames(otu_taxonomy), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n分类层级: Root Domain Phylum Class Order Family Genus Species \n```\n\n\n:::\n\n```{.r .cell-code}\n# ==============================================================================\n# Step 4: 读取系统发育树\n# ==============================================================================\notu_tree <- ape::read.tree(\n  file.path(singlem_data_path, \"pc047-singleM_OTU_tree.nwk\")\n)\n\ncat(\"系统发育树 tip 数:\", length(otu_tree$tip.label), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n系统发育树 tip 数: 640 \n```\n\n\n:::\n\n```{.r .cell-code}\n# ==============================================================================\n# Step 5: 构建 TreeSummarizedExperiment 对象\n# ==============================================================================\n# 确保 OTU ID 顺序一致\ncommon_otus <- intersect(rownames(otu_abundance), rownames(otu_taxonomy))\ncommon_otus <- intersect(common_otus, otu_tree$tip.label)\n\ncat(\"共同 OTU 数:\", length(common_otus), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n共同 OTU 数: 640 \n```\n\n\n:::\n\n```{.r .cell-code}\n# 子集化数据\notu_abundance <- otu_abundance[common_otus, ]\notu_taxonomy <- otu_taxonomy[common_otus, ]\notu_tree <- ape::keep.tip(otu_tree, common_otus)\n\n# 创建 TSE 对象\n# 注意：SingleM 输出是相对丰度，我们将其乘以 10000 作为伪计数以便后续分析\ntse_singlem <- TreeSummarizedExperiment(\n  assays = list(\n    relabundance = otu_abundance,\n    counts = round(otu_abundance * 10000) # 伪计数用于某些需要整数的分析\n  ),\n  rowData = otu_taxonomy,\n  rowTree = otu_tree\n)\n\ntse_singlem\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nclass: TreeSummarizedExperiment \ndim: 640 33 \nmetadata(0):\nassays(2): relabundance counts\nrownames(640): OTU_1 OTU_2 ... OTU_639 OTU_640\nrowData names(8): Root Domain ... Genus Species\ncolnames(33): ca01 ca02 ... ic03 ic04\ncolData names(0):\nreducedDimNames(0):\nmainExpName: NULL\naltExpNames(0):\nrowLinks: a LinkDataFrame (640 rows)\nrowTree: 1 phylo tree(s) (640 leaves)\ncolLinks: NULL\ncolTree: NULL\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================================================================\n# Step 6: 绑定样本元数据\n# ==============================================================================\nmetadata <- readxl::read_xlsx(\n  here::here(\"data\", \"metadata\", \"pc047-metadata.xlsx\")\n) |>\n  column_to_rownames(\"sample_id\")\n\n# 匹配样本名\ncommon_samples <- intersect(colnames(tse_singlem), rownames(metadata))\ncat(\"匹配的样本数:\", length(common_samples), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n匹配的样本数: 33 \n```\n\n\n:::\n\n```{.r .cell-code}\ntse_singlem <- tse_singlem[, common_samples]\ncolData(tse_singlem) <- DataFrame(metadata[common_samples, ])\n\n# ==============================================================================\n# Step 7: 创建 Caecum 子集\n# ==============================================================================\n# 本项目主要分析 caecum（盲肠）样本\ntse_singlem_ca <- tse_singlem[, tse_singlem$source_organ == \"caecum\"]\n\ncat(\"Caecum 样本数:\", ncol(tse_singlem_ca), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCaecum 样本数: 29 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"各实验组样本分布:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n各实验组样本分布:\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(table(tse_singlem_ca$treatment_group))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nApcMUT_Ctrl ApcMUT_HpKO ApcMUT_HpWT  ApcWT_Ctrl  ApcWT_HpKO  ApcWT_HpWT \n          5           4           5           5           5           5 \n```\n\n\n:::\n\n```{.r .cell-code}\ntse_singlem_ca\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nclass: TreeSummarizedExperiment \ndim: 640 29 \nmetadata(0):\nassays(2): relabundance counts\nrownames(640): OTU_1 OTU_2 ... OTU_639 OTU_640\nrowData names(8): Root Domain ... Genus Species\ncolnames(29): ca01 ca02 ... ca29 ca30\ncolData names(11): mouse_id genotype ... path_r1 path_r2\nreducedDimNames(0):\nmainExpName: NULL\naltExpNames(0):\nrowLinks: a LinkDataFrame (640 rows)\nrowTree: 1 phylo tree(s) (640 leaves)\ncolLinks: NULL\ncolTree: NULL\n```\n\n\n:::\n:::\n\n\n## 2. 数据探索与质量控制 (QC)\n\n### 2.1 第一遍清洗：数据探索\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================================================================\n# 1. 计算文库大小（基于伪计数）\n# ==============================================================================\ntse_singlem_ca_1 <- tse_singlem_ca\ntse_singlem_ca_1 <- addPerCellQCMetrics(tse_singlem_ca_1, assay.type = \"counts\")\n\n# 可视化文库大小分布\np1 <- plotHistogram(tse_singlem_ca_1, col.var = \"total\") +\n  labs(title = \"SingleM: Library Size Distribution\", x = \"Total Pseudo-counts\")\np1\n```\n\n::: {.cell-output-display}\n![](03_singlem_diversity_analysis_files/figure-html/singlem-qc-round1-1.png){width=672}\n:::\n\n```{.r .cell-code}\nggsave(\n  filename = here::here(\"data\", params$name, \"01_qc_library_size_singlem.png\"),\n  plot = p1, width = 8, height = 6, dpi = 300\n)\n\n# ==============================================================================\n# 2. Prevalence 分析\n# ==============================================================================\ntse_singlem_ca_1 <- addPrevalence(\n  tse_singlem_ca_1,\n  assay.type = \"relabundance\",\n  detection = 0,\n  as.relative = FALSE # 已经是相对丰度\n)\n\nrowData(tse_singlem_ca_1)$prevalence <- as.numeric(rowData(tse_singlem_ca_1)$prevalence)\nsummary(rowData(tse_singlem_ca_1)$prevalence)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n0.00000 0.06897 0.27586 0.36681 0.62069 1.00000 \n```\n\n\n:::\n\n```{.r .cell-code}\np2 <- plotHistogram(tse_singlem_ca_1, row.var = \"prevalence\") +\n  labs(title = \"SingleM: OTU Prevalence Distribution\", x = \"Prevalence (Fraction of Samples)\")\np2\n```\n\n::: {.cell-output-display}\n![](03_singlem_diversity_analysis_files/figure-html/singlem-qc-round1-2.png){width=672}\n:::\n\n```{.r .cell-code}\nggsave(\n  filename = here::here(\"data\", params$name, \"02_qc_prevalence_singlem.png\"),\n  plot = p2, width = 8, height = 6, dpi = 300\n)\n\n# ==============================================================================\n# 3. 查看丰度最高的 OTU\n# ==============================================================================\ntop_otus <- getTop(tse_singlem_ca_1, top = 10, assay.type = \"relabundance\")\ncat(\"Top 10 OTUs:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTop 10 OTUs:\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(top_otus)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"OTU_260\" \"OTU_179\" \"OTU_155\" \"OTU_183\" \"OTU_261\" \"OTU_280\" \"OTU_163\"\n [8] \"OTU_285\" \"OTU_277\" \"OTU_269\"\n```\n\n\n:::\n\n```{.r .cell-code}\n# 查看对应的分类信息\ncat(\"\\nTop 10 OTU 分类信息:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nTop 10 OTU 分类信息:\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(rowData(tse_singlem_ca_1)[top_otus, ])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nDataFrame with 10 rows and 9 columns\n               Root      Domain       Phylum       Class          Order\n        <character> <character>  <character> <character>    <character>\nOTU_260        Root    Bacteria Bacteroidota Bacteroidia  Bacteroidales\nOTU_179        Root    Bacteria    Bacillota  Clostridia Lachnospirales\nOTU_155        Root    Bacteria    Bacillota  Clostridia Lachnospirales\nOTU_183        Root    Bacteria    Bacillota  Clostridia Lachnospirales\nOTU_261        Root    Bacteria Bacteroidota Bacteroidia  Bacteroidales\nOTU_280        Root    Bacteria Bacteroidota Bacteroidia  Bacteroidales\nOTU_163        Root    Bacteria    Bacillota  Clostridia Lachnospirales\nOTU_285        Root    Bacteria Bacteroidota Bacteroidia  Bacteroidales\nOTU_277        Root    Bacteria Bacteroidota Bacteroidia  Bacteroidales\nOTU_269        Root    Bacteria Bacteroidota Bacteroidia  Bacteroidales\n                 Family         Genus                Species prevalence\n            <character>   <character>            <character>  <numeric>\nOTU_260  Muribaculaceae       UBA7173    UBA7173 sp001689685   0.965517\nOTU_179 Lachnospiraceae       UBA3282    UBA3282 sp009774215   0.827586\nOTU_155 Lachnospiraceae Acetatifactor Acetatifactor sp9105..   0.827586\nOTU_183 Lachnospiraceae       UBA3282    UBA3282 sp910575775   0.931034\nOTU_261  Muribaculaceae     Lepagella  Lepagella sp009775375   0.965517\nOTU_280  Muribaculaceae       CAG-873    CAG-873 sp001689665   0.862069\nOTU_163 Lachnospiraceae          COE1       COE1 sp000403215   0.758621\nOTU_285   Rikenellaceae     Alistipes  Alistipes sp910575495   0.931034\nOTU_277  Muribaculaceae       CAG-873    CAG-873 sp002490635   0.965517\nOTU_269  Muribaculaceae   Duncaniella      Duncaniella muris   0.965517\n```\n\n\n:::\n:::\n\n\n### 2.2 第二遍清洗：去除异常样本\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================================================================\n# 1. 检查是否有异常样本（如 ca08 在 01 分析中被识别为污染）\n# ==============================================================================\ntse_singlem_ca_2 <- tse_singlem_ca\n\n# 查看 ca08 的情况\nif (\"ca08\" %in% colnames(tse_singlem_ca_2)) {\n  ca08_top <- sort(assay(tse_singlem_ca_2[, \"ca08\"], \"relabundance\"), decreasing = TRUE)[1:5]\n  cat(\"ca08 样本 Top 5 OTU 丰度:\\n\")\n  print(ca08_top)\n\n  # 根据 01 分析结果，ca08 存在 E. coli 异常高丰度，考虑移除\n  cat(\"\\n根据 01 分析结果，移除 ca08 样本\\n\")\n  tse_singlem_ca_2 <- tse_singlem_ca_2[, colnames(tse_singlem_ca_2) != \"ca08\"]\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nca08 样本 Top 5 OTU 丰度:\n[1] 0.0286 0.0164 0.0164 0.0146 0.0097\n\n根据 01 分析结果，移除 ca08 样本\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"清洗后样本数:\", ncol(tse_singlem_ca_2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n清洗后样本数: 28 \n```\n\n\n:::\n\n```{.r .cell-code}\n# ==============================================================================\n# 2. Prevalence 过滤（保留 >10% 样本中出现的 OTU）\n# ==============================================================================\ntse_singlem_ca_2 <- addPrevalence(\n  tse_singlem_ca_2,\n  assay.type = \"relabundance\",\n  detection = 0,\n  as.relative = FALSE\n)\n\ncat(\"过滤前 OTU 数:\", nrow(tse_singlem_ca_2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n过滤前 OTU 数: 640 \n```\n\n\n:::\n\n```{.r .cell-code}\ntse_singlem_ca_2 <- subsetByPrevalent(tse_singlem_ca_2, prevalence = 0.1)\ncat(\"过滤后 OTU 数:\", nrow(tse_singlem_ca_2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n过滤后 OTU 数: 465 \n```\n\n\n:::\n\n```{.r .cell-code}\n# ==============================================================================\n# 3. 更新 QC 指标\n# ==============================================================================\ntse_singlem_ca_2 <- addPerCellQCMetrics(tse_singlem_ca_2, assay.type = \"counts\")\n\np3 <- plotHistogram(tse_singlem_ca_2, col.var = \"total\") +\n  labs(title = \"SingleM: Library Size (After Cleaning)\", x = \"Total Pseudo-counts\")\np3\n```\n\n::: {.cell-output-display}\n![](03_singlem_diversity_analysis_files/figure-html/singlem-qc-round2-1.png){width=672}\n:::\n\n```{.r .cell-code}\nggsave(\n  filename = here::here(\"data\", params$name, \"03_qc_library_size_cleaned_singlem.png\"),\n  plot = p3, width = 8, height = 6, dpi = 300\n)\n```\n:::\n\n\n### 2.3 清洗后数据整理\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================================================================\n# 保存清洗后的 TSE 对象\n# ==============================================================================\ntse_singlem_ca_cleaned <- tse_singlem_ca_2\n\n# 查看分类层级\ncat(\"可用的分类层级:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n可用的分类层级:\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(taxonomyRanks(tse_singlem_ca_cleaned))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"Domain\"  \"Phylum\"  \"Class\"   \"Order\"   \"Family\"  \"Genus\"   \"Species\"\n```\n\n\n:::\n\n```{.r .cell-code}\n# 保存清洗后的数据\nsaveRDS(\n  tse_singlem_ca_cleaned,\n  file = here::here(\"data\", params$name, \"tse_singlem_ca_cleaned.rds\")\n)\n\ntse_singlem_ca_cleaned\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nclass: TreeSummarizedExperiment \ndim: 465 28 \nmetadata(0):\nassays(2): relabundance counts\nrownames(465): OTU_1 OTU_2 ... OTU_595 OTU_598\nrowData names(9): Root Domain ... Species prevalence\ncolnames(28): ca01 ca02 ... ca29 ca30\ncolData names(14): mouse_id genotype ... detected total\nreducedDimNames(0):\nmainExpName: NULL\naltExpNames(0):\nrowLinks: a LinkDataFrame (465 rows)\nrowTree: 1 phylo tree(s) (465 leaves)\ncolLinks: NULL\ncolTree: NULL\n```\n\n\n:::\n:::\n\n\n## 3. 群落组成可视化\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================================================================\n# 1. Top 10 OTU 组成图\n# ==============================================================================\ntop_otus_cleaned <- getTop(tse_singlem_ca_cleaned, top = 10, assay.type = \"relabundance\")\n\n# 创建用于绘图的 TSE 副本\ntse_plot <- tse_singlem_ca_cleaned\n\n# 将非 Top 10 的 OTU 标记为 \"Other\"\nrowData(tse_plot)$OTU_Top10 <- ifelse(\n  rownames(tse_plot) %in% top_otus_cleaned,\n  paste0(rownames(tse_plot), \" (\", rowData(tse_plot)$Family, \")\"),\n  \"Other\"\n)\n\n# 聚合\ntse_plot_agg <- agglomerateByVariable(tse_plot, by = \"rows\", f = \"OTU_Top10\")\n\n# 绘图\np_comp <- plotAbundance(\n  tse_plot_agg,\n  assay.type = \"relabundance\",\n  order.row.by = \"abund\",\n  order.col.by = \"Other\"\n) +\n  labs(\n    title = \"SingleM: Top 10 OTU Composition (Caecum)\",\n    subtitle = \"Non-top OTUs grouped as 'Other'\"\n  ) +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))\n\np_comp\n```\n\n::: {.cell-output-display}\n![](03_singlem_diversity_analysis_files/figure-html/singlem-composition-1.png){width=1152}\n:::\n\n```{.r .cell-code}\nggsave(\n  filename = here::here(\"data\", params$name, \"04_composition_top10_singlem.png\"),\n  plot = p_comp, width = 14, height = 8, dpi = 300\n)\n\n# ==============================================================================\n# 2. 按 Phylum 聚合的组成图\n# ==============================================================================\n# 检查是否有 Phylum 列\nif (\"Phylum\" %in% colnames(rowData(tse_singlem_ca_cleaned))) {\n  tse_phylum <- agglomerateByRank(tse_singlem_ca_cleaned, rank = \"Phylum\")\n\n  p_phylum <- plotAbundance(\n    tse_phylum,\n    assay.type = \"relabundance\",\n    order.row.by = \"abund\"\n  ) +\n    labs(title = \"SingleM: Phylum-level Composition\") +\n    theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))\n\n  p_phylum\n\n  ggsave(\n    filename = here::here(\"data\", params$name, \"05_composition_phylum_singlem.png\"),\n    plot = p_phylum, width = 14, height = 8, dpi = 300\n  )\n}\n```\n:::\n\n\n## 4. Alpha 多样性分析\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================================================================\n# 1. 计算 Alpha 多样性指数\n# ==============================================================================\ntse_singlem_ca_cleaned <- addAlpha(\n  tse_singlem_ca_cleaned,\n  assay.type = \"counts\",\n  index = c(\"shannon\", \"observed\"),\n  name = c(\"shannon_index\", \"observed_richness\")\n)\n\ncat(\"Alpha 多样性指数已计算\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAlpha 多样性指数已计算\n```\n\n\n:::\n\n```{.r .cell-code}\n# ==============================================================================\n# 2. 提取核心比较组 (ApcMUT_HpWT vs ApcMUT_HpKO)\n# ==============================================================================\ntse_singlem_corepair <- tse_singlem_ca_cleaned[\n  , tse_singlem_ca_cleaned$treatment_group %in% c(\"ApcMUT_HpWT\", \"ApcMUT_HpKO\")\n]\ntse_singlem_corepair$treatment_group <- factor(tse_singlem_corepair$treatment_group)\n\ncat(\"核心比较组样本数:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n核心比较组样本数:\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(table(tse_singlem_corepair$treatment_group))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nApcMUT_HpKO ApcMUT_HpWT \n          4           5 \n```\n\n\n:::\n\n```{.r .cell-code}\n# ==============================================================================\n# 3. 统计检验 (Wilcoxon 秩和检验)\n# ==============================================================================\n# Shannon 指数检验\nwilcox_shannon <- wilcox.test(\n  shannon_index ~ treatment_group,\n  data = colData(tse_singlem_corepair)\n)\ncat(\"\\nShannon 指数 Wilcoxon 检验 P 值:\", round(wilcox_shannon$p.value, 4), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nShannon 指数 Wilcoxon 检验 P 值: 0.9048 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Observed richness 检验\nwilcox_observed <- wilcox.test(\n  observed_richness ~ treatment_group,\n  data = colData(tse_singlem_corepair)\n)\ncat(\"Observed Richness Wilcoxon 检验 P 值:\", round(wilcox_observed$p.value, 4), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nObserved Richness Wilcoxon 检验 P 值: 0.1111 \n```\n\n\n:::\n\n```{.r .cell-code}\n# ==============================================================================\n# 4. 可视化\n# ==============================================================================\nplot_alpha <- function(tse, y_var, title) {\n  plotColData(tse,\n    x = \"treatment_group\", y = y_var,\n    colour_by = \"treatment_group\",\n    show_boxplot = TRUE\n  ) +\n    stat_compare_means(\n      comparisons = list(c(\"ApcMUT_HpKO\", \"ApcMUT_HpWT\")),\n      method = \"wilcox.test\", label = \"p.format\"\n    ) +\n    labs(title = title, x = \"Group\", y = \"Index Value\") +\n    theme_bw() +\n    theme(legend.position = \"none\")\n}\n\np_shannon <- plot_alpha(tse_singlem_corepair, \"shannon_index\", \"SingleM: Shannon Diversity\")\np_observed <- plot_alpha(tse_singlem_corepair, \"observed_richness\", \"SingleM: Observed OTU Richness\")\n\np_alpha_combined <- p_shannon + p_observed +\n  plot_annotation(title = \"SingleM Alpha Diversity: ApcMUT_HpWT vs ApcMUT_HpKO\")\np_alpha_combined\n```\n\n::: {.cell-output-display}\n![](03_singlem_diversity_analysis_files/figure-html/singlem-alpha-diversity-1.png){width=672}\n:::\n\n```{.r .cell-code}\nggsave(\n  filename = here::here(\"data\", params$name, \"06_alpha_diversity_singlem.png\"),\n  plot = p_alpha_combined, width = 12, height = 6, dpi = 300\n)\n```\n:::\n\n\n## 5. Beta 多样性分析\n\n### 5.1 Bray-Curtis 距离\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================================================================\n# 1. PCoA (Bray-Curtis)\n# ==============================================================================\ntse_singlem_corepair <- runMDS(\n  tse_singlem_corepair,\n  FUN = vegan::vegdist,\n  method = \"bray\",\n  assay.type = \"relabundance\",\n  name = \"PCoA_Bray\"\n)\n\n# 提取特征值\neig_bray <- attr(reducedDim(tse_singlem_corepair, \"PCoA_Bray\"), \"eig\")\nrel_eig_bray <- eig_bray / sum(eig_bray[eig_bray > 0])\n\n# 可视化\np_pcoa_bray <- plotReducedDim(\n  tse_singlem_corepair,\n  \"PCoA_Bray\",\n  colour_by = \"treatment_group\"\n) +\n  theme_bw() +\n  labs(\n    title = \"SingleM: PCoA (Bray-Curtis)\",\n    x = paste0(\"PCoA 1 (\", round(100 * rel_eig_bray[1], 1), \"%)\"),\n    y = paste0(\"PCoA 2 (\", round(100 * rel_eig_bray[2], 1), \"%)\")\n  )\np_pcoa_bray\n```\n\n::: {.cell-output-display}\n![](03_singlem_diversity_analysis_files/figure-html/singlem-beta-bray-1.png){width=672}\n:::\n\n```{.r .cell-code}\nggsave(\n  filename = here::here(\"data\", params$name, \"07_beta_pcoa_bray_singlem.png\"),\n  plot = p_pcoa_bray, width = 8, height = 6, dpi = 300\n)\n\n# ==============================================================================\n# 2. PERMANOVA 检验 (Bray-Curtis)\n# ==============================================================================\npermanova_bray <- getPERMANOVA(\n  tse_singlem_corepair,\n  assay.type = \"relabundance\",\n  formula = x ~ treatment_group\n)\n\ncat(\"\\n=== PERMANOVA (Bray-Curtis) ===\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== PERMANOVA (Bray-Curtis) ===\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(permanova_bray$permanova)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPermutation test for adonis under reduced model\nMarginal effects of terms\nPermutation: free\nNumber of permutations: 999\n\nadonis2(formula = formula, data = data, method = ..1, by = by, na.action = na.action)\n                Df SumOfSqs      R2      F Pr(>F)  \ntreatment_group  1  0.28247 0.23146 2.1082  0.037 *\nResidual         7  0.93791 0.76854                \nTotal            8  1.22038 1.00000                \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n\n```{.r .cell-code}\nwrite.csv(\n  permanova_bray$permanova,\n  file = here::here(\"data\", params$name, \"08_permanova_bray_singlem.csv\"),\n  row.names = TRUE\n)\n```\n:::\n\n\n### 5.2 UniFrac 距离（利用系统发育树）\n\n::: {.callout-important}\n## UniFrac 分析的重要性\n\nUniFrac 是 SingleM 数据的**核心优势**：\n- **Bray-Curtis** 只比较丰度数值，忽略进化关系\n- **UniFrac** 通过系统发育树比较\"演化家谱\"，能识别**株系级遗传偏移**\n\n对于 pc047 项目，UniFrac 可以揭示 HpWT 组是否整体向特定\"致病演化支\"偏移。\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================================================================\n# Step 1: 诊断树和 OTU 矩阵的匹配情况\n# ==============================================================================\ncat(\"=== UniFrac 计算前诊断 ===\\n\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n=== UniFrac 计算前诊断 ===\n```\n\n\n:::\n\n```{.r .cell-code}\n# 获取树和 OTU 信息\ntree <- rowTree(tse_singlem_corepair)\notu_names <- rownames(tse_singlem_corepair)\ntree_tips <- tree$tip.label\n\ncat(\"OTU 矩阵中的 OTU 数量:\", length(otu_names), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nOTU 矩阵中的 OTU 数量: 465 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"系统发育树的 tip 数量:\", length(tree_tips), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n系统发育树的 tip 数量: 465 \n```\n\n\n:::\n\n```{.r .cell-code}\n# 检查匹配情况\nin_both <- intersect(otu_names, tree_tips)\nonly_in_otu <- setdiff(otu_names, tree_tips)\nonly_in_tree <- setdiff(tree_tips, otu_names)\n\ncat(\"两者共有的 OTU:\", length(in_both), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n两者共有的 OTU: 465 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"仅在 OTU 矩阵中:\", length(only_in_otu), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n仅在 OTU 矩阵中: 0 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"仅在树中:\", length(only_in_tree), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n仅在树中: 0 \n```\n\n\n:::\n\n```{.r .cell-code}\nif (length(only_in_otu) > 0) {\n  cat(\"\\n警告: 以下 OTU 不在树中:\\n\")\n  print(head(only_in_otu, 10))\n}\n\n# 检查树是否有效\ncat(\"\\n树结构检查:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n树结构检查:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  - 是否为二叉树:\", ape::is.binary(tree), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - 是否为二叉树: FALSE \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  - 是否有根:\", ape::is.rooted(tree), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - 是否有根: TRUE \n```\n\n\n:::\n\n```{.r .cell-code}\n# 检查边长\nif (!is.null(tree$edge.length) && length(tree$edge.length) > 0) {\n  valid_edges <- tree$edge.length[is.finite(tree$edge.length)]\n  if (length(valid_edges) > 0) {\n    cat(\"  - 有效边长范围:\", range(valid_edges), \"\\n\")\n  } else {\n    cat(\"  - 有效边长范围: 无有效边长!\\n\")\n  }\n  cat(\"  - 总边数:\", length(tree$edge.length), \"\\n\")\n  cat(\"  - NA 边长数量:\", sum(is.na(tree$edge.length)), \"\\n\")\n  cat(\"  - Inf 边长数量:\", sum(is.infinite(tree$edge.length)), \"\\n\")\n  cat(\"  - 负数边长数量:\", sum(tree$edge.length < 0, na.rm = TRUE), \"\\n\")\n} else {\n  cat(\"  - 边长信息: 树没有边长信息!\\n\")\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - 边长信息: 树没有边长信息!\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================================================================\n# Step 2: 修复树的边长问题\n# ==============================================================================\ncat(\"\\n=== 修复树的边长 ===\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== 修复树的边长 ===\n```\n\n\n:::\n\n```{.r .cell-code}\n# 获取原始树\ntree_original <- rowTree(tse_singlem_corepair)\n\n# 复制树进行修复\ntree_fixed <- tree_original\n\n# 检查并修复边长\nif (is.null(tree_fixed$edge.length) || length(tree_fixed$edge.length) == 0) {\n  # 如果完全没有边长，创建默认边长（全部设为 1）\n  cat(\"树没有边长信息，创建默认边长...\\n\")\n  tree_fixed$edge.length <- rep(1, nrow(tree_fixed$edge))\n} else {\n  # 统计问题边长\n  n_na <- sum(is.na(tree_fixed$edge.length))\n  n_inf <- sum(is.infinite(tree_fixed$edge.length))\n  n_neg <- sum(tree_fixed$edge.length < 0, na.rm = TRUE)\n  n_zero <- sum(tree_fixed$edge.length == 0, na.rm = TRUE)\n\n  cat(\"发现问题边长:\\n\")\n  cat(\"  - NA:\", n_na, \"\\n\")\n  cat(\"  - Inf:\", n_inf, \"\\n\")\n  cat(\"  - 负数:\", n_neg, \"\\n\")\n  cat(\"  - 零:\", n_zero, \"\\n\")\n\n  # 修复异常值：替换为极小的正数\n  small_value <- 1e-6\n\n  # 替换 NA\n  tree_fixed$edge.length[is.na(tree_fixed$edge.length)] <- small_value\n\n  # 替换 Inf\n  tree_fixed$edge.length[is.infinite(tree_fixed$edge.length)] <- small_value\n\n  # 替换负数\n  tree_fixed$edge.length[tree_fixed$edge.length < 0] <- small_value\n\n  # 替换零（某些算法不能处理零边长）\n  tree_fixed$edge.length[tree_fixed$edge.length == 0] <- small_value\n\n  cat(\"\\n修复后边长范围:\", range(tree_fixed$edge.length), \"\\n\")\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n树没有边长信息，创建默认边长...\n```\n\n\n:::\n\n```{.r .cell-code}\n# 更新 TSE 对象中的树\nrowTree(tse_singlem_corepair) <- tree_fixed\n\ncat(\"树修复完成!\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n树修复完成!\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================================================================\n# Step 3: 使用 mia 原生函数计算 UniFrac（OMA 推荐）\n# ==============================================================================\ncat(\"\\n=== 使用 mia 计算 UniFrac 距离 ===\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== 使用 mia 计算 UniFrac 距离 ===\n```\n\n\n:::\n\n```{.r .cell-code}\nunifrac_success <- FALSE\n\ntryCatch({\n  # 确保使用修复后的树\n  tree_for_unifrac <- rowTree(tse_singlem_corepair)\n\n  # 确保 OTU 和树完全匹配\n  common_taxa <- intersect(rownames(tse_singlem_corepair), tree_for_unifrac$tip.label)\n  cat(\"使用\", length(common_taxa), \"个共同 OTU 进行 UniFrac 计算\\n\")\n\n  # 子集化 TSE 对象以确保匹配\n  tse_for_unifrac <- tse_singlem_corepair[common_taxa, ]\n\n  # 修剪树\n  tree_pruned <- ape::keep.tip(tree_for_unifrac, common_taxa)\n  rowTree(tse_for_unifrac) <- tree_pruned\n\n  # 使用 mia::getDissimilarity 计算 UniFrac\n  cat(\"\\n计算 Weighted UniFrac...\\n\")\n  wunifrac_dist <- getDissimilarity(\n    tse_for_unifrac,\n    method = \"unifrac\",\n    weighted = TRUE,\n    assay.type = \"counts\"\n  )\n  cat(\"Weighted UniFrac 完成!\\n\")\n\n  cat(\"计算 Unweighted UniFrac...\\n\")\n  uwunifrac_dist <- getDissimilarity(\n    tse_for_unifrac,\n    method = \"unifrac\",\n    weighted = FALSE,\n    assay.type = \"counts\"\n  )\n  cat(\"Unweighted UniFrac 完成!\\n\")\n\n  unifrac_success <- TRUE\n  cat(\"\\nUniFrac 计算成功!\\n\")\n\n}, error = function(e) {\n  cat(\"\\nUniFrac 计算失败!\\n\")\n  cat(\"错误信息:\", conditionMessage(e), \"\\n\")\n  cat(\"\\n调试信息:\\n\")\n  cat(\"请检查树的边长是否已正确修复\\n\")\n})\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n使用 465 个共同 OTU 进行 UniFrac 计算\n\n计算 Weighted UniFrac...\nWeighted UniFrac 完成!\n计算 Unweighted UniFrac...\nUnweighted UniFrac 完成!\n\nUniFrac 计算成功!\n```\n\n\n:::\n\n```{.r .cell-code}\n# 如果失败，创建占位变量\nif (!unifrac_success) {\n  p_pcoa_wunifrac <- NULL\n  p_pcoa_uwunifrac <- NULL\n  permanova_wunifrac <- data.frame(`Pr(>F)` = NA, check.names = FALSE)\n  permanova_uwunifrac <- data.frame(`Pr(>F)` = NA, check.names = FALSE)\n}\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================================================================\n# Step 3: UniFrac PCoA 可视化\n# ==============================================================================\ncat(\"\\n=== UniFrac PCoA 可视化 ===\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== UniFrac PCoA 可视化 ===\n```\n\n\n:::\n\n```{.r .cell-code}\n# Weighted UniFrac PCoA\npcoa_wuf <- cmdscale(wunifrac_dist, k = min(ncol(tse_singlem_corepair) - 1, 10), eig = TRUE)\nreducedDim(tse_singlem_corepair, \"PCoA_wUniFrac\") <- pcoa_wuf$points\n\neig_wuf <- pcoa_wuf$eig\nrel_eig_wuf <- eig_wuf / sum(eig_wuf[eig_wuf > 0])\n\np_pcoa_wunifrac <- plotReducedDim(tse_singlem_corepair, \"PCoA_wUniFrac\", colour_by = \"treatment_group\") +\n  theme_bw() +\n  labs(title = \"SingleM: PCoA (Weighted UniFrac)\",\n       subtitle = \"进化谱系加权距离 - 识别株系级遗传偏移\",\n       x = paste0(\"PCoA 1 (\", round(100 * rel_eig_wuf[1], 1), \"%)\"),\n       y = paste0(\"PCoA 2 (\", round(100 * rel_eig_wuf[2], 1), \"%)\"))\np_pcoa_wunifrac\n```\n\n::: {.cell-output-display}\n![](03_singlem_diversity_analysis_files/figure-html/singlem-beta-unifrac-viz-1.png){width=672}\n:::\n\n```{.r .cell-code}\nggsave(here::here(\"data\", params$name, \"09_beta_pcoa_wunifrac_singlem.png\"),\n       p_pcoa_wunifrac, width = 8, height = 6, dpi = 300)\n\n# Unweighted UniFrac PCoA\npcoa_uwuf <- cmdscale(uwunifrac_dist, k = min(ncol(tse_singlem_corepair) - 1, 10), eig = TRUE)\nreducedDim(tse_singlem_corepair, \"PCoA_uwUniFrac\") <- pcoa_uwuf$points\n\neig_uwuf <- pcoa_uwuf$eig\nrel_eig_uwuf <- eig_uwuf / sum(eig_uwuf[eig_uwuf > 0])\n\np_pcoa_uwunifrac <- plotReducedDim(tse_singlem_corepair, \"PCoA_uwUniFrac\", colour_by = \"treatment_group\") +\n  theme_bw() +\n  labs(title = \"SingleM: PCoA (Unweighted UniFrac)\",\n       subtitle = \"进化谱系存在/缺失距离 - 识别稀有株系差异\",\n       x = paste0(\"PCoA 1 (\", round(100 * rel_eig_uwuf[1], 1), \"%)\"),\n       y = paste0(\"PCoA 2 (\", round(100 * rel_eig_uwuf[2], 1), \"%)\"))\np_pcoa_uwunifrac\n```\n\n::: {.cell-output-display}\n![](03_singlem_diversity_analysis_files/figure-html/singlem-beta-unifrac-viz-2.png){width=672}\n:::\n\n```{.r .cell-code}\nggsave(here::here(\"data\", params$name, \"10_beta_pcoa_uwunifrac_singlem.png\"),\n       p_pcoa_uwunifrac, width = 8, height = 6, dpi = 300)\n\n# ==============================================================================\n# Step 4: PERMANOVA 检验 (UniFrac)\n# ==============================================================================\npermanova_wunifrac <- vegan::adonis2(\n  wunifrac_dist ~ treatment_group,\n  data = data.frame(colData(tse_singlem_corepair)),\n  permutations = 999\n)\n\npermanova_uwunifrac <- vegan::adonis2(\n  uwunifrac_dist ~ treatment_group,\n  data = data.frame(colData(tse_singlem_corepair)),\n  permutations = 999\n)\n\ncat(\"\\n=== PERMANOVA (Weighted UniFrac) ===\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== PERMANOVA (Weighted UniFrac) ===\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(permanova_wunifrac)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPermutation test for adonis under reduced model\nPermutation: free\nNumber of permutations: 999\n\nvegan::adonis2(formula = wunifrac_dist ~ treatment_group, data = data.frame(colData(tse_singlem_corepair)), permutations = 999)\n         Df SumOfSqs      R2      F Pr(>F)  \nModel     1   8.4835 0.34596 3.7026  0.029 *\nResidual  7  16.0383 0.65404                \nTotal     8  24.5218 1.00000                \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"\\n=== PERMANOVA (Unweighted UniFrac) ===\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== PERMANOVA (Unweighted UniFrac) ===\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(permanova_uwunifrac)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPermutation test for adonis under reduced model\nPermutation: free\nNumber of permutations: 999\n\nvegan::adonis2(formula = uwunifrac_dist ~ treatment_group, data = data.frame(colData(tse_singlem_corepair)), permutations = 999)\n         Df SumOfSqs      R2     F Pr(>F)   \nModel     1  0.16273 0.20028 1.753  0.008 **\nResidual  7  0.64979 0.79972                \nTotal     8  0.81252 1.00000                \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n\n```{.r .cell-code}\nwrite.csv(as.data.frame(permanova_wunifrac),\n          here::here(\"data\", params$name, \"11_permanova_wunifrac_singlem.csv\"), row.names = TRUE)\nwrite.csv(as.data.frame(permanova_uwunifrac),\n          here::here(\"data\", params$name, \"12_permanova_uwunifrac_singlem.csv\"), row.names = TRUE)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================================================================\n# Step 5: Beta 多样性结果汇总图\n# ==============================================================================\nif (unifrac_success && !is.null(p_pcoa_wunifrac)) {\n  p_beta_combined <- (p_pcoa_bray | p_pcoa_wunifrac | p_pcoa_uwunifrac) +\n    plot_annotation(\n      title = \"SingleM Beta Diversity: ApcMUT_HpWT vs ApcMUT_HpKO\",\n      subtitle = \"Bray-Curtis (丰度) vs UniFrac (进化谱系) 距离比较\"\n    )\n\n  ggsave(here::here(\"data\", params$name, \"13_beta_diversity_combined_singlem.png\"),\n         p_beta_combined, width = 18, height = 6, dpi = 300)\n} else {\n  # 仅显示 Bray-Curtis\n  p_beta_combined <- p_pcoa_bray +\n    plot_annotation(\n      title = \"SingleM Beta Diversity: ApcMUT_HpWT vs ApcMUT_HpKO\",\n      subtitle = \"Bray-Curtis distance (UniFrac 计算失败)\"\n    )\n\n  ggsave(here::here(\"data\", params$name, \"13_beta_diversity_combined_singlem.png\"),\n         p_beta_combined, width = 8, height = 6, dpi = 300)\n}\n\np_beta_combined\n```\n\n::: {.cell-output-display}\n![](03_singlem_diversity_analysis_files/figure-html/singlem-beta-combined-1.png){width=672}\n:::\n:::\n\n\n## 6. 差异丰度分析 (DAA)\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================================================================\n# 使用 ANCOM-BC 进行差异丰度分析\n# ==============================================================================\n# 准备数据\ntse_daa <- tse_singlem_corepair\n\n# 运行 ANCOM-BC\nancombc_result <- ancombc2(\n  data = tse_daa,\n  assay_name = \"counts\",\n  fix_formula = \"treatment_group\",\n  p_adj_method = \"BH\",\n  prv_cut = 0.1,\n  lib_cut = 0,\n  group = \"treatment_group\",\n  struc_zero = TRUE,\n  neg_lb = TRUE,\n  alpha = 0.05,\n  global = FALSE\n)\n\n# 提取结果\nancombc_res <- ancombc_result$res\n\n# 查看结果结构和列名\ncat(\"ANCOM-BC 结果列名:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nANCOM-BC 结果列名:\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(colnames(ancombc_res))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"taxon\"                                 \n [2] \"lfc_(Intercept)\"                       \n [3] \"lfc_treatment_groupApcMUT_HpWT\"        \n [4] \"se_(Intercept)\"                        \n [5] \"se_treatment_groupApcMUT_HpWT\"         \n [6] \"W_(Intercept)\"                         \n [7] \"W_treatment_groupApcMUT_HpWT\"          \n [8] \"p_(Intercept)\"                         \n [9] \"p_treatment_groupApcMUT_HpWT\"          \n[10] \"q_(Intercept)\"                         \n[11] \"q_treatment_groupApcMUT_HpWT\"          \n[12] \"diff_(Intercept)\"                      \n[13] \"diff_treatment_groupApcMUT_HpWT\"       \n[14] \"passed_ss_(Intercept)\"                 \n[15] \"passed_ss_treatment_groupApcMUT_HpWT\"  \n[16] \"diff_robust_(Intercept)\"               \n[17] \"diff_robust_treatment_groupApcMUT_HpWT\"\n```\n\n\n:::\n\n```{.r .cell-code}\n# 动态识别 lfc 和 q 值列名（适应不同的因子水平）\nlfc_col <- grep(\"^lfc_treatment_group\", colnames(ancombc_res), value = TRUE)[1]\nq_col <- grep(\"^q_treatment_group\", colnames(ancombc_res), value = TRUE)[1]\n\ncat(\"使用的列名:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n使用的列名:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  LFC 列:\", lfc_col, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  LFC 列: lfc_treatment_groupApcMUT_HpWT \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  Q 值列:\", q_col, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Q 值列: q_treatment_groupApcMUT_HpWT \n```\n\n\n:::\n\n```{.r .cell-code}\n# 添加分类信息\nancombc_res <- ancombc_res |>\n  dplyr::left_join(\n    rowData(tse_daa) |> as.data.frame() |> rownames_to_column(\"taxon\"),\n    by = \"taxon\"\n  )\n\n# 按 q 值排序并取 Top 20\nancombc_top20 <- ancombc_res |>\n  arrange(.data[[q_col]]) |>\n  head(20)\n\ncat(\"\\n=== ANCOM-BC Top 20 差异 OTU ===\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== ANCOM-BC Top 20 差异 OTU ===\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(ancombc_top20 |> dplyr::select(taxon, Phylum, Family, all_of(c(lfc_col, q_col))))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n     taxon         Phylum            Family lfc_treatment_groupApcMUT_HpWT\n1  OTU_233      Bacillota           UBA3700                      2.7513599\n2  OTU_198      Bacillota   Lachnospiraceae                      1.4301972\n3  OTU_115      Bacillota  Oscillospiraceae                      1.2553130\n4  OTU_100      Bacillota  Oscillospiraceae                      1.3275608\n5  OTU_285   Bacteroidota     Rikenellaceae                      1.3370584\n6  OTU_544   Bacteroidota  Chitinophagaceae                      2.4980391\n7  OTU_297  Chrysiogenota  Mucispirillaceae                      2.0999019\n8  OTU_354 Actinomycetota Microbacteriaceae                     -1.7792945\n9   OTU_87 Actinomycetota   Eggerthellaceae                     -0.9492528\n10  OTU_18 Actinomycetota              <NA>                      1.1544624\n11 OTU_155      Bacillota   Lachnospiraceae                      1.1654897\n12 OTU_160      Bacillota   Lachnospiraceae                      1.2555437\n13  OTU_43      Bacillota  Oscillospiraceae                      1.3409735\n14  OTU_40      Bacillota  Oscillospiraceae                      0.7991612\n15 OTU_444      Bacillota   Ruminococcaceae                      2.1235990\n16   OTU_6 Actinomycetota              <NA>                     -1.1312547\n17 OTU_129      Bacillota  Oscillospiraceae                      0.8999184\n18 OTU_464      Bacillota   Lachnospiraceae                      1.2415679\n19 OTU_169      Bacillota   Lachnospiraceae                     -0.8794668\n20 OTU_164      Bacillota   Lachnospiraceae                      0.9788334\n   q_treatment_groupApcMUT_HpWT\n1                     0.1933793\n2                     0.1933793\n3                     0.1933793\n4                     0.1933793\n5                     0.1933793\n6                     0.1933793\n7                     0.1933793\n8                     0.2265670\n9                     0.2265670\n10                    0.2265670\n11                    0.2265670\n12                    0.2265670\n13                    0.2265670\n14                    0.2265670\n15                    0.2265670\n16                    0.2605927\n17                    0.2605927\n18                    0.3046710\n19                    0.3296443\n20                    0.3296443\n```\n\n\n:::\n\n```{.r .cell-code}\n# 保存结果\nwrite.csv(\n  ancombc_res,\n  file = here::here(\"data\", params$name, \"14_daa_ancombc_singlem_full.csv\"),\n  row.names = FALSE\n)\n\nwrite.csv(\n  ancombc_top20,\n  file = here::here(\"data\", params$name, \"15_daa_ancombc_singlem_top20.csv\"),\n  row.names = FALSE\n)\n\n# ==============================================================================\n# 火山图\n# ==============================================================================\np_volcano <- ggplot(ancombc_res, aes(\n  x = .data[[lfc_col]],\n  y = -log10(.data[[q_col]])\n)) +\n  geom_point(aes(color = .data[[q_col]] < 0.05), alpha = 0.6) +\n  scale_color_manual(values = c(\"grey50\", \"red\"), labels = c(\"NS\", \"q < 0.05\")) +\n  geom_hline(yintercept = -log10(0.05), linetype = \"dashed\", color = \"blue\") +\n  theme_bw() +\n  labs(\n    title = \"SingleM: Differential Abundance (ANCOM-BC)\",\n    subtitle = \"ApcMUT_HpWT vs ApcMUT_HpKO\",\n    x = \"Log2 Fold Change\",\n    y = \"-log10(q-value)\",\n    color = \"Significance\"\n  )\np_volcano\n```\n\n::: {.cell-output-display}\n![](03_singlem_diversity_analysis_files/figure-html/singlem-daa-1.png){width=672}\n:::\n\n```{.r .cell-code}\nggsave(\n  filename = here::here(\"data\", params$name, \"16_volcano_daa_singlem.png\"),\n  plot = p_volcano, width = 10, height = 8, dpi = 300\n)\n```\n:::\n\n\n\n# Part 2: Lyrebird 噬菌体分析\n\nLyrebird 是 SingleM 框架内专门用于分析 dsDNA 噬菌体（Caudoviricetes）的模块。\n\n## 7. Lyrebird 数据导入与 TSE 构建\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================================================================\n# Step 1: 定义数据路径\n# ==============================================================================\nlyrebird_data_path <- here::here(\n  \"data\", \"00-raw\", \"d03_singlem_diversity_analysis\", \"pc047-rst_lyrebird\"\n)\n\n# ==============================================================================\n# Step 2: 读取 OTU 丰度矩阵\n# ==============================================================================\nlyrebird_abundance <- read_tsv(\n  file.path(lyrebird_data_path, \"pc047-lyrebird_OTU_abundance.tsv\"),\n  show_col_types = FALSE\n) |>\n  column_to_rownames(\"otu_id\") |>\n  as.matrix()\n\n# 将百分比转换为比例\nlyrebird_abundance <- lyrebird_abundance / 100\n\ncat(\"Lyrebird OTU 矩阵维度:\", dim(lyrebird_abundance), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLyrebird OTU 矩阵维度: 1443 33 \n```\n\n\n:::\n\n```{.r .cell-code}\n# ==============================================================================\n# Step 3: 读取 OTU 分类信息\n# ==============================================================================\nlyrebird_taxonomy <- read_tsv(\n  file.path(lyrebird_data_path, \"pc047-lyrebird_OTU_taxonomy.tsv\"),\n  show_col_types = FALSE\n) |>\n  column_to_rownames(\"otu_id\") |>\n  DataFrame()\n\ncat(\"Lyrebird 分类层级:\", colnames(lyrebird_taxonomy), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLyrebird 分类层级: Root Domain Phylum Class Order Family Genus Species \n```\n\n\n:::\n\n```{.r .cell-code}\n# ==============================================================================\n# Step 4: 读取系统发育树\n# ==============================================================================\nlyrebird_tree <- ape::read.tree(\n  file.path(lyrebird_data_path, \"pc047-lyrebird_OTU_tree.nwk\")\n)\n\ncat(\"Lyrebird 系统发育树 tip 数:\", length(lyrebird_tree$tip.label), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLyrebird 系统发育树 tip 数: 1443 \n```\n\n\n:::\n\n```{.r .cell-code}\n# ==============================================================================\n# Step 5: 构建 TSE 对象\n# ==============================================================================\ncommon_otus_lyrebird <- intersect(rownames(lyrebird_abundance), rownames(lyrebird_taxonomy))\ncommon_otus_lyrebird <- intersect(common_otus_lyrebird, lyrebird_tree$tip.label)\n\ncat(\"Lyrebird 共同 OTU 数:\", length(common_otus_lyrebird), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLyrebird 共同 OTU 数: 1443 \n```\n\n\n:::\n\n```{.r .cell-code}\nlyrebird_abundance <- lyrebird_abundance[common_otus_lyrebird, ]\nlyrebird_taxonomy <- lyrebird_taxonomy[common_otus_lyrebird, ]\nlyrebird_tree <- ape::keep.tip(lyrebird_tree, common_otus_lyrebird)\n\ntse_lyrebird <- TreeSummarizedExperiment(\n  assays = list(\n    relabundance = lyrebird_abundance,\n    counts = round(lyrebird_abundance * 10000)\n  ),\n  rowData = lyrebird_taxonomy,\n  rowTree = lyrebird_tree\n)\n\n# 绑定元数据\ncommon_samples_lyrebird <- intersect(colnames(tse_lyrebird), rownames(metadata))\ntse_lyrebird <- tse_lyrebird[, common_samples_lyrebird]\ncolData(tse_lyrebird) <- DataFrame(metadata[common_samples_lyrebird, ])\n\n# 创建 Caecum 子集\ntse_lyrebird_ca <- tse_lyrebird[, tse_lyrebird$source_organ == \"caecum\"]\n\ncat(\"Lyrebird Caecum 样本数:\", ncol(tse_lyrebird_ca), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLyrebird Caecum 样本数: 29 \n```\n\n\n:::\n\n```{.r .cell-code}\ntse_lyrebird_ca\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nclass: TreeSummarizedExperiment \ndim: 1443 29 \nmetadata(0):\nassays(2): relabundance counts\nrownames(1443): OTU_1 OTU_2 ... OTU_1442 OTU_1443\nrowData names(8): Root Domain ... Genus Species\ncolnames(29): ca01 ca02 ... ca29 ca30\ncolData names(11): mouse_id genotype ... path_r1 path_r2\nreducedDimNames(0):\nmainExpName: NULL\naltExpNames(0):\nrowLinks: a LinkDataFrame (1443 rows)\nrowTree: 1 phylo tree(s) (1443 leaves)\ncolLinks: NULL\ncolTree: NULL\n```\n\n\n:::\n:::\n\n\n## 8. Lyrebird 数据清洗\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================================================================\n# 1. 移除异常样本 (与 SingleM 保持一致)\n# ==============================================================================\nif (\"ca08\" %in% colnames(tse_lyrebird_ca)) {\n  tse_lyrebird_ca <- tse_lyrebird_ca[, colnames(tse_lyrebird_ca) != \"ca08\"]\n}\n\n# ==============================================================================\n# 2. Prevalence 过滤\n# ==============================================================================\ntse_lyrebird_ca <- addPrevalence(\n  tse_lyrebird_ca,\n  assay.type = \"relabundance\",\n  detection = 0,\n  as.relative = FALSE\n)\n\ncat(\"Lyrebird 过滤前 OTU 数:\", nrow(tse_lyrebird_ca), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLyrebird 过滤前 OTU 数: 1443 \n```\n\n\n:::\n\n```{.r .cell-code}\ntse_lyrebird_ca <- subsetByPrevalent(tse_lyrebird_ca, prevalence = 0.1)\ncat(\"Lyrebird 过滤后 OTU 数:\", nrow(tse_lyrebird_ca), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLyrebird 过滤后 OTU 数: 878 \n```\n\n\n:::\n\n```{.r .cell-code}\n# 保存清洗后的数据\ntse_lyrebird_ca_cleaned <- tse_lyrebird_ca\nsaveRDS(\n  tse_lyrebird_ca_cleaned,\n  file = here::here(\"data\", params$name, \"tse_lyrebird_ca_cleaned.rds\")\n)\n```\n:::\n\n\n## 9. Lyrebird 群落组成与多样性\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================================================================\n# 1. 噬菌体组成图\n# ==============================================================================\ntop_phages <- getTop(tse_lyrebird_ca_cleaned, top = 10, assay.type = \"relabundance\")\n\ntse_lyrebird_plot <- tse_lyrebird_ca_cleaned\nrowData(tse_lyrebird_plot)$Phage_Top10 <- ifelse(\n  rownames(tse_lyrebird_plot) %in% top_phages,\n  paste0(rownames(tse_lyrebird_plot), \" (\", rowData(tse_lyrebird_plot)$Family, \")\"),\n  \"Other\"\n)\n\ntse_lyrebird_plot_agg <- agglomerateByVariable(tse_lyrebird_plot, by = \"rows\", f = \"Phage_Top10\")\n\np_lyrebird_comp <- plotAbundance(\n  tse_lyrebird_plot_agg,\n  assay.type = \"relabundance\",\n  order.row.by = \"abund\"\n) +\n  labs(\n    title = \"Lyrebird: Top 10 Phage OTU Composition (Caecum)\",\n    subtitle = \"dsDNA Phage (Caudoviricetes) communities\"\n  ) +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))\n\np_lyrebird_comp\n```\n\n::: {.cell-output-display}\n![](03_singlem_diversity_analysis_files/figure-html/lyrebird-diversity-1.png){width=1152}\n:::\n\n```{.r .cell-code}\nggsave(\n  filename = here::here(\"data\", params$name, \"17_composition_top10_lyrebird.png\"),\n  plot = p_lyrebird_comp, width = 14, height = 8, dpi = 300\n)\n\n# ==============================================================================\n# 2. Alpha 多样性\n# ==============================================================================\ntse_lyrebird_ca_cleaned <- addAlpha(\n  tse_lyrebird_ca_cleaned,\n  assay.type = \"counts\",\n  index = c(\"shannon\", \"observed\"),\n  name = c(\"shannon_index\", \"observed_richness\")\n)\n\n# 提取核心比较组\ntse_lyrebird_corepair <- tse_lyrebird_ca_cleaned[\n  , tse_lyrebird_ca_cleaned$treatment_group %in% c(\"ApcMUT_HpWT\", \"ApcMUT_HpKO\")\n]\ntse_lyrebird_corepair$treatment_group <- factor(tse_lyrebird_corepair$treatment_group)\n\n# Wilcoxon 检验\nwilcox_lyrebird_shannon <- wilcox.test(\n  shannon_index ~ treatment_group,\n  data = colData(tse_lyrebird_corepair)\n)\ncat(\"\\nLyrebird Shannon Wilcoxon P 值:\", round(wilcox_lyrebird_shannon$p.value, 4), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nLyrebird Shannon Wilcoxon P 值: 0.0317 \n```\n\n\n:::\n\n```{.r .cell-code}\n# 可视化\np_lyrebird_shannon <- plot_alpha(tse_lyrebird_corepair, \"shannon_index\", \"Lyrebird: Shannon Diversity\")\np_lyrebird_observed <- plot_alpha(tse_lyrebird_corepair, \"observed_richness\", \"Lyrebird: Observed Phage OTUs\")\n\np_lyrebird_alpha <- p_lyrebird_shannon + p_lyrebird_observed +\n  plot_annotation(title = \"Lyrebird (Phage) Alpha Diversity\")\np_lyrebird_alpha\n```\n\n::: {.cell-output-display}\n![](03_singlem_diversity_analysis_files/figure-html/lyrebird-diversity-2.png){width=1152}\n:::\n\n```{.r .cell-code}\nggsave(\n  filename = here::here(\"data\", params$name, \"18_alpha_diversity_lyrebird.png\"),\n  plot = p_lyrebird_alpha, width = 12, height = 6, dpi = 300\n)\n\n# ==============================================================================\n# 3. Beta 多样性 (Bray-Curtis)\n# ==============================================================================\ntse_lyrebird_corepair <- runMDS(\n  tse_lyrebird_corepair,\n  FUN = vegan::vegdist,\n  method = \"bray\",\n  assay.type = \"relabundance\",\n  name = \"PCoA_Bray\"\n)\n\neig_lyrebird_bray <- attr(reducedDim(tse_lyrebird_corepair, \"PCoA_Bray\"), \"eig\")\nrel_eig_lyrebird_bray <- eig_lyrebird_bray / sum(eig_lyrebird_bray[eig_lyrebird_bray > 0])\n\np_lyrebird_pcoa <- plotReducedDim(\n  tse_lyrebird_corepair,\n  \"PCoA_Bray\",\n  colour_by = \"treatment_group\"\n) +\n  theme_bw() +\n  labs(\n    title = \"Lyrebird: PCoA (Bray-Curtis)\",\n    subtitle = \"Phage community structure\",\n    x = paste0(\"PCoA 1 (\", round(100 * rel_eig_lyrebird_bray[1], 1), \"%)\"),\n    y = paste0(\"PCoA 2 (\", round(100 * rel_eig_lyrebird_bray[2], 1), \"%)\")\n  )\np_lyrebird_pcoa\n```\n\n::: {.cell-output-display}\n![](03_singlem_diversity_analysis_files/figure-html/lyrebird-diversity-3.png){width=1152}\n:::\n\n```{.r .cell-code}\nggsave(\n  filename = here::here(\"data\", params$name, \"19_beta_pcoa_bray_lyrebird.png\"),\n  plot = p_lyrebird_pcoa, width = 8, height = 6, dpi = 300\n)\n\n# PERMANOVA\npermanova_lyrebird <- getPERMANOVA(\n  tse_lyrebird_corepair,\n  assay.type = \"relabundance\",\n  formula = x ~ treatment_group\n)\n\ncat(\"\\n=== Lyrebird PERMANOVA (Bray-Curtis) ===\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== Lyrebird PERMANOVA (Bray-Curtis) ===\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(permanova_lyrebird$permanova)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPermutation test for adonis under reduced model\nMarginal effects of terms\nPermutation: free\nNumber of permutations: 999\n\nadonis2(formula = formula, data = data, method = ..1, by = by, na.action = na.action)\n                Df SumOfSqs      R2      F Pr(>F)  \ntreatment_group  1  0.27883 0.26715 2.5518  0.057 .\nResidual         7  0.76488 0.73285                \nTotal            8  1.04371 1.00000                \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n\n```{.r .cell-code}\nwrite.csv(\n  permanova_lyrebird$permanova,\n  file = here::here(\"data\", params$name, \"20_permanova_bray_lyrebird.csv\"),\n  row.names = TRUE\n)\n```\n:::\n\n\n## 10. Lyrebird UniFrac 分析\n\n借鉴 Part 1 的经验，Lyrebird 的系统发育树也可能存在边长问题，需要先诊断和修复。\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================================================================\n# Step 1: 诊断 Lyrebird 树和 OTU 矩阵的匹配情况\n# ==============================================================================\ncat(\"=== Lyrebird UniFrac 计算前诊断 ===\\n\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n=== Lyrebird UniFrac 计算前诊断 ===\n```\n\n\n:::\n\n```{.r .cell-code}\n# 获取树和 OTU 信息\ntree_lyrebird <- rowTree(tse_lyrebird_corepair)\notu_names_lyrebird <- rownames(tse_lyrebird_corepair)\ntree_tips_lyrebird <- tree_lyrebird$tip.label\n\ncat(\"OTU 矩阵中的 OTU 数量:\", length(otu_names_lyrebird), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nOTU 矩阵中的 OTU 数量: 878 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"系统发育树的 tip 数量:\", length(tree_tips_lyrebird), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n系统发育树的 tip 数量: 878 \n```\n\n\n:::\n\n```{.r .cell-code}\n# 检查匹配情况\nin_both_lyrebird <- intersect(otu_names_lyrebird, tree_tips_lyrebird)\ncat(\"两者共有的 OTU:\", length(in_both_lyrebird), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n两者共有的 OTU: 878 \n```\n\n\n:::\n\n```{.r .cell-code}\n# 检查树结构\ncat(\"\\n树结构检查:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n树结构检查:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  - 是否为二叉树:\", ape::is.binary(tree_lyrebird), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - 是否为二叉树: FALSE \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  - 是否有根:\", ape::is.rooted(tree_lyrebird), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - 是否有根: FALSE \n```\n\n\n:::\n\n```{.r .cell-code}\n# 检查边长\nif (!is.null(tree_lyrebird$edge.length) && length(tree_lyrebird$edge.length) > 0) {\n  valid_edges_lyrebird <- tree_lyrebird$edge.length[is.finite(tree_lyrebird$edge.length)]\n  if (length(valid_edges_lyrebird) > 0) {\n    cat(\"  - 有效边长范围:\", range(valid_edges_lyrebird), \"\\n\")\n  } else {\n    cat(\"  - 有效边长范围: 无有效边长!\\n\")\n  }\n  cat(\"  - 总边数:\", length(tree_lyrebird$edge.length), \"\\n\")\n  cat(\"  - NA 边长数量:\", sum(is.na(tree_lyrebird$edge.length)), \"\\n\")\n  cat(\"  - Inf 边长数量:\", sum(is.infinite(tree_lyrebird$edge.length)), \"\\n\")\n  cat(\"  - 负数边长数量:\", sum(tree_lyrebird$edge.length < 0, na.rm = TRUE), \"\\n\")\n} else {\n  cat(\"  - 边长信息: 树没有边长信息!\\n\")\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - 边长信息: 树没有边长信息!\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================================================================\n# Step 2: 修复 Lyrebird 树的边长问题\n# ==============================================================================\ncat(\"\\n=== 修复 Lyrebird 树的边长 ===\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== 修复 Lyrebird 树的边长 ===\n```\n\n\n:::\n\n```{.r .cell-code}\ntree_lyrebird_original <- rowTree(tse_lyrebird_corepair)\ntree_lyrebird_fixed <- tree_lyrebird_original\n\nif (is.null(tree_lyrebird_fixed$edge.length) || length(tree_lyrebird_fixed$edge.length) == 0) {\n  cat(\"树没有边长信息，创建默认边长...\\n\")\n  tree_lyrebird_fixed$edge.length <- rep(1, nrow(tree_lyrebird_fixed$edge))\n} else {\n  # 统计问题边长\n  n_na <- sum(is.na(tree_lyrebird_fixed$edge.length))\n  n_inf <- sum(is.infinite(tree_lyrebird_fixed$edge.length))\n  n_neg <- sum(tree_lyrebird_fixed$edge.length < 0, na.rm = TRUE)\n  n_zero <- sum(tree_lyrebird_fixed$edge.length == 0, na.rm = TRUE)\n\n  cat(\"发现问题边长:\\n\")\n  cat(\"  - NA:\", n_na, \"\\n\")\n  cat(\"  - Inf:\", n_inf, \"\\n\")\n  cat(\"  - 负数:\", n_neg, \"\\n\")\n  cat(\"  - 零:\", n_zero, \"\\n\")\n\n  # 修复异常值\n  small_value <- 1e-6\n  tree_lyrebird_fixed$edge.length[is.na(tree_lyrebird_fixed$edge.length)] <- small_value\n  tree_lyrebird_fixed$edge.length[is.infinite(tree_lyrebird_fixed$edge.length)] <- small_value\n  tree_lyrebird_fixed$edge.length[tree_lyrebird_fixed$edge.length < 0] <- small_value\n  tree_lyrebird_fixed$edge.length[tree_lyrebird_fixed$edge.length == 0] <- small_value\n\n  cat(\"\\n修复后边长范围:\", range(tree_lyrebird_fixed$edge.length), \"\\n\")\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n树没有边长信息，创建默认边长...\n```\n\n\n:::\n\n```{.r .cell-code}\nrowTree(tse_lyrebird_corepair) <- tree_lyrebird_fixed\ncat(\"Lyrebird 树修复完成!\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLyrebird 树修复完成!\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================================================================\n# Step 3: 使用 mia 计算 Lyrebird UniFrac\n# ==============================================================================\ncat(\"\\n=== 使用 mia 计算 Lyrebird UniFrac 距离 ===\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== 使用 mia 计算 Lyrebird UniFrac 距离 ===\n```\n\n\n:::\n\n```{.r .cell-code}\nlyrebird_unifrac_success <- FALSE\n\ntryCatch({\n  tree_for_unifrac_lyrebird <- rowTree(tse_lyrebird_corepair)\n  common_taxa_lyrebird <- intersect(rownames(tse_lyrebird_corepair), tree_for_unifrac_lyrebird$tip.label)\n  cat(\"使用\", length(common_taxa_lyrebird), \"个共同 OTU 进行 UniFrac 计算\\n\")\n\n  tse_for_unifrac_lyrebird <- tse_lyrebird_corepair[common_taxa_lyrebird, ]\n  tree_pruned_lyrebird <- ape::keep.tip(tree_for_unifrac_lyrebird, common_taxa_lyrebird)\n  rowTree(tse_for_unifrac_lyrebird) <- tree_pruned_lyrebird\n\n  cat(\"\\n计算 Weighted UniFrac...\\n\")\n  wunifrac_dist_lyrebird <- getDissimilarity(\n    tse_for_unifrac_lyrebird,\n    method = \"unifrac\",\n    weighted = TRUE,\n    assay.type = \"counts\"\n  )\n  cat(\"Weighted UniFrac 完成!\\n\")\n\n  cat(\"计算 Unweighted UniFrac...\\n\")\n  uwunifrac_dist_lyrebird <- getDissimilarity(\n    tse_for_unifrac_lyrebird,\n    method = \"unifrac\",\n    weighted = FALSE,\n    assay.type = \"counts\"\n  )\n  cat(\"Unweighted UniFrac 完成!\\n\")\n\n  lyrebird_unifrac_success <- TRUE\n  cat(\"\\nLyrebird UniFrac 计算成功!\\n\")\n\n}, error = function(e) {\n  cat(\"\\nLyrebird UniFrac 计算失败!\\n\")\n  cat(\"错误信息:\", conditionMessage(e), \"\\n\")\n})\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n使用 878 个共同 OTU 进行 UniFrac 计算\n\n计算 Weighted UniFrac...\nWeighted UniFrac 完成!\n计算 Unweighted UniFrac...\nUnweighted UniFrac 完成!\n\nLyrebird UniFrac 计算成功!\n```\n\n\n:::\n\n```{.r .cell-code}\nif (!lyrebird_unifrac_success) {\n  p_pcoa_wunifrac_lyrebird <- NULL\n  p_pcoa_uwunifrac_lyrebird <- NULL\n  permanova_wunifrac_lyrebird <- data.frame(`Pr(>F)` = NA, check.names = FALSE)\n  permanova_uwunifrac_lyrebird <- data.frame(`Pr(>F)` = NA, check.names = FALSE)\n}\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================================================================\n# Step 4: Lyrebird UniFrac PCoA 可视化\n# ==============================================================================\n\n# Weighted UniFrac PCoA\npcoa_wunifrac_lyrebird <- cmdscale(wunifrac_dist_lyrebird, eig = TRUE, k = 2)\neig_wunifrac_lyrebird <- pcoa_wunifrac_lyrebird$eig\nrel_eig_wunifrac_lyrebird <- eig_wunifrac_lyrebird / sum(eig_wunifrac_lyrebird[eig_wunifrac_lyrebird > 0])\n\npcoa_df_wunifrac_lyrebird <- data.frame(\n  PCoA1 = pcoa_wunifrac_lyrebird$points[, 1],\n  PCoA2 = pcoa_wunifrac_lyrebird$points[, 2],\n  treatment_group = colData(tse_lyrebird_corepair)$treatment_group\n)\n\np_pcoa_wunifrac_lyrebird <- ggplot(pcoa_df_wunifrac_lyrebird, aes(x = PCoA1, y = PCoA2, color = treatment_group)) +\n  geom_point(size = 3) +\n  theme_bw() +\n  labs(\n    title = \"Lyrebird: PCoA (Weighted UniFrac)\",\n    x = paste0(\"PCoA 1 (\", round(100 * rel_eig_wunifrac_lyrebird[1], 1), \"%)\"),\n    y = paste0(\"PCoA 2 (\", round(100 * rel_eig_wunifrac_lyrebird[2], 1), \"%)\")\n  )\n\n# Unweighted UniFrac PCoA\npcoa_uwunifrac_lyrebird <- cmdscale(uwunifrac_dist_lyrebird, eig = TRUE, k = 2)\neig_uwunifrac_lyrebird <- pcoa_uwunifrac_lyrebird$eig\nrel_eig_uwunifrac_lyrebird <- eig_uwunifrac_lyrebird / sum(eig_uwunifrac_lyrebird[eig_uwunifrac_lyrebird > 0])\n\npcoa_df_uwunifrac_lyrebird <- data.frame(\n  PCoA1 = pcoa_uwunifrac_lyrebird$points[, 1],\n  PCoA2 = pcoa_uwunifrac_lyrebird$points[, 2],\n  treatment_group = colData(tse_lyrebird_corepair)$treatment_group\n)\n\np_pcoa_uwunifrac_lyrebird <- ggplot(pcoa_df_uwunifrac_lyrebird, aes(x = PCoA1, y = PCoA2, color = treatment_group)) +\n  geom_point(size = 3) +\n  theme_bw() +\n  labs(\n    title = \"Lyrebird: PCoA (Unweighted UniFrac)\",\n    x = paste0(\"PCoA 1 (\", round(100 * rel_eig_uwunifrac_lyrebird[1], 1), \"%)\"),\n    y = paste0(\"PCoA 2 (\", round(100 * rel_eig_uwunifrac_lyrebird[2], 1), \"%)\")\n  )\n\n# 组合图\np_lyrebird_unifrac_combined <- p_pcoa_wunifrac_lyrebird + p_pcoa_uwunifrac_lyrebird +\n  plot_annotation(title = \"Lyrebird (Phage) UniFrac Beta Diversity\")\np_lyrebird_unifrac_combined\n```\n\n::: {.cell-output-display}\n![](03_singlem_diversity_analysis_files/figure-html/lyrebird-unifrac-viz-1.png){width=1344}\n:::\n\n```{.r .cell-code}\nggsave(\n  filename = here::here(\"data\", params$name, \"21_beta_pcoa_unifrac_lyrebird.png\"),\n  plot = p_lyrebird_unifrac_combined, width = 14, height = 6, dpi = 300\n)\n\n# PERMANOVA\ncat(\"\\n=== Lyrebird PERMANOVA (Weighted UniFrac) ===\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== Lyrebird PERMANOVA (Weighted UniFrac) ===\n```\n\n\n:::\n\n```{.r .cell-code}\npermanova_wunifrac_lyrebird <- vegan::adonis2(\n  wunifrac_dist_lyrebird ~ treatment_group,\n  data = as.data.frame(colData(tse_lyrebird_corepair)),\n  permutations = 999\n)\nprint(permanova_wunifrac_lyrebird)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPermutation test for adonis under reduced model\nPermutation: free\nNumber of permutations: 999\n\nvegan::adonis2(formula = wunifrac_dist_lyrebird ~ treatment_group, data = as.data.frame(colData(tse_lyrebird_corepair)), permutations = 999)\n         Df SumOfSqs      R2      F Pr(>F)  \nModel     1   3.7073 0.26506 2.5246   0.05 *\nResidual  7  10.2796 0.73494                \nTotal     8  13.9869 1.00000                \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"\\n=== Lyrebird PERMANOVA (Unweighted UniFrac) ===\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== Lyrebird PERMANOVA (Unweighted UniFrac) ===\n```\n\n\n:::\n\n```{.r .cell-code}\npermanova_uwunifrac_lyrebird <- vegan::adonis2(\n  uwunifrac_dist_lyrebird ~ treatment_group,\n  data = as.data.frame(colData(tse_lyrebird_corepair)),\n  permutations = 999\n)\nprint(permanova_uwunifrac_lyrebird)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPermutation test for adonis under reduced model\nPermutation: free\nNumber of permutations: 999\n\nvegan::adonis2(formula = uwunifrac_dist_lyrebird ~ treatment_group, data = as.data.frame(colData(tse_lyrebird_corepair)), permutations = 999)\n         Df SumOfSqs      R2      F Pr(>F)  \nModel     1  0.15278 0.21696 1.9395  0.043 *\nResidual  7  0.55143 0.78304                \nTotal     8  0.70422 1.00000                \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n\n```{.r .cell-code}\nwrite.csv(\n  permanova_wunifrac_lyrebird,\n  file = here::here(\"data\", params$name, \"22_permanova_wunifrac_lyrebird.csv\"),\n  row.names = TRUE\n)\nwrite.csv(\n  permanova_uwunifrac_lyrebird,\n  file = here::here(\"data\", params$name, \"23_permanova_uwunifrac_lyrebird.csv\"),\n  row.names = TRUE\n)\n```\n:::\n\n\n## 11. Lyrebird 差异丰度分析 (ANCOM-BC)\n\n识别在 CagA 野生型 vs CagA 敲除组之间差异丰富的噬菌体 OTU。\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================================================================\n# ANCOM-BC2 差异丰度分析\n# ==============================================================================\ncat(\"=== Lyrebird ANCOM-BC2 差异丰度分析 ===\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n=== Lyrebird ANCOM-BC2 差异丰度分析 ===\n```\n\n\n:::\n\n```{.r .cell-code}\n# 准备数据：需要 counts assay\ntse_daa_lyrebird <- tse_lyrebird_corepair\n\n# 运行 ANCOM-BC2\nancombc_output_lyrebird <- ancombc2(\n  data = tse_daa_lyrebird,\n  assay.type = \"counts\",\n  fix_formula = \"treatment_group\",\n  p_adj_method = \"fdr\",\n  prv_cut = 0.1,\n  lib_cut = 0,\n  group = \"treatment_group\",\n  struc_zero = TRUE,\n  neg_lb = TRUE,\n  alpha = 0.05,\n  global = FALSE,\n  verbose = TRUE\n)\n\n# 提取结果\nancombc_res_lyrebird <- ancombc_output_lyrebird$res\n\n# 动态查找列名\nlfc_col_lyrebird <- grep(\"^lfc_\", colnames(ancombc_res_lyrebird), value = TRUE)[1]\nq_col_lyrebird <- grep(\"^q_\", colnames(ancombc_res_lyrebird), value = TRUE)[1]\n\ncat(\"使用的列名:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n使用的列名:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  LFC 列:\", lfc_col_lyrebird, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  LFC 列: lfc_(Intercept) \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  Q 值列:\", q_col_lyrebird, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Q 值列: q_(Intercept) \n```\n\n\n:::\n\n```{.r .cell-code}\n# 添加分类信息\nancombc_res_lyrebird <- ancombc_res_lyrebird |>\n  dplyr::left_join(\n    rowData(tse_daa_lyrebird) |> as.data.frame() |> rownames_to_column(\"taxon\"),\n    by = \"taxon\"\n  )\n\n# 按 q 值排序并取 Top 20\nancombc_top20_lyrebird <- ancombc_res_lyrebird |>\n  arrange(.data[[q_col_lyrebird]]) |>\n  head(20)\n\ncat(\"\\n=== Lyrebird ANCOM-BC Top 20 差异噬菌体 OTU ===\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== Lyrebird ANCOM-BC Top 20 差异噬菌体 OTU ===\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(ancombc_top20_lyrebird |> dplyr::select(taxon, Family, all_of(c(lfc_col_lyrebird, q_col_lyrebird))))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n     taxon                                               Family lfc_(Intercept)\n1  OTU_452 novel_family_198_of_novel_order_89_of_Caudoviricetes      -1.2098370\n2   OTU_32  novel_family_42_of_novel_order_89_of_Caudoviricetes       0.6556359\n3  OTU_117  novel_family_42_of_novel_order_89_of_Caudoviricetes       0.6889229\n4  OTU_291 novel_family_20_of_novel_order_213_of_Caudoviricetes      -0.7940812\n5  OTU_344  novel_family_52_of_novel_order_86_of_Caudoviricetes      -0.7342270\n6  OTU_527  novel_family_52_of_novel_order_86_of_Caudoviricetes      -0.8622626\n7  OTU_590  novel_family_6_of_novel_order_141_of_Caudoviricetes       1.2776161\n8  OTU_465 novel_family_199_of_novel_order_89_of_Caudoviricetes      -0.4442871\n9  OTU_114 novel_family_198_of_novel_order_89_of_Caudoviricetes      -1.1017314\n10 OTU_127 novel_family_131_of_novel_order_89_of_Caudoviricetes       1.1799765\n11 OTU_539 novel_family_25_of_novel_order_123_of_Caudoviricetes      -0.6279100\n12  OTU_82 novel_family_20_of_novel_order_205_of_Caudoviricetes       0.7187393\n13 OTU_387 novel_family_25_of_novel_order_123_of_Caudoviricetes      -0.6960128\n14   OTU_3                                                 <NA>       0.6224263\n15 OTU_568 novel_family_11_of_novel_order_142_of_Caudoviricetes       0.5670256\n16 OTU_396 novel_family_37_of_novel_order_143_of_Caudoviricetes      -0.3642664\n17 OTU_392 novel_family_56_of_novel_order_143_of_Caudoviricetes       0.6293459\n18 OTU_529 novel_family_20_of_novel_order_205_of_Caudoviricetes      -0.8611610\n19 OTU_354 novel_family_20_of_novel_order_205_of_Caudoviricetes      -0.4861191\n20 OTU_485  novel_family_81_of_novel_order_96_of_Caudoviricetes      -0.6029827\n   q_(Intercept)\n1    0.003699226\n2    0.003699226\n3    0.004203810\n4    0.005018931\n5    0.007320107\n6    0.007320107\n7    0.009293767\n8    0.009293767\n9    0.013916633\n10   0.021650988\n11   0.026966574\n12   0.033280198\n13   0.040842413\n14   0.040842413\n15   0.040842413\n16   0.040842413\n17   0.040842413\n18   0.040842413\n19   0.041032731\n20   0.047869818\n```\n\n\n:::\n\n```{.r .cell-code}\n# 保存完整结果\nwrite.csv(\n  ancombc_res_lyrebird,\n  file = here::here(\"data\", params$name, \"24_ancombc_lyrebird_full.csv\"),\n  row.names = FALSE\n)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================================================================\n# 火山图可视化\n# ==============================================================================\n\n# 准备火山图数据\nvolcano_data_lyrebird <- ancombc_res_lyrebird |>\n  mutate(\n    sig = .data[[q_col_lyrebird]] < 0.05,\n    direction = case_when(\n      .data[[q_col_lyrebird]] < 0.05 & .data[[lfc_col_lyrebird]] > 0 ~ \"Up in HpWT\",\n      .data[[q_col_lyrebird]] < 0.05 & .data[[lfc_col_lyrebird]] < 0 ~ \"Up in HpKO\",\n      TRUE ~ \"NS\"\n    )\n  )\n\n# 统计差异 OTU 数量\nn_sig_up_lyrebird <- sum(volcano_data_lyrebird$direction == \"Up in HpWT\", na.rm = TRUE)\nn_sig_down_lyrebird <- sum(volcano_data_lyrebird$direction == \"Up in HpKO\", na.rm = TRUE)\ncat(\"\\n差异噬菌体 OTU 统计:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n差异噬菌体 OTU 统计:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  Up in HpWT (CagA+):\", n_sig_up_lyrebird, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Up in HpWT (CagA+): 8 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  Up in HpKO (CagA-):\", n_sig_down_lyrebird, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Up in HpKO (CagA-): 12 \n```\n\n\n:::\n\n```{.r .cell-code}\np_volcano_lyrebird <- ggplot(volcano_data_lyrebird, aes(x = .data[[lfc_col_lyrebird]], y = -log10(.data[[q_col_lyrebird]]))) +\n  geom_point(aes(color = direction), alpha = 0.6, size = 2) +\n  scale_color_manual(values = c(\"Up in HpWT\" = \"#E41A1C\", \"Up in HpKO\" = \"#377EB8\", \"NS\" = \"grey60\")) +\n  geom_hline(yintercept = -log10(0.05), linetype = \"dashed\", color = \"grey40\") +\n  geom_vline(xintercept = 0, linetype = \"dashed\", color = \"grey40\") +\n  theme_bw() +\n  labs(\n    title = \"Lyrebird: Differential Phage Abundance (ANCOM-BC2)\",\n    subtitle = paste0(\"Up in HpWT: \", n_sig_up_lyrebird, \" | Up in HpKO: \", n_sig_down_lyrebird),\n    x = \"Log Fold Change (HpWT vs HpKO)\",\n    y = \"-log10(Q-value)\",\n    color = \"Direction\"\n  )\n\np_volcano_lyrebird\n```\n\n::: {.cell-output-display}\n![](03_singlem_diversity_analysis_files/figure-html/lyrebird-ancombc-volcano-1.png){width=960}\n:::\n\n```{.r .cell-code}\nggsave(\n  filename = here::here(\"data\", params$name, \"25_volcano_ancombc_lyrebird.png\"),\n  plot = p_volcano_lyrebird, width = 10, height = 8, dpi = 300\n)\n```\n:::\n\n\n# Part 3: 结果汇总\n\n## 12. 完整结果汇总表\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================================================================\n# 创建完整结果汇总表（SingleM + Lyrebird + Bracken）\n# ==============================================================================\n\n# 安全提取 P 值的辅助函数\nget_unifrac_p <- function(permanova_result) {\n  if (is.null(permanova_result) || is.na(permanova_result$`Pr(>F)`[1])) {\n    return(NA)\n  }\n  return(round(permanova_result$`Pr(>F)`[1], 4))\n}\n\nget_lyrebird_unifrac_p <- function(permanova_result) {\n  tryCatch({\n    if (is.null(permanova_result)) return(NA)\n    return(round(permanova_result$`Pr(>F)`[1], 4))\n  }, error = function(e) NA)\n}\n\n# 完整结果汇总表\nsummary_table <- data.frame(\n  Analysis = c(\n    \"Alpha: Shannon (Wilcoxon)\",\n    \"Alpha: Observed (Wilcoxon)\",\n    \"Beta: Bray-Curtis (PERMANOVA)\",\n    \"Beta: Weighted UniFrac (PERMANOVA)\",\n    \"Beta: Unweighted UniFrac (PERMANOVA)\"\n  ),\n  SingleM = c(\n    round(wilcox_shannon$p.value, 4),\n    round(wilcox_observed$p.value, 4),\n    round(permanova_bray$permanova$`Pr(>F)`[1], 4),\n    get_unifrac_p(permanova_wunifrac),\n    get_unifrac_p(permanova_uwunifrac)\n  ),\n  Lyrebird = c(\n    round(wilcox_lyrebird_shannon$p.value, 4),\n    NA,  # Lyrebird 没有单独计算 Observed 的 Wilcoxon\n    round(permanova_lyrebird$permanova$`Pr(>F)`[1], 4),\n    get_lyrebird_unifrac_p(permanova_wunifrac_lyrebird),\n    get_lyrebird_unifrac_p(permanova_uwunifrac_lyrebird)\n  ),\n  Bracken = c(\n    0.73,\n    0.29,\n    0.012,\n    NA,\n    NA\n  )\n)\n\ncat(\"\\n=== 完整结果汇总 (P 值) ===\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== 完整结果汇总 (P 值) ===\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"比较组: ApcMUT_HpWT vs ApcMUT_HpKO\\n\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n比较组: ApcMUT_HpWT vs ApcMUT_HpKO\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(summary_table)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                              Analysis SingleM Lyrebird Bracken\n1            Alpha: Shannon (Wilcoxon)  0.9048   0.0317   0.730\n2           Alpha: Observed (Wilcoxon)  0.1111       NA   0.290\n3        Beta: Bray-Curtis (PERMANOVA)  0.0370   0.0570   0.012\n4   Beta: Weighted UniFrac (PERMANOVA)  0.0290   0.0500      NA\n5 Beta: Unweighted UniFrac (PERMANOVA)  0.0080   0.0430      NA\n```\n\n\n:::\n\n```{.r .cell-code}\n# 添加显著性标记\nsummary_table_sig <- summary_table |>\n  mutate(\n    SingleM_sig = case_when(\n      SingleM < 0.001 ~ \"***\",\n      SingleM < 0.01 ~ \"**\",\n      SingleM < 0.05 ~ \"*\",\n      TRUE ~ \"\"\n    ),\n    Lyrebird_sig = case_when(\n      Lyrebird < 0.001 ~ \"***\",\n      Lyrebird < 0.01 ~ \"**\",\n      Lyrebird < 0.05 ~ \"*\",\n      is.na(Lyrebird) ~ \"-\",\n      TRUE ~ \"\"\n    ),\n    Bracken_sig = case_when(\n      Bracken < 0.001 ~ \"***\",\n      Bracken < 0.01 ~ \"**\",\n      Bracken < 0.05 ~ \"*\",\n      is.na(Bracken) ~ \"-\",\n      TRUE ~ \"\"\n    )\n  )\n\nwrite.csv(\n  summary_table,\n  file = here::here(\"data\", params$name, \"26_full_results_comparison.csv\"),\n  row.names = FALSE\n)\n```\n:::\n\n\n## 13. 结果可视化总结\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================================================================\n# P 值热图\n# ==============================================================================\n\n# 准备热图数据\nheatmap_data <- summary_table |>\n  pivot_longer(cols = c(SingleM, Lyrebird, Bracken),\n               names_to = \"Method\", values_to = \"P_value\") |>\n  mutate(\n    neg_log_p = -log10(P_value),\n    neg_log_p = ifelse(is.infinite(neg_log_p), 4, neg_log_p),  # 处理极小 P 值\n    sig_label = case_when(\n      is.na(P_value) ~ \"NA\",\n      P_value < 0.001 ~ \"***\",\n      P_value < 0.01 ~ \"**\",\n      P_value < 0.05 ~ \"*\",\n      TRUE ~ \"ns\"\n    ),\n    Method = factor(Method, levels = c(\"SingleM\", \"Lyrebird\", \"Bracken\"))\n  )\n\np_heatmap <- ggplot(heatmap_data, aes(x = Method, y = Analysis, fill = neg_log_p)) +\n  geom_tile(color = \"white\", linewidth = 0.5) +\n  geom_text(aes(label = sig_label), size = 5) +\n  scale_fill_gradient2(\n    low = \"white\", mid = \"lightyellow\", high = \"red\",\n    midpoint = 1.3,  # -log10(0.05) ≈ 1.3\n    na.value = \"grey90\",\n    name = \"-log10(P)\"\n  ) +\n  theme_minimal() +\n  theme(\n    axis.text.x = element_text(size = 12, face = \"bold\"),\n    axis.text.y = element_text(size = 10),\n    panel.grid = element_blank()\n  ) +\n  labs(\n    title = \"Statistical Significance Heatmap\",\n    subtitle = \"ApcMUT_HpWT vs ApcMUT_HpKO | *P<0.05, **P<0.01, ***P<0.001\",\n    x = \"\", y = \"\"\n  )\n\n# ==============================================================================\n# P 值条形图\n# ==============================================================================\n\nbar_data <- summary_table |>\n  pivot_longer(cols = c(SingleM, Lyrebird, Bracken),\n               names_to = \"Method\", values_to = \"P_value\") |>\n  filter(!is.na(P_value)) |>\n  mutate(\n    neg_log_p = -log10(P_value),\n    Method = factor(Method, levels = c(\"SingleM\", \"Lyrebird\", \"Bracken\")),\n    sig = P_value < 0.05\n  )\n\np_barplot <- ggplot(bar_data, aes(x = Analysis, y = neg_log_p, fill = Method)) +\n  geom_bar(stat = \"identity\", position = position_dodge(width = 0.8), width = 0.7) +\n  geom_hline(yintercept = -log10(0.05), linetype = \"dashed\", color = \"red\", linewidth = 0.8) +\n  annotate(\"text\", x = 0.5, y = -log10(0.05) + 0.15, label = \"P=0.05\", color = \"red\", hjust = 0, size = 3) +\n  scale_fill_brewer(palette = \"Set2\") +\n  coord_flip() +\n  theme_bw() +\n  labs(\n    title = \"Statistical Significance by Method\",\n    subtitle = \"Higher bars = more significant (bars above red line: P < 0.05)\",\n    x = \"\", y = \"-log10(P-value)\"\n  )\n\n# 组合图\np_summary_combined <- p_heatmap + p_barplot +\n  plot_layout(widths = c(1, 1.2)) +\n  plot_annotation(\n    title = \"Part 3: Results Summary\",\n    theme = theme(plot.title = element_text(size = 16, face = \"bold\"))\n  )\n\np_summary_combined\n```\n\n::: {.cell-output-display}\n![](03_singlem_diversity_analysis_files/figure-html/summary-visualization-1.png){width=1152}\n:::\n\n```{.r .cell-code}\nggsave(\n  filename = here::here(\"data\", params$name, \"27_results_summary_visualization.png\"),\n  plot = p_summary_combined, width = 14, height = 8, dpi = 300\n)\n```\n:::\n\n\n## 14. Host-Virus 关联分析\n\n探索细菌（SingleM）和噬菌体（Lyrebird）群落之间的关联，这是 SingleM/Lyrebird 框架的独特优势。\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================================================================\n# 1. 样本级别的多样性关联\n# ==============================================================================\ncat(\"=== Host-Virus 关联分析 ===\\n\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n=== Host-Virus 关联分析 ===\n```\n\n\n:::\n\n```{.r .cell-code}\n# 获取共同样本\ncommon_samples_hv <- intersect(\n  colnames(tse_singlem_corepair),\n  colnames(tse_lyrebird_corepair)\n)\ncat(\"共同样本数:\", length(common_samples_hv), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n共同样本数: 9 \n```\n\n\n:::\n\n```{.r .cell-code}\n# 提取 Alpha 多样性数据\ndiversity_data <- data.frame(\n  sample = common_samples_hv,\n  bacteria_shannon = colData(tse_singlem_corepair)[common_samples_hv, \"shannon_index\"],\n  phage_shannon = colData(tse_lyrebird_corepair)[common_samples_hv, \"shannon_index\"],\n  treatment_group = colData(tse_singlem_corepair)[common_samples_hv, \"treatment_group\"]\n)\n\n# Spearman 相关性\ncor_test <- cor.test(\n  diversity_data$bacteria_shannon,\n  diversity_data$phage_shannon,\n  method = \"spearman\"\n)\n\ncat(\"\\n细菌-噬菌体 Shannon 多样性相关性:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n细菌-噬菌体 Shannon 多样性相关性:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  Spearman rho:\", round(cor_test$estimate, 3), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Spearman rho: 0.567 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  P-value:\", round(cor_test$p.value, 4), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  P-value: 0.1206 \n```\n\n\n:::\n\n```{.r .cell-code}\n# 可视化\np_diversity_cor <- ggplot(diversity_data, aes(x = bacteria_shannon, y = phage_shannon)) +\n  geom_point(aes(color = treatment_group), size = 3) +\n  geom_smooth(method = \"lm\", se = TRUE, color = \"grey40\", linetype = \"dashed\") +\n  theme_bw() +\n  labs(\n    title = \"Host-Virus Alpha Diversity Correlation\",\n    subtitle = paste0(\"Spearman ρ = \", round(cor_test$estimate, 3),\n                     \", P = \", round(cor_test$p.value, 4)),\n    x = \"Bacteria Shannon Diversity (SingleM)\",\n    y = \"Phage Shannon Diversity (Lyrebird)\",\n    color = \"Treatment\"\n  )\n\n# ==============================================================================\n# 2. Procrustes 分析：Beta 多样性关联\n# ==============================================================================\ncat(\"\\n\\n=== Procrustes 分析 (Beta 多样性关联) ===\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\n=== Procrustes 分析 (Beta 多样性关联) ===\n```\n\n\n:::\n\n```{.r .cell-code}\n# 获取 Bray-Curtis 距离矩阵\nbacteria_dist <- vegan::vegdist(\n  t(assay(tse_singlem_corepair[, common_samples_hv], \"relabundance\")),\n  method = \"bray\"\n)\nphage_dist <- vegan::vegdist(\n  t(assay(tse_lyrebird_corepair[, common_samples_hv], \"relabundance\")),\n  method = \"bray\"\n)\n\n# PCoA\nbacteria_pcoa <- cmdscale(bacteria_dist, k = 2)\nphage_pcoa <- cmdscale(phage_dist, k = 2)\n\n# Procrustes 分析\nprocrustes_result <- vegan::protest(bacteria_pcoa, phage_pcoa, permutations = 999)\n\ncat(\"Procrustes 相关性 (m²):\", round(procrustes_result$ss, 4), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nProcrustes 相关性 (m²): 0.2375 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"相关系数:\", round(sqrt(1 - procrustes_result$ss), 4), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n相关系数: 0.8732 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"P-value:\", round(procrustes_result$signif, 4), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nP-value: 0.002 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Procrustes 可视化\nprocrustes_df <- data.frame(\n  X1_bacteria = bacteria_pcoa[, 1],\n  Y1_bacteria = bacteria_pcoa[, 2],\n  X2_phage = procrustes_result$Yrot[, 1],\n  Y2_phage = procrustes_result$Yrot[, 2],\n  sample = common_samples_hv,\n  treatment = diversity_data$treatment_group\n)\n\np_procrustes <- ggplot(procrustes_df) +\n  geom_segment(aes(x = X1_bacteria, y = Y1_bacteria,\n                   xend = X2_phage, yend = Y2_phage),\n               color = \"grey60\", alpha = 0.6) +\n  geom_point(aes(x = X1_bacteria, y = Y1_bacteria, color = treatment),\n             size = 3, shape = 16) +\n  geom_point(aes(x = X2_phage, y = Y2_phage, color = treatment),\n             size = 3, shape = 17) +\n  theme_bw() +\n  labs(\n    title = \"Procrustes Analysis: Bacteria vs Phage Communities\",\n    subtitle = paste0(\"Correlation = \", round(sqrt(1 - procrustes_result$ss), 3),\n                     \", P = \", round(procrustes_result$signif, 4),\n                     \" | ● Bacteria, ▲ Phage\"),\n    x = \"PCoA 1\", y = \"PCoA 2\",\n    color = \"Treatment\"\n  )\n\n# ==============================================================================\n# 3. Mantel 检验：距离矩阵相关性\n# ==============================================================================\ncat(\"\\n\\n=== Mantel 检验 ===\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\n=== Mantel 检验 ===\n```\n\n\n:::\n\n```{.r .cell-code}\nmantel_result <- vegan::mantel(bacteria_dist, phage_dist, method = \"spearman\", permutations = 999)\n\ncat(\"Mantel 统计量 (r):\", round(mantel_result$statistic, 4), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nMantel 统计量 (r): 0.9323 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"P-value:\", round(mantel_result$signif, 4), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nP-value: 0.001 \n```\n\n\n:::\n\n```{.r .cell-code}\n# ==============================================================================\n# 组合图\n# ==============================================================================\np_host_virus <- p_diversity_cor + p_procrustes +\n  plot_annotation(\n    title = \"Host-Virus (Bacteria-Phage) Community Associations\",\n    subtitle = paste0(\"Mantel test: r = \", round(mantel_result$statistic, 3),\n                     \", P = \", round(mantel_result$signif, 4)),\n    theme = theme(plot.title = element_text(size = 14, face = \"bold\"))\n  )\n\np_host_virus\n```\n\n::: {.cell-output-display}\n![](03_singlem_diversity_analysis_files/figure-html/host-virus-correlation-1.png){width=1152}\n:::\n\n```{.r .cell-code}\nggsave(\n  filename = here::here(\"data\", params$name, \"28_host_virus_association.png\"),\n  plot = p_host_virus, width = 14, height = 6, dpi = 300\n)\n\n# 保存关联分析结果\nhost_virus_summary <- data.frame(\n  Analysis = c(\"Alpha Diversity Correlation\", \"Procrustes Analysis\", \"Mantel Test\"),\n  Statistic = c(\n    paste0(\"Spearman ρ = \", round(cor_test$estimate, 3)),\n    paste0(\"Correlation = \", round(sqrt(1 - procrustes_result$ss), 3)),\n    paste0(\"Mantel r = \", round(mantel_result$statistic, 3))\n  ),\n  P_value = c(\n    round(cor_test$p.value, 4),\n    round(procrustes_result$signif, 4),\n    round(mantel_result$signif, 4)\n  )\n)\n\ncat(\"\\n\\n=== Host-Virus 关联分析汇总 ===\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\n=== Host-Virus 关联分析汇总 ===\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(host_virus_summary)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                     Analysis           Statistic P_value\n1 Alpha Diversity Correlation  Spearman ρ = 0.567  0.1206\n2         Procrustes Analysis Correlation = 0.873  0.0020\n3                 Mantel Test    Mantel r = 0.932  0.0010\n```\n\n\n:::\n\n```{.r .cell-code}\nwrite.csv(\n  host_virus_summary,\n  file = here::here(\"data\", params$name, \"29_host_virus_association_summary.csv\"),\n  row.names = FALSE\n)\n```\n:::\n\n\n## 15. 分析小结\n\n\n```{.r .cell-code}\n# 构建 SingleM UniFrac 结果文本\nunifrac_text <- if (unifrac_success) {\n  paste0(\n    \"3. **Beta 多样性 (Weighted UniFrac)**: PERMANOVA P=\", get_unifrac_p(permanova_wunifrac), \"\\n\",\n    \"4. **Beta 多样性 (Unweighted UniFrac)**: PERMANOVA P=\", get_unifrac_p(permanova_uwunifrac)\n  )\n} else {\n  \"3. **Beta 多样性 (UniFrac)**: 计算未成功\"\n}\n\n# 构建 Lyrebird UniFrac 结果文本\nlyrebird_unifrac_text <- if (lyrebird_unifrac_success) {\n  paste0(\n    \"3. **Beta 多样性 (Weighted UniFrac)**: PERMANOVA P=\", round(permanova_wunifrac_lyrebird$`Pr(>F)`[1], 4), \"\\n\",\n    \"4. **Beta 多样性 (Unweighted UniFrac)**: PERMANOVA P=\", round(permanova_uwunifrac_lyrebird$`Pr(>F)`[1], 4)\n  )\n} else {\n  \"3. **Beta 多样性 (UniFrac)**: 计算未成功\"\n}\n\ncat(\"\n## SingleM/Lyrebird 分析小结\n\n### Part 1: SingleM 细菌/古菌分析\n\n**数据概况**:\n- 清洗后 OTU 数: \", nrow(tse_singlem_ca_cleaned), \"\n- 样本数: \", ncol(tse_singlem_ca_cleaned), \"\n- 核心比较组: ApcMUT_HpWT (n=\", sum(tse_singlem_corepair$treatment_group == 'ApcMUT_HpWT'), \") vs ApcMUT_HpKO (n=\", sum(tse_singlem_corepair$treatment_group == 'ApcMUT_HpKO'), \")\n\n**关键发现**:\n1. **Alpha 多样性**: Shannon P=\", round(wilcox_shannon$p.value, 4), \", Observed P=\", round(wilcox_observed$p.value, 4), \"\n2. **Beta 多样性 (Bray-Curtis)**: PERMANOVA P=\", round(permanova_bray$permanova$`Pr(>F)`[1], 4), \"\n\", unifrac_text, \"\n5. **差异丰度 (ANCOM-BC2)**: 见火山图\n\n### Part 2: Lyrebird 噬菌体分析\n\n**数据概况**:\n- 清洗后噬菌体 OTU 数: \", nrow(tse_lyrebird_ca_cleaned), \"\n- 样本数: \", ncol(tse_lyrebird_ca_cleaned), \"\n- 核心比较组样本数: \", ncol(tse_lyrebird_corepair), \"\n\n**关键发现**:\n1. **Alpha 多样性**: Shannon P=\", round(wilcox_lyrebird_shannon$p.value, 4), \"\n2. **Beta 多样性 (Bray-Curtis)**: PERMANOVA P=\", round(permanova_lyrebird$permanova$`Pr(>F)`[1], 4), \"\n\", lyrebird_unifrac_text, \"\n5. **差异丰度 (ANCOM-BC2)**: Up in HpWT=\", n_sig_up_lyrebird, \", Up in HpKO=\", n_sig_down_lyrebird, \"\n\n### Part 3: Host-Virus 关联分析\n\n**核心发现**:\n1. **Alpha 多样性关联**: 细菌与噬菌体 Shannon 多样性 Spearman ρ=\", round(cor_test$estimate, 3), \", P=\", round(cor_test$p.value, 4), \"\n2. **Beta 多样性关联 (Procrustes)**: 相关系数=\", round(sqrt(1 - procrustes_result$ss), 3), \", P=\", round(procrustes_result$signif, 4), \"\n3. **Mantel 检验**: r=\", round(mantel_result$statistic, 3), \", P=\", round(mantel_result$signif, 4), \"\n\n### SingleM/Lyrebird 相比 Bracken 的优势\n\n1. **UniFrac 距离**: 提供系统发育树，可计算考虑进化关系的 UniFrac 距离\n2. **新物种检测**: 基于标记基因 HMM，能检测数据库中未收录的物种\n3. **OTU 分辨率**: 更细粒度的群落结构分析\n4. **噬菌体分析**: Lyrebird 专门针对 dsDNA 噬菌体，Bracken 无此功能\n5. **Host-Virus 关联**: 可同时分析细菌和噬菌体，探索宿主-病毒互作\n\")\n```\n\n\n## SingleM/Lyrebird 分析小结\n\n### Part 1: SingleM 细菌/古菌分析\n\n**数据概况**:\n- 清洗后 OTU 数:  465 \n- 样本数:  28 \n- 核心比较组: ApcMUT_HpWT (n= 5 ) vs ApcMUT_HpKO (n= 4 )\n\n**关键发现**:\n1. **Alpha 多样性**: Shannon P= 0.9048 , Observed P= 0.1111 \n2. **Beta 多样性 (Bray-Curtis)**: PERMANOVA P= 0.037 \n 3. **Beta 多样性 (Weighted UniFrac)**: PERMANOVA P=0.029\n4. **Beta 多样性 (Unweighted UniFrac)**: PERMANOVA P=0.008 \n5. **差异丰度 (ANCOM-BC2)**: 见火山图\n\n### Part 2: Lyrebird 噬菌体分析\n\n**数据概况**:\n- 清洗后噬菌体 OTU 数:  878 \n- 样本数:  28 \n- 核心比较组样本数:  9 \n\n**关键发现**:\n1. **Alpha 多样性**: Shannon P= 0.0317 \n2. **Beta 多样性 (Bray-Curtis)**: PERMANOVA P= 0.057 \n 3. **Beta 多样性 (Weighted UniFrac)**: PERMANOVA P=0.05\n4. **Beta 多样性 (Unweighted UniFrac)**: PERMANOVA P=0.043 \n5. **差异丰度 (ANCOM-BC2)**: Up in HpWT= 8 , Up in HpKO= 12 \n\n### Part 3: Host-Virus 关联分析\n\n**核心发现**:\n1. **Alpha 多样性关联**: 细菌与噬菌体 Shannon 多样性 Spearman ρ= 0.567 , P= 0.1206 \n2. **Beta 多样性关联 (Procrustes)**: 相关系数= 0.873 , P= 0.002 \n3. **Mantel 检验**: r= 0.932 , P= 0.001 \n\n### SingleM/Lyrebird 相比 Bracken 的优势\n\n1. **UniFrac 距离**: 提供系统发育树，可计算考虑进化关系的 UniFrac 距离\n2. **新物种检测**: 基于标记基因 HMM，能检测数据库中未收录的物种\n3. **OTU 分辨率**: 更细粒度的群落结构分析\n4. **噬菌体分析**: Lyrebird 专门针对 dsDNA 噬菌体，Bracken 无此功能\n5. **Host-Virus 关联**: 可同时分析细菌和噬菌体，探索宿主-病毒互作\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================================================================\n# 保存关键数据供下游分析（如 03b_virome_function_integration）使用\n# ==============================================================================\n\ncat(\"=== 保存数据供下游分析 ===\\n\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n=== 保存数据供下游分析 ===\n```\n\n\n:::\n\n```{.r .cell-code}\n# 保存 Lyrebird 噬菌体 TSE 对象（核心比较组）\nsaveRDS(\n  tse_lyrebird_corepair,\n  file = here::here(\"data\", params$name, \"tse_lyrebird_corepair.rds\")\n)\ncat(\"已保存: tse_lyrebird_corepair.rds\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n已保存: tse_lyrebird_corepair.rds\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  - 样本数:\", ncol(tse_lyrebird_corepair), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - 样本数: 9 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  - 噬菌体 OTU 数:\", nrow(tse_lyrebird_corepair), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - 噬菌体 OTU 数: 878 \n```\n\n\n:::\n\n```{.r .cell-code}\n# 保存 SingleM 细菌 TSE 对象（核心比较组）\nsaveRDS(\n  tse_singlem_corepair,\n  file = here::here(\"data\", params$name, \"tse_singlem_corepair.rds\")\n)\ncat(\"\\n已保存: tse_singlem_corepair.rds\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n已保存: tse_singlem_corepair.rds\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  - 样本数:\", ncol(tse_singlem_corepair), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - 样本数: 9 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  - 细菌 OTU 数:\", nrow(tse_singlem_corepair), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - 细菌 OTU 数: 465 \n```\n\n\n:::\n:::\n\n\n---\n\n## Files written\n\nThese files have been written to the target directory, data/03_singlem_diversity_analysis:\n\n\n",
    "supporting": [
      "03_singlem_diversity_analysis_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}