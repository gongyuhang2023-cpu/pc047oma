{
  "hash": "23d9f987f8f509478fa88757248cb76d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"02b: 扩展功能分析 - Gene Families / GO / PFAM\"\nauthor: \"Gong Yuhang\"\ndate: today\nformat:\n  html:\n    toc: true\n    toc-depth: 3\n    code-fold: true\n    embed-resources: true\nparams:\n  name: \"02b_extended_functional\"\nexecute:\n  warning: false\n  message: false\n---\n\n## 概述\n\n本文件是02_functional_profiling的扩展分析，针对HUMAnN4输出的其他功能注释数据进行差异分析：\n\n| 数据类型 | 特征数 | 说明 |\n|----------|--------|------|\n| Gene Families | ~430万 | 原始UniRef90基因家族（需过滤） |\n| GO | ~13,000 | Gene Ontology功能分类 |\n| PFAM | ~7,600 | 蛋白质结构域 |\n\n**目的**: 在Pathway/KO层面未发现显著差异的情况下，尝试更精细的功能分辨率。\n\n## 环境设置\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(here)\nlibrary(TreeSummarizedExperiment)\nlibrary(mia)\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(Maaslin2)\n\n# 创建输出目录 (qmd在analyses目录下，不需要重复\"analyses\")\noutput_dir <- here::here(\"data\", params$name)\nif (!dir.exists(output_dir)) {\n  dir.create(output_dir, recursive = TRUE)\n}\n\n# 数据目录\nhumann_dir <- here::here(\"data\", \"00-raw\", \"d02_functional_profiling\", \"humann4\")\n\ncat(\"数据目录:\", humann_dir, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n数据目录: C:/Users/36094/Desktop/pc047oma/analyses/data/00-raw/d02_functional_profiling/humann4 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"输出目录:\", output_dir, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n输出目录: C:/Users/36094/Desktop/pc047oma/analyses/data/02b_extended_functional \n```\n\n\n:::\n:::\n\n\n## Part 1: GO (Gene Ontology) 差异分析\n\nGO分类提供更直观的功能分类（分子功能、生物过程、细胞组分）。\n\n### 1.1 读取GO数据\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 读取GO unstratified数据\ngo_file <- file.path(humann_dir, \"humann4_genefamilies-step3-GO_unstratified.tsv\")\n\nif (file.exists(go_file)) {\n  go_raw <- read.delim(go_file, header = TRUE, row.names = 1, check.names = FALSE)\n  cat(\"GO数据维度:\", nrow(go_raw), \"特征 ×\", ncol(go_raw), \"样本\\n\")\n\n  # 移除UNMAPPED和UNGROUPED\n  go_raw <- go_raw[!grepl(\"UNMAPPED|UNGROUPED\", rownames(go_raw)), ]\n  cat(\"过滤后:\", nrow(go_raw), \"GO terms\\n\")\n} else {\n  stop(\"GO数据文件不存在!\")\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nGO数据维度: 13149 特征 × 33 样本\n过滤后: 13148 GO terms\n```\n\n\n:::\n:::\n\n\n### 1.2 读取样本元数据\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 从01分析读取清洗后的TSE获取元数据\ntse_ref <- readRDS(here::here(\"data\", \"01_alpha_beta_diversity_analysis\",\n                               \"tse_standard_species_ca_cleaned.rds\"))\n\nmetadata <- as.data.frame(colData(tse_ref))\ncat(\"元数据样本数:\", nrow(metadata), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n元数据样本数: 28 \n```\n\n\n:::\n\n```{.r .cell-code}\n# 匹配样本 (显式使用base::intersect避免命名空间冲突)\ncommon_samples <- base::intersect(colnames(go_raw), rownames(metadata))\ncat(\"共同样本数:\", length(common_samples), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n共同样本数: 28 \n```\n\n\n:::\n\n```{.r .cell-code}\n# 过滤\ngo_filtered <- go_raw[, common_samples]\nmetadata_filtered <- metadata[common_samples, ]\n```\n:::\n\n\n### 1.3 Prevalence过滤\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 计算prevalence (在多少比例的样本中存在)\nprevalence <- rowSums(go_filtered > 0) / ncol(go_filtered)\n\n# 过滤条件: 至少在10%样本中存在\nprev_threshold <- 0.10\ngo_prevalent <- go_filtered[prevalence >= prev_threshold, ]\n\ncat(sprintf(\"Prevalence过滤 (>=%d%%样本): %d → %d GO terms\\n\",\n            prev_threshold * 100, nrow(go_filtered), nrow(go_prevalent)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPrevalence过滤 (>=10%样本): 13148 → 11944 GO terms\n```\n\n\n:::\n:::\n\n\n### 1.4 MaAsLin2差异分析\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 准备MaAsLin2输入\ngo_for_maaslin <- as.data.frame(t(go_prevalent))\nmetadata_for_maaslin <- metadata_filtered[, c(\"treatment_group\"), drop = FALSE]\n\n# 核心比较: 只保留ApcMUT样本\ncore_samples <- rownames(metadata_for_maaslin)[\n  metadata_for_maaslin$treatment_group %in% c(\"ApcMUT_HpWT\", \"ApcMUT_HpKO\")\n]\n\ngo_core <- go_for_maaslin[core_samples, ]\nmetadata_core <- metadata_for_maaslin[core_samples, , drop = FALSE]\n\n# 运行MaAsLin2\nmaaslin_go_dir <- file.path(output_dir, \"maaslin2_go_results\")\n\nfit_go <- Maaslin2(\n  input_data = go_core,\n  input_metadata = metadata_core,\n  output = maaslin_go_dir,\n  fixed_effects = c(\"treatment_group\"),\n  reference = \"treatment_group,ApcMUT_HpKO\",\n  normalization = \"TSS\",\n  transform = \"LOG\",\n  analysis_method = \"LM\",\n  max_significance = 0.25,\n  min_abundance = 0.0001,\n  min_prevalence = 0.1,\n  cores = 1,\n  plot_heatmap = FALSE,\n  plot_scatter = FALSE\n)\n```\n:::\n\n\n### 1.5 GO差异结果\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngo_results <- fit_go$results %>%\n  dplyr::filter(metadata == \"treatment_group\") %>%\n  arrange(pval)\n\ncat(\"\\nGO差异分析结果:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nGO差异分析结果:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"----------------\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n----------------\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(sprintf(\"总检测GO terms: %d\\n\", nrow(go_results)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n总检测GO terms: 11851\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(sprintf(\"P < 0.05: %d\\n\", sum(go_results$pval < 0.05)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nP < 0.05: 1577\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(sprintf(\"FDR < 0.25: %d\\n\", sum(go_results$qval < 0.25)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFDR < 0.25: 0\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(sprintf(\"FDR < 0.05: %d\\n\", sum(go_results$qval < 0.05)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFDR < 0.05: 0\n```\n\n\n:::\n\n```{.r .cell-code}\n# 显示Top结果\nif (nrow(go_results) > 0) {\n  cat(\"\\nTop 20 GO terms (by P-value):\\n\\n\")\n  print(head(go_results[, c(\"feature\", \"coef\", \"pval\", \"qval\")], 20))\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nTop 20 GO terms (by P-value):\n\n      feature       coef         pval      qval\n1  GO.0030429 -4.2303964 0.0001727968 0.3370617\n2  GO.0003868 -3.5817183 0.0003000125 0.3370617\n3  GO.1904288 -1.2033578 0.0003852742 0.3370617\n4  GO.0008199 -0.4836708 0.0003865758 0.3370617\n5  GO.0004057 -1.7179945 0.0007115163 0.3370617\n6  GO.0004452 -0.6834391 0.0008347110 0.3370617\n7  GO.0042279  1.9285547 0.0008586291 0.3370617\n8  GO.0010430 -0.9917908 0.0008907517 0.3370617\n9  GO.0048019 -0.9917908 0.0008907517 0.3370617\n10 GO.0051835 -1.0047553 0.0011005171 0.3370617\n11 GO.0045151 -2.8007826 0.0011456810 0.3370617\n12 GO.0047605 -2.8007826 0.0011456810 0.3370617\n13 GO.0005684 -0.9519888 0.0011941213 0.3370617\n14 GO.0018276 -0.9519888 0.0011941213 0.3370617\n15 GO.0034247 -0.9519888 0.0011941213 0.3370617\n16 GO.0070100 -0.9519888 0.0011941213 0.3370617\n17 GO.0030694  0.7582170 0.0012260147 0.3370617\n18 GO.1902033 -1.9956903 0.0014503545 0.3370617\n19 GO.1905062 -1.9956903 0.0014503545 0.3370617\n20 GO.0004115 -0.9492659 0.0016141378 0.3370617\n```\n\n\n:::\n\n```{.r .cell-code}\n# 保存结果\nwrite.csv(go_results,\n          file = file.path(output_dir, \"01_go_daa_results.csv\"),\n          row.names = FALSE)\n```\n:::\n\n\n## Part 2: PFAM (蛋白质结构域) 差异分析\n\nPFAM提供蛋白质结构域层面的功能信息。\n\n### 2.1 读取PFAM数据\n\n\n::: {.cell}\n\n```{.r .cell-code}\npfam_file <- file.path(humann_dir, \"humann4_genefamilies-step3-PFAM_unstratified.tsv\")\n\nif (file.exists(pfam_file)) {\n  pfam_raw <- read.delim(pfam_file, header = TRUE, row.names = 1, check.names = FALSE)\n  cat(\"PFAM数据维度:\", nrow(pfam_raw), \"特征 ×\", ncol(pfam_raw), \"样本\\n\")\n\n  # 移除UNMAPPED和UNGROUPED\n  pfam_raw <- pfam_raw[!grepl(\"UNMAPPED|UNGROUPED\", rownames(pfam_raw)), ]\n  cat(\"过滤后:\", nrow(pfam_raw), \"PFAM domains\\n\")\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPFAM数据维度: 7647 特征 × 33 样本\n过滤后: 7646 PFAM domains\n```\n\n\n:::\n:::\n\n\n### 2.2 PFAM MaAsLin2分析\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 过滤样本\npfam_filtered <- pfam_raw[, common_samples]\n\n# Prevalence过滤\nprevalence_pfam <- rowSums(pfam_filtered > 0) / ncol(pfam_filtered)\npfam_prevalent <- pfam_filtered[prevalence_pfam >= prev_threshold, ]\n\ncat(sprintf(\"PFAM Prevalence过滤: %d → %d domains\\n\",\n            nrow(pfam_filtered), nrow(pfam_prevalent)))\n\n# 准备MaAsLin2\npfam_for_maaslin <- as.data.frame(t(pfam_prevalent))\npfam_core <- pfam_for_maaslin[core_samples, ]\n\n# 运行MaAsLin2\nmaaslin_pfam_dir <- file.path(output_dir, \"maaslin2_pfam_results\")\n\nfit_pfam <- Maaslin2(\n  input_data = pfam_core,\n  input_metadata = metadata_core,\n  output = maaslin_pfam_dir,\n  fixed_effects = c(\"treatment_group\"),\n  reference = \"treatment_group,ApcMUT_HpKO\",\n  normalization = \"TSS\",\n  transform = \"LOG\",\n  analysis_method = \"LM\",\n  max_significance = 0.25,\n  min_abundance = 0.0001,\n  min_prevalence = 0.1,\n  cores = 1,\n  plot_heatmap = FALSE,\n  plot_scatter = FALSE\n)\n```\n:::\n\n\n### 2.3 PFAM差异结果\n\n\n::: {.cell}\n\n```{.r .cell-code}\npfam_results <- fit_pfam$results %>%\n  dplyr::filter(metadata == \"treatment_group\") %>%\n  arrange(pval)\n\ncat(\"\\nPFAM差异分析结果:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nPFAM差异分析结果:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"------------------\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n------------------\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(sprintf(\"总检测PFAM domains: %d\\n\", nrow(pfam_results)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n总检测PFAM domains: 6544\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(sprintf(\"P < 0.05: %d\\n\", sum(pfam_results$pval < 0.05)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nP < 0.05: 849\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(sprintf(\"FDR < 0.25: %d\\n\", sum(pfam_results$qval < 0.25)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFDR < 0.25: 1\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(sprintf(\"FDR < 0.05: %d\\n\", sum(pfam_results$qval < 0.05)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFDR < 0.05: 0\n```\n\n\n:::\n\n```{.r .cell-code}\nif (nrow(pfam_results) > 0) {\n  cat(\"\\nTop 20 PFAM domains (by P-value):\\n\\n\")\n  print(head(pfam_results[, c(\"feature\", \"coef\", \"pval\", \"qval\")], 20))\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nTop 20 PFAM domains (by P-value):\n\n   feature      coef         pval      qval\n1  PF09907 -2.852660 3.299631e-05 0.2159278\n2  PF05860  2.957733 1.753921e-04 0.2981744\n3  PF09106  1.754006 2.101224e-04 0.2981744\n4  PF09107  1.754006 2.101224e-04 0.2981744\n5  PF11213  1.708001 2.571272e-04 0.2981744\n6  PF14276  1.546380 2.733873e-04 0.2981744\n7  PF03595  3.229093 4.596771e-04 0.3605977\n8  PF17830  1.693871 5.173382e-04 0.3605977\n9  PF09560  1.906894 6.420130e-04 0.3605977\n10 PF16258  2.894647 6.487389e-04 0.3605977\n11 PF14620  2.104112 6.843070e-04 0.3605977\n12 PF13884  2.508949 7.987192e-04 0.3605977\n13 PF09254  1.461800 8.026438e-04 0.3605977\n14 PF04367  2.710648 8.390271e-04 0.3605977\n15 PF09951  1.872313 8.507196e-04 0.3605977\n16 PF15781  2.379250 8.816569e-04 0.3605977\n17 PF08523 -1.635124 9.599590e-04 0.3667067\n18 PF17032  2.665722 1.008668e-03 0.3667067\n19 PF17209  2.341294 1.252762e-03 0.3775188\n20 PF08343 -3.651362 1.407609e-03 0.3775188\n```\n\n\n:::\n\n```{.r .cell-code}\nwrite.csv(pfam_results,\n          file = file.path(output_dir, \"02_pfam_daa_results.csv\"),\n          row.names = FALSE)\n```\n:::\n\n\n## Part 3: Gene Families 差异分析（过滤后）\n\nGene Families是最精细的功能层级，但数据量巨大需要严格过滤。\n\n### 3.1 读取Gene Families数据\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngf_file <- file.path(humann_dir, \"humann4_genefamilies-step2-normalized.tsv\")\n\nif (file.exists(gf_file)) {\n  # 只读取前100行看结构\n  gf_preview <- read.delim(gf_file, header = TRUE, nrows = 100, check.names = FALSE)\n  cat(\"Gene Families预览:\\n\")\n  cat(\"列数:\", ncol(gf_preview), \"\\n\")\n  cat(\"前几行特征名:\\n\")\n  print(head(rownames(gf_preview)))\n\n  # 完整读取（可能很慢）\n  cat(\"\\n正在读取完整Gene Families数据（可能需要几分钟）...\\n\")\n  gf_raw <- read.delim(gf_file, header = TRUE, row.names = 1, check.names = FALSE)\n  cat(\"Gene Families原始维度:\", nrow(gf_raw), \"×\", ncol(gf_raw), \"\\n\")\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nGene Families预览:\n列数: 34 \n前几行特征名:\n[1] \"1\" \"2\" \"3\" \"4\" \"5\" \"6\"\n\n正在读取完整Gene Families数据（可能需要几分钟）...\nGene Families原始维度: 4326726 × 33 \n```\n\n\n:::\n:::\n\n\n### 3.2 严格过滤\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 移除stratified条目（只保留unstratified）\nunstratified_idx <- !grepl(\"\\\\|\", rownames(gf_raw))\ngf_unstrat <- gf_raw[unstratified_idx, ]\ncat(\"移除stratified后:\", nrow(gf_unstrat), \"gene families\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n移除stratified后: 2025642 gene families\n```\n\n\n:::\n\n```{.r .cell-code}\n# 移除UNMAPPED\ngf_unstrat <- gf_unstrat[!grepl(\"UNMAPPED\", rownames(gf_unstrat)), ]\ncat(\"移除UNMAPPED后:\", nrow(gf_unstrat), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n移除UNMAPPED后: 2025641 \n```\n\n\n:::\n\n```{.r .cell-code}\n# 过滤样本\ngf_filtered <- gf_unstrat[, common_samples]\n\n# 严格Prevalence过滤: 至少在20%样本中存在\nprev_strict <- 0.20\nprevalence_gf <- rowSums(gf_filtered > 0) / ncol(gf_filtered)\ngf_prevalent <- gf_filtered[prevalence_gf >= prev_strict, ]\n\ncat(sprintf(\"严格Prevalence过滤 (>=%d%%): %d → %d gene families\\n\",\n            prev_strict * 100, nrow(gf_filtered), nrow(gf_prevalent)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n严格Prevalence过滤 (>=20%): 2025641 → 1011016 gene families\n```\n\n\n:::\n\n```{.r .cell-code}\n# 进一步过滤: 最小丰度\nmin_abundance <- 1  # CPM\nmean_abundance <- rowMeans(gf_prevalent)\ngf_final <- gf_prevalent[mean_abundance >= min_abundance, ]\n\ncat(sprintf(\"最小丰度过滤 (>=%.1f CPM): %d gene families\\n\",\n            min_abundance, nrow(gf_final)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n最小丰度过滤 (>=1.0 CPM): 75 gene families\n```\n\n\n:::\n:::\n\n\n### 3.3 Gene Families MaAsLin2分析\n\n\n::: {.cell}\n\n```{.r .cell-code}\nif (nrow(gf_final) > 0 && nrow(gf_final) < 50000) {\n  # 准备MaAsLin2\n  gf_for_maaslin <- as.data.frame(t(gf_final))\n  gf_core <- gf_for_maaslin[core_samples, ]\n\n  # 运行MaAsLin2\n  maaslin_gf_dir <- file.path(output_dir, \"maaslin2_genefamilies_results\")\n\n  fit_gf <- Maaslin2(\n    input_data = gf_core,\n    input_metadata = metadata_core,\n    output = maaslin_gf_dir,\n    fixed_effects = c(\"treatment_group\"),\n    reference = \"treatment_group,ApcMUT_HpKO\",\n    normalization = \"TSS\",\n    transform = \"LOG\",\n    analysis_method = \"LM\",\n    max_significance = 0.25,\n    min_abundance = 0.0001,\n    min_prevalence = 0.1,\n    cores = 1,\n    plot_heatmap = FALSE,\n    plot_scatter = FALSE\n  )\n\n  gf_results <- fit_gf$results %>%\n    dplyr::filter(metadata == \"treatment_group\") %>%\n    arrange(pval)\n\n  cat(\"\\nGene Families差异分析结果:\\n\")\n  cat(sprintf(\"总检测: %d\\n\", nrow(gf_results)))\n  cat(sprintf(\"P < 0.05: %d\\n\", sum(gf_results$pval < 0.05)))\n  cat(sprintf(\"FDR < 0.25: %d\\n\", sum(gf_results$qval < 0.25)))\n\n  write.csv(gf_results,\n            file = file.path(output_dir, \"03_genefamilies_daa_results.csv\"),\n            row.names = FALSE)\n} else {\n  cat(\"Gene Families数量仍太大或为0，跳过MaAsLin2分析\\n\")\n  cat(\"建议进一步过滤或使用其他方法\\n\")\n}\n```\n:::\n\n\n## Part 4: 综合比较\n\n\n## 扩展功能分析汇总\n\n| 数据类型 | 检测特征数 | P<0.05 | FDR<0.25 | FDR<0.05 |\n|----------|------------|--------|----------|----------|\n| GO | 11851 | 1577 | 0 | 0 |\n| PFAM | 6544 | 849 | 1 | 0 |\n| Gene Families | 74 | 16 | 20 | 0 |\n\n### 结论\n\n- 如果GO/PFAM层面仍无显著差异，进一步支持**功能冗余假说**\n- 如果发现显著差异，可能揭示被Pathway/KO掩盖的精细功能变化\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncat(\"\\n【分析环境信息】\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n【分析环境信息】\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"R版本:\", R.version.string, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nR版本: R version 4.5.2 (2025-10-31 ucrt) \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"分析日期:\", format(Sys.time(), \"%Y-%m-%d %H:%M:%S\"), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n分析日期: 2026-01-20 13:20:08 \n```\n\n\n:::\n:::\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}