{
  "hash": "adf1e72e21dd9638d269743d81d618b1",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"03c: Co-occurrence网络分析 - 细菌及细菌-噬菌体跨域网络\"\nauthor: \"Gong Yuhang\"\ndate: today\nformat:\n  html:\n    toc: true\n    toc-depth: 3\n    code-fold: true\n    embed-resources: true\nparams:\n  name: \"03c_cooccurrence_network\"\nexecute:\n  warning: false\n  message: false\n---\n\n## 概述\n\nCo-occurrence网络分析用于评估物种间的共生/竞争关系，以及CagA感染如何改变这些关系。\n\n**分析内容**:\n\n1. **细菌-细菌网络**: 评估细菌间共生/竞争关系\n2. **细菌-噬菌体跨域网络**: 宿主-噬菌体特异性互作\n3. **网络拓扑比较**: 不同处理组的网络结构差异\n\n**方法**: SparCC (Sparse Correlations for Compositional data) - 专为组成型数据设计\n\n## 环境设置\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(here)\nlibrary(TreeSummarizedExperiment)\nlibrary(mia)\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(ggplot2)\nlibrary(igraph)\nlibrary(corrplot)\n\n# 创建输出目录\noutput_dir <- here::here(\"data\", params$name)\nif (!dir.exists(output_dir)) {\n  dir.create(output_dir, recursive = TRUE)\n}\n\ncat(\"输出目录:\", output_dir, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n输出目录: C:/Users/36094/Desktop/pc047oma/analyses/data/03c_cooccurrence_network \n```\n\n\n:::\n:::\n\n\n## Part 1: 数据加载\n\n### 1.1 加载细菌数据 (01分析)\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 读取清洗后的细菌TSE\ntse_bacteria <- readRDS(here::here(\"data\", \"01_alpha_beta_diversity_analysis\",\n                                    \"tse_standard_species_ca_cleaned.rds\"))\n\ncat(\"细菌TSE:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n细菌TSE:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"- 物种数:\", nrow(tse_bacteria), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n- 物种数: 11210 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"- 样本数:\", ncol(tse_bacteria), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n- 样本数: 27 \n```\n\n\n:::\n\n```{.r .cell-code}\n# 获取元数据\nmetadata <- as.data.frame(colData(tse_bacteria))\nprint(table(metadata$treatment_group))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nApcMUT_Ctrl ApcMUT_HpKO ApcMUT_HpWT  ApcWT_Ctrl  ApcWT_HpKO  ApcWT_HpWT \n          3           4           5           5           5           5 \n```\n\n\n:::\n:::\n\n\n### 1.2 加载噬菌体数据 (03分析)\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 检查噬菌体TSE是否存在\nphage_file <- here::here(\"data\", \"03_singlem_diversity_analysis\",\n                          \"tse_lyrebird.rds\")\n\nif (file.exists(phage_file)) {\n  tse_phage <- readRDS(phage_file)\n  cat(\"\\n噬菌体TSE:\\n\")\n  cat(\"- OTU数:\", nrow(tse_phage), \"\\n\")\n  cat(\"- 样本数:\", ncol(tse_phage), \"\\n\")\n  has_phage <- TRUE\n} else {\n  cat(\"\\n噬菌体TSE不存在，将只进行细菌网络分析\\n\")\n  has_phage <- FALSE\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n噬菌体TSE不存在，将只进行细菌网络分析\n```\n\n\n:::\n:::\n\n\n### 1.3 找共同样本\n\n\n::: {.cell}\n\n```{.r .cell-code}\nif (has_phage) {\n  common_samples <- base::intersect(colnames(tse_bacteria), colnames(tse_phage))\n  cat(\"细菌-噬菌体共同样本数:\", length(common_samples), \"\\n\")\n} else {\n  common_samples <- colnames(tse_bacteria)\n}\n```\n:::\n\n\n## Part 2: 细菌-细菌Co-occurrence网络\n\n### 2.1 准备丰度矩阵\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 获取counts矩阵\nbacteria_counts <- assay(tse_bacteria, \"counts\")\n\n# 过滤低丰度物种 (至少在20%样本中存在)\nprevalence <- rowSums(bacteria_counts > 0) / ncol(bacteria_counts)\nbacteria_filtered <- bacteria_counts[prevalence >= 0.2, ]\n\ncat(\"Prevalence过滤后物种数:\", nrow(bacteria_filtered), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPrevalence过滤后物种数: 10595 \n```\n\n\n:::\n\n```{.r .cell-code}\n# 转换为相对丰度\nbacteria_relab_all <- sweep(bacteria_filtered, 2, colSums(bacteria_filtered), \"/\")\n\n# 只保留Top 100高丰度物种用于网络分析\n# 原因：1) 计算效率；2) 样本数少时统计意义有限；3) 聚焦主要物种\nmax_species_network <- 100\nmean_abundance <- rowMeans(bacteria_relab_all)\ntop_species <- names(sort(mean_abundance, decreasing = TRUE))[1:min(max_species_network, length(mean_abundance))]\nbacteria_relab <- bacteria_relab_all[top_species, , drop = FALSE]\n\ncat(\"网络分析使用Top\", nrow(bacteria_relab), \"高丰度物种\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n网络分析使用Top 100 高丰度物种\n```\n\n\n:::\n:::\n\n\n### 2.2 计算Spearman相关性\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 使用Spearman相关性（对组成型数据更稳健）\n# 注意：理想情况下应使用SparCC，但这里用Spearman作为快速替代\n\ncor_matrix <- cor(t(bacteria_relab), method = \"spearman\")\n\ncat(\"相关矩阵维度:\", dim(cor_matrix), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n相关矩阵维度: 100 100 \n```\n\n\n:::\n:::\n\n\n### 2.3 构建网络（全样本）\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 设置相关性阈值\ncor_threshold <- 0.75  # 提高阈值减少边数\np_threshold <- 0.05\n\n# 计算p值\nn_samples <- ncol(bacteria_relab)\ncor_to_t <- function(r, n) {\n  r * sqrt((n - 2) / (1 - r^2))\n}\nt_values <- cor_to_t(cor_matrix, n_samples)\np_values <- 2 * pt(-abs(t_values), df = n_samples - 2)\n\n# 显著且强相关的边\nadj_matrix <- abs(cor_matrix) >= cor_threshold & p_values < p_threshold\ndiag(adj_matrix) <- FALSE\n\n# 创建igraph对象\ng_all <- graph_from_adjacency_matrix(adj_matrix, mode = \"undirected\")\n\n# 添加边权重（相关系数）\nedge_list <- which(adj_matrix, arr.ind = TRUE)\nedge_list <- edge_list[edge_list[,1] < edge_list[,2], ]  # 只保留上三角\n\nif (nrow(edge_list) > 0) {\n  E(g_all)$weight <- sapply(1:nrow(edge_list), function(i) {\n    cor_matrix[edge_list[i,1], edge_list[i,2]]\n  })\n  E(g_all)$sign <- ifelse(E(g_all)$weight > 0, \"positive\", \"negative\")\n}\n\ncat(\"\\n全样本细菌网络:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n全样本细菌网络:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"- 节点数:\", vcount(g_all), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n- 节点数: 100 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"- 边数:\", ecount(g_all), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n- 边数: 530 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"- 正相关边:\", sum(E(g_all)$sign == \"positive\", na.rm = TRUE), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n- 正相关边: 498 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"- 负相关边:\", sum(E(g_all)$sign == \"negative\", na.rm = TRUE), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n- 负相关边: 32 \n```\n\n\n:::\n:::\n\n\n### 2.4 按处理组构建网络\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 定义要比较的组\ngroups_to_compare <- c(\"ApcMUT_HpKO\", \"ApcMUT_HpWT\")\n\nnetwork_stats <- list()\n\nfor (grp in groups_to_compare) {\n  # 获取该组样本\n  grp_samples <- rownames(metadata)[metadata$treatment_group == grp]\n\n  if (length(grp_samples) < 3) {\n    cat(sprintf(\"\\n%s: 样本数不足，跳过\\n\", grp))\n    next\n  }\n\n  # 计算该组的相关性\n  grp_relab <- bacteria_relab[, grp_samples]\n\n  # 过滤掉标准差为0的物种（避免相关系数变NA）\n  row_sds <- apply(grp_relab, 1, sd)\n  grp_relab_filtered <- grp_relab[row_sds > 0, , drop = FALSE]\n\n  # 只保留Top N高丰度物种（样本数太少时，物种数也应限制）\n  # 统一使用 Top 50，与可视化保持一致\n  max_species <- min(nrow(grp_relab_filtered), 50)\n  mean_abundance <- rowMeans(grp_relab_filtered)\n  top_species <- names(sort(mean_abundance, decreasing = TRUE))[1:max_species]\n  grp_relab_top <- grp_relab_filtered[top_species, , drop = FALSE]\n\n  cat(sprintf(\"\\n%s: 原始%d → 非恒定%d → Top %d高丰度物种\\n\",\n              grp, nrow(grp_relab), nrow(grp_relab_filtered), nrow(grp_relab_top)))\n\n  if (nrow(grp_relab_top) < 3) {\n    cat(sprintf(\"  物种数不足，跳过网络构建\\n\"))\n    next\n  }\n\n  grp_cor <- cor(t(grp_relab_top), method = \"spearman\")\n\n  # 处理可能残留的NA（理论上不应该有了）\n  grp_cor[is.na(grp_cor)] <- 0\n\n  # 构建网络\n  grp_adj <- abs(grp_cor) >= cor_threshold\n  diag(grp_adj) <- FALSE\n\n  g_grp <- graph_from_adjacency_matrix(grp_adj, mode = \"undirected\")\n\n  # 计算网络拓扑参数\n  stats <- list(\n    group = grp,\n    n_samples = length(grp_samples),\n    n_nodes = vcount(g_grp),\n    n_edges = ecount(g_grp),\n    density = edge_density(g_grp),\n    transitivity = transitivity(g_grp, type = \"global\"),\n    avg_path_length = if (is_connected(g_grp)) mean_distance(g_grp) else NA,\n    modularity = if (ecount(g_grp) > 0) modularity(cluster_louvain(g_grp)) else NA\n  )\n\n  network_stats[[grp]] <- stats\n\n  cat(sprintf(\"\\n%s 网络统计:\\n\", grp))\n  cat(sprintf(\"  节点: %d, 边: %d\\n\", stats$n_nodes, stats$n_edges))\n  cat(sprintf(\"  密度: %.4f\\n\", stats$density))\n  cat(sprintf(\"  聚类系数: %.4f\\n\", stats$transitivity))\n  cat(sprintf(\"  模块度: %.4f\\n\", stats$modularity))\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nApcMUT_HpKO: 原始100 → 非恒定100 → Top 50高丰度物种\n\nApcMUT_HpKO 网络统计:\n  节点: 50, 边: 416\n  密度: 0.3396\n  聚类系数: 0.6281\n  模块度: 0.3932\n\nApcMUT_HpWT: 原始100 → 非恒定100 → Top 50高丰度物种\n\nApcMUT_HpWT 网络统计:\n  节点: 50, 边: 360\n  密度: 0.2939\n  聚类系数: 0.7672\n  模块度: 0.2367\n```\n\n\n:::\n\n```{.r .cell-code}\n# 汇总表\nnetwork_stats_df <- bind_rows(network_stats)\nprint(network_stats_df)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 8\n  group       n_samples n_nodes n_edges density transitivity avg_path_length\n  <chr>           <int>   <dbl>   <dbl>   <dbl>        <dbl>           <dbl>\n1 ApcMUT_HpKO         4      50     416   0.340        0.628            1.90\n2 ApcMUT_HpWT         5      50     360   0.294        0.767           NA   \n# ℹ 1 more variable: modularity <dbl>\n```\n\n\n:::\n\n```{.r .cell-code}\nwrite.csv(network_stats_df,\n          file = file.path(output_dir, \"01_bacteria_network_stats.csv\"),\n          row.names = FALSE)\n```\n:::\n\n\n### 2.5 网络可视化\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 全样本网络可视化\nif (ecount(g_all) > 0 && ecount(g_all) < 500) {\n  # 设置布局\n  set.seed(42)\n  layout <- layout_with_fr(g_all)\n\n  # 节点大小基于度 (显式使用igraph::degree避免与ape冲突)\n  V(g_all)$size <- igraph::degree(g_all) + 3\n\n  # 边颜色基于正负相关\n  E(g_all)$color <- ifelse(E(g_all)$sign == \"positive\", \"steelblue\", \"tomato\")\n\n  par(mfrow = c(1, 1), mar = c(1, 1, 3, 1))\n  plot(g_all,\n       layout = layout,\n       vertex.label = NA,\n       vertex.color = \"lightblue\",\n       edge.width = abs(E(g_all)$weight) * 2,\n       main = \"细菌Co-occurrence网络\\n(蓝=正相关, 红=负相关)\")\n\n} else if (ecount(g_all) >= 500) {\n  cat(\"边数过多 (\", ecount(g_all), \")，跳过全网络可视化\\n\")\n  cat(\"建议提高相关性阈值或使用专门的网络可视化工具\\n\")\n} else {\n  cat(\"网络无边，跳过可视化\\n\")\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n边数过多 ( 530 )，跳过全网络可视化\n建议提高相关性阈值或使用专门的网络可视化工具\n```\n\n\n:::\n:::\n\n\n### 2.5b 分组网络对比可视化\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ========== 分组网络对比可视化 ==========\ncat(\"\\n====== 生成分组网络对比图 ======\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n====== 生成分组网络对比图 ======\n```\n\n\n:::\n\n```{.r .cell-code}\n# 设置更高的可视化阈值\nviz_cor_threshold <- 0.75\n\npng(file.path(output_dir, \"03_network_comparison.png\"),\n    width = 1400, height = 700, res = 150)\n\npar(mfrow = c(1, 2), mar = c(2, 2, 4, 2))\n\nfor (grp in groups_to_compare) {\n  grp_samples <- rownames(metadata)[metadata$treatment_group == grp]\n  grp_relab <- bacteria_relab[, grp_samples]\n\n  # 过滤\n  row_sds <- apply(grp_relab, 1, sd)\n  grp_relab_filtered <- grp_relab[row_sds > 0, , drop = FALSE]\n\n  # 只取 Top 50 高丰度物种\n  max_species <- min(50, nrow(grp_relab_filtered))\n  mean_abundance <- rowMeans(grp_relab_filtered)\n  top_species <- names(sort(mean_abundance, decreasing = TRUE))[1:max_species]\n  grp_relab_top <- grp_relab_filtered[top_species, , drop = FALSE]\n\n  # 计算相关性\n  grp_cor <- cor(t(grp_relab_top), method = \"spearman\")\n  grp_cor[is.na(grp_cor)] <- 0\n\n  # 用更高阈值构建网络\n  grp_adj <- abs(grp_cor) >= viz_cor_threshold\n  diag(grp_adj) <- FALSE\n\n  g_grp <- graph_from_adjacency_matrix(grp_adj, mode = \"undirected\")\n\n  # 计算模块度\n  mod_value <- if (ecount(g_grp) > 0) modularity(cluster_louvain(g_grp)) else 0\n\n  if (ecount(g_grp) > 0) {\n    set.seed(42)\n    layout_grp <- layout_with_fr(g_grp)\n\n    # 节点大小基于度\n    deg <- igraph::degree(g_grp)\n    V(g_grp)$size <- deg / max(deg) * 12 + 4\n\n    # 节点颜色基于模块\n    if (ecount(g_grp) > 0) {\n      communities <- cluster_louvain(g_grp)\n      V(g_grp)$color <- rainbow(max(membership(communities)))[membership(communities)]\n    }\n\n    plot(g_grp,\n         layout = layout_grp,\n         vertex.label = NA,\n         edge.color = \"gray60\",\n         edge.width = 0.5,\n         main = sprintf(\"%s\\nNodes: %d | Edges: %d | Modularity: %.3f\",\n                       grp, vcount(g_grp), ecount(g_grp), mod_value))\n  } else {\n    plot.new()\n    text(0.5, 0.5, paste(grp, \"\\nNo edges at threshold\", viz_cor_threshold))\n  }\n}\n\ndev.off()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\npng \n  2 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"✅ 网络对比图已保存: 03_network_comparison.png\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n✅ 网络对比图已保存: 03_network_comparison.png\n```\n\n\n:::\n:::\n\n\n### 2.5c 网络统计柱状图\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ========== 网络统计柱状图 ==========\n\nif (nrow(network_stats_df) >= 2) {\n  # 准备长格式数据\n  stats_for_plot <- network_stats_df %>%\n    dplyr::select(group, n_nodes, n_edges, modularity) %>%\n    pivot_longer(cols = -group, names_to = \"metric\", values_to = \"value\") %>%\n    mutate(metric = factor(metric,\n                          levels = c(\"n_nodes\", \"n_edges\", \"modularity\"),\n                          labels = c(\"Nodes\", \"Edges\", \"Modularity\")))\n\n  # 计算变化\n  ctrl_mod <- network_stats_df$modularity[network_stats_df$group == \"ApcMUT_HpKO\"]\n  caga_mod <- network_stats_df$modularity[network_stats_df$group == \"ApcMUT_HpWT\"]\n  mod_change <- round((caga_mod - ctrl_mod) / ctrl_mod * 100, 0)\n\n  p_stats <- ggplot(stats_for_plot, aes(x = metric, y = value, fill = group)) +\n    geom_bar(stat = \"identity\", position = position_dodge(width = 0.8), width = 0.7) +\n    geom_text(aes(label = round(value, 3)),\n              position = position_dodge(width = 0.8), vjust = -0.5, size = 3.5) +\n    theme_bw(base_size = 14) +\n    labs(title = \"Network Topology Changes: CagA Effect\",\n         subtitle = sprintf(\"Modularity change: %d%% (from %.3f to %.3f)\",\n                           mod_change, ctrl_mod, caga_mod),\n         x = NULL, y = \"Value\",\n         fill = \"Group\") +\n    scale_fill_manual(values = c(\"ApcMUT_HpKO\" = \"#66c2a5\", \"ApcMUT_HpWT\" = \"#fc8d62\"),\n                      labels = c(\"Control (HpKO)\", \"CagA+ (HpWT)\")) +\n    facet_wrap(~metric, scales = \"free_y\", nrow = 1) +\n    theme(legend.position = \"bottom\")\n\n  print(p_stats)\n\n  ggsave(file.path(output_dir, \"04_network_stats_barplot.png\"),\n         plot = p_stats, width = 12, height = 5, dpi = 300)\n\n  cat(\"✅ 网络统计图已保存: 04_network_stats_barplot.png\\n\")\n}\n```\n\n::: {.cell-output-display}\n![](03c_cooccurrence_network_analysis_files/figure-html/part2-stats-barplot-1.png){width=1152}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n✅ 网络统计图已保存: 04_network_stats_barplot.png\n```\n\n\n:::\n:::\n\n\n### 2.6 Hub物种识别\n\n\n::: {.cell}\n\n```{.r .cell-code}\nif (ecount(g_all) > 0) {\n  # 计算中心性指标 (显式使用igraph::避免与ape冲突)\n  # 注意：betweenness/closeness 不使用权重，因为相关系数可为负\n  degree_cent <- igraph::degree(g_all)\n  betweenness_cent <- igraph::betweenness(g_all, weights = NA)\n  closeness_cent <- igraph::closeness(g_all, weights = NA)\n\n  hub_df <- data.frame(\n    species = V(g_all)$name,\n    degree = degree_cent,\n    betweenness = betweenness_cent,\n    closeness = closeness_cent\n  ) %>%\n    arrange(desc(degree))\n\n  cat(\"\\nTop 10 Hub物种 (按度排序):\\n\\n\")\n  print(head(hub_df, 10))\n\n  write.csv(hub_df,\n            file = file.path(output_dir, \"02_bacteria_hub_species.csv\"),\n            row.names = FALSE)\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nTop 10 Hub物种 (按度排序):\n\n                                                  species degree betweenness\nMarvinbryantia formatexigens Marvinbryantia formatexigens     30    64.39925\nBlautia parvula                           Blautia parvula     29   159.12282\nSellimonas catena                       Sellimonas catena     28    35.63975\nAgathobacter rectalis               Agathobacter rectalis     27    55.17001\nHungatella hathewayi                 Hungatella hathewayi     26   107.49917\nRoseburia hominis                       Roseburia hominis     26    56.46658\nBlautia obeum                               Blautia obeum     25   128.10765\nHungatella sp. SB206                 Hungatella sp. SB206     25    15.96324\nClostridium sp. M62/1               Clostridium sp. M62/1     24   207.21707\n[Clostridium] hylemonae           [Clostridium] hylemonae     23   124.80287\n                               closeness\nMarvinbryantia formatexigens 0.006329114\nBlautia parvula              0.007142857\nSellimonas catena            0.006211180\nAgathobacter rectalis        0.006097561\nHungatella hathewayi         0.006993007\nRoseburia hominis            0.006211180\nBlautia obeum                0.007092199\nHungatella sp. SB206         0.006060606\nClostridium sp. M62/1        0.006993007\n[Clostridium] hylemonae      0.006896552\n```\n\n\n:::\n:::\n\n\n## Part 3: 细菌-噬菌体跨域网络\n\n\n::: {.cell}\n\n```{.r .cell-code}\nif (has_phage) {\n  cat(\"\\n====== 细菌-噬菌体跨域网络分析 ======\\n\\n\")\n\n  # 获取共同样本的数据\n  bacteria_common <- bacteria_relab[, common_samples]\n  phage_counts <- assay(tse_phage[, common_samples], \"counts\")\n\n  # 过滤噬菌体\n  phage_prev <- rowSums(phage_counts > 0) / ncol(phage_counts)\n  phage_filtered <- phage_counts[phage_prev >= 0.2, ]\n  phage_relab <- sweep(phage_filtered, 2, colSums(phage_filtered) + 1, \"/\")\n\n  cat(\"过滤后细菌数:\", nrow(bacteria_common), \"\\n\")\n  cat(\"过滤后噬菌体数:\", nrow(phage_filtered), \"\\n\")\n\n  # 计算细菌-噬菌体相关性\n  cross_cor <- cor(t(bacteria_common), t(phage_relab), method = \"spearman\")\n\n  cat(\"跨域相关矩阵维度:\", dim(cross_cor), \"\\n\")\n\n  # 识别显著关联\n  cross_threshold <- 0.5\n  sig_pairs <- which(abs(cross_cor) >= cross_threshold, arr.ind = TRUE)\n\n  if (nrow(sig_pairs) > 0) {\n    cross_pairs_df <- data.frame(\n      bacteria = rownames(cross_cor)[sig_pairs[,1]],\n      phage = colnames(cross_cor)[sig_pairs[,2]],\n      correlation = sapply(1:nrow(sig_pairs), function(i) {\n        cross_cor[sig_pairs[i,1], sig_pairs[i,2]]\n      })\n    ) %>%\n      arrange(desc(abs(correlation)))\n\n    cat(\"\\nTop 20 细菌-噬菌体关联:\\n\\n\")\n    print(head(cross_pairs_df, 20))\n\n    write.csv(cross_pairs_df,\n              file = file.path(output_dir, \"03_bacteria_phage_associations.csv\"),\n              row.names = FALSE)\n  } else {\n    cat(\"未发现显著的细菌-噬菌体关联 (阈值:\", cross_threshold, \")\\n\")\n  }\n}\n```\n:::\n\n\n## Part 4: 网络比较 - CagA效应\n\n\n::: {.cell}\n\n```{.r .cell-code}\nif (length(network_stats) >= 2) {\n  cat(\"\\n====== 网络拓扑比较: CagA效应 ======\\n\\n\")\n\n  # 比较ApcMUT_HpWT vs ApcMUT_HpKO\n  if (\"ApcMUT_HpWT\" %in% names(network_stats) && \"ApcMUT_HpKO\" %in% names(network_stats)) {\n    hpwt <- network_stats[[\"ApcMUT_HpWT\"]]\n    hpko <- network_stats[[\"ApcMUT_HpKO\"]]\n\n    cat(\"| 指标 | HpKO (对照) | HpWT (CagA+) | 变化 |\\n\")\n    cat(\"|------|-------------|--------------|------|\\n\")\n    cat(sprintf(\"| 边数 | %d | %d | %+d |\\n\",\n                hpko$n_edges, hpwt$n_edges, hpwt$n_edges - hpko$n_edges))\n    cat(sprintf(\"| 密度 | %.4f | %.4f | %+.4f |\\n\",\n                hpko$density, hpwt$density, hpwt$density - hpko$density))\n    cat(sprintf(\"| 聚类系数 | %.4f | %.4f | %+.4f |\\n\",\n                hpko$transitivity, hpwt$transitivity,\n                hpwt$transitivity - hpko$transitivity))\n    cat(sprintf(\"| 模块度 | %.4f | %.4f | %+.4f |\\n\",\n                hpko$modularity, hpwt$modularity,\n                hpwt$modularity - hpko$modularity))\n\n    cat(\"\\n**解读**:\\n\")\n    if (hpwt$density > hpko$density) {\n      cat(\"- CagA感染**增加**网络密度 → 物种间关联更紧密\\n\")\n    } else {\n      cat(\"- CagA感染**降低**网络密度 → 物种间关联更松散\\n\")\n    }\n\n    if (hpwt$modularity > hpko$modularity) {\n      cat(\"- CagA感染**增加**模块度 → 群落更加模块化/分隔\\n\")\n    } else {\n      cat(\"- CagA感染**降低**模块度 → 群落结构更混合\\n\")\n    }\n  }\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n====== 网络拓扑比较: CagA效应 ======\n\n| 指标 | HpKO (对照) | HpWT (CagA+) | 变化 |\n|------|-------------|--------------|------|\n| 边数 | 416 | 360 | -56 |\n| 密度 | 0.3396 | 0.2939 | -0.0457 |\n| 聚类系数 | 0.6281 | 0.7672 | +0.1391 |\n| 模块度 | 0.3932 | 0.2367 | -0.1565 |\n\n**解读**:\n- CagA感染**降低**网络密度 → 物种间关联更松散\n- CagA感染**降低**模块度 → 群落结构更混合\n```\n\n\n:::\n:::\n\n\n## Part 5: 结论汇总\n\n\n## Part 5 关键发现\n\n### 细菌网络\n\n- 全样本网络: 100节点, 530边\n- 正相关边: 498 (94.0%), 负相关边: 32 (6.0%)\n\n### Hub物种 (Top 5)\n\n1. Marvinbryantia formatexigens (度=30)\n2. Blautia parvula (度=29)\n3. Sellimonas catena (度=28)\n4. Agathobacter rectalis (度=27)\n5. Hungatella hathewayi (度=26)\n\n### 后续分析建议\n\n1. 使用SparCC替代Spearman获得更准确的组成型数据相关性\n2. 进行网络稳定性分析（bootstrap）\n3. 整合功能数据进行三方网络分析\n\n✅ 03c分析结果已保存:\n  - 01_bacteria_network_stats.csv\n  - 02_bacteria_hub_species.csv\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncat(\"\\n【分析环境信息】\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n【分析环境信息】\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"R版本:\", R.version.string, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nR版本: R version 4.5.2 (2025-10-31 ucrt) \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"分析日期:\", format(Sys.time(), \"%Y-%m-%d %H:%M:%S\"), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n分析日期: 2026-01-22 22:58:08 \n```\n\n\n:::\n:::\n\n",
    "supporting": [
      "03c_cooccurrence_network_analysis_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}