---
title: "Part 4: Network Analysis"
subtitle: "PC047 vCagAepitope - Co-occurrence网络与跨域互作分析"
author:
  - name: Gong Yuhang
date: today
toc: true
toc-depth: 4
number-sections: true
code-fold: true
code-line-numbers: true
code-tools: true
format:
  html:
    embed-resources: true
    smooth-scroll: true
    page-layout: full
    fig-width: 7.2
    fig-height: 5
    fig-dpi: 300
execute:
  warning: false
  message: false
reference-location: section
citation-location: document
params:
  name: "04_network_analysis"
---

# 研究问题 {#sec-question}

> **核心问题**：CagA感染如何改变肠道微生物组的生态网络结构？
>
> **假说**：CagA感染会重塑物种间的共生/竞争关系，导致网络拓扑特性（如模块度、连通性）发生变化。

## 分析背景

Co-occurrence网络分析用于评估物种间的共生/竞争关系，以及CagA感染如何改变这些关系。

**分析内容**：

1. **细菌-细菌网络**：评估细菌间共生/竞争关系
2. **细菌-噬菌体跨域网络**：宿主-噬菌体特异性互作
3. **网络拓扑比较**：不同处理组的网络结构差异

**方法**：Spearman相关性（组成型数据的稳健替代方案）

---

```{r}
#| label: params
#| eval: !expr interactive()
#| include: false
params = list(name = "04_network_analysis")
```

```{r}
#| label: setup
#| message: false
#| include: false
#| warning: false
wd <- "analyses"
if (basename(getwd()) != wd) {
  setwd(here::here(wd))
}
here::i_am(paste0(params$name, ".qmd"), uuid = "f0e586d9-7089-4322-a7c5-1a52210db08b")
projthis::proj_create_dir_target(params$name, clean = FALSE)
path_target <- projthis::proj_path_target(params$name)
path_source <- projthis::proj_path_source(params$name)
path_raw <- path_source("00-raw")
path_resource <- here::here(path_raw, "d00-resource")
path_data <- here::here(path_raw, paste0("d", params$name))
dir.create(path_raw, recursive = TRUE, showWarnings = FALSE)
dir.create(path_data, recursive = TRUE, showWarnings = FALSE)
dir.create(path_resource, recursive = TRUE, showWarnings = FALSE)
```

```{r}
#| label: packages
#| message: false
suppressPackageStartupMessages({
  library(here)
  library(conflicted)
  library(tidyverse)
  library(data.table)
  library(TreeSummarizedExperiment)
  library(mia)
  library(igraph)
  library(ggraph)
  library(ggrepel)
  library(scales)
  library(corrplot)
  library(patchwork)
  devtools::load_all()
})

# 解决命名空间冲突
conflicts_prefer(base::setdiff)
conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::select)
conflicts_prefer(dplyr::lag)
conflicts_prefer(base::intersect)
conflicts_prefer(igraph::degree)
conflicts_prefer(igraph::betweenness)
conflicts_prefer(igraph::closeness)

set.seed(20261)
```

# Part 1: 数据准备 {#sec-part1}

## 1.1 加载细菌数据 (01分析)

```{r}
#| label: part1-load-bacteria

# 读取清洗后的细菌TSE
tse_bacteria <- readRDS(here::here("data", "01_alpha_beta_diversity_analysis",
                                    "tse_standard_species_ca_cleaned.rds"))

cat("细菌TSE:\n")
cat("- 物种数:", nrow(tse_bacteria), "\n")
cat("- 样本数:", ncol(tse_bacteria), "\n")

# 获取元数据
metadata <- as.data.frame(colData(tse_bacteria))
print(table(metadata$treatment_group))
```

## 1.2 加载噬菌体数据 (03分析)

```{r}
#| label: part1-load-phage

# 检查噬菌体TSE是否存在
phage_file <- here::here("data", "03_singlem_diversity_analysis",
                          "tse_lyrebird_corepair.rds")

if (file.exists(phage_file)) {
  tse_phage <- readRDS(phage_file)
  cat("\n噬菌体TSE:\n")
  cat("- OTU数:", nrow(tse_phage), "\n")
  cat("- 样本数:", ncol(tse_phage), "\n")
  has_phage <- TRUE
} else {
  cat("\n噬菌体TSE不存在，将只进行细菌网络分析\n")
  has_phage <- FALSE
}
```

## 1.3 找共同样本

```{r}
#| label: part1-common-samples

if (has_phage) {
  common_samples <- base::intersect(colnames(tse_bacteria), colnames(tse_phage))
  cat("细菌-噬菌体共同样本数:", length(common_samples), "\n")
} else {
  common_samples <- colnames(tse_bacteria)
}
```

# Part 2: 细菌-细菌 Co-occurrence 网络 {#sec-part2}

## 2.1 准备丰度矩阵

```{r}
#| label: part2-prep-matrix

# 获取counts矩阵
bacteria_counts <- assay(tse_bacteria, "counts")

# 过滤低丰度物种 (至少在20%样本中存在)
prevalence <- rowSums(bacteria_counts > 0) / ncol(bacteria_counts)
bacteria_filtered <- bacteria_counts[prevalence >= 0.2, ]

cat("Prevalence过滤后物种数:", nrow(bacteria_filtered), "\n")

# 转换为相对丰度
bacteria_relab_all <- sweep(bacteria_filtered, 2, colSums(bacteria_filtered), "/")

# 只保留Top 100高丰度物种用于网络分析
max_species_network <- 100
mean_abundance <- rowMeans(bacteria_relab_all)
top_species <- names(sort(mean_abundance, decreasing = TRUE))[1:min(max_species_network, length(mean_abundance))]
bacteria_relab <- bacteria_relab_all[top_species, , drop = FALSE]

cat("网络分析使用Top", nrow(bacteria_relab), "高丰度物种\n")
```

## 2.2 计算Spearman相关性

```{r}
#| label: part2-calc-correlation

# 使用Spearman相关性（对组成型数据更稳健）
cor_matrix <- cor(t(bacteria_relab), method = "spearman")

cat("相关矩阵维度:", dim(cor_matrix), "\n")
```

## 2.3 构建全样本网络

```{r}
#| label: part2-build-network

# 设置相关性阈值
cor_threshold <- 0.75
p_threshold <- 0.05

# 计算p值
n_samples <- ncol(bacteria_relab)
cor_to_t <- function(r, n) {
  r * sqrt((n - 2) / (1 - r^2))
}
t_values <- cor_to_t(cor_matrix, n_samples)
p_values <- 2 * pt(-abs(t_values), df = n_samples - 2)

# 显著且强相关的边
adj_matrix <- abs(cor_matrix) >= cor_threshold & p_values < p_threshold
diag(adj_matrix) <- FALSE

# 创建igraph对象
g_all <- igraph::graph_from_adjacency_matrix(adj_matrix, mode = "undirected")

# 添加边权重（相关系数）
edge_list <- which(adj_matrix, arr.ind = TRUE)
edge_list <- edge_list[edge_list[,1] < edge_list[,2], ]

if (nrow(edge_list) > 0) {
  igraph::E(g_all)$weight <- sapply(1:nrow(edge_list), function(i) {
    cor_matrix[edge_list[i,1], edge_list[i,2]]
  })
  igraph::E(g_all)$sign <- ifelse(igraph::E(g_all)$weight > 0, "positive", "negative")
}

cat("\n全样本细菌网络:\n")
cat("- 节点数:", igraph::vcount(g_all), "\n")
cat("- 边数:", igraph::ecount(g_all), "\n")
cat("- 正相关边:", sum(igraph::E(g_all)$sign == "positive", na.rm = TRUE), "\n")
cat("- 负相关边:", sum(igraph::E(g_all)$sign == "negative", na.rm = TRUE), "\n")
```

## 2.4 按处理组构建网络

```{r}
#| label: part2-group-networks

# 定义要比较的组
groups_to_compare <- c("ApcMUT_HpKO", "ApcMUT_HpWT")

network_stats <- list()

for (grp in groups_to_compare) {
  grp_samples <- rownames(metadata)[metadata$treatment_group == grp]

  if (length(grp_samples) < 3) {
    cat(sprintf("\n%s: 样本数不足，跳过\n", grp))
    next
  }

  grp_relab <- bacteria_relab[, grp_samples]

  # 过滤掉标准差为0的物种
  row_sds <- apply(grp_relab, 1, sd)
  grp_relab_filtered <- grp_relab[row_sds > 0, , drop = FALSE]

  # 只保留Top 50高丰度物种
  max_species <- min(nrow(grp_relab_filtered), 50)
  mean_abundance_grp <- rowMeans(grp_relab_filtered)
  top_species_grp <- names(sort(mean_abundance_grp, decreasing = TRUE))[1:max_species]
  grp_relab_top <- grp_relab_filtered[top_species_grp, , drop = FALSE]

  cat(sprintf("\n%s: 原始%d → 非恒定%d → Top %d高丰度物种\n",
              grp, nrow(grp_relab), nrow(grp_relab_filtered), nrow(grp_relab_top)))

  if (nrow(grp_relab_top) < 3) {
    cat(sprintf("  物种数不足，跳过网络构建\n"))
    next
  }

  grp_cor <- cor(t(grp_relab_top), method = "spearman")
  grp_cor[is.na(grp_cor)] <- 0

  grp_adj <- abs(grp_cor) >= cor_threshold
  diag(grp_adj) <- FALSE

  g_grp <- igraph::graph_from_adjacency_matrix(grp_adj, mode = "undirected")

  # 计算网络拓扑参数
  stats <- list(
    group = grp,
    n_samples = length(grp_samples),
    n_nodes = igraph::vcount(g_grp),
    n_edges = igraph::ecount(g_grp),
    density = igraph::edge_density(g_grp),
    transitivity = igraph::transitivity(g_grp, type = "global"),
    avg_path_length = if (igraph::is_connected(g_grp)) igraph::mean_distance(g_grp) else NA,
    modularity = if (igraph::ecount(g_grp) > 0) igraph::modularity(igraph::cluster_louvain(g_grp)) else NA
  )

  network_stats[[grp]] <- stats

  cat(sprintf("\n%s 网络统计:\n", grp))
  cat(sprintf("  节点: %d, 边: %d\n", stats$n_nodes, stats$n_edges))
  cat(sprintf("  密度: %.4f\n", stats$density))
  cat(sprintf("  聚类系数: %.4f\n", stats$transitivity))
  cat(sprintf("  模块度: %.4f\n", stats$modularity))
}

# 汇总表
network_stats_df <- bind_rows(network_stats)
print(network_stats_df)

write.csv(network_stats_df,
          file = here::here("data", params$name, "01_bacteria_network_stats.csv"),
          row.names = FALSE)
```

## 2.5 网络可视化

### 2.5.1 全样本网络

```{r}
#| label: part2-visualization
#| fig-width: 10
#| fig-height: 8

if (igraph::ecount(g_all) > 0 && igraph::ecount(g_all) < 500) {
  set.seed(42)
  layout <- igraph::layout_with_fr(g_all)

  igraph::V(g_all)$size <- igraph::degree(g_all) + 3
  igraph::E(g_all)$color <- ifelse(igraph::E(g_all)$sign == "positive", "steelblue", "tomato")

  par(mfrow = c(1, 1), mar = c(1, 1, 3, 1))
  plot(g_all,
       layout = layout,
       vertex.label = NA,
       vertex.color = "lightblue",
       edge.width = abs(igraph::E(g_all)$weight) * 2,
       main = "细菌Co-occurrence网络\n(蓝=正相关, 红=负相关)")

} else if (igraph::ecount(g_all) >= 500) {
  cat("边数过多 (", igraph::ecount(g_all), ")，跳过全网络可视化\n")
} else {
  cat("网络无边，跳过可视化\n")
}
```

### 2.5.2 分组网络对比

```{r}
#| label: part2-group-network-viz
#| fig-width: 14
#| fig-height: 7

viz_cor_threshold <- 0.75

png(here::here("data", params$name, "02_network_comparison.png"),
    width = 1400, height = 700, res = 150)

par(mfrow = c(1, 2), mar = c(2, 2, 4, 2))

for (grp in groups_to_compare) {
  grp_samples <- rownames(metadata)[metadata$treatment_group == grp]
  grp_relab <- bacteria_relab[, grp_samples]

  row_sds <- apply(grp_relab, 1, sd)
  grp_relab_filtered <- grp_relab[row_sds > 0, , drop = FALSE]

  max_species <- min(50, nrow(grp_relab_filtered))
  mean_abundance_grp <- rowMeans(grp_relab_filtered)
  top_species_grp <- names(sort(mean_abundance_grp, decreasing = TRUE))[1:max_species]
  grp_relab_top <- grp_relab_filtered[top_species_grp, , drop = FALSE]

  grp_cor <- cor(t(grp_relab_top), method = "spearman")
  grp_cor[is.na(grp_cor)] <- 0

  grp_adj <- abs(grp_cor) >= viz_cor_threshold
  diag(grp_adj) <- FALSE

  g_grp <- igraph::graph_from_adjacency_matrix(grp_adj, mode = "undirected")
  mod_value <- if (igraph::ecount(g_grp) > 0) igraph::modularity(igraph::cluster_louvain(g_grp)) else 0

  if (igraph::ecount(g_grp) > 0) {
    set.seed(42)
    layout_grp <- igraph::layout_with_fr(g_grp)

    deg <- igraph::degree(g_grp)
    igraph::V(g_grp)$size <- deg / max(deg) * 12 + 4

    communities <- igraph::cluster_louvain(g_grp)
    igraph::V(g_grp)$color <- rainbow(max(igraph::membership(communities)))[igraph::membership(communities)]

    plot(g_grp,
         layout = layout_grp,
         vertex.label = NA,
         edge.color = "gray60",
         edge.width = 0.5,
         main = sprintf("%s\nNodes: %d | Edges: %d | Modularity: %.3f",
                       grp, igraph::vcount(g_grp), igraph::ecount(g_grp), mod_value))
  } else {
    plot.new()
    text(0.5, 0.5, paste(grp, "\nNo edges at threshold", viz_cor_threshold))
  }
}

dev.off()
cat("网络对比图已保存: 02_network_comparison.png\n")
```

### 2.5.3 网络统计柱状图

```{r}
#| label: part2-stats-barplot
#| fig-width: 12
#| fig-height: 5

if (nrow(network_stats_df) >= 2) {
  stats_for_plot <- network_stats_df %>%
    dplyr::select(group, n_nodes, n_edges, modularity) %>%
    pivot_longer(cols = -group, names_to = "metric", values_to = "value") %>%
    mutate(metric = factor(metric,
                          levels = c("n_nodes", "n_edges", "modularity"),
                          labels = c("Nodes", "Edges", "Modularity")))

  ctrl_mod <- network_stats_df$modularity[network_stats_df$group == "ApcMUT_HpKO"]
  caga_mod <- network_stats_df$modularity[network_stats_df$group == "ApcMUT_HpWT"]
  mod_change <- round((caga_mod - ctrl_mod) / ctrl_mod * 100, 0)

  p_stats <- ggplot(stats_for_plot, aes(x = metric, y = value, fill = group)) +
    geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.7) +
    geom_text(aes(label = round(value, 3)),
              position = position_dodge(width = 0.8), vjust = -0.5, size = 3.5) +
    theme_bw(base_size = 14) +
    labs(title = "Network Topology Changes: CagA Effect",
         subtitle = sprintf("Modularity change: %d%% (from %.3f to %.3f)",
                           mod_change, ctrl_mod, caga_mod),
         x = NULL, y = "Value",
         fill = "Group") +
    scale_fill_manual(values = c("ApcMUT_HpKO" = "#66c2a5", "ApcMUT_HpWT" = "#fc8d62"),
                      labels = c("Control (HpKO)", "CagA+ (HpWT)")) +
    facet_wrap(~metric, scales = "free_y", nrow = 1) +
    theme(legend.position = "bottom")

  print(p_stats)

  ggsave(here::here("data", params$name, "03_network_stats_barplot.png"),
         plot = p_stats, width = 12, height = 5, dpi = 300)
}
```

## 2.6 Hub物种识别

```{r}
#| label: part2-hub-species

if (igraph::ecount(g_all) > 0) {
  degree_cent <- igraph::degree(g_all)
  betweenness_cent <- igraph::betweenness(g_all, weights = NA)
  closeness_cent <- igraph::closeness(g_all, weights = NA)

  hub_df <- data.frame(
    species = igraph::V(g_all)$name,
    degree = degree_cent,
    betweenness = betweenness_cent,
    closeness = closeness_cent
  ) %>%
    arrange(desc(degree))

  cat("\nTop 10 Hub物种 (按度排序):\n\n")
  print(head(hub_df, 10))

  write.csv(hub_df,
            file = here::here("data", params$name, "04_bacteria_hub_species.csv"),
            row.names = FALSE)
}
```

## 2.7 网络稳定性分析 (Bootstrap)

Bootstrap重采样评估网络边的可靠性：在多次重采样中稳定出现的边更可信。

```{r}
#| label: part2-bootstrap-stability
#| cache: true

# Bootstrap参数
n_bootstrap <- 500  # 重采样次数（生产环境建议1000）
stability_threshold <- 0.7  # 边稳定性阈值

cat("====== Bootstrap网络稳定性分析 ======\n")
cat("重采样次数:", n_bootstrap, "\n")
cat("稳定性阈值:", stability_threshold, "\n\n")

# 初始化边计数矩阵
n_species <- nrow(bacteria_relab)
edge_counts <- matrix(0, nrow = n_species, ncol = n_species,
                      dimnames = list(rownames(bacteria_relab), rownames(bacteria_relab)))

set.seed(42)

# Bootstrap循环
pb_interval <- floor(n_bootstrap / 10)
for (b in 1:n_bootstrap) {
  # 有放回重采样样本

boot_samples <- sample(ncol(bacteria_relab), replace = TRUE)
  boot_data <- bacteria_relab[, boot_samples]

  # 计算相关性
  boot_cor <- cor(t(boot_data), method = "spearman")
  boot_cor[is.na(boot_cor)] <- 0

  # 识别显著边
  boot_adj <- abs(boot_cor) >= cor_threshold
  diag(boot_adj) <- FALSE

 # 累加边计数
  edge_counts <- edge_counts + boot_adj

  if (b %% pb_interval == 0) {
    cat(sprintf("  进度: %d/%d (%.0f%%)\n", b, n_bootstrap, 100*b/n_bootstrap))
  }
}

# 计算边稳定性
edge_stability <- edge_counts / n_bootstrap

# 统计稳定边
stable_edges <- edge_stability >= stability_threshold
diag(stable_edges) <- FALSE
n_stable_edges <- sum(stable_edges) / 2  # 无向图，除以2

cat("\n====== 稳定性分析结果 ======\n")
cat("原始网络边数:", igraph::ecount(g_all), "\n")
cat(sprintf("稳定边数 (稳定性≥%.0f%%): %d\n", stability_threshold*100, n_stable_edges))
cat(sprintf("边保留率: %.1f%%\n", 100 * n_stable_edges / max(igraph::ecount(g_all), 1)))
```

### 2.7.1 边稳定性分布

```{r}
#| label: part2-stability-distribution
#| fig-width: 10
#| fig-height: 4

# 提取上三角的稳定性值（排除对角线）
upper_tri_stability <- edge_stability[upper.tri(edge_stability)]
nonzero_stability <- upper_tri_stability[upper_tri_stability > 0]

if (length(nonzero_stability) > 0) {
  # 稳定性分布直方图
  p_hist <- ggplot(data.frame(stability = nonzero_stability), aes(x = stability)) +
    geom_histogram(binwidth = 0.05, fill = "steelblue", color = "white", alpha = 0.8) +
    geom_vline(xintercept = stability_threshold, color = "red", linetype = "dashed", linewidth = 1) +
    annotate("text", x = stability_threshold + 0.05, y = Inf, vjust = 2,
             label = sprintf("Threshold: %.0f%%", stability_threshold*100),
             color = "red", fontface = "bold") +
    scale_x_continuous(labels = scales::percent, limits = c(0, 1)) +
    labs(
      title = "Edge Stability Distribution (Bootstrap)",
      subtitle = sprintf("%d bootstrap iterations | %d stable edges (≥%.0f%%)",
                        n_bootstrap, n_stable_edges, stability_threshold*100),
      x = "Edge Stability (proportion of bootstrap samples)",
      y = "Count"
    ) +
    theme_bw(base_size = 12) +
    theme(plot.title = element_text(face = "bold"))

  # 稳定性分类饼图
  stability_categories <- cut(nonzero_stability,
                              breaks = c(0, 0.3, 0.5, 0.7, 0.9, 1.0),
                              labels = c("<30%", "30-50%", "50-70%", "70-90%", ">90%"),
                              include.lowest = TRUE)

  pie_data <- as.data.frame(table(stability_categories)) %>%
    mutate(prop = Freq / sum(Freq),
           label = sprintf("%s\n(n=%d)", stability_categories, Freq))

  p_pie <- ggplot(pie_data, aes(x = "", y = Freq, fill = stability_categories)) +
    geom_bar(stat = "identity", width = 1) +
    coord_polar("y") +
    scale_fill_manual(values = c("<30%" = "#d73027", "30-50%" = "#fc8d59",
                                  "50-70%" = "#fee090", "70-90%" = "#91cf60",
                                  ">90%" = "#1a9850"),
                      name = "Stability") +
    labs(title = "Edge Stability Categories") +
    theme_void(base_size = 12) +
    theme(plot.title = element_text(face = "bold", hjust = 0.5),
          legend.position = "right")

  print(p_hist + p_pie + plot_layout(widths = c(2, 1)))

  ggsave(here::here("data", params$name, "05_edge_stability_distribution.png"),
         plot = p_hist + p_pie + plot_layout(widths = c(2, 1)),
         width = 10, height = 4, dpi = 300)
}
```

### 2.7.2 构建稳健网络

```{r}
#| label: part2-robust-network
#| fig-width: 8
#| fig-height: 7

# 基于稳定性构建稳健网络
g_robust <- igraph::graph_from_adjacency_matrix(stable_edges, mode = "undirected")

# 添加稳定性作为边权重
if (igraph::ecount(g_robust) > 0) {
  edge_list_robust <- igraph::as_edgelist(g_robust)
  edge_stab_values <- sapply(1:nrow(edge_list_robust), function(i) {
    edge_stability[edge_list_robust[i,1], edge_list_robust[i,2]]
  })
  igraph::E(g_robust)$stability <- edge_stab_values

  # 添加原始相关系数
  edge_cor_values <- sapply(1:nrow(edge_list_robust), function(i) {
    cor_matrix[edge_list_robust[i,1], edge_list_robust[i,2]]
  })
  igraph::E(g_robust)$correlation <- edge_cor_values
  igraph::E(g_robust)$sign <- ifelse(edge_cor_values > 0, "positive", "negative")
}

cat("\n====== 稳健网络统计 ======\n")
cat("原始网络: 节点", igraph::vcount(g_all), ", 边", igraph::ecount(g_all), "\n")
cat("稳健网络: 节点", igraph::vcount(g_robust), ", 边", igraph::ecount(g_robust), "\n")

if (igraph::ecount(g_robust) > 0) {
  cat("\n稳健网络边的稳定性:\n")
  cat("  平均:", round(mean(igraph::E(g_robust)$stability), 3), "\n")
  cat("  最小:", round(min(igraph::E(g_robust)$stability), 3), "\n")
  cat("  最大:", round(max(igraph::E(g_robust)$stability), 3), "\n")

  # 可视化稳健网络
  if (igraph::ecount(g_robust) < 300) {
    set.seed(42)
    layout_robust <- igraph::layout_with_fr(g_robust)

    # 节点大小 = 度
    igraph::V(g_robust)$size <- igraph::degree(g_robust) + 3

    # 边颜色 = 正/负相关
    igraph::E(g_robust)$color <- ifelse(igraph::E(g_robust)$sign == "positive",
                                         "#3498db", "#e74c3c")

    # 边宽度 = 稳定性
    igraph::E(g_robust)$width <- igraph::E(g_robust)$stability * 3

    par(mar = c(1, 1, 3, 1))
    plot(g_robust,
         layout = layout_robust,
         vertex.label = NA,
         vertex.color = "lightgray",
         main = sprintf("Robust Network (stability ≥ %.0f%%)\nNodes: %d | Edges: %d",
                       stability_threshold*100,
                       igraph::vcount(g_robust),
                       igraph::ecount(g_robust)))
    legend("bottomright",
           legend = c("Positive correlation", "Negative correlation"),
           col = c("#3498db", "#e74c3c"),
           lwd = 2, bty = "n", cex = 0.8)

  } else {
    cat("\n边数过多，跳过可视化\n")
  }
}
```

### 2.7.3 稳健网络Hub物种

```{r}
#| label: part2-robust-hub-species

if (igraph::ecount(g_robust) > 0) {
  # 计算稳健网络的中心性
  robust_degree <- igraph::degree(g_robust)
  robust_betweenness <- igraph::betweenness(g_robust, weights = NA)

  robust_hub_df <- data.frame(
    species = names(robust_degree),
    degree = robust_degree,
    betweenness = robust_betweenness
  ) %>%
    filter(degree > 0) %>%
    arrange(desc(degree))

  cat("\n====== 稳健网络Top 10 Hub物种 ======\n\n")
  print(head(robust_hub_df, 10))

  # 与原始网络Hub比较
  if (exists("hub_df")) {
    original_top10 <- head(hub_df$species, 10)
    robust_top10 <- head(robust_hub_df$species, 10)
    overlap <- length(base::intersect(original_top10, robust_top10))

    cat(sprintf("\n原始网络 vs 稳健网络 Top10 Hub重叠: %d/10 (%.0f%%)\n",
                overlap, overlap * 10))
  }

  write.csv(robust_hub_df,
            file = here::here("data", params$name, "06_robust_hub_species.csv"),
            row.names = FALSE)
}
```

## 2.8 Keystone Species识别 (Zi-Pi分析)

Zi-Pi分析通过模块内连接度(Zi)和参与系数(Pi)识别网络中的关键物种：

- **Zi (Within-module degree)**: 节点在其模块内的标准化连接度
- **Pi (Participation coefficient)**: 节点连接分布于不同模块的均匀程度

根据Guimerà & Amaral (2005)的分类标准：

| 类型 | Zi | Pi | 生态意义 |
|------|----|----|----------|
| Module hub | > 2.5 | ≤ 0.62 | 模块内关键物种 |
| Network hub | > 2.5 | > 0.62 | 连接不同模块的超级连接者 |
| Connector | ≤ 2.5 | > 0.62 | 跨模块连接者 |
| Peripheral | ≤ 2.5 | ≤ 0.62 | 边缘物种 |

**Keystone species** = Module hubs + Network hubs

```{r}
#| label: part2-zi-pi-functions

# 定义Zi-Pi计算函数
calculate_zi <- function(graph, membership) {
  # Within-module degree z-score
  nodes <- igraph::V(graph)$name
  zi_values <- numeric(length(nodes))
  names(zi_values) <- nodes

  for (i in seq_along(nodes)) {
    node <- nodes[i]
    node_module <- membership[node]

    # 获取同模块节点
    module_nodes <- names(membership)[membership == node_module]

    # 计算模块内度
    neighbors <- names(igraph::neighbors(graph, node))
    ki <- sum(neighbors %in% module_nodes)

    # 计算模块内平均度和标准差
    module_degrees <- sapply(module_nodes, function(n) {
      n_neighbors <- names(igraph::neighbors(graph, n))
      sum(n_neighbors %in% module_nodes)
    })

    mean_k <- mean(module_degrees)
    sd_k <- sd(module_degrees)

    # 计算Zi (处理 NA 值，当模块只有1个节点时 sd 返回 NA)
    if (!is.na(sd_k) && sd_k > 0) {
      zi_values[i] <- (ki - mean_k) / sd_k
    } else {
      zi_values[i] <- 0
    }
  }

  return(zi_values)
}

calculate_pi <- function(graph, membership) {
  # Participation coefficient
  nodes <- igraph::V(graph)$name
  pi_values <- numeric(length(nodes))
  names(pi_values) <- nodes

  modules <- unique(membership)

  for (i in seq_along(nodes)) {
    node <- nodes[i]
    ki <- igraph::degree(graph, node)

    if (ki == 0) {
      pi_values[i] <- 0
      next
    }

    neighbors <- names(igraph::neighbors(graph, node))

    # 计算到各模块的连接比例
    sum_squared <- 0
    for (m in modules) {
      module_nodes <- names(membership)[membership == m]
      kis <- sum(neighbors %in% module_nodes)
      sum_squared <- sum_squared + (kis / ki)^2
    }

    pi_values[i] <- 1 - sum_squared
  }

  return(pi_values)
}

# 节点分类函数
classify_nodes <- function(zi, pi, zi_threshold = 2.5, pi_threshold = 0.62) {
  classification <- character(length(zi))

  for (i in seq_along(zi)) {
    if (zi[i] > zi_threshold && pi[i] <= pi_threshold) {
      classification[i] <- "Module hub"
    } else if (zi[i] > zi_threshold && pi[i] > pi_threshold) {
      classification[i] <- "Network hub"
    } else if (zi[i] <= zi_threshold && pi[i] > pi_threshold) {
      classification[i] <- "Connector"
    } else {
      classification[i] <- "Peripheral"
    }
  }

  return(classification)
}
```

### 2.8.1 全样本网络Zi-Pi分析

```{r}
#| label: part2-zi-pi-analysis
#| fig-width: 9
#| fig-height: 7

if (igraph::ecount(g_all) > 0) {
  cat("====== Zi-Pi分析 ======\n\n")

  # 模块检测 (使用 weights=NA 因为 cluster_louvain 不支持负权重)
  communities <- igraph::cluster_louvain(g_all, weights = NA)
  membership <- igraph::membership(communities)
  names(membership) <- igraph::V(g_all)$name

  cat("检测到模块数:", max(membership), "\n")
  cat("模块度:", round(igraph::modularity(communities), 4), "\n\n")

  # 计算Zi和Pi
  zi_values <- calculate_zi(g_all, membership)
  pi_values <- calculate_pi(g_all, membership)

  # 分类节点
  node_class <- classify_nodes(zi_values, pi_values)

  # 构建结果数据框
  zi_pi_df <- data.frame(
    species = names(zi_values),
    module = as.integer(membership[names(zi_values)]),
    degree = igraph::degree(g_all)[names(zi_values)],
    Zi = zi_values,
    Pi = pi_values,
    role = node_class,
    stringsAsFactors = FALSE
  ) %>%
    arrange(desc(Zi))

  # 统计各类节点数量
  role_counts <- table(zi_pi_df$role)
  cat("节点角色分布:\n")
  print(role_counts)

  # 识别keystone species
  keystone_species <- zi_pi_df %>%
    filter(role %in% c("Module hub", "Network hub"))

  cat(sprintf("\n====== Keystone Species (n=%d) ======\n\n", nrow(keystone_species)))
  if (nrow(keystone_species) > 0) {
    print(keystone_species)
  } else {
    cat("未检测到严格定义的keystone species (Zi > 2.5)\n")
    cat("显示Top 10高Zi值物种:\n\n")
    print(head(zi_pi_df, 10))
  }

  # 保存结果
  write.csv(zi_pi_df,
            file = here::here("data", params$name, "07_zi_pi_analysis.csv"),
            row.names = FALSE)
}
```

### 2.8.2 Zi-Pi散点图

```{r}
#| label: part2-zi-pi-plot
#| fig-width: 10
#| fig-height: 8

if (exists("zi_pi_df") && nrow(zi_pi_df) > 0) {
  # 定义颜色
  role_colors <- c(
    "Module hub" = "#e74c3c",
    "Network hub" = "#9b59b6",
    "Connector" = "#3498db",
    "Peripheral" = "#95a5a6"
  )

  # 确保role是因子并设置顺序
  zi_pi_df$role <- factor(zi_pi_df$role,
                          levels = c("Network hub", "Module hub", "Connector", "Peripheral"))

  # 标记要显示名称的物种 (keystone + top connectors)
  top_species_label <- zi_pi_df %>%
    group_by(role) %>%
    slice_max(Zi, n = 3) %>%
    ungroup() %>%
    filter(role != "Peripheral") %>%
    pull(species)

  zi_pi_df$label <- ifelse(zi_pi_df$species %in% top_species_label,
                            gsub("_", " ", zi_pi_df$species), "")

  # 绘制Zi-Pi图
  p_zi_pi <- ggplot(zi_pi_df, aes(x = Pi, y = Zi, color = role, size = degree)) +
    # 添加分类阈值线
    geom_hline(yintercept = 2.5, linetype = "dashed", color = "gray40", linewidth = 0.8) +
    geom_vline(xintercept = 0.62, linetype = "dashed", color = "gray40", linewidth = 0.8) +
    # 添加区域标签
    annotate("text", x = 0.31, y = max(zi_pi_df$Zi) * 0.95,
             label = "Module\nhubs", color = "#e74c3c", fontface = "bold", size = 3.5) +
    annotate("text", x = 0.81, y = max(zi_pi_df$Zi) * 0.95,
             label = "Network\nhubs", color = "#9b59b6", fontface = "bold", size = 3.5) +
    annotate("text", x = 0.81, y = min(zi_pi_df$Zi) + 0.5,
             label = "Connectors", color = "#3498db", fontface = "bold", size = 3.5) +
    annotate("text", x = 0.31, y = min(zi_pi_df$Zi) + 0.5,
             label = "Peripherals", color = "#95a5a6", fontface = "bold", size = 3.5) +
    # 绑制点
    geom_point(alpha = 0.7) +
    # 添加物种标签
    ggrepel::geom_text_repel(
      aes(label = label),
      size = 2.5,
      max.overlaps = 15,
      segment.color = "gray60",
      segment.size = 0.3
    ) +
    scale_color_manual(values = role_colors, name = "Node Role") +
    scale_size_continuous(range = c(2, 10), name = "Degree") +
    labs(
      title = "Zi-Pi Plot: Keystone Species Identification",
      subtitle = sprintf("Modules: %d | Keystone species: %d (Module hub: %d, Network hub: %d)",
                        max(membership),
                        sum(role_counts[c("Module hub", "Network hub")], na.rm = TRUE),
                        role_counts["Module hub"] %||% 0,
                        role_counts["Network hub"] %||% 0),
      x = "Participation Coefficient (Pi)",
      y = "Within-module Degree (Zi)"
    ) +
    theme_bw(base_size = 12) +
    theme(
      plot.title = element_text(face = "bold", size = 14),
      plot.subtitle = element_text(size = 11, color = "gray30"),
      legend.position = "right",
      panel.grid.minor = element_blank()
    )

  print(p_zi_pi)

  ggsave(here::here("data", params$name, "08_zi_pi_plot.png"),
         plot = p_zi_pi, width = 10, height = 8, dpi = 300)
}
```
### 2.8.3 分组Zi-Pi比较

```{r}
#| label: part2-zi-pi-by-group
#| fig-width: 12
#| fig-height: 6

# 对两个处理组分别进行Zi-Pi分析
zi_pi_by_group <- list()

for (grp in groups_to_compare) {
  grp_samples <- rownames(metadata)[metadata$treatment_group == grp]

  if (length(grp_samples) < 3) next

  grp_relab <- bacteria_relab[, grp_samples]
  row_sds <- apply(grp_relab, 1, sd)
  grp_relab_filtered <- grp_relab[row_sds > 0, , drop = FALSE]

  max_species <- min(50, nrow(grp_relab_filtered))
  mean_abundance_grp <- rowMeans(grp_relab_filtered)
  top_species_grp <- names(sort(mean_abundance_grp, decreasing = TRUE))[1:max_species]
  grp_relab_top <- grp_relab_filtered[top_species_grp, , drop = FALSE]

  grp_cor <- cor(t(grp_relab_top), method = "spearman")
  grp_cor[is.na(grp_cor)] <- 0

  grp_adj <- abs(grp_cor) >= cor_threshold
  diag(grp_adj) <- FALSE

  g_grp <- igraph::graph_from_adjacency_matrix(grp_adj, mode = "undirected")

  if (igraph::ecount(g_grp) < 5) {
    cat(sprintf("%s: 边数不足，跳过Zi-Pi分析\n", grp))
    next
  }

  # 模块检测
  comm_grp <- igraph::cluster_louvain(g_grp)
  memb_grp <- igraph::membership(comm_grp)
  names(memb_grp) <- igraph::V(g_grp)$name

  # 计算Zi-Pi
  zi_grp <- calculate_zi(g_grp, memb_grp)
  pi_grp <- calculate_pi(g_grp, memb_grp)
  class_grp <- classify_nodes(zi_grp, pi_grp)

  zi_pi_by_group[[grp]] <- data.frame(
    species = names(zi_grp),
    group = grp,
    Zi = zi_grp,
    Pi = pi_grp,
    role = class_grp,
    stringsAsFactors = FALSE
  )
}

# 合并并可视化
if (length(zi_pi_by_group) == 2) {
  zi_pi_combined <- bind_rows(zi_pi_by_group)
  zi_pi_combined$group <- factor(zi_pi_combined$group,
                                  levels = c("ApcMUT_HpKO", "ApcMUT_HpWT"),
                                  labels = c("Control (HpKO)", "CagA+ (HpWT)"))
  zi_pi_combined$role <- factor(zi_pi_combined$role,
                                 levels = c("Network hub", "Module hub", "Connector", "Peripheral"))

  # 分组Zi-Pi图
  p_zi_pi_group <- ggplot(zi_pi_combined, aes(x = Pi, y = Zi, color = role)) +
    geom_hline(yintercept = 2.5, linetype = "dashed", color = "gray40") +
    geom_vline(xintercept = 0.62, linetype = "dashed", color = "gray40") +
    geom_point(alpha = 0.7, size = 3) +
    scale_color_manual(values = c(
      "Module hub" = "#e74c3c",
      "Network hub" = "#9b59b6",
      "Connector" = "#3498db",
      "Peripheral" = "#95a5a6"
    ), name = "Node Role") +
    facet_wrap(~group) +
    labs(
      title = "Zi-Pi Analysis by Treatment Group",
      subtitle = "Comparing network roles between Control and CagA+ groups",
      x = "Participation Coefficient (Pi)",
      y = "Within-module Degree (Zi)"
    ) +
    theme_bw(base_size = 12) +
    theme(
      plot.title = element_text(face = "bold"),
      strip.background = element_rect(fill = "gray90"),
      strip.text = element_text(face = "bold", size = 11)
    )

  print(p_zi_pi_group)

  ggsave(here::here("data", params$name, "09_zi_pi_by_group.png"),
         plot = p_zi_pi_group, width = 12, height = 6, dpi = 300)

  # 角色分布对比
  role_summary <- zi_pi_combined %>%
    group_by(group, role) %>%
    summarise(count = n(), .groups = "drop") %>%
    group_by(group) %>%
    mutate(proportion = count / sum(count))

  cat("\n====== 分组角色分布对比 ======\n\n")
  print(as.data.frame(role_summary))

  write.csv(zi_pi_combined,
            file = here::here("data", params$name, "10_zi_pi_by_group.csv"),
            row.names = FALSE)
}
```

## 2.9 SparCC组成型数据相关性 (可选)

**背景**：Spearman相关性在组成型数据（相对丰度）上存在偏差，因为各物种丰度总和恒为1，导致假性负相关。
SparCC (Sparse Correlations for Compositional data) 专门解决这一问题。

**方法**：使用`SpiecEasi`包实现SparCC，迭代估计真实相关性。

```{r}
#| label: part2-sparcc-check

# 检查SpiecEasi是否安装
sparcc_available <- requireNamespace("SpiecEasi", quietly = TRUE)

if (!sparcc_available) {
  cat("====== SparCC分析 ======\n\n")
  cat("SpiecEasi包未安装，跳过SparCC分析。\n")
  cat("安装方法:\n")
  cat("  # 从Bioconductor安装\n")
  cat("  BiocManager::install('SpiecEasi')\n")
  cat("\n或从GitHub安装:\n")
  cat("  devtools::install_github('zdk123/SpiecEasi')\n")
} else {
  cat("SpiecEasi包已安装，将进行SparCC分析。\n")
}
```

```{r}
#| label: part2-sparcc-analysis
#| eval: !expr sparcc_available
#| cache: true

if (sparcc_available) {
  library(SpiecEasi)

  cat("\n====== SparCC分析 ======\n\n")

  # 准备counts数据（SparCC需要整数counts）
  # 使用原始counts而非相对丰度
  bacteria_counts_filtered <- assay(tse_bacteria, "counts")

  # 过滤低丰度物种
  prevalence_counts <- rowSums(bacteria_counts_filtered > 0) / ncol(bacteria_counts_filtered)
  bacteria_counts_filtered <- bacteria_counts_filtered[prevalence_counts >= 0.2, ]

  # 取Top 50高丰度物种（SparCC计算密集）
  mean_counts <- rowMeans(bacteria_counts_filtered)
  top_species_sparcc <- names(sort(mean_counts, decreasing = TRUE))[1:min(50, length(mean_counts))]
  bacteria_counts_sparcc <- bacteria_counts_filtered[top_species_sparcc, ]

  cat("SparCC分析物种数:", nrow(bacteria_counts_sparcc), "\n")
  cat("样本数:", ncol(bacteria_counts_sparcc), "\n\n")

  # 运行SparCC（使用较少迭代以节省时间）
  cat("运行SparCC（这可能需要几分钟）...\n")

  sparcc_result <- tryCatch({
    SpiecEasi::sparcc(t(bacteria_counts_sparcc), iter = 20, inner_iter = 10)
  }, error = function(e) {
    cat("SparCC计算出错:", conditionMessage(e), "\n")
    NULL
  })

  if (!is.null(sparcc_result)) {
    sparcc_cor <- sparcc_result$Cor
    rownames(sparcc_cor) <- rownames(bacteria_counts_sparcc)
    colnames(sparcc_cor) <- rownames(bacteria_counts_sparcc)

    cat("SparCC相关矩阵计算完成\n")
    cat("相关系数范围:", round(min(sparcc_cor), 3), "到", round(max(sparcc_cor[sparcc_cor < 1]), 3), "\n")
  }
}
```

### 2.9.1 SparCC vs Spearman对比

```{r}
#| label: part2-sparcc-comparison
#| eval: !expr sparcc_available && exists("sparcc_cor")
#| fig-width: 12
#| fig-height: 5

if (exists("sparcc_cor") && !is.null(sparcc_cor)) {
  # 获取共同物种
  common_species <- base::intersect(rownames(sparcc_cor), rownames(cor_matrix))

  if (length(common_species) >= 10) {
    sparcc_sub <- sparcc_cor[common_species, common_species]
    spearman_sub <- cor_matrix[common_species, common_species]

    # 提取上三角相关系数
    sparcc_values <- sparcc_sub[upper.tri(sparcc_sub)]
    spearman_values <- spearman_sub[upper.tri(spearman_sub)]

    comparison_df <- data.frame(
      Spearman = spearman_values,
      SparCC = sparcc_values
    )

    # 相关性散点图
    p_scatter <- ggplot(comparison_df, aes(x = Spearman, y = SparCC)) +
      geom_point(alpha = 0.5, color = "steelblue") +
      geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
      geom_smooth(method = "lm", se = TRUE, color = "darkblue", linewidth = 0.8) +
      labs(
        title = "SparCC vs Spearman Correlation",
        subtitle = sprintf("Pearson r = %.3f | %d species pairs",
                          cor(sparcc_values, spearman_values),
                          length(sparcc_values)),
        x = "Spearman Correlation",
        y = "SparCC Correlation"
      ) +
      theme_bw(base_size = 12) +
      theme(plot.title = element_text(face = "bold"))

    # 差异分布
    comparison_df$difference <- comparison_df$SparCC - comparison_df$Spearman

    p_diff <- ggplot(comparison_df, aes(x = difference)) +
      geom_histogram(binwidth = 0.05, fill = "steelblue", color = "white", alpha = 0.8) +
      geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
      geom_vline(xintercept = mean(comparison_df$difference), color = "darkblue", linewidth = 1) +
      annotate("text", x = mean(comparison_df$difference), y = Inf, vjust = 2,
               label = sprintf("Mean diff: %.3f", mean(comparison_df$difference)),
               color = "darkblue", fontface = "bold") +
      labs(
        title = "SparCC - Spearman Difference",
        subtitle = "Positive = SparCC shows stronger correlation",
        x = "Difference (SparCC - Spearman)",
        y = "Count"
      ) +
      theme_bw(base_size = 12) +
      theme(plot.title = element_text(face = "bold"))

    print(p_scatter + p_diff)

    ggsave(here::here("data", params$name, "11_sparcc_vs_spearman.png"),
           plot = p_scatter + p_diff, width = 12, height = 5, dpi = 300)

    # 统计总结
    cat("\n====== SparCC vs Spearman 对比 ======\n\n")
    cat("共同物种数:", length(common_species), "\n")
    cat("物种对数:", length(sparcc_values), "\n")
    cat("Spearman-SparCC相关性:", round(cor(sparcc_values, spearman_values), 4), "\n")
    cat("平均差异 (SparCC - Spearman):", round(mean(comparison_df$difference), 4), "\n")
    cat("差异标准差:", round(sd(comparison_df$difference), 4), "\n")

    # 分类比较
    spearman_strong <- sum(abs(spearman_values) >= 0.7)
    sparcc_strong <- sum(abs(sparcc_values) >= 0.7)
    cat("\n强相关 (|r| ≥ 0.7):\n")
    cat("  Spearman:", spearman_strong, "\n")
    cat("  SparCC:", sparcc_strong, "\n")
  }
}
```

### 2.9.2 SparCC网络构建

```{r}
#| label: part2-sparcc-network
#| eval: !expr sparcc_available && exists("sparcc_cor")
#| fig-width: 9
#| fig-height: 8

if (exists("sparcc_cor") && !is.null(sparcc_cor)) {
  # 使用相同阈值构建SparCC网络
  sparcc_threshold <- 0.5  # SparCC通常使用较低阈值

  sparcc_adj <- abs(sparcc_cor) >= sparcc_threshold
  diag(sparcc_adj) <- FALSE

  g_sparcc <- igraph::graph_from_adjacency_matrix(sparcc_adj, mode = "undirected")

  # 添加边权重
  if (igraph::ecount(g_sparcc) > 0) {
    edge_list_sp <- igraph::as_edgelist(g_sparcc)
    edge_weights_sp <- sapply(1:nrow(edge_list_sp), function(i) {
      sparcc_cor[edge_list_sp[i,1], edge_list_sp[i,2]]
    })
    igraph::E(g_sparcc)$weight <- edge_weights_sp
    igraph::E(g_sparcc)$sign <- ifelse(edge_weights_sp > 0, "positive", "negative")
  }

  cat("\n====== SparCC网络统计 ======\n\n")
  cat("相关性阈值:", sparcc_threshold, "\n")
  cat("节点数:", igraph::vcount(g_sparcc), "\n")
  cat("边数:", igraph::ecount(g_sparcc), "\n")

  if (igraph::ecount(g_sparcc) > 0) {
    pos_edges <- sum(igraph::E(g_sparcc)$sign == "positive")
    neg_edges <- sum(igraph::E(g_sparcc)$sign == "negative")
    cat("正相关边:", pos_edges, sprintf("(%.1f%%)", 100*pos_edges/igraph::ecount(g_sparcc)), "\n")
    cat("负相关边:", neg_edges, sprintf("(%.1f%%)", 100*neg_edges/igraph::ecount(g_sparcc)), "\n")

    # 与Spearman网络比较
    cat("\n与Spearman网络对比:\n")
    cat("  Spearman网络边数:", igraph::ecount(g_all), "\n")
    cat("  SparCC网络边数:", igraph::ecount(g_sparcc), "\n")

    # 可视化
    if (igraph::ecount(g_sparcc) < 300) {
      set.seed(42)
      layout_sparcc <- igraph::layout_with_fr(g_sparcc)

      igraph::V(g_sparcc)$size <- igraph::degree(g_sparcc) + 3
      igraph::E(g_sparcc)$color <- ifelse(igraph::E(g_sparcc)$sign == "positive",
                                           "#3498db", "#e74c3c")

      par(mar = c(1, 1, 3, 1))
      plot(g_sparcc,
           layout = layout_sparcc,
           vertex.label = NA,
           vertex.color = "lightgray",
           edge.width = abs(igraph::E(g_sparcc)$weight) * 2,
           main = sprintf("SparCC Network (threshold ≥ %.2f)\nNodes: %d | Edges: %d | Blue=Positive, Red=Negative",
                         sparcc_threshold, igraph::vcount(g_sparcc), igraph::ecount(g_sparcc)))
    }

    # 保存SparCC相关矩阵
    write.csv(as.data.frame(sparcc_cor),
              file = here::here("data", params$name, "12_sparcc_correlation_matrix.csv"))

    # 保存网络统计
    sparcc_stats <- data.frame(
      method = c("Spearman", "SparCC"),
      threshold = c(cor_threshold, sparcc_threshold),
      n_nodes = c(igraph::vcount(g_all), igraph::vcount(g_sparcc)),
      n_edges = c(igraph::ecount(g_all), igraph::ecount(g_sparcc)),
      density = c(igraph::edge_density(g_all), igraph::edge_density(g_sparcc))
    )

    write.csv(sparcc_stats,
              file = here::here("data", params$name, "13_spearman_vs_sparcc_stats.csv"),
              row.names = FALSE)

    cat("\nSparCC结果已保存\n")
  }
}
```

# Part 3: 细菌-噬菌体跨域网络 {#sec-part3}

```{r}
#| label: part3-cross-domain
#| eval: !expr has_phage

if (has_phage) {
  cat("\n====== 细菌-噬菌体跨域网络分析 ======\n\n")

  # 获取共同样本的数据
  bacteria_common <- bacteria_relab[, common_samples]
  phage_counts <- assay(tse_phage[, common_samples], "counts")

  # 过滤噬菌体
  phage_prev <- rowSums(phage_counts > 0) / ncol(phage_counts)
  phage_filtered <- phage_counts[phage_prev >= 0.2, ]
  phage_relab <- sweep(phage_filtered, 2, colSums(phage_filtered) + 1, "/")

  cat("过滤后细菌数:", nrow(bacteria_common), "\n")
  cat("过滤后噬菌体数:", nrow(phage_filtered), "\n")

  # 计算细菌-噬菌体相关性
  cross_cor <- cor(t(bacteria_common), t(phage_relab), method = "spearman")

  cat("跨域相关矩阵维度:", dim(cross_cor), "\n")

  # 识别显著关联
  cross_threshold <- 0.5
  sig_pairs <- which(abs(cross_cor) >= cross_threshold, arr.ind = TRUE)

  if (nrow(sig_pairs) > 0) {
    cross_pairs_df <- data.frame(
      bacteria = rownames(cross_cor)[sig_pairs[,1]],
      phage = colnames(cross_cor)[sig_pairs[,2]],
      correlation = sapply(1:nrow(sig_pairs), function(i) {
        cross_cor[sig_pairs[i,1], sig_pairs[i,2]]
      })
    ) %>%
      arrange(desc(abs(correlation)))

    cat("\nTop 20 细菌-噬菌体关联:\n\n")
    print(head(cross_pairs_df, 20))

    write.csv(cross_pairs_df,
              file = here::here("data", params$name, "14_bacteria_phage_associations.csv"),
              row.names = FALSE)
  } else {
    cat("未发现显著的细菌-噬菌体关联 (阈值:", cross_threshold, ")\n")
  }
}
```

# Part 4: 细菌-噬菌体网络结构对比 {#sec-part4}

## 4.1 构建分组网络

```{r}
#| label: part4-bacteria-phage-network
#| fig-width: 9
#| fig-height: 8
#| eval: !expr has_phage

if (has_phage) {
  cat("\n====== Part 4: 细菌-噬菌体网络对比 ======\n")

  # 定义网络构建函数
  build_network_for_group <- function(tse, samples, top_n = 50, cor_threshold = 0.6) {
    counts <- assay(tse, "counts")[, samples, drop = FALSE]
    grp_relab <- sweep(counts, 2, colSums(counts) + 1, "/")

    row_sds <- apply(grp_relab, 1, sd)
    grp_relab <- grp_relab[row_sds > 0, , drop = FALSE]

    n_species <- min(top_n, nrow(grp_relab))
    mean_abund <- rowMeans(grp_relab)
    top_species_net <- names(sort(mean_abund, decreasing = TRUE))[1:n_species]
    grp_relab <- grp_relab[top_species_net, , drop = FALSE]

    cor_mat <- cor(t(grp_relab), method = "spearman")
    cor_mat[is.na(cor_mat)] <- 0

    adj_mat <- abs(cor_mat) >= cor_threshold
    diag(adj_mat) <- FALSE

    g <- igraph::graph_from_adjacency_matrix(adj_mat, mode = "undirected")

    if (igraph::ecount(g) > 0) {
      comm <- igraph::cluster_louvain(g)
      mod <- igraph::modularity(comm)
    } else {
      mod <- 0
    }

    return(list(
      n_nodes = igraph::vcount(g),
      n_edges = igraph::ecount(g),
      modularity = mod,
      graph = g
    ))
  }

  # 获取样本分组
  phage_meta <- as.data.frame(colData(tse_phage))
  phage_hpko <- rownames(phage_meta)[phage_meta$treatment_group == "ApcMUT_HpKO"]
  phage_hpwt <- rownames(phage_meta)[phage_meta$treatment_group == "ApcMUT_HpWT"]

  # 构建网络
  cat("构建细菌网络...\n")
  bact_net_hpko <- build_network_for_group(tse_bacteria,
                                            rownames(metadata)[metadata$treatment_group == "ApcMUT_HpKO"])
  bact_net_hpwt <- build_network_for_group(tse_bacteria,
                                            rownames(metadata)[metadata$treatment_group == "ApcMUT_HpWT"])

  cat("构建噬菌体网络...\n")
  phage_net_hpko <- build_network_for_group(tse_phage, phage_hpko)
  phage_net_hpwt <- build_network_for_group(tse_phage, phage_hpwt)

  # 汇总统计
  bact_phage_stats_df <- data.frame(
    data_type = c("Bacteria", "Bacteria", "Phage", "Phage"),
    group = c("Control (HpKO)", "CagA+ (HpWT)", "Control (HpKO)", "CagA+ (HpWT)"),
    group_short = c("Control", "CagA+", "Control", "CagA+"),
    nodes = c(bact_net_hpko$n_nodes, bact_net_hpwt$n_nodes,
              phage_net_hpko$n_nodes, phage_net_hpwt$n_nodes),
    edges = c(bact_net_hpko$n_edges, bact_net_hpwt$n_edges,
              phage_net_hpko$n_edges, phage_net_hpwt$n_edges),
    modularity = c(bact_net_hpko$modularity, bact_net_hpwt$modularity,
                   phage_net_hpko$modularity, phage_net_hpwt$modularity)
  )

  print(bact_phage_stats_df)

  # 计算变化百分比
  bact_mod_change <- (bact_net_hpwt$modularity - bact_net_hpko$modularity) /
                     bact_net_hpko$modularity * 100

  phage_mod_change <- (phage_net_hpwt$modularity - phage_net_hpko$modularity) /
                      phage_net_hpko$modularity * 100

  cat("\n细菌网络模块度变化:", round(bact_mod_change, 1), "%\n")
  cat("噬菌体网络模块度变化:", round(phage_mod_change, 1), "%\n")

  write.csv(bact_phage_stats_df,
            file = here::here("data", params$name, "15_bacteria_phage_network_stats.csv"),
            row.names = FALSE)
}
```

## 4.2 模块度对比可视化

```{r}
#| label: part4-modularity-comparison
#| fig-width: 8
#| fig-height: 5
#| eval: !expr has_phage

if (has_phage) {
  bact_phage_stats_df$group_short <- factor(bact_phage_stats_df$group_short,
                                             levels = c("Control", "CagA+"))
  bact_phage_stats_df$data_type <- factor(bact_phage_stats_df$data_type,
                                           levels = c("Bacteria", "Phage"))

  p_modularity_comparison <- ggplot(bact_phage_stats_df,
                                     aes(x = group_short, y = modularity, fill = group_short)) +
    geom_col(width = 0.6, alpha = 0.85) +
    geom_text(aes(label = sprintf("%.3f", modularity)), vjust = -0.5, size = 4.5, fontface = "bold") +
    facet_wrap(~data_type) +
    scale_fill_manual(values = c("Control" = "#3498db", "CagA+" = "#e74c3c")) +
    scale_y_continuous(limits = c(0, max(bact_phage_stats_df$modularity) * 1.2)) +
    labs(
      title = "Network Modularity: Bacteria vs Phage",
      subtitle = sprintf("Both show change under CagA (Bacteria: %.0f%%, Phage: %.0f%%)",
                         bact_mod_change, phage_mod_change),
      x = NULL,
      y = "Modularity",
      fill = "Group"
    ) +
    theme_bw(base_size = 12) +
    theme(
      plot.title = element_text(face = "bold", size = 14),
      plot.subtitle = element_text(size = 11, color = "gray30"),
      legend.position = "none",
      strip.background = element_rect(fill = "gray90"),
      strip.text = element_text(face = "bold", size = 12)
    )

  print(p_modularity_comparison)

  ggsave(
    filename = here::here("data", params$name, "16_bacteria_phage_modularity_comparison.png"),
    plot = p_modularity_comparison,
    width = 8, height = 5, dpi = 300
  )
}
```

## 4.3 2x2 网络可视化

```{r}
#| label: part4-network-2x2
#| fig-width: 12
#| fig-height: 12
#| eval: !expr has_phage

if (has_phage) {
  get_colors <- function(n) {
    if (n <= 8) {
      return(c("#e74c3c", "#3498db", "#2ecc71", "#f39c12", "#9b59b6", "#1abc9c", "#e67e22", "#34495e")[1:n])
    } else {
      return(rainbow(n, s = 0.7, v = 0.8))
    }
  }

  png(here::here("data", params$name, "17_bacteria_phage_network_2x2.png"),
      width = 1600, height = 1600, res = 150)

  par(mfrow = c(2, 2), mar = c(1, 1, 4, 1))

  set.seed(42)

  # --- 细菌 Control ---
  g <- bact_net_hpko$graph
  if (igraph::ecount(g) > 0) {
    comm <- igraph::cluster_louvain(g)
    igraph::V(g)$community <- igraph::membership(comm)
    n_comm <- max(igraph::V(g)$community)
    colors <- get_colors(n_comm)[igraph::V(g)$community]
    igraph::V(g)$degree <- igraph::degree(g)
    layout_bact <- igraph::layout_with_fr(g)

    plot(g,
         layout = layout_bact,
         vertex.color = colors,
         vertex.size = 3 + sqrt(igraph::V(g)$degree) * 2,
         vertex.label = NA,
         edge.color = rgb(0.5, 0.5, 0.5, 0.3),
         edge.width = 0.5,
         main = sprintf("Bacteria - Control (HpKO)\nEdges: %d | Modularity: %.3f",
                        bact_net_hpko$n_edges, bact_net_hpko$modularity))
  }

  # --- 细菌 CagA+ ---
  g <- bact_net_hpwt$graph
  if (igraph::ecount(g) > 0) {
    comm <- igraph::cluster_louvain(g)
    igraph::V(g)$community <- igraph::membership(comm)
    n_comm <- max(igraph::V(g)$community)
    colors <- get_colors(n_comm)[igraph::V(g)$community]
    igraph::V(g)$degree <- igraph::degree(g)

    plot(g,
         layout = layout_bact,
         vertex.color = colors,
         vertex.size = 3 + sqrt(igraph::V(g)$degree) * 2,
         vertex.label = NA,
         edge.color = rgb(0.5, 0.5, 0.5, 0.3),
         edge.width = 0.5,
         main = sprintf("Bacteria - CagA+ (HpWT)\nEdges: %d | Modularity: %.3f",
                        bact_net_hpwt$n_edges, bact_net_hpwt$modularity))
  }

  set.seed(42)

  # --- 噬菌体 Control ---
  g <- phage_net_hpko$graph
  if (igraph::ecount(g) > 0) {
    comm <- igraph::cluster_louvain(g)
    igraph::V(g)$community <- igraph::membership(comm)
    n_comm <- max(igraph::V(g)$community)
    colors <- get_colors(n_comm)[igraph::V(g)$community]
    igraph::V(g)$degree <- igraph::degree(g)
    layout_phage <- igraph::layout_with_fr(g)

    plot(g,
         layout = layout_phage,
         vertex.color = colors,
         vertex.size = 3 + sqrt(igraph::V(g)$degree) * 2,
         vertex.label = NA,
         edge.color = rgb(0.5, 0.5, 0.5, 0.3),
         edge.width = 0.5,
         main = sprintf("Phage - Control (HpKO)\nEdges: %d | Modularity: %.3f",
                        phage_net_hpko$n_edges, phage_net_hpko$modularity))
  }

  # --- 噬菌体 CagA+ ---
  g <- phage_net_hpwt$graph
  if (igraph::ecount(g) > 0) {
    comm <- igraph::cluster_louvain(g)
    igraph::V(g)$community <- igraph::membership(comm)
    n_comm <- max(igraph::V(g)$community)
    colors <- get_colors(n_comm)[igraph::V(g)$community]
    igraph::V(g)$degree <- igraph::degree(g)

    plot(g,
         layout = layout_phage,
         vertex.color = colors,
         vertex.size = 3 + sqrt(igraph::V(g)$degree) * 2,
         vertex.label = NA,
         edge.color = rgb(0.5, 0.5, 0.5, 0.3),
         edge.width = 0.5,
         main = sprintf("Phage - CagA+ (HpWT)\nEdges: %d | Modularity: %.3f",
                        phage_net_hpwt$n_edges, phage_net_hpwt$modularity))
  }

  dev.off()

  cat("2x2 网络对比图已保存: 17_bacteria_phage_network_2x2.png\n")
}
```

# Part 5: 结果汇总 {#sec-part5}

## 5.1 关键发现

```{r}
#| label: part5-conclusions
#| results: asis

cat("\n## 细菌网络\n\n")
if (exists("g_all") && igraph::ecount(g_all) > 0) {
  cat(sprintf("- 全样本网络: %d节点, %d边\n", igraph::vcount(g_all), igraph::ecount(g_all)))
  pos_edges <- sum(igraph::E(g_all)$sign == "positive", na.rm = TRUE)
  neg_edges <- sum(igraph::E(g_all)$sign == "negative", na.rm = TRUE)
  cat(sprintf("- 正相关边: %d (%.1f%%), 负相关边: %d (%.1f%%)\n",
              pos_edges, 100*pos_edges/igraph::ecount(g_all),
              neg_edges, 100*neg_edges/igraph::ecount(g_all)))
}

if (exists("hub_df") && nrow(hub_df) > 0) {
  cat("\n## Hub物种 (Top 5)\n\n")
  for (i in 1:min(5, nrow(hub_df))) {
    cat(sprintf("%d. %s (度=%d)\n", i, hub_df$species[i], hub_df$degree[i]))
  }
}

if (exists("g_robust") && igraph::ecount(g_robust) > 0) {
  cat("\n## Bootstrap稳健网络\n\n")
  cat(sprintf("- 稳定性阈值: %.0f%%\n", stability_threshold * 100))
  cat(sprintf("- 稳健边数: %d (原始边数: %d)\n", igraph::ecount(g_robust), igraph::ecount(g_all)))
  cat(sprintf("- 边保留率: %.1f%%\n", 100 * igraph::ecount(g_robust) / max(igraph::ecount(g_all), 1)))
}

if (exists("zi_pi_df") && nrow(zi_pi_df) > 0) {
  cat("\n## Keystone Species (Zi-Pi分析)\n\n")
  role_counts <- table(zi_pi_df$role)
  cat(sprintf("- Module hubs: %d\n", role_counts["Module hub"] %||% 0))
  cat(sprintf("- Network hubs: %d\n", role_counts["Network hub"] %||% 0))
  cat(sprintf("- Connectors: %d\n", role_counts["Connector"] %||% 0))
  cat(sprintf("- Peripherals: %d\n", role_counts["Peripheral"] %||% 0))
}

if (exists("sparcc_available") && sparcc_available && exists("g_sparcc")) {
  cat("\n## SparCC组成型数据网络\n\n")
  cat(sprintf("- SparCC网络边数: %d\n", igraph::ecount(g_sparcc)))
  cat(sprintf("- Spearman网络边数: %d\n", igraph::ecount(g_all)))
  cat("- 方法改进: 校正组成型数据假性负相关\n")
}

if (exists("network_stats_df") && nrow(network_stats_df) >= 2) {
  cat("\n## 网络拓扑比较: CagA效应\n\n")

  if ("ApcMUT_HpWT" %in% network_stats_df$group && "ApcMUT_HpKO" %in% network_stats_df$group) {
    hpwt <- network_stats_df[network_stats_df$group == "ApcMUT_HpWT", ]
    hpko <- network_stats_df[network_stats_df$group == "ApcMUT_HpKO", ]

    cat("| 指标 | HpKO (对照) | HpWT (CagA+) | 变化 |\n")
    cat("|------|-------------|--------------|------|\n")
    cat(sprintf("| 边数 | %d | %d | %+d |\n",
                hpko$n_edges, hpwt$n_edges, hpwt$n_edges - hpko$n_edges))
    cat(sprintf("| 密度 | %.4f | %.4f | %+.4f |\n",
                hpko$density, hpwt$density, hpwt$density - hpko$density))
    cat(sprintf("| 模块度 | %.4f | %.4f | %+.4f |\n",
                hpko$modularity, hpwt$modularity,
                hpwt$modularity - hpko$modularity))
  }
}

cat("\n## 后续分析建议\n\n")
cat("1. 差异网络分析（NetShift）量化组间网络重构\n")
cat("2. 整合功能数据进行三方网络分析\n")
cat("3. 网络稳健性分析（节点移除模拟）\n")
```

## 5.2 输出文件列表

```{r}
#| label: part5-output-files

cat("\n分析结果已保存:\n")
cat("  - 01_bacteria_network_stats.csv\n")
cat("  - 02_network_comparison.png\n")
cat("  - 03_network_stats_barplot.png\n")
cat("  - 04_bacteria_hub_species.csv\n")
cat("  - 05_edge_stability_distribution.png\n")
cat("  - 06_robust_hub_species.csv\n")
cat("  - 07_zi_pi_analysis.csv\n")
cat("  - 08_zi_pi_plot.png\n")
cat("  - 09_zi_pi_by_group.png\n")
cat("  - 10_zi_pi_by_group.csv\n")
if (sparcc_available && exists("sparcc_cor")) {
  cat("  - 11_sparcc_vs_spearman.png\n")
  cat("  - 12_sparcc_correlation_matrix.csv\n")
  cat("  - 13_spearman_vs_sparcc_stats.csv\n")
}
if (has_phage) {
  cat("  - 14_bacteria_phage_associations.csv\n")
  cat("  - 15_bacteria_phage_network_stats.csv\n")
  cat("  - 16_bacteria_phage_modularity_comparison.png\n")
  cat("  - 17_bacteria_phage_network_2x2.png\n")
}
```

---

## Files written

These files have been written to the target directory, `r paste0("data/", params$name)`:

```{r}
#| label: list-files-target
#| include: false
projthis::proj_dir_info(path_target(), tz = "CET")
```

```{r}
#| label: session-info

cat("\n【分析环境信息】\n")
cat("R版本:", R.version.string, "\n")
cat("分析日期:", format(Sys.time(), "%Y-%m-%d %H:%M:%S"), "\n")
```
