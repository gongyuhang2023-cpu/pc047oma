---
title: "03b_virome_function_integration"
title-block-banner: true
author: Gong Yuhang
date: "2026-01-10"
toc: true
toc-depth: 4
number-sections: true
code-fold: true
code-line-numbers: true
code-tools: true
format:
  html:
    embed-resources: true
    smooth-scroll: true
    page-layout: full
    theme: cosmo
reference-location: section
citation-location: document
params:
  name: "03b_virome_function_integration"
---

**Updated: `r format(Sys.time(), '%Y-%m-%d %H:%M:%S', tz = 'CET')` CET.**

本文档是项目 pc047 (vCagAepitope) 的 **病毒组-功能整合分析** 模块。

**分析目的**：
整合 03 分析（SingleM/Lyrebird）和 02 分析（HUMAnN功能）的结果，探索：

1. **噬菌体-功能关联**：噬菌体OTU丰度与KO/Pathway丰度的相关性
2. **三角互作网络**：细菌-噬菌体-功能的联合分析

**科学意义**：
噬菌体通过裂解/溶原影响细菌群落，可能间接调控菌群的代谢功能。这类分析在肿瘤微生物组研究中较为少见。

```{r}
#| label: params
#| eval: !expr interactive()
#| include: false
params = list(name = "03b_virome_function_integration")
```

```{r}
#| label: setup
#| message: false
#| include: false
#| warning: false
wd <- "analyses"
if (basename(getwd()) != wd) {
  setwd(here::here(wd))
}
here::i_am(paste0(params$name, ".qmd"), uuid = "c465c8e1-bc4f-47fa-8e95-7b0bcfe53436")
projthis::proj_create_dir_target(params$name, clean = FALSE)
path_target <- projthis::proj_path_target(params$name)
path_source <- projthis::proj_path_source(params$name)
path_raw <- path_source("00-raw")
path_resource <- here::here(path_raw, "d00-resource")
path_data <- here::here(path_raw, paste0("d", params$name))
dir.create(path_raw, recursive = TRUE, showWarnings = FALSE)
dir.create(path_data, recursive = TRUE, showWarnings = FALSE)
dir.create(path_resource, recursive = TRUE, showWarnings = FALSE)
```

```{r}
#| label: packages
#| message: false
suppressPackageStartupMessages({
  library(here)
  library(conflicted)
  library(tidyverse)
  library(data.table)
  library(mia)
  library(TreeSummarizedExperiment)
  library(patchwork)
  library(ggplot2)
  library(pheatmap)
  library(vegan)
  library(igraph)
  library(ggraph)
  devtools::load_all()
})

# 解决命名空间冲突
conflicts_prefer(base::setdiff)
conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::select)
conflicts_prefer(dplyr::lag)
conflicts_prefer(dplyr::first)
conflicts_prefer(dplyr::left_join)
conflicts_prefer(base::intersect)

set.seed(20261)
```

# Part 1: 数据导入

从 02 和 03 分析的产出读取预处理好的数据。

```{r}
#| label: load-data

cat("=== 数据导入 ===\n\n")

# ------------------------------------------------------------------------------
# 从 02 分析导入功能数据
# ------------------------------------------------------------------------------
tse_ko <- readRDS(here::here("data", "02_functional_profiling", "tse_ko_corepair.rds"))
tse_pathway <- readRDS(here::here("data", "02_functional_profiling", "tse_humann_pathway_corepair.rds"))

cat("02 分析数据:\n")
cat("  KO TSE: ", ncol(tse_ko), " 样本, ", nrow(tse_ko), " KOs\n")
cat("  Pathway TSE: ", ncol(tse_pathway), " 样本, ", nrow(tse_pathway), " Pathways\n")

# ------------------------------------------------------------------------------
# 从 03 分析导入噬菌体和细菌数据
# ------------------------------------------------------------------------------
tse_lyrebird <- readRDS(here::here("data", "03_singlem_diversity_analysis", "tse_lyrebird_corepair.rds"))
tse_singlem <- readRDS(here::here("data", "03_singlem_diversity_analysis", "tse_singlem_corepair.rds"))

cat("\n03 分析数据:\n")
cat("  Lyrebird (噬菌体) TSE: ", ncol(tse_lyrebird), " 样本, ", nrow(tse_lyrebird), " OTUs\n")
cat("  SingleM (细菌) TSE: ", ncol(tse_singlem), " 样本, ", nrow(tse_singlem), " OTUs\n")

# ------------------------------------------------------------------------------
# 找到共同样本
# ------------------------------------------------------------------------------
common_samples <- Reduce(intersect, list(
  colnames(tse_ko),
  colnames(tse_pathway),
  colnames(tse_lyrebird),
  colnames(tse_singlem)
))

cat("\n共同样本数: ", length(common_samples), "\n")
cat("样本列表: ", paste(common_samples, collapse = ", "), "\n")
```

```{r}
#| label: subset-common-samples

# 子集化到共同样本
tse_ko <- tse_ko[, common_samples]
tse_pathway <- tse_pathway[, common_samples]
tse_lyrebird <- tse_lyrebird[, common_samples]
tse_singlem <- tse_singlem[, common_samples]

# 获取处理组信息
treatment_groups <- colData(tse_ko)$treatment_group
cat("\n处理组分布:\n")
print(table(treatment_groups))
```

# Part 2: 噬菌体-KO 关联分析 (方案A)

计算噬菌体OTU丰度与KO丰度的Spearman相关性，类似于02分析中的物种-KO关联。

## 2.1 提取丰度矩阵

```{r}
#| label: extract-abundance-matrices

# ------------------------------------------------------------------------------
# 提取噬菌体丰度矩阵
# ------------------------------------------------------------------------------
# 使用相对丰度
if ("relabundance" %in% assayNames(tse_lyrebird)) {
  phage_abundance <- as.matrix(assay(tse_lyrebird, "relabundance"))
} else {
  # 如果没有relabundance，计算相对丰度
  phage_counts <- as.matrix(assay(tse_lyrebird, "counts"))
  phage_abundance <- sweep(phage_counts, 2, colSums(phage_counts), "/")
}

# 过滤低丰度噬菌体（至少在20%样本中存在）
phage_prevalence <- rowSums(phage_abundance > 0) / ncol(phage_abundance)
phage_abundant <- phage_prevalence >= 0.2
phage_abundance_filtered <- phage_abundance[phage_abundant, ]

cat("噬菌体过滤:\n")
cat("  原始 OTU 数:", nrow(phage_abundance), "\n")
cat("  过滤后 OTU 数 (prevalence >= 20%):", nrow(phage_abundance_filtered), "\n")

# ------------------------------------------------------------------------------
# 提取 KO 丰度矩阵
# ------------------------------------------------------------------------------
if ("cpm" %in% assayNames(tse_ko)) {
  ko_abundance <- as.matrix(assay(tse_ko, "cpm"))
} else {
  ko_counts <- as.matrix(assay(tse_ko, "counts"))
  ko_abundance <- sweep(ko_counts, 2, colSums(ko_counts), "/") * 1e6
}

# 过滤低丰度 KO
ko_prevalence <- rowSums(ko_abundance > 0) / ncol(ko_abundance)
ko_abundant <- ko_prevalence >= 0.2
ko_abundance_filtered <- ko_abundance[ko_abundant, ]

cat("\nKO 过滤:\n")
cat("  原始 KO 数:", nrow(ko_abundance), "\n")
cat("  过滤后 KO 数 (prevalence >= 20%):", nrow(ko_abundance_filtered), "\n")
```

## 2.2 计算噬菌体-KO 相关性

```{r}
#| label: phage-ko-correlation

cat("=== 计算噬菌体-KO Spearman 相关性 ===\n")
cat("矩阵大小:", nrow(phage_abundance_filtered), "噬菌体 ×", nrow(ko_abundance_filtered), "KOs\n")
cat("计算中...\n")

# 转置矩阵（样本为行）
phage_t <- t(phage_abundance_filtered)
ko_t <- t(ko_abundance_filtered)

# 计算相关性矩阵
n_phage <- ncol(phage_t)
n_ko <- ncol(ko_t)

cor_matrix_phage_ko <- matrix(NA, nrow = n_phage, ncol = n_ko)
pval_matrix_phage_ko <- matrix(NA, nrow = n_phage, ncol = n_ko)
rownames(cor_matrix_phage_ko) <- colnames(phage_t)
colnames(cor_matrix_phage_ko) <- colnames(ko_t)
rownames(pval_matrix_phage_ko) <- colnames(phage_t)
colnames(pval_matrix_phage_ko) <- colnames(ko_t)

# 计算 Spearman 相关性
for (i in 1:n_phage) {
  for (j in 1:n_ko) {
    test_result <- cor.test(
      phage_t[, i], ko_t[, j],
      method = "spearman",
      exact = FALSE
    )
    cor_matrix_phage_ko[i, j] <- test_result$estimate
    pval_matrix_phage_ko[i, j] <- test_result$p.value
  }
}

cat("相关性计算完成\n")
```

## 2.3 FDR 校正

```{r}
#| label: phage-ko-fdr

# FDR 校正 (Benjamini-Hochberg)
pval_vector <- as.vector(pval_matrix_phage_ko)
qval_vector <- p.adjust(pval_vector, method = "BH")
qval_matrix_phage_ko <- matrix(qval_vector, nrow = n_phage, ncol = n_ko)
rownames(qval_matrix_phage_ko) <- rownames(cor_matrix_phage_ko)
colnames(qval_matrix_phage_ko) <- colnames(cor_matrix_phage_ko)

# 统计显著关联
n_sig_005 <- sum(qval_matrix_phage_ko < 0.05, na.rm = TRUE)
n_sig_010 <- sum(qval_matrix_phage_ko < 0.10, na.rm = TRUE)
n_sig_025 <- sum(qval_matrix_phage_ko < 0.25, na.rm = TRUE)

cat("\n=== 噬菌体-KO 关联统计 ===\n")
cat("显著关联数 (FDR < 0.05):", n_sig_005, "\n")
cat("显著关联数 (FDR < 0.10):", n_sig_010, "\n")
cat("显著关联数 (FDR < 0.25):", n_sig_025, "\n")
```

## 2.4 Top 噬菌体-KO 关联对

```{r}
#| label: top-phage-ko-pairs

# 创建关联对数据框
phage_ko_pairs <- expand.grid(
  phage = rownames(cor_matrix_phage_ko),
  ko = colnames(cor_matrix_phage_ko),
  stringsAsFactors = FALSE
)

phage_ko_pairs$correlation <- as.vector(cor_matrix_phage_ko)
phage_ko_pairs$pvalue <- as.vector(pval_matrix_phage_ko)
phage_ko_pairs$qvalue <- as.vector(qval_matrix_phage_ko)
phage_ko_pairs$abs_cor <- abs(phage_ko_pairs$correlation)

# 排序并显示 Top 20
top_pairs <- phage_ko_pairs |>
  arrange(qvalue, desc(abs_cor)) |>
  head(20)

cat("\n=== Top 20 噬菌体-KO 关联对 ===\n")
print(top_pairs |> dplyr::select(phage, ko, correlation, qvalue))

# 保存结果
write.csv(
  phage_ko_pairs |> arrange(qvalue),
  file = path_target("01_phage_ko_correlation_all.csv"),
  row.names = FALSE
)

# 保存显著结果
sig_pairs <- phage_ko_pairs |> filter(qvalue < 0.25)
if (nrow(sig_pairs) > 0) {
  write.csv(
    sig_pairs |> arrange(qvalue),
    file = path_target("02_phage_ko_correlation_significant.csv"),
    row.names = FALSE
  )
}
```

## 2.5 噬菌体-KO 关联热图

```{r}
#| label: phage-ko-heatmap
#| fig-width: 14
#| fig-height: 10

# 筛选有最强关联的噬菌体和KO用于可视化
# 选择相关性绝对值最大的噬菌体和KO

# 每个噬菌体的最大相关性
phage_max_cor <- apply(abs(cor_matrix_phage_ko), 1, max, na.rm = TRUE)
top_phage <- names(sort(phage_max_cor, decreasing = TRUE))[1:min(30, n_phage)]

# 每个KO的最大相关性
ko_max_cor <- apply(abs(cor_matrix_phage_ko), 2, max, na.rm = TRUE)
top_ko <- names(sort(ko_max_cor, decreasing = TRUE))[1:min(40, n_ko)]

# 子集化
cor_matrix_subset <- cor_matrix_phage_ko[top_phage, top_ko]
qval_matrix_subset <- qval_matrix_phage_ko[top_phage, top_ko]

# 简化名称
rownames(cor_matrix_subset) <- stringr::str_trunc(rownames(cor_matrix_subset), 35)
colnames(cor_matrix_subset) <- stringr::str_trunc(colnames(cor_matrix_subset), 15)

# 创建显著性标记
sig_marks <- ifelse(qval_matrix_subset < 0.05, "**",
                    ifelse(qval_matrix_subset < 0.10, "*",
                           ifelse(qval_matrix_subset < 0.25, ".", "")))

# 绘制热图
p_heatmap_phage_ko <- pheatmap(
  cor_matrix_subset,
  color = colorRampPalette(c("#2166AC", "#F7F7F7", "#B2182B"))(100),
  breaks = seq(-1, 1, length.out = 101),
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  show_rownames = TRUE,
  show_colnames = TRUE,
  fontsize_row = 7,
  fontsize_col = 8,
  angle_col = 45,
  main = "Phage-KO Correlation Heatmap (Spearman)",
  display_numbers = sig_marks,
  number_color = "black",
  fontsize_number = 6,
  silent = TRUE
)

print(p_heatmap_phage_ko)

# 保存
png(path_target("03_phage_ko_correlation_heatmap.png"),
    width = 14, height = 10, units = "in", res = 300)
print(p_heatmap_phage_ko)
dev.off()

cat("\n** = FDR < 0.05, * = FDR < 0.10, . = FDR < 0.25\n")
```

# Part 3: 噬菌体-Pathway 关联分析

类似地分析噬菌体与代谢通路的关联。

```{r}
#| label: phage-pathway-correlation

# ------------------------------------------------------------------------------
# 提取 Pathway 丰度矩阵
# ------------------------------------------------------------------------------
if ("relabundance" %in% assayNames(tse_pathway)) {
  pathway_abundance <- as.matrix(assay(tse_pathway, "relabundance"))
} else {
  pathway_counts <- as.matrix(assay(tse_pathway, "abundance"))
  pathway_abundance <- sweep(pathway_counts, 2, colSums(pathway_counts), "/")
}

# 过滤低丰度通路
pathway_prevalence <- rowSums(pathway_abundance > 0) / ncol(pathway_abundance)
pathway_abundant <- pathway_prevalence >= 0.2
pathway_abundance_filtered <- pathway_abundance[pathway_abundant, ]

cat("Pathway 过滤:\n")
cat("  原始通路数:", nrow(pathway_abundance), "\n")
cat("  过滤后通路数 (prevalence >= 20%):", nrow(pathway_abundance_filtered), "\n")

# ------------------------------------------------------------------------------
# 计算噬菌体-Pathway 相关性
# ------------------------------------------------------------------------------
pathway_t <- t(pathway_abundance_filtered)
n_pathway <- ncol(pathway_t)

cor_matrix_phage_pathway <- matrix(NA, nrow = n_phage, ncol = n_pathway)
pval_matrix_phage_pathway <- matrix(NA, nrow = n_phage, ncol = n_pathway)
rownames(cor_matrix_phage_pathway) <- colnames(phage_t)
colnames(cor_matrix_phage_pathway) <- colnames(pathway_t)
rownames(pval_matrix_phage_pathway) <- colnames(phage_t)
colnames(pval_matrix_phage_pathway) <- colnames(pathway_t)

cat("\n计算噬菌体-Pathway 相关性...\n")

for (i in 1:n_phage) {
  for (j in 1:n_pathway) {
    test_result <- cor.test(
      phage_t[, i], pathway_t[, j],
      method = "spearman",
      exact = FALSE
    )
    cor_matrix_phage_pathway[i, j] <- test_result$estimate
    pval_matrix_phage_pathway[i, j] <- test_result$p.value
  }
}

# FDR 校正
pval_vector_pathway <- as.vector(pval_matrix_phage_pathway)
qval_vector_pathway <- p.adjust(pval_vector_pathway, method = "BH")
qval_matrix_phage_pathway <- matrix(qval_vector_pathway, nrow = n_phage, ncol = n_pathway)
rownames(qval_matrix_phage_pathway) <- rownames(cor_matrix_phage_pathway)
colnames(qval_matrix_phage_pathway) <- colnames(cor_matrix_phage_pathway)

# 统计
n_sig_pathway_005 <- sum(qval_matrix_phage_pathway < 0.05, na.rm = TRUE)
n_sig_pathway_010 <- sum(qval_matrix_phage_pathway < 0.10, na.rm = TRUE)
n_sig_pathway_025 <- sum(qval_matrix_phage_pathway < 0.25, na.rm = TRUE)

cat("\n=== 噬菌体-Pathway 关联统计 ===\n")
cat("显著关联数 (FDR < 0.05):", n_sig_pathway_005, "\n")
cat("显著关联数 (FDR < 0.10):", n_sig_pathway_010, "\n")
cat("显著关联数 (FDR < 0.25):", n_sig_pathway_025, "\n")
```

```{r}
#| label: phage-pathway-heatmap
#| fig-width: 14
#| fig-height: 10

# 选择 Top 噬菌体和通路
phage_max_cor_pw <- apply(abs(cor_matrix_phage_pathway), 1, max, na.rm = TRUE)
top_phage_pw <- names(sort(phage_max_cor_pw, decreasing = TRUE))[1:min(25, n_phage)]

pathway_max_cor <- apply(abs(cor_matrix_phage_pathway), 2, max, na.rm = TRUE)
top_pathway <- names(sort(pathway_max_cor, decreasing = TRUE))[1:min(30, n_pathway)]

cor_matrix_pw_subset <- cor_matrix_phage_pathway[top_phage_pw, top_pathway]
qval_matrix_pw_subset <- qval_matrix_phage_pathway[top_phage_pw, top_pathway]

# 简化通路名称
rownames(cor_matrix_pw_subset) <- stringr::str_trunc(rownames(cor_matrix_pw_subset), 35)
colnames(cor_matrix_pw_subset) <- stringr::str_replace(colnames(cor_matrix_pw_subset), ".*: ", "")
colnames(cor_matrix_pw_subset) <- stringr::str_trunc(colnames(cor_matrix_pw_subset), 40)

sig_marks_pw <- ifelse(qval_matrix_pw_subset < 0.05, "**",
                       ifelse(qval_matrix_pw_subset < 0.10, "*",
                              ifelse(qval_matrix_pw_subset < 0.25, ".", "")))

p_heatmap_phage_pathway <- pheatmap(
  cor_matrix_pw_subset,
  color = colorRampPalette(c("#2166AC", "#F7F7F7", "#B2182B"))(100),
  breaks = seq(-1, 1, length.out = 101),
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  show_rownames = TRUE,
  show_colnames = TRUE,
  fontsize_row = 7,
  fontsize_col = 7,
  angle_col = 45,
  main = "Phage-Pathway Correlation Heatmap (Spearman)",
  display_numbers = sig_marks_pw,
  number_color = "black",
  fontsize_number = 5,
  silent = TRUE
)

print(p_heatmap_phage_pathway)

png(path_target("04_phage_pathway_correlation_heatmap.png"),
    width = 14, height = 10, units = "in", res = 300)
print(p_heatmap_phage_pathway)
dev.off()
```

# Part 4: 三角互作网络分析 (方案B)

整合细菌-噬菌体、细菌-KO、噬菌体-KO三种关联，构建三角互作网络。

## 4.1 计算细菌-KO 关联

```{r}
#| label: bacteria-ko-correlation

cat("=== 计算细菌(SingleM)-KO 关联 ===\n")

# 提取细菌丰度
if ("relabundance" %in% assayNames(tse_singlem)) {
  bacteria_abundance <- as.matrix(assay(tse_singlem, "relabundance"))
} else {
  bacteria_counts <- as.matrix(assay(tse_singlem, "counts"))
  bacteria_abundance <- sweep(bacteria_counts, 2, colSums(bacteria_counts), "/")
}

# 过滤
bacteria_prevalence <- rowSums(bacteria_abundance > 0) / ncol(bacteria_abundance)
bacteria_abundant <- bacteria_prevalence >= 0.2
bacteria_abundance_filtered <- bacteria_abundance[bacteria_abundant, ]

cat("细菌过滤:\n")
cat("  原始 OTU 数:", nrow(bacteria_abundance), "\n")
cat("  过滤后 OTU 数:", nrow(bacteria_abundance_filtered), "\n")

# 计算相关性
bacteria_t <- t(bacteria_abundance_filtered)
n_bacteria <- ncol(bacteria_t)

cor_matrix_bacteria_ko <- matrix(NA, nrow = n_bacteria, ncol = n_ko)
pval_matrix_bacteria_ko <- matrix(NA, nrow = n_bacteria, ncol = n_ko)
rownames(cor_matrix_bacteria_ko) <- colnames(bacteria_t)
colnames(cor_matrix_bacteria_ko) <- colnames(ko_t)

cat("计算细菌-KO相关性...\n")

for (i in 1:n_bacteria) {
  for (j in 1:n_ko) {
    test_result <- cor.test(
      bacteria_t[, i], ko_t[, j],
      method = "spearman",
      exact = FALSE
    )
    cor_matrix_bacteria_ko[i, j] <- test_result$estimate
    pval_matrix_bacteria_ko[i, j] <- test_result$p.value
  }
}

# FDR
qval_matrix_bacteria_ko <- matrix(
  p.adjust(as.vector(pval_matrix_bacteria_ko), method = "BH"),
  nrow = n_bacteria, ncol = n_ko
)
rownames(qval_matrix_bacteria_ko) <- rownames(cor_matrix_bacteria_ko)
colnames(qval_matrix_bacteria_ko) <- colnames(cor_matrix_bacteria_ko)

n_sig_bac_ko <- sum(qval_matrix_bacteria_ko < 0.25, na.rm = TRUE)
cat("细菌-KO 显著关联数 (FDR < 0.25):", n_sig_bac_ko, "\n")
```

## 4.2 计算细菌-噬菌体 关联

```{r}
#| label: bacteria-phage-correlation

cat("\n=== 计算细菌-噬菌体 关联 ===\n")

cor_matrix_bacteria_phage <- matrix(NA, nrow = n_bacteria, ncol = n_phage)
pval_matrix_bacteria_phage <- matrix(NA, nrow = n_bacteria, ncol = n_phage)
rownames(cor_matrix_bacteria_phage) <- colnames(bacteria_t)
colnames(cor_matrix_bacteria_phage) <- colnames(phage_t)

cat("计算细菌-噬菌体相关性...\n")

for (i in 1:n_bacteria) {
  for (j in 1:n_phage) {
    test_result <- cor.test(
      bacteria_t[, i], phage_t[, j],
      method = "spearman",
      exact = FALSE
    )
    cor_matrix_bacteria_phage[i, j] <- test_result$estimate
    pval_matrix_bacteria_phage[i, j] <- test_result$p.value
  }
}

# FDR
qval_matrix_bacteria_phage <- matrix(
  p.adjust(as.vector(pval_matrix_bacteria_phage), method = "BH"),
  nrow = n_bacteria, ncol = n_phage
)
rownames(qval_matrix_bacteria_phage) <- rownames(cor_matrix_bacteria_phage)
colnames(qval_matrix_bacteria_phage) <- colnames(cor_matrix_bacteria_phage)

n_sig_bac_phage <- sum(qval_matrix_bacteria_phage < 0.25, na.rm = TRUE)
cat("细菌-噬菌体 显著关联数 (FDR < 0.25):", n_sig_bac_phage, "\n")
```

## 4.3 构建三角互作网络

```{r}
#| label: tripartite-network
#| fig-width: 14
#| fig-height: 12

cat("\n=== 构建三角互作网络 ===\n")

# 使用较宽松的阈值筛选边
cor_threshold <- 0.5
fdr_threshold <- 0.25

# 创建边列表
edges_list <- list()

# 1. 细菌-KO 边
for (i in 1:n_bacteria) {
  for (j in 1:n_ko) {
    if (!is.na(qval_matrix_bacteria_ko[i, j]) &&
        qval_matrix_bacteria_ko[i, j] < fdr_threshold &&
        abs(cor_matrix_bacteria_ko[i, j]) > cor_threshold) {
      edges_list[[length(edges_list) + 1]] <- data.frame(
        from = rownames(cor_matrix_bacteria_ko)[i],
        to = colnames(cor_matrix_bacteria_ko)[j],
        weight = cor_matrix_bacteria_ko[i, j],
        type = "Bacteria-KO",
        stringsAsFactors = FALSE
      )
    }
  }
}

# 2. 细菌-噬菌体 边
for (i in 1:n_bacteria) {
  for (j in 1:n_phage) {
    if (!is.na(qval_matrix_bacteria_phage[i, j]) &&
        qval_matrix_bacteria_phage[i, j] < fdr_threshold &&
        abs(cor_matrix_bacteria_phage[i, j]) > cor_threshold) {
      edges_list[[length(edges_list) + 1]] <- data.frame(
        from = rownames(cor_matrix_bacteria_phage)[i],
        to = colnames(cor_matrix_bacteria_phage)[j],
        weight = cor_matrix_bacteria_phage[i, j],
        type = "Bacteria-Phage",
        stringsAsFactors = FALSE
      )
    }
  }
}

# 3. 噬菌体-KO 边
for (i in 1:n_phage) {
  for (j in 1:n_ko) {
    if (!is.na(qval_matrix_phage_ko[i, j]) &&
        qval_matrix_phage_ko[i, j] < fdr_threshold &&
        abs(cor_matrix_phage_ko[i, j]) > cor_threshold) {
      edges_list[[length(edges_list) + 1]] <- data.frame(
        from = rownames(cor_matrix_phage_ko)[i],
        to = colnames(cor_matrix_phage_ko)[j],
        weight = cor_matrix_phage_ko[i, j],
        type = "Phage-KO",
        stringsAsFactors = FALSE
      )
    }
  }
}

# 合并边
if (length(edges_list) > 0) {
  edges_df <- bind_rows(edges_list)

  cat("网络边数:\n")
  cat("  细菌-KO:", sum(edges_df$type == "Bacteria-KO"), "\n")
  cat("  细菌-噬菌体:", sum(edges_df$type == "Bacteria-Phage"), "\n")
  cat("  噬菌体-KO:", sum(edges_df$type == "Phage-KO"), "\n")
  cat("  总计:", nrow(edges_df), "\n")

  # 保存边列表
  write.csv(edges_df, path_target("05_tripartite_network_edges.csv"), row.names = FALSE)

} else {
  cat("当前阈值下没有足够的边，尝试降低阈值...\n")
  edges_df <- data.frame()
}
```

```{r}
#| label: network-visualization
#| fig-width: 14
#| fig-height: 12

if (nrow(edges_df) > 0) {

  # 创建节点列表
  all_nodes <- unique(c(edges_df$from, edges_df$to))

  # 确定节点类型
  node_type <- case_when(
    all_nodes %in% rownames(cor_matrix_bacteria_ko) ~ "Bacteria",
    all_nodes %in% rownames(cor_matrix_phage_ko) ~ "Phage",
    all_nodes %in% colnames(cor_matrix_bacteria_ko) ~ "KO",
    TRUE ~ "Unknown"
  )

  nodes_df <- data.frame(
    name = all_nodes,
    type = node_type,
    stringsAsFactors = FALSE
  )

  # 简化节点名称
  nodes_df$label <- stringr::str_trunc(nodes_df$name, 20)

  # 创建 igraph 对象
  g <- graph_from_data_frame(edges_df, directed = FALSE, vertices = nodes_df)

  # 设置边颜色（基于关联类型）
  edge_colors <- case_when(
    E(g)$type == "Bacteria-KO" ~ "#1B9E77",
    E(g)$type == "Bacteria-Phage" ~ "#D95F02",
    E(g)$type == "Phage-KO" ~ "#7570B3",
    TRUE ~ "grey"
  )

  # 设置边宽度（使用绝对值）
  E(g)$width <- abs(E(g)$weight) * 3
  E(g)$color <- edge_colors

  # 边的线型：实线=正相关，虚线=负相关
  E(g)$lty <- ifelse(E(g)$weight > 0, 1, 2)

  # 重要：为布局算法创建正权重（使用绝对值）
  E(g)$layout_weight <- abs(E(g)$weight)

  # 设置节点颜色
  node_colors <- case_when(
    V(g)$type == "Bacteria" ~ "#66C2A5",
    V(g)$type == "Phage" ~ "#FC8D62",
    V(g)$type == "KO" ~ "#8DA0CB",
    TRUE ~ "grey"
  )
  V(g)$color <- node_colors

  # 绘制网络（使用正权重进行布局）
  p_network <- ggraph(g, layout = "fr", weights = E(g)$layout_weight) +
    geom_edge_link(aes(color = type, width = abs(weight), linetype = ifelse(weight > 0, "positive", "negative")),
                   alpha = 0.6) +
    geom_node_point(aes(color = type), size = 5) +
    geom_node_text(aes(label = label), repel = TRUE, size = 2.5) +
    scale_edge_color_manual(
      values = c("Bacteria-KO" = "#1B9E77",
                 "Bacteria-Phage" = "#D95F02",
                 "Phage-KO" = "#7570B3")
    ) +
    scale_edge_linetype_manual(
      values = c("positive" = "solid", "negative" = "dashed"),
      name = "Correlation"
    ) +
    scale_color_manual(
      values = c("Bacteria" = "#66C2A5",
                 "Phage" = "#FC8D62",
                 "KO" = "#8DA0CB")
    ) +
    theme_void() +
    labs(
      title = "Tripartite Interaction Network",
      subtitle = "Bacteria - Phage - KO associations (|r| > 0.5, FDR < 0.25)\nSolid = positive correlation, Dashed = negative correlation",
      edge_color = "Edge Type",
      color = "Node Type"
    ) +
    theme(
      plot.title = element_text(size = 14, face = "bold"),
      legend.position = "right"
    )

  print(p_network)

  ggsave(
    path_target("06_tripartite_network.png"),
    p_network, width = 14, height = 12, dpi = 300
  )

} else {
  cat("边数不足，无法绘制网络图\n")
}
```

# Part 5: 结果汇总

```{r}
#| label: summary

cat("
================================================================================
                    03b 病毒组-功能整合分析 结果汇总
================================================================================

【数据概况】
- 共同样本数: ", length(common_samples), "
- 噬菌体 OTU 数 (过滤后): ", nrow(phage_abundance_filtered), "
- 细菌 OTU 数 (过滤后): ", nrow(bacteria_abundance_filtered), "
- KO 数 (过滤后): ", nrow(ko_abundance_filtered), "
- Pathway 数 (过滤后): ", nrow(pathway_abundance_filtered), "

【噬菌体-KO 关联分析】
- 显著关联数 (FDR < 0.05): ", n_sig_005, "
- 显著关联数 (FDR < 0.10): ", n_sig_010, "
- 显著关联数 (FDR < 0.25): ", n_sig_025, "

【噬菌体-Pathway 关联分析】
- 显著关联数 (FDR < 0.05): ", n_sig_pathway_005, "
- 显著关联数 (FDR < 0.10): ", n_sig_pathway_010, "
- 显著关联数 (FDR < 0.25): ", n_sig_pathway_025, "

【三角互作网络】
- 细菌-KO 显著关联: ", n_sig_bac_ko, " (FDR < 0.25)
- 细菌-噬菌体 显著关联: ", n_sig_bac_phage, " (FDR < 0.25)
- 噬菌体-KO 显著关联: ", n_sig_025, " (FDR < 0.25)

【科学意义】
1. 噬菌体-功能关联揭示了噬菌体可能通过影响细菌群落间接调控代谢功能
2. 三角互作网络展示了 CagA 感染环境下细菌-噬菌体-功能的协同变化模式
3. 这些发现补充了 02 分析中的物种-功能关联，提供了病毒组视角

================================================================================
")
```

```{r}
#| label: session-info

cat("\n【分析环境信息】\n")
cat("R版本:", R.version.string, "\n")
cat("分析日期:", format(Sys.time(), "%Y-%m-%d %H:%M:%S"), "\n")
cat("工作目录:", getwd(), "\n")
```

---

## Files written

These files have been written to the target directory, `r paste0("data/", params$name)`:

```{r}
#| label: list-files-target
projthis::proj_dir_info(path_target(), tz = "CET") |> knitr::kable()
```
