---
title: "03b_virome_function_integration"
title-block-banner: true
author: Gong Yuhang
date: "2026-01-10"
toc: true
toc-depth: 4
number-sections: true
code-fold: true
code-line-numbers: true
code-tools: true
format:
  html:
    embed-resources: true
    smooth-scroll: true
    page-layout: full
    theme: cosmo
reference-location: section
citation-location: document
params:
  name: "03b_virome_function_integration"
---

**Updated: `r format(Sys.time(), '%Y-%m-%d %H:%M:%S', tz = 'CET')` CET.**

本文档是项目 pc047 (vCagAepitope) 的 **病毒组-功能整合分析** 模块。

**分析目的**：
整合 03 分析（SingleM/Lyrebird）和 02 分析（HUMAnN功能）的结果，探索：

1. **噬菌体-功能关联**：噬菌体OTU丰度与KO/Pathway丰度的相关性
2. **三角互作网络**：细菌-噬菌体-功能的联合分析

**科学意义**：
噬菌体通过裂解/溶原影响细菌群落，可能间接调控菌群的代谢功能。这类分析在肿瘤微生物组研究中较为少见。

```{r}
#| label: params
#| eval: !expr interactive()
#| include: false
params = list(name = "03b_virome_function_integration")
```

```{r}
#| label: setup
#| message: false
#| include: false
#| warning: false
wd <- "analyses"
if (basename(getwd()) != wd) {
  setwd(here::here(wd))
}
here::i_am(paste0(params$name, ".qmd"), uuid = "c465c8e1-bc4f-47fa-8e95-7b0bcfe53436")
projthis::proj_create_dir_target(params$name, clean = FALSE)
path_target <- projthis::proj_path_target(params$name)
path_source <- projthis::proj_path_source(params$name)
path_raw <- path_source("00-raw")
path_resource <- here::here(path_raw, "d00-resource")
path_data <- here::here(path_raw, paste0("d", params$name))
dir.create(path_raw, recursive = TRUE, showWarnings = FALSE)
dir.create(path_data, recursive = TRUE, showWarnings = FALSE)
dir.create(path_resource, recursive = TRUE, showWarnings = FALSE)
```

```{r}
#| label: packages
#| message: false
suppressPackageStartupMessages({
  library(here)
  library(conflicted)
  library(tidyverse)
  library(data.table)
  library(mia)
  library(TreeSummarizedExperiment)
  library(patchwork)
  library(ggplot2)
  library(pheatmap)
  library(vegan)
  library(igraph)
  library(ggraph)
  library(Hmisc)  # OMA风格：高效相关性计算
  devtools::load_all()
})

# 解决命名空间冲突
conflicts_prefer(base::setdiff)
conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::select)
conflicts_prefer(dplyr::lag)
conflicts_prefer(dplyr::first)
conflicts_prefer(dplyr::left_join)
conflicts_prefer(base::intersect)

set.seed(20261)
```

```{r}
#| label: helper-functions

# ==============================================================================
# OMA风格辅助函数：跨矩阵Spearman相关性计算
# ==============================================================================

#' 计算两个矩阵之间的Spearman相关性（向量化）
#'
#' @param mat_x 矩阵X (样本×特征A)
#' @param mat_y 矩阵Y (样本×特征B)，样本数需与mat_x一致
#' @return 列表包含：r (相关系数矩阵), P (p值矩阵), n (样本数)
cross_rcorr <- function(mat_x, mat_y) {
  # 确保行数（样本数）一致
  stopifnot(nrow(mat_x) == nrow(mat_y))

  n <- nrow(mat_x)
  nx <- ncol(mat_x)
  ny <- ncol(mat_y)

  # 合并矩阵后使用Hmisc::rcorr
  combined <- cbind(mat_x, mat_y)
  rcorr_result <- rcorr(as.matrix(combined), type = "spearman")

  # 提取跨矩阵部分
  r_matrix <- rcorr_result$r[1:nx, (nx+1):(nx+ny)]
  p_matrix <- rcorr_result$P[1:nx, (nx+1):(nx+ny)]

  # 恢复行列名
  rownames(r_matrix) <- colnames(mat_x)
  colnames(r_matrix) <- colnames(mat_y)
  rownames(p_matrix) <- colnames(mat_x)
  colnames(p_matrix) <- colnames(mat_y)

  list(r = r_matrix, P = p_matrix, n = n)
}

#' 将相关性结果转换为长格式数据框
#'
#' @param cor_result cross_rcorr()的返回值
#' @param name_x X矩阵特征名称列名
#' @param name_y Y矩阵特征名称列名
#' @return 数据框包含：feature_x, feature_y, correlation, pvalue, qvalue, abs_cor
corr_to_df <- function(cor_result, name_x = "feature_x", name_y = "feature_y") {
  df <- expand.grid(
    feature_x = rownames(cor_result$r),
    feature_y = colnames(cor_result$r),
    stringsAsFactors = FALSE
  )
  names(df)[1:2] <- c(name_x, name_y)

  df$correlation <- as.vector(cor_result$r)
  df$pvalue <- as.vector(cor_result$P)
  df$qvalue <- p.adjust(df$pvalue, method = "BH")
  df$abs_cor <- abs(df$correlation)

  df
}

#' 从相关性结果创建网络边
#'
#' @param cor_result cross_rcorr()的返回值
#' @param cor_threshold 相关系数绝对值阈值
#' @param fdr_threshold FDR阈值
#' @param edge_type 边类型标签
#' @return 边数据框
corr_to_edges <- function(cor_result, cor_threshold = 0.5, fdr_threshold = 0.25, edge_type = "Association") {
  df <- corr_to_df(cor_result)

  df |>
    dplyr::filter(abs_cor > cor_threshold, qvalue < fdr_threshold) |>
    transmute(
      from = .data[[names(df)[1]]],
      to = .data[[names(df)[2]]],
      weight = correlation,
      type = edge_type
    )
}
```

# Part 1: 数据导入

从 02 和 03 分析的产出读取预处理好的数据。

```{r}
#| label: load-data

cat("=== 数据导入 ===\n\n")

# ------------------------------------------------------------------------------
# 从 02 分析导入功能数据
# ------------------------------------------------------------------------------
tse_ko <- readRDS(here::here("data", "02_functional_profiling", "tse_ko_corepair.rds"))
tse_pathway <- readRDS(here::here("data", "02_functional_profiling", "tse_humann_pathway_corepair.rds"))

cat("02 分析数据:\n")
cat("  KO TSE: ", ncol(tse_ko), " 样本, ", nrow(tse_ko), " KOs\n")
cat("  Pathway TSE: ", ncol(tse_pathway), " 样本, ", nrow(tse_pathway), " Pathways\n")

# ------------------------------------------------------------------------------
# 从 03 分析导入噬菌体和细菌数据
# ------------------------------------------------------------------------------
tse_lyrebird <- readRDS(here::here("data", "03_singlem_diversity_analysis", "tse_lyrebird_corepair.rds"))
tse_singlem <- readRDS(here::here("data", "03_singlem_diversity_analysis", "tse_singlem_corepair.rds"))

cat("\n03 分析数据:\n")
cat("  Lyrebird (噬菌体) TSE: ", ncol(tse_lyrebird), " 样本, ", nrow(tse_lyrebird), " OTUs\n")
cat("  SingleM (细菌) TSE: ", ncol(tse_singlem), " 样本, ", nrow(tse_singlem), " OTUs\n")

# ------------------------------------------------------------------------------
# 找到共同样本
# ------------------------------------------------------------------------------
common_samples <- Reduce(intersect, list(
  colnames(tse_ko),
  colnames(tse_pathway),
  colnames(tse_lyrebird),
  colnames(tse_singlem)
))

cat("\n共同样本数: ", length(common_samples), "\n")
cat("样本列表: ", paste(common_samples, collapse = ", "), "\n")
```

```{r}
#| label: subset-common-samples

# 子集化到共同样本
tse_ko <- tse_ko[, common_samples]
tse_pathway <- tse_pathway[, common_samples]
tse_lyrebird <- tse_lyrebird[, common_samples]
tse_singlem <- tse_singlem[, common_samples]

# 获取处理组信息
treatment_groups <- colData(tse_ko)$treatment_group
cat("\n处理组分布:\n")
print(table(treatment_groups))
```

# Part 2: 噬菌体-KO 关联分析 (方案A)

计算噬菌体OTU丰度与KO丰度的Spearman相关性，类似于02分析中的物种-KO关联。

## 2.1 提取丰度矩阵

```{r}
#| label: extract-abundance-matrices

# ------------------------------------------------------------------------------
# 提取噬菌体丰度矩阵
# ------------------------------------------------------------------------------
# 使用相对丰度
if ("relabundance" %in% assayNames(tse_lyrebird)) {
  phage_abundance <- as.matrix(assay(tse_lyrebird, "relabundance"))
} else {
  # 如果没有relabundance，计算相对丰度
  phage_counts <- as.matrix(assay(tse_lyrebird, "counts"))
  phage_abundance <- sweep(phage_counts, 2, colSums(phage_counts), "/")
}

# 过滤低丰度噬菌体（至少在20%样本中存在）
phage_prevalence <- rowSums(phage_abundance > 0) / ncol(phage_abundance)
phage_abundant <- phage_prevalence >= 0.2
phage_abundance_filtered <- phage_abundance[phage_abundant, ]

cat("噬菌体过滤:\n")
cat("  原始 OTU 数:", nrow(phage_abundance), "\n")
cat("  过滤后 OTU 数 (prevalence >= 20%):", nrow(phage_abundance_filtered), "\n")

# ------------------------------------------------------------------------------
# 提取 KO 丰度矩阵
# ------------------------------------------------------------------------------
if ("cpm" %in% assayNames(tse_ko)) {
  ko_abundance <- as.matrix(assay(tse_ko, "cpm"))
} else {
  ko_counts <- as.matrix(assay(tse_ko, "counts"))
  ko_abundance <- sweep(ko_counts, 2, colSums(ko_counts), "/") * 1e6
}

# 过滤低丰度 KO
ko_prevalence <- rowSums(ko_abundance > 0) / ncol(ko_abundance)
ko_abundant <- ko_prevalence >= 0.2
ko_abundance_filtered <- ko_abundance[ko_abundant, ]

cat("\nKO 过滤:\n")
cat("  原始 KO 数:", nrow(ko_abundance), "\n")
cat("  过滤后 KO 数 (prevalence >= 20%):", nrow(ko_abundance_filtered), "\n")
```

## 2.2 计算噬菌体-KO 相关性 (OMA风格)

```{r}
#| label: phage-ko-correlation

cat("=== 计算噬菌体-KO Spearman 相关性 (Hmisc::rcorr) ===\n")

# 转置矩阵（样本为行）
phage_t <- t(phage_abundance_filtered)
ko_t <- t(ko_abundance_filtered)

n_phage <- ncol(phage_t)
n_ko <- ncol(ko_t)

cat("矩阵大小:", n_phage, "噬菌体 ×", n_ko, "KOs\n")

# OMA风格：使用cross_rcorr一次性计算所有相关性
cor_phage_ko <- cross_rcorr(phage_t, ko_t)

# 转换为长格式数据框（自动FDR校正）
phage_ko_pairs <- corr_to_df(cor_phage_ko, "phage", "ko")

# 统计显著关联
n_sig_005 <- sum(phage_ko_pairs$qvalue < 0.05, na.rm = TRUE)
n_sig_010 <- sum(phage_ko_pairs$qvalue < 0.10, na.rm = TRUE)
n_sig_025 <- sum(phage_ko_pairs$qvalue < 0.25, na.rm = TRUE)

cat("\n=== 噬菌体-KO 关联统计 ===\n")
cat("显著关联数 (FDR < 0.05):", n_sig_005, "\n")
cat("显著关联数 (FDR < 0.10):", n_sig_010, "\n")
cat("显著关联数 (FDR < 0.25):", n_sig_025, "\n")

# Top 20
cat("\n=== Top 20 噬菌体-KO 关联对 ===\n")
top_pairs <- phage_ko_pairs |> arrange(qvalue, desc(abs_cor)) |> head(20)
print(top_pairs |> dplyr::select(phage, ko, correlation, qvalue))

# 保存结果
write.csv(phage_ko_pairs |> arrange(qvalue),
          file = path_target("01_phage_ko_correlation_all.csv"), row.names = FALSE)

sig_pairs <- phage_ko_pairs |> dplyr::filter(qvalue < 0.25)
if (nrow(sig_pairs) > 0) {
  write.csv(sig_pairs |> arrange(qvalue),
            file = path_target("02_phage_ko_correlation_significant.csv"), row.names = FALSE)
}
```

## 2.3 噬菌体-KO 关联热图

```{r}
#| label: phage-ko-heatmap
#| fig-width: 14
#| fig-height: 10

# 从相关性结果提取矩阵
cor_matrix_phage_ko <- cor_phage_ko$r

# 创建qvalue矩阵用于显著性标记
qval_matrix_phage_ko <- matrix(
  phage_ko_pairs$qvalue,
  nrow = n_phage, ncol = n_ko,
  dimnames = list(rownames(cor_matrix_phage_ko), colnames(cor_matrix_phage_ko))
)

# 选择Top特征
phage_max_cor <- apply(abs(cor_matrix_phage_ko), 1, max, na.rm = TRUE)
top_phage <- names(sort(phage_max_cor, decreasing = TRUE))[1:min(30, n_phage)]

ko_max_cor <- apply(abs(cor_matrix_phage_ko), 2, max, na.rm = TRUE)
top_ko <- names(sort(ko_max_cor, decreasing = TRUE))[1:min(40, n_ko)]

# 子集化并简化名称
cor_subset <- cor_matrix_phage_ko[top_phage, top_ko]
qval_subset <- qval_matrix_phage_ko[top_phage, top_ko]

rownames(cor_subset) <- stringr::str_trunc(rownames(cor_subset), 35)
colnames(cor_subset) <- stringr::str_trunc(colnames(cor_subset), 15)

# 显著性标记
sig_marks <- ifelse(qval_subset < 0.05, "**",
                    ifelse(qval_subset < 0.10, "*",
                           ifelse(qval_subset < 0.25, ".", "")))

# 热图
p_heatmap_phage_ko <- pheatmap(
  cor_subset,
  color = colorRampPalette(c("#2166AC", "#F7F7F7", "#B2182B"))(100),
  breaks = seq(-1, 1, length.out = 101),
  cluster_rows = TRUE, cluster_cols = TRUE,
  fontsize_row = 7, fontsize_col = 8, angle_col = 45,
  main = "Phage-KO Correlation Heatmap (Spearman)",
  display_numbers = sig_marks, number_color = "black", fontsize_number = 6,
  silent = TRUE
)

print(p_heatmap_phage_ko)

png(path_target("03_phage_ko_correlation_heatmap.png"),
    width = 14, height = 10, units = "in", res = 300)
print(p_heatmap_phage_ko)
dev.off()

cat("\n** = FDR < 0.05, * = FDR < 0.10, . = FDR < 0.25\n")
```

# Part 3: 噬菌体-Pathway 关联分析

类似地分析噬菌体与代谢通路的关联。

```{r}
#| label: phage-pathway-correlation

# 提取 Pathway 丰度矩阵
if ("relabundance" %in% assayNames(tse_pathway)) {
  pathway_abundance <- as.matrix(assay(tse_pathway, "relabundance"))
} else {
  pathway_counts <- as.matrix(assay(tse_pathway, "abundance"))
  pathway_abundance <- sweep(pathway_counts, 2, colSums(pathway_counts), "/")
}

# 过滤低丰度通路
pathway_prevalence <- rowSums(pathway_abundance > 0) / ncol(pathway_abundance)
pathway_abundance_filtered <- pathway_abundance[pathway_prevalence >= 0.2, ]
pathway_t <- t(pathway_abundance_filtered)
n_pathway <- ncol(pathway_t)

cat("Pathway 过滤:\n")
cat("  原始通路数:", nrow(pathway_abundance), "\n")
cat("  过滤后通路数 (prevalence >= 20%):", n_pathway, "\n")

# OMA风格：使用cross_rcorr计算相关性
cor_phage_pathway <- cross_rcorr(phage_t, pathway_t)
phage_pathway_pairs <- corr_to_df(cor_phage_pathway, "phage", "pathway")

# 统计
n_sig_pathway_005 <- sum(phage_pathway_pairs$qvalue < 0.05, na.rm = TRUE)
n_sig_pathway_010 <- sum(phage_pathway_pairs$qvalue < 0.10, na.rm = TRUE)
n_sig_pathway_025 <- sum(phage_pathway_pairs$qvalue < 0.25, na.rm = TRUE)

cat("\n=== 噬菌体-Pathway 关联统计 ===\n")
cat("显著关联数 (FDR < 0.05):", n_sig_pathway_005, "\n")
cat("显著关联数 (FDR < 0.10):", n_sig_pathway_010, "\n")
cat("显著关联数 (FDR < 0.25):", n_sig_pathway_025, "\n")
```

```{r}
#| label: phage-pathway-heatmap
#| fig-width: 14
#| fig-height: 10

cor_matrix_phage_pathway <- cor_phage_pathway$r
qval_matrix_phage_pathway <- matrix(
  phage_pathway_pairs$qvalue,
  nrow = n_phage, ncol = n_pathway,
  dimnames = list(rownames(cor_matrix_phage_pathway), colnames(cor_matrix_phage_pathway))
)

# 选择Top特征
phage_max_cor_pw <- apply(abs(cor_matrix_phage_pathway), 1, max, na.rm = TRUE)
top_phage_pw <- names(sort(phage_max_cor_pw, decreasing = TRUE))[1:min(25, n_phage)]

pathway_max_cor <- apply(abs(cor_matrix_phage_pathway), 2, max, na.rm = TRUE)
top_pathway <- names(sort(pathway_max_cor, decreasing = TRUE))[1:min(30, n_pathway)]

cor_pw_subset <- cor_matrix_phage_pathway[top_phage_pw, top_pathway]
qval_pw_subset <- qval_matrix_phage_pathway[top_phage_pw, top_pathway]

# 简化名称
rownames(cor_pw_subset) <- stringr::str_trunc(rownames(cor_pw_subset), 35)
colnames(cor_pw_subset) <- stringr::str_replace(colnames(cor_pw_subset), ".*: ", "") |>
  stringr::str_trunc(40)

sig_marks_pw <- ifelse(qval_pw_subset < 0.05, "**",
                       ifelse(qval_pw_subset < 0.10, "*",
                              ifelse(qval_pw_subset < 0.25, ".", "")))

p_heatmap_phage_pathway <- pheatmap(
  cor_pw_subset,
  color = colorRampPalette(c("#2166AC", "#F7F7F7", "#B2182B"))(100),
  breaks = seq(-1, 1, length.out = 101),
  cluster_rows = TRUE, cluster_cols = TRUE,
  fontsize_row = 7, fontsize_col = 7, angle_col = 45,
  main = "Phage-Pathway Correlation Heatmap (Spearman)",
  display_numbers = sig_marks_pw, number_color = "black", fontsize_number = 5,
  silent = TRUE
)

print(p_heatmap_phage_pathway)

png(path_target("04_phage_pathway_correlation_heatmap.png"),
    width = 14, height = 10, units = "in", res = 300)
print(p_heatmap_phage_pathway)
dev.off()
```

# Part 4: 三角互作网络分析 (方案B)

整合细菌-噬菌体、细菌-KO、噬菌体-KO三种关联，构建三角互作网络。

## 4.1 计算细菌-KO 和 细菌-噬菌体 关联

```{r}
#| label: bacteria-correlations

cat("=== 计算细菌(SingleM) 关联 ===\n")

# 提取细菌丰度
if ("relabundance" %in% assayNames(tse_singlem)) {
  bacteria_abundance <- as.matrix(assay(tse_singlem, "relabundance"))
} else {
  bacteria_counts <- as.matrix(assay(tse_singlem, "counts"))
  bacteria_abundance <- sweep(bacteria_counts, 2, colSums(bacteria_counts), "/")
}

# 过滤
bacteria_prevalence <- rowSums(bacteria_abundance > 0) / ncol(bacteria_abundance)
bacteria_abundance_filtered <- bacteria_abundance[bacteria_prevalence >= 0.2, ]
bacteria_t <- t(bacteria_abundance_filtered)
n_bacteria <- ncol(bacteria_t)

cat("细菌过滤:\n")
cat("  原始 OTU 数:", nrow(bacteria_abundance), "\n")
cat("  过滤后 OTU 数:", n_bacteria, "\n")

# OMA风格：使用cross_rcorr计算细菌-KO和细菌-噬菌体相关性
cor_bacteria_ko <- cross_rcorr(bacteria_t, ko_t)
cor_bacteria_phage <- cross_rcorr(bacteria_t, phage_t)

bacteria_ko_pairs <- corr_to_df(cor_bacteria_ko, "bacteria", "ko")
bacteria_phage_pairs <- corr_to_df(cor_bacteria_phage, "bacteria", "phage")

n_sig_bac_ko <- sum(bacteria_ko_pairs$qvalue < 0.25, na.rm = TRUE)
n_sig_bac_phage <- sum(bacteria_phage_pairs$qvalue < 0.25, na.rm = TRUE)

cat("\n细菌-KO 显著关联数 (FDR < 0.25):", n_sig_bac_ko, "\n")
cat("细菌-噬菌体 显著关联数 (FDR < 0.25):", n_sig_bac_phage, "\n")
```

## 4.2 构建三角互作网络

```{r}
#| label: tripartite-network
#| fig-width: 14
#| fig-height: 12

cat("\n=== 构建三角互作网络 ===\n")

# 阈值设置
cor_threshold <- 0.5
fdr_threshold <- 0.25

# OMA风格：使用corr_to_edges向量化创建边列表
edges_bacteria_ko <- corr_to_edges(cor_bacteria_ko, cor_threshold, fdr_threshold, "Bacteria-KO")
edges_bacteria_phage <- corr_to_edges(cor_bacteria_phage, cor_threshold, fdr_threshold, "Bacteria-Phage")
edges_phage_ko <- corr_to_edges(cor_phage_ko, cor_threshold, fdr_threshold, "Phage-KO")

# 合并所有边
edges_df <- bind_rows(edges_bacteria_ko, edges_bacteria_phage, edges_phage_ko)

if (nrow(edges_df) > 0) {
  cat("网络边数:\n")
  cat("  细菌-KO:", nrow(edges_bacteria_ko), "\n")
  cat("  细菌-噬菌体:", nrow(edges_bacteria_phage), "\n")
  cat("  噬菌体-KO:", nrow(edges_phage_ko), "\n")
  cat("  总计:", nrow(edges_df), "\n")

  write.csv(edges_df, path_target("05_tripartite_network_edges.csv"), row.names = FALSE)
} else {
  cat("当前阈值下没有足够的边，尝试降低阈值...\n")
}
```

```{r}
#| label: network-visualization
#| fig-width: 14
#| fig-height: 12

if (nrow(edges_df) > 0) {

  # 创建节点列表并确定类型
  all_nodes <- unique(c(edges_df$from, edges_df$to))

  # 使用cross_rcorr结果的行列名判断节点类型
  bacteria_names <- rownames(cor_bacteria_ko$r)
  phage_names <- rownames(cor_phage_ko$r)
  ko_names <- colnames(cor_bacteria_ko$r)

  node_type <- case_when(
    all_nodes %in% bacteria_names ~ "Bacteria",
    all_nodes %in% phage_names ~ "Phage",
    all_nodes %in% ko_names ~ "KO",
    TRUE ~ "Unknown"
  )

  nodes_df <- data.frame(
    name = all_nodes,
    type = node_type,
    label = stringr::str_trunc(all_nodes, 20),
    stringsAsFactors = FALSE
  )

  # 创建igraph对象
  g <- graph_from_data_frame(edges_df, directed = FALSE, vertices = nodes_df)

  # 重要：为布局算法创建正权重
  E(g)$layout_weight <- abs(E(g)$weight)

  # 绘制网络
  p_network <- ggraph(g, layout = "fr", weights = E(g)$layout_weight) +
    geom_edge_link(
      aes(color = type, width = abs(weight),
          linetype = ifelse(weight > 0, "positive", "negative")),
      alpha = 0.6
    ) +
    geom_node_point(aes(color = type), size = 5) +
    geom_node_text(aes(label = label), repel = TRUE, size = 2.5) +
    scale_edge_color_manual(
      values = c("Bacteria-KO" = "#1B9E77",
                 "Bacteria-Phage" = "#D95F02",
                 "Phage-KO" = "#7570B3")
    ) +
    scale_edge_linetype_manual(
      values = c("positive" = "solid", "negative" = "dashed"),
      name = "Correlation"
    ) +
    scale_color_manual(
      values = c("Bacteria" = "#66C2A5", "Phage" = "#FC8D62", "KO" = "#8DA0CB")
    ) +
    theme_void() +
    labs(
      title = "Tripartite Interaction Network",
      subtitle = "Bacteria - Phage - KO associations (|r| > 0.5, FDR < 0.25)\nSolid = positive, Dashed = negative",
      edge_color = "Edge Type", color = "Node Type"
    ) +
    theme(plot.title = element_text(size = 14, face = "bold"), legend.position = "right")

  print(p_network)

  ggsave(path_target("06_tripartite_network.png"), p_network, width = 14, height = 12, dpi = 300)

} else {
  cat("边数不足，无法绘制网络图\n")
}
```

# Part 5: 结果汇总

```{r}
#| label: summary

cat("
================================================================================
                    03b 病毒组-功能整合分析 结果汇总
================================================================================

【数据概况】
- 共同样本数: ", length(common_samples), "
- 噬菌体 OTU 数 (过滤后): ", nrow(phage_abundance_filtered), "
- 细菌 OTU 数 (过滤后): ", nrow(bacteria_abundance_filtered), "
- KO 数 (过滤后): ", nrow(ko_abundance_filtered), "
- Pathway 数 (过滤后): ", nrow(pathway_abundance_filtered), "

【噬菌体-KO 关联分析】
- 显著关联数 (FDR < 0.05): ", n_sig_005, "
- 显著关联数 (FDR < 0.10): ", n_sig_010, "
- 显著关联数 (FDR < 0.25): ", n_sig_025, "

【噬菌体-Pathway 关联分析】
- 显著关联数 (FDR < 0.05): ", n_sig_pathway_005, "
- 显著关联数 (FDR < 0.10): ", n_sig_pathway_010, "
- 显著关联数 (FDR < 0.25): ", n_sig_pathway_025, "

【三角互作网络】
- 细菌-KO 显著关联: ", n_sig_bac_ko, " (FDR < 0.25)
- 细菌-噬菌体 显著关联: ", n_sig_bac_phage, " (FDR < 0.25)
- 噬菌体-KO 显著关联: ", n_sig_025, " (FDR < 0.25)

【科学意义】
1. 噬菌体-功能关联揭示了噬菌体可能通过影响细菌群落间接调控代谢功能
2. 三角互作网络展示了 CagA 感染环境下细菌-噬菌体-功能的协同变化模式
3. 这些发现补充了 02 分析中的物种-功能关联，提供了病毒组视角

================================================================================
")
```

```{r}
#| label: session-info

cat("\n【分析环境信息】\n")
cat("R版本:", R.version.string, "\n")
cat("分析日期:", format(Sys.time(), "%Y-%m-%d %H:%M:%S"), "\n")
cat("工作目录:", getwd(), "\n")
```

# Part 6: 科学结论与讨论

## 6.1 主要发现

本分析整合了病毒组（Lyrebird噬菌体）与功能组（HUMAnN KO/Pathway）数据，构建了细菌-噬菌体-功能的三角互作网络。

**核心发现：**

1. **噬菌体-功能关联广泛存在**
   - 噬菌体与KO之间存在大量显著相关（FDR<0.05: 2877对），表明噬菌体丰度变化与宿主菌群的代谢功能密切相关
   - 噬菌体与代谢通路的关联相对较少（FDR<0.05: 337对），可能反映了通路水平的功能冗余性

2. **细菌-噬菌体协同模式**
   - 细菌-噬菌体显著关联数量最多，反映了噬菌体与其潜在宿主细菌之间的共变化模式
   - 正相关可能代表溶原状态下的共存关系，负相关可能反映裂解周期的捕食关系

3. **三角互作网络特征**
   - 网络高度连通，显示CagA感染环境下微生物组各层次之间的紧密联系
   - 噬菌体同时与细菌和功能模块相关联，支持"噬菌体通过调控细菌群落间接影响功能"的假说

## 6.2 与前期分析的整合

| 分析模块 | 主要发现 | 03b的补充 |
|----------|----------|-----------|
| 01 物种多样性 | CagA+组物种组成显著变化 | 噬菌体也呈现类似的组间差异模式 |
| 02 功能分析 | 特定KO/Pathway与CagA状态关联 | 这些功能变化部分可由噬菌体-宿主互作解释 |
| 03 SingleM/Lyrebird | 噬菌体多样性与处理组相关 | 噬菌体多样性变化与功能组变化存在关联 |

## 6.3 研究局限性

1. **样本量限制**：仅9个共同样本，导致：
   - 部分相关系数达到极端值（r=1或-1）
   - 统计检验力有限，可能存在假阳性
   - 建议后续研究扩大样本量验证

2. **因果关系推断**：相关性分析无法确定因果方向
   - 噬菌体变化可能是因（主动调控），也可能是果（响应细菌变化）
   - 需要实验验证或时间序列数据支持

3. **功能注释局限**：噬菌体OTU缺乏详细的分类学和功能注释

## 6.4 科学意义

本分析首次在pc047项目中系统性地整合了病毒组与功能组数据，主要贡献包括：

1. **方法学创新**：建立了噬菌体-细菌-功能三角互作分析框架，可应用于其他微生物组研究
2. **机制提示**：CagA感染可能通过调控噬菌体-细菌平衡间接影响菌群功能
3. **数据资源**：生成了完整的相关性矩阵和网络边列表，为后续深入分析提供基础

---

## Files written

These files have been written to the target directory, `r paste0("data/", params$name)`:

```{r}
#| label: list-files-target
projthis::proj_dir_info(path_target(), tz = "CET") |> knitr::kable()
```
