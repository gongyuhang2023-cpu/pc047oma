# 02 功能分析 (Functional Profiling) - 学习笔记

**文件**: `02_functional_profiling.qmd`
**学习日期**: 2026-01-11
**参考**: OMA Chapter 16-20, HUMAnN4 Analysis Protocol

---

## 目录

1. [分析目标与逻辑](#1-分析目标与逻辑)
2. [HUMAnN数据理解](#2-humann数据理解)
3. [功能多样性分析](#3-功能多样性分析)
4. [通路差异丰度分析](#4-通路差异丰度分析)
5. [KO基因家族分析](#5-ko基因家族分析)
6. [驱动物种分析](#6-驱动物种分析)
7. [物种-功能整合分析](#7-物种-功能整合分析)
8. [结果汇总与生物学意义](#8-结果汇总与生物学意义)

---

## 1. 分析目标与逻辑

### 1.1 核心问题

> **CagA依赖性感染是否改变了肠道微生物的代谢功能潜力？**

### 1.2 分析逻辑链

```
01分析回答："Who is there?"（物种组成）
    → 发现细菌Beta多样性显著改变 (P=0.012)

02分析回答："What are they capable of?"（功能潜力）
    → 验证"Functional Footprint"假说
```

### 1.3 分析大纲

| Part | 内容 | 问题 |
|------|------|------|
| Part 1 | HUMAnN数据导入 | 理解功能注释数据结构 |
| Part 2 | 功能多样性 | 功能Alpha/Beta多样性是否改变？ |
| Part 3 | 通路DAA | 哪些代谢通路发生变化？ |
| Part 4 | 驱动物种 | 谁贡献了这些功能？ |
| Part 5 | KO分析 | 更精细的基因水平差异 |
| Part 6 | 物种-功能整合 | 物种和功能的关联模式 |

---

## 2. HUMAnN数据理解

### 2.1 什么是HUMAnN？

**HUMAnN** (HMP Unified Metabolic Analysis Network) 是功能宏基因组分析的标准工具。

**类比理解**：
- Kraken/Bracken告诉你"工厂里有哪些工人"
- HUMAnN告诉你"这些工人能做什么工作"

### 2.2 HUMAnN输出的三种数据

| 数据类型 | 含义 | 用途 |
|----------|------|------|
| **Gene families** | 基因家族丰度（UniRef90） | 最精细的功能单元 |
| **Pathways** | 代谢通路丰度（MetaCyc） | **本分析主要使用** |
| **KOs** | KEGG直系同源基因 | 基因水平功能分析 |

### 2.3 Stratified vs Unstratified

| 版本 | 含义 | 用途 |
|------|------|------|
| **Unstratified** | 通路总丰度 | 多样性分析、DAA |
| **Stratified** | 按物种分解的丰度 | 驱动物种分析 |

**示例**：
```
# Unstratified
PWY-7219: adenosine ribonucleotides de novo biosynthesis  →  总丰度 = 100 CPM

# Stratified
PWY-7219|g__Bacteroides.s__Bacteroides_uniformis  →  60 CPM
PWY-7219|g__Muribaculum.s__Muribaculum_intestinale  →  40 CPM
```

### 2.4 特殊行说明

| 行 | 含义 |
|----|------|
| **UNMAPPED** | 无法比对到已知序列的reads |
| **UNINTEGRATED** | 比对成功但未能整合到通路 |

这些行在分析前需要**移除**。

---

## 3. 功能多样性分析

### 3.1 与物种多样性的对应关系

| 物种分析 | 功能分析 | 问的问题 |
|----------|----------|----------|
| Alpha多样性 | 功能Alpha多样性 | 有多少种代谢通路？ |
| Beta多样性 | 功能Beta多样性 | 通路组成是否不同？ |

### 3.2 Alpha多样性分析

```r
# 使用mia包计算（与01分析一致）
tse <- addAlpha(tse, assay.type = "abundance",
                index = c("shannon", "observed"))

# Wilcoxon检验
wilcox.test(humann_observed_richness ~ treatment_group, data = colData(tse))
```

**结果**：功能Alpha多样性**无显著差异**

### 3.3 Beta多样性分析

```r
# Bray-Curtis距离 + PCoA
tse <- addMDS(tse, method = "bray", assay.type = "relabundance")

# PERMANOVA检验
getPERMANOVA(tse, formula = x ~ treatment_group)
```

**结果**：
- **P = 0.012**，功能组成显著不同
- **R² = 33.1%**，组间差异解释了33%的功能变异

### 3.4 关键发现：与物种多样性的对比

| 分析层面 | Alpha多样性 | Beta多样性 |
|----------|-------------|------------|
| 物种组成(01) | p=0.73 | **p=0.012** |
| 功能通路(02) | p≈0.73 | **p=0.012** |

**解读**：物种和功能层面表现出**一致的模式**——整体多样性不变，但组成结构显著改变。

---

## 4. 通路差异丰度分析 (DAA)

### 4.1 为什么使用MaAsLin2？

根据HUMAnN4 Protocol推荐：

| 方法 | 优点 | 参数设置 |
|------|------|----------|
| **MaAsLin2** | 专门处理微生物组的组成性和稀疏性 | normalization="NONE", transform="LOG" |

**注意**：HUMAnN输出已是CPM标准化数据，无需再次标准化！

### 4.2 MaAsLin2参数详解

```r
Maaslin2(
  input_data = pathway_matrix,
  input_metadata = metadata,
  fixed_effects = c("treatment_group"),
  normalization = "NONE",    # 已是CPM，不再标准化
  transform = "LOG",         # 对数转换稳定方差
  analysis_method = "LM",    # 线性模型
  correction = "BH",         # FDR校正
  min_prevalence = 0.1       # 至少10%样本中存在
)
```

### 4.3 结果解读

**通路水平结果**：
- 显著差异通路 (q < 0.05): **0个**
- 趋势性差异 (q < 0.1): 少数

**这意味着什么？**
- 整体代谢功能潜力在两组间**保持稳定**
- 支持**"功能冗余"假说**

### 4.4 什么是功能冗余？

| 物种组成 | 功能通路 | 现象 |
|----------|----------|------|
| **显著变化** (P=0.012) | 无显著差异 | **功能冗余** |

**生物学解释**：
- 不同物种可以执行**相似的代谢功能**
- 即使物种A减少，物种B可以"接手"相同工作
- 这是微生物生态系统的**稳定性机制**

---

## 5. KO基因家族分析

### 5.1 为什么需要KO分析？

当通路水平未发现显著差异时，需要更精细的分析：

| 分析层级 | 粒度 | 类比 |
|----------|------|------|
| Pathway | 粗 | 一个工厂 |
| **KO** | 细 | 工厂里的具体工人 |

**关键酶或毒力因子可能在KO水平显示差异，即使通路总体不变。**

### 5.2 KO分析流程

```r
# 1. 创建KO的TSE对象
tse_ko <- TreeSummarizedExperiment(assays = list(counts = ko_matrix))

# 2. CPM标准化
ko_cpm <- sweep(ko_counts, 2, colSums(ko_counts), "/") * 1e6

# 3. MaAsLin2分析
Maaslin2(input_data = ko_cpm, fixed_effects = "treatment_group")
```

### 5.3 KO分析结果

| 阈值 | 显著KO数 |
|------|----------|
| q < 0.05 | 0 |
| q < 0.10 | 少数 |
| q < 0.25 | 若干趋势性差异 |

**结论**：KO水平同样未发现大量显著差异，进一步支持功能冗余假说。

---

## 6. 驱动物种分析

### 6.1 什么是驱动物种分析？

> **问题**：即使通路总丰度不变，是由**相同的物种**还是**不同的物种**在贡献？

**使用Stratified数据**追溯每个通路由哪些物种贡献。

### 6.2 分析逻辑

```
Part 3: Unstratified数据 → 发现Top差异通路
    ↓
Part 4: Stratified数据 → 追溯谁在贡献这些通路
```

### 6.3 可能的发现模式

| 模式 | 含义 | 生物学意义 |
|------|------|------------|
| **功能替代** | 同一通路由不同物种主导 | 群落结构变化但功能保持 |
| **关键驱动物种** | 特定物种在多个通路中贡献变化 | 可作为后续研究靶点 |

### 6.4 可视化方法

1. **热图**：展示Top通路的物种贡献
2. **堆叠条形图**：比较两组中物种贡献比例
3. **点图**：物种在不同通路中的贡献差异

---

## 7. 物种-功能整合分析

### 7.1 分析目的

即使DAA未发现显著差异，物种和功能之间的**关联模式**仍有价值：

> 如果01分析发现的差异物种与特定功能强相关，这仍具有生物学意义。

### 7.2 使用OMA的getCrossAssociation()

```r
# 计算物种-KO相关性矩阵
cross_cor <- getCrossAssociation(
  tse_species,
  tse_ko,
  method = "spearman",
  mode = "matrix"
)
```

### 7.3 结果：78对显著关联

| 发现 | 数量 |
|------|------|
| 显著物种-KO关联 (FDR < 0.05) | **78对** |
| 涉及物种数 | 29个 |
| 涉及KO数 | 45个 |

**生物学意义**：
- 虽然组间功能差异不显著，但特定物种确实承担特定功能
- 这29个物种和45个KO构成了**潜在的CagA-菌群-肿瘤调控网络**
- 为后续整合肿瘤/免疫数据提供**候选靶点**

---

## 8. 结果汇总与生物学意义

### 8.1 统计结果一览

| 分析 | 方法 | 结果 | P/q值 |
|------|------|------|-------|
| 功能Alpha多样性 | Shannon/Wilcoxon | 无差异 | ~0.73 |
| 功能Beta多样性 | Bray-Curtis/PERMANOVA | **有差异** | 0.012 |
| 通路DAA | MaAsLin2 | 无显著差异 | q > 0.05 |
| KO DAA | MaAsLin2 | 趋势性差异 | q > 0.05 |
| 物种-KO关联 | Spearman | **78对显著** | FDR < 0.05 |

### 8.2 核心科学结论

```
┌─────────────────────────────────────────────────────────────┐
│  功能冗余现象 (Functional Redundancy)                        │
│                                                              │
│  ✓ 物种组成改变（01分析 Beta P=0.012）                       │
│  ✓ 功能组成改变（02分析 Beta P=0.012）                       │
│  ✗ 但具体通路无显著差异                                      │
│  ✓ 物种-功能存在强关联（78对）                              │
│                                                              │
│  → 不同物种执行相似功能，整体代谢潜力保持稳定                 │
└─────────────────────────────────────────────────────────────┘
```

### 8.3 与PC047项目假说的契合度分析

#### PC047核心假说回顾

> **"Functional Footprint"假说**：CagA感染永久性改变微生物群落结构，改变后的群落产生**特定代谢物**，驱动CD8+ T细胞持续激活。

#### 假说对02分析的预期

根据假说，02分析**预期应该发现**：
- 在ApcMUT_HpWT组中有**显著富集的代谢通路**
- 这些通路产生的代谢物可能驱动T细胞激活

#### 实际结果 vs 预期

| 分析 | 假说预期 | 实际结果 | 契合度 |
|------|----------|----------|--------|
| 功能Beta多样性 | 显著差异 | **P=0.012 显著** | ✓ 支持 |
| 通路DAA | 显著富集的通路 | **无显著 (q>0.05)** | ✗ 不符预期 |
| KO DAA | 显著差异的基因 | 趋势性差异 | 部分支持 |
| 物种-功能关联 | 存在关联 | **78对显著** | ✓ 支持 |

#### 关键发现：功能冗余现象

**功能冗余（Functional Redundancy）** 是微生物生态学的经典概念（非PC047特有）：
- 不同物种可以执行**相同的代谢功能**
- 物种A减少时，物种B可以"接手"相同工作
- 这是生态系统**稳定性机制**

#### 对假说的影响

```
┌─────────────────────────────────────────────────────────────┐
│  02分析 **部分支持** "Functional Footprint"假说              │
│                                                              │
│  ✓ 支持的部分：                                              │
│    - 功能组成确实有差异（Beta P=0.012）                       │
│    - 物种-功能存在强关联（78对，候选靶点）                    │
│                                                              │
│  ✗ 未符合预期的部分：                                        │
│    - 没有找到"显著富集的代谢通路"                            │
│    - 功能层面无法直接解释T细胞激活机制                        │
│                                                              │
│  假说验证进度：Step 2 部分完成，核心预期未实现                │
└─────────────────────────────────────────────────────────────┘
```

#### 假说没有被推翻，但机制更复杂

| 可能解释 | 说明 | 后续研究方向 |
|----------|------|--------------|
| **层级问题** | 效应不在"通路丰度"层面，而在**具体代谢物**层面 | 需要代谢组学数据 |
| **特定物种效应** | 可能是特定物种产生的**特异性分子** | 聚焦01分析的差异物种 |
| **非代谢机制** | T细胞激活可能是**直接免疫互作**介导 | 需要免疫学数据 |
| **功能冗余** | 通路总量不变，但产物可能有**细微差异** | 更精细的代谢物分析 |

### 8.4 对PC047项目的实际意义

1. **CagA不是通过改变"整体功能"影响肿瘤**
   - 代谢通路层面无显著差异（功能冗余）

2. **可能的机制**：
   - 特定物种产生的**特异性代谢物**（非通路水平）
   - 物种与宿主的**直接免疫互作**
   - 需要**代谢组学数据**进一步验证

3. **候选靶点**：
   - 29个关联物种
   - 45个关联KO
   - 可用于后续整合肿瘤/T细胞表型数据

4. **下一步建议**：
   - 如果有代谢组学数据，优先分析
   - 整合肿瘤负担/T细胞数据，验证物种-功能-表型关联
   - 考虑单菌培养验证候选物种的代谢产物

### 8.4 与01分析的呼应

| 01分析发现 | 02分析验证 |
|------------|-----------|
| Alpha不变，Beta显著 | 功能层面同样模式 |
| 群落重组 | 功能冗余现象 |
| DAA发现趋势物种 | 物种-功能关联印证 |

---

## 与后续分析的关联

### 为03分析奠定基础

| 02分析提供 | 03分析将使用 |
|------------|-------------|
| 功能冗余结论 | 验证是否通过噬菌体间接影响 |
| 物种-KO关联矩阵 | 扩展到细菌-噬菌体-功能三角网络 |

### 保存的关键文件

```r
# TSE对象
saveRDS(tse_humann_pathway_ca, "tse_humann_pathway_ca.rds")
saveRDS(tse_ko, "tse_humann_ko.rds")

# 分析结果
write.csv(maaslin2_summary, "05_daa_maaslin2_humann_pathway_full.csv")
write.csv(ko_sig_list, "19_significant_KOs.csv")
write.csv(taxa_ko_correlations, "20_taxa_ko_correlation_heatmap.csv")
```

---

## 关键术语速查表

| 术语 | 英文 | 简单解释 |
|------|------|----------|
| HUMAnN | HMP Unified Metabolic Analysis Network | 功能宏基因组分析工具 |
| Pathway | 代谢通路 | 一系列生化反应组成的代谢过程 |
| KO | KEGG Orthology | KEGG数据库定义的基因功能单元 |
| CPM | Counts Per Million | 每百万reads中的计数，标准化方法 |
| Stratified | 分层的 | 按物种分解的数据 |
| Unstratified | 未分层的 | 总丰度数据 |
| 功能冗余 | Functional Redundancy | 不同物种执行相同功能的现象 |
| 驱动物种 | Driver Species | 对功能变化贡献最大的物种 |
| MaAsLin2 | - | 微生物组多变量关联线性模型工具 |

---

## 9. Part 8 扩展分析 - 2×3因子设计（2026-01-17 新增）

### 9.1 分析背景

Part 8 将功能分析从核心双组比较扩展为完整的 2×3 因子设计，与 01 Part 4 保持一致：

| 因子 | 水平 | 说明 |
|------|------|------|
| **Genotype** | ApcWT, ApcMUT | 2个水平 |
| **Infection** | Ctrl, HpKO, HpWT | 3个水平 |

### 9.2 核心发现

#### betadisper 方差齐性检验

| Factor | F值 | P值 | 解读 |
|--------|-----|-----|------|
| Treatment (6组) | 1.61 | 0.168 | 方差齐性 ✓ |
| Genotype | 1.68 | 0.214 | 方差齐性 ✓ |
| Infection | 1.70 | 0.185 | 方差齐性 ✓ |

#### Alpha 多样性

| 效应 | F值/统计量 | P值 | 显著性 |
|------|------------|-----|--------|
| Kruskal-Wallis (6组) | 12.91 | **0.024** | ⭐ |
| **Genotype 主效应** | 6.09 | **0.021** | ⭐ |
| Infection 主效应 | 2.23 | 0.127 | - |
| Genotype×Infection 交互 | 2.96 | 0.070 | 边缘 |

#### Beta 多样性 PERMANOVA (2×3)

| 效应 | Df | R² | F值 | P值 | 解读 |
|------|-----|-----|-----|-----|------|
| Genotype | 1 | 3.6% | 1.11 | 0.302 | 不显著 |
| Infection | 2 | 3.4% | 0.53 | 0.769 | 不显著 |
| Genotype×Infection | 2 | 8.7% | 1.34 | 0.223 | 无交互 |

### 9.3 功能冗余假说的验证

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  物种 vs 功能 对比 (2×3 因子设计)                                             │
│                                                                              │
│  物种 Beta 多样性（01 Part 4）：                                              │
│    • Genotype×Infection 交互作用：p = 0.024 ✓ 显著                           │
│    • CagA效应@变异鼠：p = 0.007，R² = 33.6% ✓                                │
│                                                                              │
│  功能 Beta 多样性（02 Part 8）：                                              │
│    • Genotype×Infection 交互作用：p = 0.223 ✗ 不显著                         │
│    • 所有效应均不显著                                                         │
│                                                                              │
│  结论：功能冗余假说得到支持                                                    │
│    → 物种组成改变但功能组成稳定                                               │
│    → 不同物种可执行相似的代谢功能                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 9.4 NotebookLM 解读：功能冗余的生物学意义

根据 OMA book 的解释：

1. **功能冗余定义**
   - 许多在系统发育上完全不同的物种能够执行相同或相似的代谢功能
   - "谁在那里" vs "它们在做什么" 是两个独立的问题

2. **本研究的证据**
   - 物种Beta显著：说明群落"成员名单"发生了实质性偏移
   - 功能Beta不显著：说明群落的"代谢潜力"在宏观尺度上保持稳定

3. **如果功能稳定但物种改变，可能的致病机制**
   - **活性表达 vs 基因潜力**：疾病可能由转录活性（RNA）而非基因存在（DNA）驱动
   - **物种特异性免疫激发**：虽然功能相同，但不同物种的细胞壁成分可能激活不同免疫反应
   - **株系水平变异**：同一物种的不同株系可能携带微小遗传差异
   - **功能贡献者的更替**：Stratified数据可能揭示执行同一功能的物种发生了替换

### 9.5 对假说的影响

| 原假说预期 | 实际发现 | 调整后的理解 |
|------------|----------|--------------|
| 应找到显著富集的通路 | 功能Beta无差异 | 效应可能在**代谢物层面**而非通路丰度 |
| 代谢功能应该改变 | 组成变了但整体功能稳定 | **功能冗余**是肠道生态系统的保护机制 |
| 直接的代谢变化 | 无显著差异 | 可能是**特定物种的特异性产物**或**免疫互作** |

### 9.6 后续研究建议

1. **宏转录组分析**：检测功能基因的实际表达水平
2. **Stratified数据分析**：观察功能的物种贡献者是否改变
3. **代谢组学验证**：直接测定代谢物水平
4. **株系水平分析**：使用StrainPhlAn检测株系变异

---

*2026-01-17 更新 | Part 8 扩展分析*

---

**下一步**：阅读 `03_singlem_diversity_learning_notes.md` 了解SingleM/Lyrebird分析

---

*笔记由 Claude 协助整理 | 参考 OMA Chapter 16-20, HUMAnN4 Protocol*
