# 03c 共现网络分析 (Co-occurrence Network Analysis) - 学习笔记

**文件**: `03c_cooccurrence_network_analysis.qmd`
**学习日期**: 2026-01-20
**参考**: OMA Chapter 10 (Community Ecology), igraph Documentation

---

## 目录

1. [分析目标与逻辑](#1-分析目标与逻辑)
2. [共现网络基础概念](#2-共现网络基础概念)
3. [网络构建方法](#3-网络构建方法)
4. [网络拓扑指标](#4-网络拓扑指标)
5. [分析结果解读](#5-分析结果解读)
6. [对假说的支持](#6-对假说的支持)

---

## 1. 分析目标与逻辑

### 1.1 核心问题

> **CagA感染如何改变肠道菌群物种间的相互作用模式？**

前序分析已经回答：
- 01分析：**谁在那里？** → 物种组成改变 (Beta P=0.012)
- 02分析：**它们能做什么？** → 功能冗余（整体稳定）

03c分析回答：
- **它们如何互动？** → 物种间的共现/互斥关系

### 1.2 分析逻辑

```
物种组成改变（01分析）
    ↓
功能冗余（02分析）
    ↓ 为什么功能冗余？
共现网络分析（03c）→ 物种间互作模式改变
                    → 模块结构瓦解
                    → 生态位重叠增加
```

### 1.3 分析大纲

| Part | 内容 | 问题 |
|------|------|------|
| Part 1 | 数据加载 | 准备丰度矩阵 |
| Part 2 | 细菌网络构建 | 物种间相关性网络 |
| Part 3 | 跨域网络 | 细菌-噬菌体互作 |
| Part 4 | 网络比较 | CagA效应分析 |

---

## 2. 共现网络基础概念

### 2.1 什么是共现网络？

**共现网络 (Co-occurrence Network)** 是一种将物种间相关性可视化为图的方法：

| 元素 | 含义 | 类比 |
|------|------|------|
| **节点 (Node)** | 物种 | 社交网络中的人 |
| **边 (Edge)** | 物种间相关性 | 人与人的关系 |
| **边权重** | 相关系数 | 关系强度 |
| **边符号** | 正/负相关 | 朋友/敌人 |

### 2.2 生物学解读

| 相关类型 | 含义 | 可能机制 |
|----------|------|----------|
| **正相关** | 共同出现 | 互利共生、相似生态位 |
| **负相关** | 互斥出现 | 竞争、拮抗 |
| **无相关** | 独立 | 无直接互作 |

**注意**：相关性 ≠ 因果性！共现可能是：
- 直接互作（代谢物交换）
- 间接互作（共同响应环境）
- 第三因素驱动

### 2.3 为什么用网络而不只看多样性？

| 分析类型 | 问的问题 | 局限性 |
|----------|----------|--------|
| Alpha多样性 | 有多少物种？ | 忽略物种身份 |
| Beta多样性 | 物种组成是否不同？ | 忽略物种互作 |
| **网络分析** | 物种如何相互作用？ | 补充前两者 |

---

## 3. 网络构建方法

### 3.1 相关性计算

使用Spearman相关系数（对秩而非绝对值）：

```r
# Spearman相关 - 对组成型数据更稳健
cor_matrix <- cor(t(bacteria_relab), method = "spearman")
```

**为什么用Spearman而不是Pearson？**
- 微生物组数据通常非正态分布
- 相对丰度数据（组成型数据）有特殊统计性质
- Spearman对异常值更稳健

### 3.2 网络阈值设定

不是所有相关性都建立边，需要过滤：

```r
# 常用阈值
cor_threshold <- 0.5        # 相关系数绝对值
p_threshold <- 0.05         # P值
adj_matrix <- abs(cor_matrix) >= cor_threshold
```

**阈值选择考虑**：
- 阈值太低：网络太密，噪声多
- 阈值太高：网络太稀，丢失信息
- 通常 |r| > 0.5 或 0.6

### 3.3 图构建

使用igraph包：

```r
library(igraph)

# 从邻接矩阵创建图
g <- graph_from_adjacency_matrix(adj_matrix, mode = "undirected")

# 添加边属性（权重和符号）
E(g)$weight <- cor_values
E(g)$sign <- ifelse(cor_values > 0, "positive", "negative")
```

### 3.4 物种数限制

**重要经验**：样本数太少时不能用太多物种！

```r
# 经验法则：物种数不超过样本数的10-20倍
max_species <- min(100, n_samples * 20)

# 选择高丰度物种
top_species <- names(sort(rowMeans(abundance), decreasing = TRUE))[1:max_species]
```

**原因**：
- 样本数=4-5时，计算9000×9000相关矩阵无意义
- 统计自由度太低，相关系数不可靠
- 计算量巨大

---

## 4. 网络拓扑指标

### 4.1 基本指标

| 指标 | 英文 | 计算方法 | 生物学意义 |
|------|------|----------|------------|
| **节点数** | Nodes | 图中顶点数 | 参与互作的物种数 |
| **边数** | Edges | 图中边数 | 物种间关联数 |
| **密度** | Density | 边数/最大可能边数 | 网络连接紧密程度 |

### 4.2 模块度 (Modularity) - 最重要的指标

```r
# 使用Louvain算法检测社区
communities <- cluster_louvain(g)
modularity_score <- modularity(communities)
```

**模块度含义**：

| 模块度值 | 含义 | 生物学解读 |
|----------|------|------------|
| **高 (>0.4)** | 网络有清晰模块结构 | 物种分化明显，各司其职 |
| **低 (<0.3)** | 网络混合 | 物种间界限模糊，功能重叠 |
| **0** | 随机网络 | 无结构 |

### 4.3 中心性指标

| 指标 | 英文 | 含义 | 用途 |
|------|------|------|------|
| **度 (Degree)** | degree | 连接边数 | 识别Hub物种 |
| **介数 (Betweenness)** | betweenness | 经过该点的最短路径数 | 识别桥梁物种 |
| **接近度 (Closeness)** | closeness | 到其他节点的平均距离 | 识别核心物种 |

```r
# 计算中心性（注意命名空间冲突！）
degree_cent <- igraph::degree(g)
betweenness_cent <- igraph::betweenness(g, weights = NA)
closeness_cent <- igraph::closeness(g, weights = NA)
```

**注意**：`degree`函数与`ape`包冲突，必须显式使用`igraph::degree`！

### 4.4 聚类系数 (Transitivity)

```r
transitivity(g, type = "global")
```

**含义**：如果A与B连接，B与C连接，A与C也连接的概率

- 高聚类系数：物种形成紧密小团体
- 低聚类系数：物种关系分散

---

## 5. 分析结果解读

### 5.1 网络拓扑比较

**表1. CagA效应对网络结构的影响（Top 100高丰度物种）**

| 指标 | ApcMUT_HpKO (对照) | ApcMUT_HpWT (CagA+) | 变化 |
|------|-------------------|---------------------|------|
| 节点数 | 80 | 100 | +20 |
| 边数 | 1,280 | 2,190 | **+910 (+71%)** |
| 网络密度 | 0.405 | 0.442 | +0.037 |
| **模块度** | **0.468** | **0.177** | **-0.291 (-62%)** |
| 聚类系数 | 0.771 | 0.796 | +0.025 |

### 5.2 核心发现：模块度显著降低

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  CagA感染导致网络模块度降低62%                                               │
│                                                                              │
│  HpKO (对照): 模块度 = 0.468                                                 │
│  ┌─────┐   ┌─────┐   ┌─────┐                                               │
│  │模块A│   │模块B│   │模块C│    清晰的功能模块                              │
│  │ ○○○ │   │ ○○○ │   │ ○○○ │    物种各司其职                                │
│  └──┬──┘   └──┬──┘   └──┬──┘                                               │
│     └────────┴────────┘                                                     │
│                                                                              │
│  HpWT (CagA+): 模块度 = 0.177                                                │
│  ┌─────────────────────────┐                                                │
│  │    ○ ○ ○ ○ ○ ○ ○ ○     │    模块结构瓦解                                │
│  │   ○ ○ ○ ○ ○ ○ ○ ○ ○    │    物种间界限模糊                              │
│  │    ○ ○ ○ ○ ○ ○ ○ ○     │                                                │
│  └─────────────────────────┘                                                │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 Hub物种（网络枢纽）

**Top 5 Hub物种（按度排序）**：

| 物种 | 度 | 介数 | 功能 |
|------|-----|------|------|
| *Blautia obeum* | 44 | 74.7 | SCFA生产者 |
| *Hungatella hathewayi* | 42 | 40.7 | 厌氧发酵 |
| *Roseburia hominis* | 42 | 47.6 | 丁酸生产者 |
| *Blautia parvula* | 42 | 40.7 | SCFA生产者 |
| *Marvinbryantia formatexigens* | 41 | 35.0 | 甲酸利用 |

**特征**：Hub物种主要是**厌氧梭菌类**，是肠道短链脂肪酸(SCFA)的主要生产者。

### 5.4 桥梁物种

*Parabacteroides distasonis* 介数中心性异常高(402.1)但度仅33：
- 连接不同功能模块的"桥梁"
- 可能是CagA影响群落结构的关键节点

---

## 6. 对假说的支持

### 6.1 解释功能冗余机制

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  为什么物种变化但功能稳定？网络分析给出答案                                    │
│                                                                              │
│  模块度降低 → 物种间界限模糊 → 生态位重叠增加 → 功能可相互替代                │
│                                                                              │
│  正常群落：                                                                   │
│    物种A执行功能1                                                            │
│    物种B执行功能2                                                            │
│    → 分工明确，效率高                                                        │
│                                                                              │
│  CagA感染后：                                                                 │
│    物种A'和B'都能执行功能1和2                                                │
│    → 功能冗余，但结构紊乱                                                    │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 对T细胞激活的启示

| 机制 | 网络证据 | 免疫学意义 |
|------|----------|------------|
| 群落结构紊乱 | 模块度降低62% | 抗原多样性改变 |
| Hub物种改变 | SCFA生产者互作模式变化 | 免疫调节改变 |
| 桥梁物种 | P. distasonis高介数 | 可能是关键免疫调节点 |

### 6.3 与其他分析的整合

| 分析 | 发现 | 网络分析补充 |
|------|------|--------------|
| 01分析 | 物种组成改变 | 物种**互作模式**也改变 |
| 02分析 | 功能冗余 | 因为模块结构瓦解导致功能重叠 |
| 03分析 | 噬菌体协同变化 | 可扩展到跨域网络 |

---

## 常见问题与技术要点

### Q1: 为什么限制Top 100物种？

- 样本数太少（4-5个）时，无法可靠估计大量物种间的相关性
- 计算 n×n 矩阵复杂度 O(n²)
- 聚焦高丰度物种更有生物学意义

### Q2: betweenness报错"Weight must be positive"

相关系数可以是负数，但betweenness要求正权重：
```r
# 解决方案：不使用权重
betweenness_cent <- igraph::betweenness(g, weights = NA)
```

### Q3: 如何处理标准差为0的物种？

某些物种在分组内丰度恒定时相关系数为NA：
```r
# 过滤标准差为0的物种
row_sds <- apply(abundance, 1, sd)
abundance_filtered <- abundance[row_sds > 0, ]
```

---

## 输出文件

| 文件 | 内容 |
|------|------|
| `01_bacteria_network_stats.csv` | 网络拓扑统计（含模块度） |
| `02_bacteria_hub_species.csv` | Hub物种中心性指标 |

---

## 关键术语速查表

| 术语 | 英文 | 简单解释 |
|------|------|----------|
| 共现网络 | Co-occurrence Network | 基于相关性的物种互作网络 |
| 模块度 | Modularity | 网络模块化程度的指标 |
| Hub物种 | Hub Species | 高连接度的核心物种 |
| 介数中心性 | Betweenness Centrality | 物种作为"桥梁"的重要性 |
| 聚类系数 | Transitivity | 网络中三角形闭合的程度 |
| Louvain算法 | Louvain Algorithm | 社区/模块检测算法 |

---

*笔记由 Claude 协助整理 | 参考 OMA Chapter 10, igraph Documentation*
