---
title: "Part 1: Alpha & Beta Diversity Analysis"
subtitle: "PC047 vCagAepitope - Brackenç‰©ç§ç»„æˆä¸ç¾¤è½ç»“æ„åˆ†æ"
author:
  - name: Gong Yuhang
date: today
toc: true
toc-depth: 4
number-sections: true
code-fold: true
code-line-numbers: true
code-tools: true
format:
  html:
    embed-resources: true
    smooth-scroll: true
    page-layout: full
    fig-width: 7.2
    fig-height: 5
    fig-dpi: 300
execute:
  warning: false
  message: false
reference-location: section
citation-location: document
params:
  name: "01_alpha_beta_diversity_analysis"
---

# ç ”ç©¶é—®é¢˜ {#sec-question}

> **æ ¸å¿ƒé—®é¢˜**ï¼šCagAè›‹ç™½æ˜¯å¦æ˜¾è‘—æ”¹å˜äº†å°é¼ è‚ é“å¾®ç”Ÿç‰©ç»„çš„ç¾¤è½ç»“æ„ï¼Ÿ
>
> **Functional Footprintå‡è¯´**ï¼šH. pylori CagAæ¥äº†åˆèµ°äº†ï¼Œä½†åœ¨è‚ é“å¾®ç”Ÿç‰©ç»„ä¸­ç•™ä¸‹äº†"åŠŸèƒ½è¶³è¿¹"â€”â€”
> è¿™ç§å¾®ç”Ÿç‰©ç»„æ”¹å˜å¯èƒ½æ˜¯CagAç‰¹å¼‚æ€§CD8+ Tç»†èƒæŒç»­æ´»åŒ–çš„é©±åŠ¨å› ç´ ã€‚

## åˆ†æèƒŒæ™¯

æœ¬æ–‡æ¡£æ˜¯PC047é¡¹ç›®çš„é¦–ä¸ªæ ¸å¿ƒåˆ†ææ¨¡å—ã€‚ç›®æ ‡æ˜¯è¯„ä¼°CagAä¾èµ–æ€§æ„ŸæŸ“æ˜¯å¦é‡å¡‘äº†å°é¼ ç›²è‚ å¾®ç”Ÿç‰©ç»„çš„ç¾¤è½å¤æ‚åº¦ã€‚

**æ ¸å¿ƒæ¯”è¾ƒ**ï¼š
- **ApcMUT_HpWT** (n=5): Apc^Min/+çªå˜å°é¼  + H. pylorié‡ç”Ÿå‹æ„ŸæŸ“ (CagA+)
- **ApcMUT_HpKO** (n=4): Apc^Min/+çªå˜å°é¼  + H. pylori CagAæ•²é™¤æ„ŸæŸ“ (CagA-)

## é¢„æœŸå‘ç°

åŸºäºFunctional Footprintå‡è¯´ï¼Œæˆ‘ä»¬é¢„æœŸï¼š

1. **Alphaå¤šæ ·æ€§**ï¼šå¯èƒ½æ— æ˜¾è‘—å·®å¼‚ï¼ˆç¾¤è½å¤æ‚åº¦ä¿æŒç¨³å®šï¼‰
2. **Betaå¤šæ ·æ€§**ï¼šé¢„æœŸæœ‰æ˜¾è‘—å·®å¼‚ï¼ˆç¾¤è½ç»„æˆå‘ç”Ÿæ”¹å˜ï¼‰
3. **ç‰©ç§æ°´å¹³ vs ç—…æ¯’æ°´å¹³**ï¼šStandardç»†èŒå’ŒViruså¯èƒ½å‘ˆç°ä¸åŒçš„å“åº”æ¨¡å¼

## æ–¹æ³•æ¦‚è¿°

| åˆ†æå†…å®¹ | æ–¹æ³• | é€‰æ‹©ç†ç”± |
|---------|------|----------|
| ç‰©ç§ç»„æˆ | Bracken (Kraken2) | é«˜ç²¾åº¦ç‰©ç§æ°´å¹³åˆ†ç±» |
| Alphaå¤šæ ·æ€§ | Shannon, Observed | ç¾¤è½å¤æ‚åº¦è¯„ä¼° |
| Betaå¤šæ ·æ€§ | Bray-Curtis, Aitchison | ç»„æˆå‹æ•°æ®è·ç¦»åº¦é‡ |
| ç»Ÿè®¡æ£€éªŒ | Wilcoxon, PERMANOVA | éå‚æ•°æ£€éªŒï¼Œé€‚åˆå°æ ·æœ¬ |
| å·®å¼‚ä¸°åº¦ | ANCOM-BC, ALDEx2 | ç»„æˆå‹æ•°æ®DAA |

---

```{r}
#| label: params
#| eval: !expr interactive()
#| include: false
params <- list(name = "01_alpha_beta_diversity_analysis")
```

```{r}
#| label: setup
#| message: false
#| include: false
#| warning: false
wd <- "analyses"
if (basename(getwd()) != wd) {
  setwd(here::here(wd))
}
here::i_am(paste0(params$name, ".qmd"), uuid = "50d69c11-b05a-4df7-a64e-de75a8a3850b")
projthis::proj_create_dir_target(params$name, clean = FALSE)
path_target <- projthis::proj_path_target(params$name)
path_source <- projthis::proj_path_source(params$name)
path_raw <- path_source("00-raw")
path_resource <- here::here(path_raw, "d00-resource")
path_data <- here::here(path_raw, paste0("d", params$name))
dir.create(path_raw, recursive = TRUE, showWarnings = FALSE)
dir.create(path_data, recursive = TRUE, showWarnings = FALSE)
dir.create(path_resource, recursive = TRUE, showWarnings = FALSE)
```

# ç¯å¢ƒè®¾ç½® {#sec-setup}

## åŒ…åŠ è½½ {#sec-packages}

```{r}
#| label: packages
#| message: false

suppressPackageStartupMessages({
  # æ•°æ®å¤„ç†
  library(here)
  library(conflicted)
  library(tidyverse)
  library(data.table)
  library(readxl)

  # å¾®ç”Ÿç‰©ç»„åˆ†æ
  library(mia)
  library(TreeSummarizedExperiment)
  library(miaViz)
  library(scuttle)
  library(scater)
  library(vegan)

  # å·®å¼‚ä¸°åº¦åˆ†æ
  library(ANCOMBC)
  library(ALDEx2)

  # å¯è§†åŒ–
  library(ggplot2)
  library(patchwork)
  library(ggpubr)
  library(ggsci)
  library(MatrixGenerics)

  devtools::load_all()
})

# è§£å†³å‘½åç©ºé—´å†²çª
conflicts_prefer(base::setdiff)
conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::select)
conflicts_prefer(dplyr::lag)
conflicts_prefer(dplyr::first)
conflicts_prefer(ggplot2::annotate)

set.seed(20261)
```

## å…¨å±€è®¾ç½® {#sec-theme}

```{r}
#| label: theme-setup

# åŠ è½½å…¬å…±å‡½æ•°
source(here::here("R", "functions.R"))

# è®¾ç½®å‘è¡¨çº§ä¸»é¢˜
theme_set(theme_publication())

# NPGé…è‰²
group_colors <- get_group_colors()

# è¾“å‡ºç›®å½•
output_dir <- here::here("data", params$name)
dir.create(output_dir, recursive = TRUE, showWarnings = FALSE)
```

---

# Part 1: Standardç»†èŒå¤šæ ·æ€§åˆ†æ {#sec-standard}
## 1.1 å¯¼å…¥æ•°æ®å¹¶æ„å»ºTreeSE
```{r}
# Step 1ï¼šå®šä¹‰å¯¼å…¥æ–‡ä»¶å‡½æ•°
read_bracken_standard_species <- function(path) {
  files <- list.files(path, pattern = "_S\\.tsv$", full.names = TRUE)

  abundance_list <- lapply(files, function(f) {
    df <- readr::read_tsv(f, show_col_types = FALSE)

    sample_id <- basename(f) |> stringr::str_extract("^[^_]+")

    tibble(
      feature = df$name,
      abundance = df$new_est_reads,
      sample = sample_id
    )
  })

  bind_rows(abundance_list)
}

# Step 2ï¼šæ„å»ºcount matrix
bracken_long_standard_species <- read_bracken_standard_species(
  here::here(
    "data",
    "00-raw",
    "d01_alpha_beta_diversity_analysis",
    "bracken_standard"
  )
)

count_mat_standard_species <- bracken_long_standard_species |>
  pivot_wider(
    names_from  = sample,
    values_from = abundance,
    values_fill = 0
  ) |>
  column_to_rownames("feature") |>
  as.matrix()

# dim(count_mat)
# head(rownames(count_mat))
# head(colnames(count_mat))
count_mat_standard_species 

# Step 3ï¼šæ„å»º tse_standard_species
tse_standard_species <- TreeSummarizedExperiment(
  assays = list(counts = count_mat_standard_species)
)
# tse_standard_species

# Step 4ï¼šæ„å»ºrowData
rowData(tse_standard_species)$Species <- rownames(tse_standard_species)
# tse_standard_species

# Step 5ï¼šç»‘å®š metadata
metadata <- readxl::read_xlsx(
  here::here("data", "metadata", "pc047-metadata.xlsx")
) |>
  column_to_rownames("sample_id")

common_samples <- base::intersect(
  colnames(tse_standard_species),
  rownames(metadata)
)

tse_standard_species <- tse_standard_species[, common_samples]
colData(tse_standard_species) <- DataFrame(metadata[common_samples, ])
# tse_standard_species

# Step 6.å»ºç«‹åªæœ‰ ca (caecum) çš„å­é›†
# ç­›é€‰é€»è¾‘ï¼šä¿ç•™ sample_type ç­‰äº "caecum" çš„åˆ—
tse_standard_species_ca <- tse_standard_species[, tse_standard_species$source_organ == "caecum"]
# tse_standard_species_ca
```

## 1.2 æ•°æ®æ¢ç´¢ä¸è´¨é‡æ§åˆ¶
### ç¬¬ä¸€éæ¸…æ´—(æ•°æ®æ¢ç´¢)
```{r}
# 1. è‡ªåŠ¨è®¡ç®—è´¨é‡æ§åˆ¶æŒ‡æ ‡ (Library Size)
# ä½¿ç”¨ scuttle åŒ…è®¡ç®—æ¯ä¸ªæ ·æœ¬çš„æ€» reads æ•°ï¼ˆæ–‡åº“å¤§å°ï¼‰
# è¿™ä¼šåœ¨ colData ä¸­ç”Ÿæˆ 'total' åˆ—
tse_standard_species_ca_1 <- tse_standard_species_ca
tse_standard_species_ca_1 <- addPerCellQCMetrics(tse_standard_species_ca_1)

# å¯è§†åŒ–æ–‡åº“å¤§å°åˆ†å¸ƒ
# å¦‚æœ sampling depth å·®å¼‚è¿‡å¤§ï¼ˆä¾‹å¦‚è¶…è¿‡ 40 å€ï¼‰ï¼Œå¯èƒ½éœ€è¦åç»­è¿‡æ»¤
p1 <- plotHistogram(tse_standard_species_ca_1, col.var = "total") +
  labs(title = "Library Size Distribution", x = "Total Reads")
p1

# ä¿å­˜å›¾è¡¨åˆ° data/01_alpha_beta_diversity_analysis æ–‡ä»¶å¤¹
ggsave(
  filename = here::here("data", params$name, "01_qc_library_size_cleaning1.png"),
  plot = p1,
  width = 8, height = 6, dpi = 300
)

tse_standard_species_ca_1

# 2. é’ˆå¯¹caçš„prevalenceåˆ†æä¸ æ¸…æ´—ï¼ˆprevalence ï¼10%ï¼‰
# ğŸŒ¸æ³¨æ„ï¼šåé¢å¦‚æœæ²¡æœ‰ç‰¹åˆ«è¯´æ˜ï¼Œéƒ½ä¸»è¦ä½¿ç”¨caç­›é€‰åçš„å­é›†ï¼Œä¹Ÿå°±æ˜¯tse_standard_species_ca
# å› ä¸ºå’±ä»¬çš„é¡¹ç›®ä¸»è¦æ˜¯åˆ†æè¿™ä¸€æ ·æœ¬çš„ä¸åŒå®éªŒç»„ï¼Œicæ˜¯å¦ä¸€ä¸ªæ ·æœ¬çš„æ•°æ®è¡¥å……ã€‚
tse_standard_species_ca_1 <- addPrevalence(
  tse_standard_species_ca_1,
  assay.type = "counts",
  detection = 0,
  as.relative = TRUE
)

rowData(tse_standard_species_ca_1)$prevalence <- as.numeric(rowData(tse_standard_species_ca_1)$prevalence)
summary(rowData(tse_standard_species_ca_1)$prevalence) # æŸ¥çœ‹æœ€å¤§å€¼ã€ä¸­ä½æ•°ç­‰
# æœ€å¤§å€¼ä¸è¶…è¿‡1ï¼Œæœ€å°ä¹Ÿå¤§è¿‡0ï¼Œè¯´æ˜æ²¡é—®é¢˜

p2 <- plotHistogram(tse_standard_species_ca_1, row.var = "prevalence") +
  labs(title = "Feature Prevalence Distribution", x = "Prevalence (Fraction of Samples)")
p2

# ä¿å­˜å›¾è¡¨
ggsave(
  filename = here::here("data", params$name, "02_qc_prevalence_distribution_cleaning1.png"),
  plot = p2,
  width = 8, height = 6, dpi = 300
)

# è·å–æ™®éæ€§å¤§äº 10% çš„ç‰©ç§åå•
prev_standard_species_ca_1 <- getPrevalent(tse_standard_species_ca_1, prevalence = 0.1)
# length(prev_standard_species_ca_1) # æŸ¥çœ‹æœ‰å¤šå°‘ç‰©ç§è¾¾æ ‡ 11215

# æ‰§è¡Œæ•°æ®æ¸…æ´—ï¼šåªä¿ç•™åœ¨ >10% æ ·æœ¬ä¸­å‡ºç°çš„ç‰©ç§
# dim(tse_standard_species_ca_1)
# æ¸…æ´—å‰ 12043

tse_standard_species_ca_1 <- subsetByPrevalent(tse_standard_species_ca_1, prevalence = 0.1)
# dim(tse_standard_species_ca_1)
# æ¸…æ´—å 11215

# 3. å°†æ•°æ®è½¬åŒ–ä¸ºç›¸å¯¹ä¸°åº¦ åŠ ä¸»å¯¼speciesåˆ†æ
tse_standard_species_ca_1 <- transformAssay(tse_standard_species_ca_1, method = "relabundance")

# æ‰¾å‡ºä¸°åº¦å‰åçš„species
top_taxa_standard_species_ca_1 <- getTop(tse_standard_species_ca_1, top = 10, assay.type = "relabundance")
top_taxa_standard_species_ca_1
# Homo sapiensæ˜¯äººæºspeciesï¼ŒCurtobacterium flaccumfaciensæ˜¯é¼ å­é¥²æ–™ä¸­çš„å¸¸è§æ¤ç‰©speciesã€‚è¦å»é™¤
#  [1] "Homo sapiens"                  "Curtobacterium flaccumfaciens" "Duncaniella sp. B8"
#  [4] "Muribaculum gordoncarteri"     "Duncaniella dubosii"           "Paramuribaculum intestinale"
#  [7] "Muribaculum intestinale"       "Acutalibacter muris"           "Mucispirillum schaedleri"
# [10] "Bacteroides uniformis"
# å› æ­¤ï¼Œéœ€è¦å»é™¤è¿™ä¸¤ç§å¼‚æºæ€§speciesã€‚
```
### ç¬¬äºŒéæ¸…æ´— å»é™¤å¼‚æºæ€§species
```{r}
tse_standard_species_ca_2 <- tse_standard_species_ca
# ------------------------------------------------------------------------------
# 1.æ˜¾å¼å»æ±¡
# ------------------------------------------------------------------------------
unwanted_taxa_standard_species_ca_2 <- c("Homo sapiens", "Curtobacterium flaccumfaciens")
tse_standard_species_ca_2 <- tse_standard_species_ca_2[!rownames(tse_standard_species_ca_2) %in% unwanted_taxa_standard_species_ca_2, ]

# tse_standard_species_ca_2

# OMAä¸­æåˆ°çš„å»æ±¡æ–¹æ³•ï¼š
# â€¢ åŸºäºæµè¡Œç‡ï¼ˆPrevalence-basedï¼‰çš„æ–¹æ³•ï¼šä¸å¯è¡Œã€‚ è¿™ç§æ–¹æ³•ç¡®å®å¿…é¡»ä¾èµ–é˜´æ€§å¯¹ç…§ï¼ˆNegative Controlsï¼‰ã€‚æ—¢ç„¶ä½ æ²¡æœ‰å¯¹ç…§æ ·æœ¬ï¼Œå°±æ— æ³•é€šè¿‡æ¯”å¯¹â€œç©ºç®¡â€å’Œâ€œæ ·æœ¬â€æ¥è¯†åˆ«ç¯å¢ƒæ±¡æŸ“ç‰©ã€‚
# â€¢ åŸºäºé¢‘ç‡ï¼ˆFrequency-basedï¼‰çš„æ–¹æ³•ï¼šå–å†³äºå…ƒæ•°æ®ã€‚ å¦‚æœä½ æœ‰æ¯ä¸ªæ ·æœ¬çš„ DNA æµ“åº¦æ•°æ®ï¼ˆä¾‹å¦‚ colData ä¸­çš„ post_pcr_dna_ngï¼‰ï¼Œä½ ä¾ç„¶å¯ä»¥ä½¿ç”¨ OMA çš„ addContaminantQC()ã€‚

# ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ
# æœ¬æ•°æ®é‡Œéƒ½æ²¡æœ‰ï¼Œé‚£å°±åªèƒ½æŠŠæ˜æ˜¾ä¸å¯¹ä¸”å å¤§å¤´çš„æ±¡æŸ“å»é™¤äº†ï¼Œåªèƒ½åšåˆ°è¿™ä¸€æ­¥å—ï¼Ÿï¼Ÿï¼Ÿ
# ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ


# ------------------------------------------------------------------------------
# 2.é‡æ–°è®¡ç®—æœ‰æ•ˆlibrary size
# ------------------------------------------------------------------------------
tse_standard_species_ca_2 <- addPerCellQC(tse_standard_species_ca_2)
# colnames(colData(tse_standard_species_ca_2))


# å¯è§†åŒ–æ–‡åº“å¤§å°åˆ†å¸ƒ
p1_2 <- plotHistogram(tse_standard_species_ca_2, col.var = "total") +
  labs(title = "Library Size Distribution", x = "Total Reads")
p1_2

# ä¿å­˜å›¾è¡¨
ggsave(
  filename = here::here("data", params$name, "03_qc_library_size_cleaning2.png"),
  plot = p1_2,
  width = 8, height = 6, dpi = 300
)

# tse_standard_species_ca_2


# ------------------------------------------------------------------------------
# 3. prevalenceåˆ†æä¸ æ¸…æ´—ï¼ˆprevalence ï¼10%ï¼‰
# ------------------------------------------------------------------------------
tse_standard_species_ca_2 <- addPrevalence(
  tse_standard_species_ca_2,
  assay.type = "counts",
  detection = 0,
  as.relative = TRUE
)

rowData(tse_standard_species_ca_2)$prevalence <- as.numeric(rowData(tse_standard_species_ca_2)$prevalence)
summary(rowData(tse_standard_species_ca_2)$prevalence) # æŸ¥çœ‹æœ€å¤§å€¼ã€ä¸­ä½æ•°ç­‰
# æœ€å¤§å€¼ä¸è¶…è¿‡1ï¼Œæœ€å°ä¹Ÿå¤§è¿‡0ï¼Œè¯´æ˜æ²¡é—®é¢˜

p2_2 <- plotHistogram(tse_standard_species_ca_2, row.var = "prevalence") +
  labs(title = "Feature Prevalence Distribution", x = "Prevalence (Fraction of Samples)")
p2_2

# ä¿å­˜å›¾è¡¨
ggsave(
  filename = here::here("data", params$name, "04_qc_prevalence_distribution_cleaning2.png"),
  plot = p2_2,
  width = 8, height = 6, dpi = 300
)

# è·å–æ™®éæ€§å¤§äº 10% çš„ç‰©ç§åå•
prev_standard_species_ca_2 <- getPrevalent(tse_standard_species_ca_2, prevalence = 0.1)
length(prev_standard_species_ca_2) # æŸ¥çœ‹æœ‰å¤šå°‘ç‰©ç§è¾¾æ ‡ 11213

# æ‰§è¡Œæ•°æ®æ¸…æ´—ï¼šåªä¿ç•™åœ¨ >10% æ ·æœ¬ä¸­å‡ºç°çš„ç‰©ç§
dim(tse_standard_species_ca_2)
# æ¸…æ´—å‰ 12041

tse_standard_species_ca_2 <- subsetByPrevalent(tse_standard_species_ca_2, prevalence = 0.1)
dim(tse_standard_species_ca_2) # æ¸…æ´—å 11213


# ------------------------------------------------------------------------------
# 4. å°†æ•°æ®è½¬åŒ–ä¸ºç›¸å¯¹ä¸°åº¦ åŠ ä¸»å¯¼speciesåˆ†æ
# ------------------------------------------------------------------------------
tse_standard_species_ca_2 <- transformAssay(tse_standard_species_ca_2, method = "relabundance")
# æ‰¾å‡ºä¸°åº¦å‰åçš„species
top_taxa_standard_species_ca_2 <- getTop(tse_standard_species_ca_2, top = 10, assay.type = "relabundance")
# top_taxa_standard_species_ca
#  [1] "Duncaniella sp. B8"          "Muribaculum gordoncarteri"   "Duncaniella dubosii"
#  [4] "Paramuribaculum intestinale" "Muribaculum intestinale"     "Mucispirillum schaedleri"
#  [7] "Acutalibacter muris"         "Blautia producta"            "Bacteroides uniformis"
# [10] "Escherichia coli"


# ------------------------------------------------------------------------------
# 5. ç¾¤è½ç»„æˆå›¾ åŠ ä¸°åº¦å¯†åº¦å›¾
# ------------------------------------------------------------------------------
# 5.1 ç¾¤è½ç»„æˆå›¾
# ä¸ºäº†é˜²æ­¢æ±¡æŸ“ï¼Œå¤åˆ¶ä¸€ä¸ªtseæ–‡ä»¶ã€‚
tse_standard_species_ca_top10forplot_2 <- tse_standard_species_ca_2

# å°†å‰ 10 åä»¥å¤–çš„ç‰©ç§é‡å‘½åä¸º "Other"
rowData(tse_standard_species_ca_top10forplot_2)$Species_Top10 <- ifelse(
  rownames(tse_standard_species_ca_top10forplot_2) %in% top_taxa_standard_species_ca_2,
  rownames(tse_standard_species_ca_top10forplot_2),
  "Other"
)

# ä»¥æ­¤èšåˆ
tse_standard_species_ca_top10forplot_2 <- agglomerateByVariable(tse_standard_species_ca_top10forplot_2, by = "rows", f = "Species_Top10")

# ç»˜å›¾
P3_2 <- plotAbundance(
  tse_standard_species_ca_top10forplot_2,
  assay.type = "relabundance",
  order.row.by = "abund",
  order.col.by = "Other"
) +
  labs(title = "Top 10 Species Composition (Caecum)", subtitle = "Non-top taxa grouped as 'Other'") +
  theme(axis.text.x = element_blank())
P3_2

# ä¿å­˜å›¾è¡¨
ggsave(
  filename = here::here("data", params$name, "05_composition_top10_species_cleaning2.png"),
  plot = P3_2,
  width = 12, height = 6, dpi = 300
)

# å›¾ä¸­å‘ç°æœ‰ä¸€ä¸ªæ ·å“ï¼Œå…¶Escherichia coliæ˜¾è‘—é«˜äºä»»ä½•ä¸€ä¸ªæ ·å“ã€‚
sample_id_cleaning_2 <- which.max(assay(tse_standard_species_ca_2, "relabundance")["Escherichia coli", ])
sample_id_cleaning_2
# å‘ç°æ˜¯ca08ï¼Œä¹Ÿå°±æ˜¯ApcMUT_Ctrlç»„ä¸­çš„ä¸€åªè€é¼ ã€‚é‚£ä¹ˆï¼Œè®¤ä¸ºæ˜¯é”™è¯¯æ ·æœ¬ï¼Œåº”äºˆä»¥æ¸…é™¤ã€‚
```
### ç¬¬ä¸‰éæ¸…æ´— åœ¨ç¬¬äºŒéæ¸…æ´—çš„åŸºç¡€ä¸Šï¼Œå»é™¤ca08æ ·æœ¬
```{r}
tse_standard_species_ca_3 <- tse_standard_species_ca_2
tse_standard_species_ca_3 # æ£€æŸ¥ä¸€ä¸‹ï¼Œè¿™ä¸€æ­¥è¿˜æœ‰29ä¸ªæ ·æœ¬

# ------------------------------------------------------------------------------
# 1. å»é™¤ca08æ ·æœ¬
# ------------------------------------------------------------------------------
tse_standard_species_ca_3 <- tse_standard_species_ca_3[, colnames(tse_standard_species_ca) != "ca08"]
tse_standard_species_ca_3 # è¿™é‡Œå°±æœ‰28ä¸ªæ ·æœ¬äº†ï¼Œè¯´æ˜å»é™¤æˆåŠŸäº†ã€‚


# ------------------------------------------------------------------------------
# 2.é‡æ–°è®¡ç®—æœ‰æ•ˆlibrary size
# ------------------------------------------------------------------------------
# tse_standard_species_ca_3 <- addPerCellQC(tse_standard_species_ca_3)
# colnames(colData(tse_standard_species_ca_3))
# è¿™ä¸€æ­¥å‘ç°ï¼Œæœ‰é‡å¤çš„colnamesï¼š "sum"             "detected"        "total"
# å› ä¸ºå†æ¬¡æµ‹ç®—çš„library sizeä¸èƒ½è¦†ç›–ï¼Œæ˜¯é‡æ–°ç”Ÿæˆã€‚
# è¿™æ ·çš„è¯ï¼Œå°±åº”è¯¥å…ˆæŠŠæ—§çš„å‰”é™¤æ‰ï¼Œç„¶åå†ç®—æ–°çš„ã€‚
colData(tse_standard_species_ca_3) <- colData(tse_standard_species_ca_3)[, 1:11]
tse_standard_species_ca_3 <- addPerCellQC(tse_standard_species_ca_3)
colnames(colData(tse_standard_species_ca_3))

# å¯è§†åŒ–æ–‡åº“å¤§å°åˆ†å¸ƒ
p1_3 <- plotHistogram(tse_standard_species_ca_3, col.var = "total") +
  labs(title = "Library Size Distribution", x = "Total Reads")
p1_3

# ä¿å­˜å›¾è¡¨
ggsave(
  filename = here::here("data", params$name, "06_qc_library_size_cleaning3.png"),
  plot = p1_3,
  width = 8, height = 6, dpi = 300
)

tse_standard_species_ca_3


# ------------------------------------------------------------------------------
# 3. prevalenceåˆ†æä¸ æ¸…æ´—ï¼ˆprevalence ï¼10%ï¼‰
# ------------------------------------------------------------------------------
tse_standard_species_ca_3 <- addPrevalence(
  tse_standard_species_ca_3,
  assay.type = "counts",
  detection = 0,
  as.relative = TRUE
)

rowData(tse_standard_species_ca_3)$prevalence <- as.numeric(rowData(tse_standard_species_ca_3)$prevalence)
summary(rowData(tse_standard_species_ca_3)$prevalence) # æŸ¥çœ‹æœ€å¤§å€¼ã€ä¸­ä½æ•°ç­‰
# æœ€å¤§å€¼ä¸è¶…è¿‡1ï¼Œæœ€å°ä¹Ÿå¤§è¿‡0ï¼Œè¯´æ˜æ²¡é—®é¢˜

p2_3 <- plotHistogram(tse_standard_species_ca_3, row.var = "prevalence") +
  labs(title = "Feature Prevalence Distribution", x = "Prevalence (Fraction of Samples)")
p2_3

# ä¿å­˜å›¾è¡¨
ggsave(
  filename = here::here("data", params$name, "07_qc_prevalence_distribution_cleaning3.png"),
  plot = p2_3,
  width = 8, height = 6, dpi = 300
)

# è·å–æ™®éæ€§å¤§äº 10% çš„ç‰©ç§åå•
prev_standard_species_ca_3 <- getPrevalent(tse_standard_species_ca_3, prevalence = 0.1)
length(prev_standard_species_ca_3) # æŸ¥çœ‹æœ‰å¤šå°‘ç‰©ç§è¾¾æ ‡ 11213

# æ‰§è¡Œæ•°æ®æ¸…æ´—ï¼šåªä¿ç•™åœ¨ >10% æ ·æœ¬ä¸­å‡ºç°çš„ç‰©ç§
dim(tse_standard_species_ca_3)
# æ¸…æ´—å‰ 11213ï¼Œæ²¡æœ‰å› å»æ‰ca08å‘ç”Ÿå˜åŒ–ï¼Œä¸éœ€è¦è¿›ä¸€æ­¥å¤„ç†ã€‚

# ------------------------------------------------------------------------------
# 4. å°†æ•°æ®è½¬åŒ–ä¸ºç›¸å¯¹ä¸°åº¦ åŠ ä¸»å¯¼speciesåˆ†æ
# ------------------------------------------------------------------------------
tse_standard_species_ca_3 <- transformAssay(tse_standard_species_ca_3, method = "relabundance")
# æ‰¾å‡ºä¸°åº¦å‰åçš„species
top_taxa_standard_species_ca_3 <- getTop(tse_standard_species_ca_3, top = 10, assay.type = "relabundance")
# top_taxa_standard_species_ca_3
#  [1] "Duncaniella sp. B8"          "Muribaculum gordoncarteri"   "Duncaniella dubosii"
#  [4] "Paramuribaculum intestinale" "Muribaculum intestinale"     "Mucispirillum schaedleri"
#  [7] "Acutalibacter muris"         "Blautia producta"            "Bacteroides uniformis"
# [10] "Enterocloster bolteae"


# ------------------------------------------------------------------------------
# 5. ç¾¤è½ç»„æˆå›¾ åŠ ä¸°åº¦å¯†åº¦å›¾
# ------------------------------------------------------------------------------
# 5.1 ç¾¤è½ç»„æˆå›¾
# ä¸ºäº†é˜²æ­¢æ±¡æŸ“ï¼Œå¤åˆ¶ä¸€ä¸ªtseæ–‡ä»¶ã€‚
tse_standard_species_ca_top10forplot_3 <- tse_standard_species_ca_3

# å°†å‰ 10 åä»¥å¤–çš„ç‰©ç§é‡å‘½åä¸º "Other"
rowData(tse_standard_species_ca_top10forplot_3)$Species_Top10 <- ifelse(
  rownames(tse_standard_species_ca_top10forplot_3) %in% top_taxa_standard_species_ca_3,
  rownames(tse_standard_species_ca_top10forplot_3),
  "Other"
)

# ä»¥æ­¤èšåˆ
tse_standard_species_ca_top10forplot_3 <- agglomerateByVariable(tse_standard_species_ca_top10forplot_3, by = "rows", f = "Species_Top10")

# ç»˜å›¾
P3_3 <- plotAbundance(
  tse_standard_species_ca_top10forplot_3,
  assay.type   = "relabundance",
  order.row.by = "abund",
  order.col.by = "Other"
) +
  labs(title = "Top 10 Species Composition (Caecum)", subtitle = "Non-top taxa grouped as 'Other'") +
  theme(axis.text.x = element_blank())
P3_3

# ä¿å­˜å›¾è¡¨
ggsave(
  filename = here::here("data", params$name, "08_composition_top10_species_final.png"),
  plot = P3_3,
  width = 12, height = 6, dpi = 300
)

# 5.2 ä¸°åº¦å¯†åº¦å›¾
# è§‚å¯Ÿå‰ 5 ä¸ªæœ€ä¸°å¯Œç‰©ç§åœ¨ä¸¤ç»„ä¸­çš„å¯†åº¦åˆ†å¸ƒ
p3_3_density <- plotAbundanceDensity(
  tse_standard_species_ca_top10forplot_3,
  layout      = "density",
  assay.type  = "relabundance",
  n           = 5, # é€‰å–ä¸°åº¦æœ€é«˜çš„5ä¸ªç‰©ç§
  colour_by   = "treatment_group", # æŒ‰å¤„ç†ç»„åˆ†è‰²å¯¹æ¯”
  point_alpha = 0.1
) +
  scale_x_log10() +
  labs(title = "Abundance Density of Top 5 Species")
p3_3_density

# ä¿å­˜å›¾è¡¨
ggsave(
  filename = here::here("data", params$name, "09_abundance_density_top5_species.png"),
  plot = p3_3_density,
  width = 10, height = 8, dpi = 300
)
```

### ç¬¬å››éæ¸…æ´— è¿‡æ»¤é›¶æ–¹å·®ç‰¹å¾ (Filtering zero-variance features)
åœ¨å»é™¤æ‰å¼‚å¸¸speciesã€å¼‚å¸¸æ ·æœ¬åï¼Œå¯¹é›¶æ–¹å·®ç‰¹å¾è¿›è¡Œç­›é™¤ã€‚
OMA æåˆ°ï¼Œåœ¨å‡†å¤‡åšç»„é—´æ¯”è¾ƒï¼ˆå¦‚ HpWT vs HpKOï¼‰æ—¶ï¼Œæœ‰äº›ç‰©ç§è™½ç„¶é€šè¿‡äº†æµè¡Œç‡ç­›é€‰ï¼Œä½†å®ƒä»¬åœ¨æ‰€æœ‰æ ·æœ¬ä¸­çš„ä¸°åº¦å‡ ä¹æ˜¯ä¸€æ ·çš„ã€‚è¿™äº›ç‰¹å¾æ²¡æœ‰ç»Ÿè®¡å­¦æ„ä¹‰ï¼Œåªä¼šå¢åŠ è®¡ç®—è´Ÿæ‹…ã€‚
```{r}
# åœ¨ç¬¬ä¸‰éæ¸…æ´—çš„åŸºç¡€ä¸Šå¼€å±•
tse_standard_species_ca_4 <- tse_standard_species_ca_3

# ------------------------------------------------------------------------------
# 1. è®¡ç®—æ¯ä¸ªç‰©ç§åœ¨æ‰€æœ‰æ ·æœ¬ä¸­çš„æ ‡å‡†å·® (sd)ï¼Œå¹¶å­˜å…¥ rowData
# ------------------------------------------------------------------------------
# å»ºè®®ä½¿ç”¨åŸå§‹è®¡æ•° (counts) å±‚è¿›è¡Œæ–¹å·®åˆ¤æ–­
rowData(tse_standard_species_ca_4)[["sd"]] <- MatrixGenerics::rowSds(assay(tse_standard_species_ca_4, "counts"))

# ç»Ÿè®¡ æœ‰å¤šå°‘ç‰©ç§æ˜¯é›¶æ–¹å·®çš„ï¼Ÿ
table(rowData(tse_standard_species_ca_4)$sd > 0) #  TRUE 11213ï¼Œä¸ä¹‹å‰çš„speciesæ•°é‡ç›¸åŒï¼Œè¯´æ˜éƒ½å¤§äº0

# 2. æ‰§è¡Œè¿‡æ»¤ï¼šè®¾ç½®ä¸€ä¸ªå°é˜ˆå€¼ï¼ˆ > 0.001ï¼‰æ¥è¿‡æ»¤æ‰å˜åŠ¨æå°çš„ç‰©ç§
tse_standard_species_ca_4 <- tse_standard_species_ca_4[rowData(tse_standard_species_ca_4)$sd > 0.001, ]

dim(tse_standard_species_ca_4) # è¿˜æ˜¯11213ï¼Œè¯´æ˜å·²ç»å¯ä»¥äº†ï¼ˆå…¶å®prevalenceå·²ç»å¸®åŠ©ç­›é€‰äº†ï¼‰
```

### æ¸…æ´—åçš„æ•°æ®æ•´ç† åŠ genusæ°´å¹³èšåˆ
```{r}
# ------------------------------------------------------------------------------
# 1.æ¸…æ´—åæ•°æ®å¦ä¿å­˜ä¸ºclean tseæ–‡ä»¶
# ------------------------------------------------------------------------------
tse_standard_species_ca_cleaned <- tse_standard_species_ca_4
# tse_standard_ca_cleaned
# colnames(colData(tse_standard_species_ca_3))


# ------------------------------------------------------------------------------
# 2.genusæ°´å¹³èšåˆ
# ------------------------------------------------------------------------------
# taxonomyRanks(tse_standard_species_ca_cleaned) # åŸå§‹æ•°æ®ä¸­æ²¡æœ‰genusåˆ—ï¼Œåªæœ‰speciesã€‚

# 2.1 åœ¨ rowData ä¸­å¢åŠ  Genus åˆ—
rowData(tse_standard_species_ca_cleaned)$Genus <- str_extract(rownames(tse_standard_species_ca_cleaned), "^[^ ]+")
# taxonomyRanks(tse_standard_species_ca_cleaned) # [1] "Species" "Genus"
# ä½†æ˜¯è¿™æ ·ä¸å¯ä»¥çš„ã€‚å› ä¸ºå‡½æ•°agglomerateByRankè¦æ±‚ä¸¥æ ¼æŒ‰ç…§é¡ºåºï¼Œä¹Ÿå°±æ˜¯genusè¦å†specieså‰é¢
# é‡æ–°æ’åº
correct_order_cleaning_4 <- c("Genus", "Species")

# 2.2 é‡æ–°å¯¹ rowData çš„åˆ—è¿›è¡Œæ’åº
# è¿™ä¸€æ­¥ç¡®ä¿äº† Genus åœ¨å·¦ï¼ŒSpecies åœ¨å³
rowData(tse_standard_species_ca_cleaned) <- rowData(tse_standard_species_ca_cleaned)[, correct_order_cleaning_4]
# å†æ¬¡éªŒè¯åˆ†ç±»å±‚çº§
taxonomyRanks(tse_standard_species_ca_cleaned) # "Genus"   "Species"

# èšåˆ
tse_standard_genus_ca_originfrom_standardspeciescacleaned <- agglomerateByRank(tse_standard_species_ca_cleaned, rank = "Genus")
tse_standard_genus_ca_originfrom_standardspeciescacleaned

# ------------------------------------------------------------------------------
# 3. ä¿å­˜æ¸…æ´—åçš„ TSE å¯¹è±¡ï¼ˆä¾› 02qmd ç­‰åç»­åˆ†æä½¿ç”¨ï¼‰
# ------------------------------------------------------------------------------
saveRDS(
  tse_standard_species_ca_cleaned,
  file = here::here("data", "01_alpha_beta_diversity_analysis", "tse_standard_species_ca_cleaned.rds")
)
saveRDS(
  tse_standard_genus_ca_originfrom_standardspeciescacleaned,
  file = here::here("data", "01_alpha_beta_diversity_analysis", "tse_standard_genus_ca_cleaned.rds")
)
cat("âœ… å·²ä¿å­˜ TSE å¯¹è±¡:\n")
cat("  - tse_standard_species_ca_cleaned.rds\n")
cat("  - tse_standard_genus_ca_cleaned.rds\n")
```

## 1.3 æ•°æ®åˆ†æ
### 1.3.1 Alphaå¤šæ ·æ€§åˆ†æ
```{r}
# 1.è®¡ç®—Shannonï¼ˆä¿¡æ¯ç†µï¼‰ã€Observedï¼ˆè§‚æµ‹åˆ°çš„ç‰©ç§æ•°ï¼‰
tse_standard_species_ca_cleaned <- addAlpha(
  tse_standard_species_ca_cleaned,
  assay.type = "counts",
  index = c("shannon", "observed"),
  name = c("shannon_index", "observed_richness")
)
head(colData(tse_standard_species_ca_cleaned)) # å¤šäº† shannon å’Œ observed ä¸¤åˆ—


# ------------------------------------------------------------------------------
# 2. ç»Ÿè®¡æ£€éªŒ (Species)
# ------------------------------------------------------------------------------
# 2.0.1 æ•´ä½“å·®å¼‚æ£€æµ‹
# ä½¿ç”¨éå‚æ•°æ£€éªŒï¼Œä¸å‡è®¾æ•°æ®ç¬¦åˆæ­£æ€åˆ†å¸ƒ
standard_species_ca_kruskal_result_global <- kruskal.test(shannon_index ~ treatment_group, data = colData(tse_standard_species_ca_cleaned))
print(paste("å…¨å±€ Shannon å·®å¼‚ P å€¼:", round(standard_species_ca_kruskal_result_global$p.value, 4)))
# å…¨å±€ Shannon å·®å¼‚ P å€¼: 0.0651
# æ•´ä½“æ²¡æœ‰æ˜¾è‘—æ€§å·®å¼‚ï¼Œé¢„è®¡ç»„ä¸ç»„ä¹‹é—´å¯èƒ½ä¸å®¹æ˜“æœ‰æ˜¾è‘—æ€§å·®å¼‚ã€‚

# 2.0.2 æœªæ„ŸæŸ“æƒ…å†µä¸‹ï¼ŒåŸºå› çªå˜å¯¹äºèŒç¾¤çš„å½±å“
tse_standard_species_ca_cleaned_baseline <- tse_standard_species_ca_cleaned[, tse_standard_species_ca_cleaned$treatment_group %in% c("ApcWT_HpKO", "ApcMUT_HpKO")]

tse_standard_species_ca_cleaned_baseline$treatment_group <- factor(tse_standard_species_ca_cleaned_baseline$treatment_group)

standard_species_ca_cleaned_wilcox_baseline <- wilcox.test(shannon_index ~ treatment_group, data = colData(tse_standard_species_ca_cleaned_baseline))
print(paste("å®¿ä¸»åŸºçº¿å·®å¼‚ P å€¼:", round(standard_species_ca_cleaned_wilcox_baseline$p.value, 4)))
# "å®¿ä¸»åŸºçº¿å·®å¼‚ P å€¼: 0.0635"
# æ— æ˜¾è‘—æ€§å·®å¼‚ï¼Œè¯´æ˜åŸºå› çªå˜å¯¹èŒç¾¤æ— å½±å“ã€‚

# 2.1 å…ˆæŠŠå¾…æµ‹çš„ä¸¤ç»„ç­›é€‰å‡ºæ¥
# ç­›é€‰å‡º Apc çªå˜èƒŒæ™¯ä¸‹çš„ HpWT å’Œ HpKO ç»„
tse_standard_species_ca_cleaned_corepair <- tse_standard_species_ca_cleaned[, tse_standard_species_ca_cleaned$treatment_group %in% c("ApcMUT_HpWT", "ApcMUT_HpKO")]

# ç§»é™¤æ‰ colData ä¸­é‚£äº›ä¸å†ä½¿ç”¨çš„å› å­æ°´å¹³ï¼ˆLevelï¼‰
tse_standard_species_ca_cleaned_corepair$treatment_group <- factor(tse_standard_species_ca_cleaned_corepair$treatment_group)

# 2.2 ç»Ÿè®¡æ£€éªŒ (Wilcoxon ç§©å’Œæ£€éªŒ)
# å¾®ç”Ÿç‰©ç»„æ•°æ®é€šå¸¸ä¸ç¬¦åˆæ­£æ€åˆ†å¸ƒï¼ŒOMA å¼ºçƒˆå»ºè®®ä½¿ç”¨éå‚æ•°æ£€éªŒ
standard_species_ca_wilcox_result_corepair <- wilcox.test(shannon_index ~ treatment_group, data = colData(tse_standard_species_ca_cleaned_corepair))
print(paste("Shannon æŒ‡æ•°å·®å¼‚ P å€¼:", round(standard_species_ca_wilcox_result_corepair$p.value, 4)))
# "Shannon æŒ‡æ•°å·®å¼‚ P å€¼: 0.7302"
# è¿™ä¸¤ç»„ä¹‹é—´æ²¡æœ‰å·®å¼‚ã€‚

# 2.3 å¯è§†åŒ–
standard_species_ca_wilcox_result_corepair_plot_alpha <- function(tse, y_var, title) {
  plotColData(tse,
    x            = "treatment_group", y = y_var,
    colour_by    = "treatment_group",
    show_boxplot = TRUE
  ) + # æ˜¾ç¤ºç®±çº¿å›¾
    stat_compare_means(
      comparisons = list(c("ApcMUT_HpKO", "ApcMUT_HpWT")),
      method = "wilcox.test", label = "p.format"
    ) +
    labs(title = title, x = "Group", y = "Index Value") +
    theme_bw() +
    theme(legend.position = "none")
}

p3_1_1 <- standard_species_ca_wilcox_result_corepair_plot_alpha(tse_standard_species_ca_cleaned_corepair, "shannon_index", "Shannon Diversity (Species Level)")
p3_1_2 <- standard_species_ca_wilcox_result_corepair_plot_alpha(tse_standard_species_ca_cleaned_corepair, "observed_richness", "Observed Richness (Species Level)")

# æ‹¼å›¾å±•ç¤º
p3_1_combined <- p3_1_1 + p3_1_2 # æ²¡æœ‰æ˜¾è‘—æ€§å·®å¼‚
p3_1_combined

# ä¿å­˜å•ç‹¬çš„å›¾è¡¨
ggsave(
  filename = here::here("data", params$name, "10_alpha_shannon_diversity_species.png"),
  plot = p3_1_1,
  width = 6, height = 5, dpi = 300
)

ggsave(
  filename = here::here("data", params$name, "11_alpha_observed_richness_species.png"),
  plot = p3_1_2,
  width = 6, height = 5, dpi = 300
)

# ä¿å­˜ç»„åˆå›¾
ggsave(
  filename = here::here("data", params$name, "12_alpha_diversity_combined_species.png"),
  plot = p3_1_combined,
  width = 12, height = 5, dpi = 300
)


# ------------------------------------------------------------------------------
# 3. Genusæ°´å¹³å¤æ ¸ ç»Ÿè®¡æ£€éªŒ (ApcMUT_HpWT vs ApcMUT_HpKO)
# ------------------------------------------------------------------------------
tse_standard_genus_ca_originfrom_standardspeciescacleaned <- 
  addAlpha(
    tse_standard_genus_ca_originfrom_standardspeciescacleaned,
    assay.type = "counts",
    index      = c("shannon", "observed"),
    name       = c("shannon_index", "observed_richness")
    )

# ç­›é€‰å‡º Apc çªå˜èƒŒæ™¯ä¸‹çš„ HpWT å’Œ HpKO ç»„
tse_standard_genus_ca_corepair <- 
  tse_standard_genus_ca_originfrom_standardspeciescacleaned[,tse_standard_genus_ca_originfrom_standardspeciescacleaned$treatment_group %in% c("ApcMUT_HpWT", "ApcMUT_HpKO")]

# ç§»é™¤æ‰ colData ä¸­é‚£äº›ä¸å†ä½¿ç”¨çš„å› å­æ°´å¹³ï¼ˆLevelï¼‰
tse_standard_genus_ca_corepair$treatment_group <-
  factor(tse_standard_genus_ca_corepair$treatment_group)

standard_genus_ca_wilcox_result_corepair <- 
  wilcox.test(shannon_index ~ treatment_group, data = colData(tse_standard_genus_ca_corepair))
print(paste("Shannon æŒ‡æ•°å·®å¼‚ P å€¼:", round(standard_genus_ca_wilcox_result_corepair$p.value, 4)))
# "Shannon æŒ‡æ•°å·®å¼‚ P å€¼: 1"
# æ›´è¯´æ˜äº†äºŒè€…ç¡®å®æ²¡æœ‰å·®å¼‚ã€‚
```
Î±-diversityåˆ†æå°ç»“
ï¼ˆ1ï¼‰ç»Ÿè®¡ç»“æœï¼š
1ï¼‰åœ¨ Speciesï¼ˆç§ï¼‰æ°´å¹³ä¸Šï¼Œè‡´ç˜¤ç»„ï¼ˆApcMUT_HpWTï¼‰ä¸å¯¹ç…§ç»„ï¼ˆApcMUT_HpKOï¼‰çš„ Shannon æŒ‡æ•°ï¼ˆP=0.73ï¼‰å’Œç‰©ç§ä¸°å¯Œåº¦ï¼ˆObserved Richness, P=0.29ï¼‰å‡æ— æ˜¾è‘—å·®å¼‚ã€‚
2ï¼‰åœ¨ Genusï¼ˆå±ï¼‰æ°´å¹³ä¸Šï¼Œä¸¤ç»„é—´çš„ Shannon æŒ‡æ•°å·®å¼‚ç»Ÿè®¡å­¦ä¸Šå®Œå…¨ä¸æ˜¾è‘—ï¼ˆP=1ï¼‰ï¼Œè¯´æ˜ä¸¤ç»„åœ¨ä¸­ä½æ•°å’Œç§©åˆ†å¸ƒä¸Šé«˜åº¦ä¸€è‡´ã€‚
ï¼ˆ2ï¼‰ç”Ÿç‰©å­¦è§£é‡Šï¼š
1ï¼‰ç¾¤è½å¤æ‚åº¦ç¨³å¥æ€§ï¼šç›®å‰çš„è¯æ®è¡¨æ˜ï¼ŒCagA è›‹ç™½çš„æ³¨å…¥ä»¥åŠåç»­çš„è‡´ç˜¤è¿‡ç¨‹ï¼Œå¹¶æ²¡æœ‰å¼•èµ·ç›²è‚ èŒç¾¤æ•´ä½“å¤æ‚åº¦ï¼ˆç‰©ç§æ•°é‡ï¼‰æˆ–åˆ†å¸ƒå‡åŒ€åº¦çš„å‰§çƒˆå´©æºƒã€‚
2ï¼‰æ’é™¤â€œå¤§ç­ç»â€å‡è¯´ï¼šè¿™è¯´æ˜è‚¿ç˜¤çš„å‘ç”Ÿå¹¶ä¸æ˜¯é€šè¿‡ç®€å•åœ°â€œæ€ç­ç›Šç”ŸèŒâ€æˆ–â€œé™ä½èŒç¾¤å¤šæ ·æ€§â€è¿™ç§å®è§‚ç”Ÿæ€å¤±è¡¡æ¨¡å¼é©±åŠ¨çš„ã€‚
ï¼ˆ3ï¼‰ç§‘å­¦ä»·å€¼ï¼š
è¿™ä¸€ç»“æœå®é™…ä¸Šä¸º**Functional Footprint**å‡è¯´æä¾›äº†é—´æ¥æ”¯æŒï¼š
æ—¢ç„¶å¤šæ ·æ€§ï¼ˆAlphaï¼‰æ²¡æœ‰å˜åŒ–ï¼Œé‚£ä¹ˆé—®é¢˜çš„æ ¸å¿ƒææœ‰å¯èƒ½éšè—åœ¨å…·ä½“çš„ç‰©ç§ç»„æˆç»“æ„ï¼ˆBetaï¼‰æˆ–ä»£è°¢åŠŸèƒ½äº§ç‰©çš„ç»†å¾®åç§»ä¸­ã€‚

### 1.3.2 Betaå¤šæ ·æ€§åˆ†æ
```{r}
# ------------------------------------------------------------------------------
# 1.è®¡ç®— Bray-Curtis è·ç¦»ä¸ PCoA æ’åºå›¾ (ApcMUT_HpWT vs ApcMUT_HpKO)(species)
# ------------------------------------------------------------------------------
tse_standard_species_ca_cleaned_corepair
tse_standard_genus_ca_corepair

# 1.1 è½¬æ¢ä¸ºç›¸å¯¹ä¸°åº¦ï¼ˆBray-Curtis é€šå¸¸åŸºäºæ¯”ä¾‹æ•°æ®ï¼‰
tse_standard_species_ca_cleaned_corepair <- transformAssay(tse_standard_species_ca_cleaned_corepair, assay.type = "counts", method = "relabundance")

# 1.2 è¿è¡Œ PCoA (MDS) å¹¶å­˜å‚¨åœ¨ reducedDim æ§½ä½ä¸­
# è¿™é‡Œä½¿ç”¨ addMDS å‡½æ•°ï¼Œå®ƒä¼šè‡ªåŠ¨è®¡ç®—è·ç¦»çŸ©é˜µå¹¶é™ç»´
tse_standard_species_ca_cleaned_corepair <- addMDS(
  tse_standard_species_ca_cleaned_corepair,
  FUN = getDissimilarity,
  method = "bray",
  assay.type = "relabundance",
  name = "PCoA_Bray"
)

# æå–ç‰¹å¾å€¼ (Eigenvalues)
standard_species_ca_cleaned_corepair_eigenvalues_bray <- attr(reducedDim(tse_standard_species_ca_cleaned_corepair, "PCoA_Bray"), "eig")

# è®¡ç®—ç›¸å¯¹è§£é‡Šæ–¹å·® (ä»…é’ˆå¯¹æ­£ç‰¹å¾å€¼è¿›è¡Œå½’ä¸€åŒ–)
standard_species_ca_cleaned_corepair_relative_eigenvalues_bray <- standard_species_ca_cleaned_corepair_eigenvalues_bray / sum(standard_species_ca_cleaned_corepair_eigenvalues_bray[standard_species_ca_cleaned_corepair_eigenvalues_bray > 0])

# 1.3 å¯è§†åŒ–ï¼šè§‚å¯Ÿ HpWT å’Œ HpKO ç»„æ˜¯å¦å½¢æˆäº†ä¸åŒçš„ç°‡
p3_2_1 <- plotReducedDim(
  tse_standard_species_ca_cleaned_corepair,
  "PCoA_Bray",
  colour_by = "treatment_group"
) +
  theme_bw() +
  labs(
    title = "PCoA based on Bray-Curtis Dissimilarity",
    x = paste0("PCoA 1 (", round(100 * standard_species_ca_cleaned_corepair_relative_eigenvalues_bray[1], 1), "%)"),
    y = paste0("PCoA 2 (", round(100 * standard_species_ca_cleaned_corepair_relative_eigenvalues_bray[2], 1), "%)")
  )
p3_2_1

# ä¿å­˜å›¾è¡¨
ggsave(
  filename = here::here("data", params$name, "13_beta_pcoa_bray_curtis_species.png"),
  plot = p3_2_1,
  width = 8, height = 6, dpi = 300
)

# ç›´è§‚åœ°çœ‹çš„è¯ï¼Œå¥½åƒç¡®å®ä¸å¤ªä¸€æ ·ã€‚
# ä½†æ˜¯éœ€è¦æ›´å…·ä½“çš„æ•°å­—è¯æ®

# 1.4 PERMANOVAæ£€éªŒ
# æµ‹è¯•ä¸¤ç»„çš„è´¨å¿ƒï¼ˆCentroidsï¼‰æ˜¯å¦åœ¨å¤šç»´ç©ºé—´ä¸­æ˜¾è‘—åˆ†ç¦»

standard_species_ca_cleaned_corepair_permanova_result <- getPERMANOVA(
  tse_standard_species_ca_cleaned_corepair,
  assay.type = "relabundance",
  formula = x ~ treatment_group
)

print(standard_species_ca_cleaned_corepair_permanova_result$permanova)
# å¾—åˆ°P = 0.012ï¼Œå˜å¼‚é¼ çš„HpWT å’Œ HpKO ç»„ä¹‹é—´ï¼Œå…¶Î²-diversityæœ‰æ˜¾è‘—æ€§å·®å¼‚ã€‚
# ğŸŒ¸è¯æ˜ CagA è›‹ç™½ç¡®å®æ˜¾è‘—é‡å¡‘äº†ç›²è‚ èŒç¾¤çš„æ•´ä½“ç»“æ„

# ä¿å­˜PERMANOVAç»“æœï¼ˆSpeciesæ°´å¹³ï¼‰
write.csv(
  standard_species_ca_cleaned_corepair_permanova_result$permanova,
  file = here::here("data", params$name, "16_permanova_bray_curtis_species.csv"),
  row.names = TRUE
)

# 1.5 Aitchison è·ç¦»ï¼šå…ˆåš CLR è½¬æ¢ï¼Œå†è®¡ç®—æ¬§å‡ é‡Œå¾—è·ç¦»
tse_standard_species_ca_cleaned_corepair <- transformAssay(
  tse_standard_species_ca_cleaned_corepair,
  assay.type = "counts",
  method = "clr",
  pseudocount = TRUE
)

tse_standard_species_ca_cleaned_corepair <- addMDS(
  tse_standard_species_ca_cleaned_corepair,
  FUN = getDissimilarity,
  method = "euclidean",
  assay.type = "clr",
  name = "Aitchison"
)

# æå–ç‰¹å¾å€¼ (Eigenvalues)
e_ait <- attr(reducedDim(tse_standard_species_ca_cleaned_corepair, "Aitchison"), "eig")

# è®¡ç®—ç›¸å¯¹è§£é‡Šæ–¹å·®ï¼ˆä»…å–æ­£ç‰¹å¾å€¼ä¹‹å’Œä½œä¸ºåˆ†æ¯ï¼‰
rel_eig_ait <- e_ait / sum(e_ait[e_ait > 0])

# ç”Ÿæˆåæ ‡è½´æ ‡ç­¾å­—ç¬¦ä¸²
label_x_ait <- paste0("PC 1 (", round(100 * rel_eig_ait[[7]], 1), "%)")
label_y_ait <- paste0("PC 2 (", round(100 * rel_eig_ait[[8]], 1), "%)")

p3_2_2 <- plotReducedDim(
  tse_standard_species_ca_cleaned_corepair,
  "Aitchison",
  colour_by = "treatment_group"
) +
  theme_bw() +
  labs(
    title = "PCoA based on Aitchison Distance",
    x = label_x_ait,
    y = label_y_ait
  )

p3_2_2

# ä¿å­˜å›¾è¡¨
ggsave(
  filename = here::here("data", params$name, "14_beta_pcoa_aitchison_species.png"),
  plot = p3_2_2,
  width = 8, height = 6, dpi = 300
)

# è¿™ä¸ªè§£é‡Šç¨‹åº¦ä»…æœ‰ä¸åˆ°10%ã€‚


# ------------------------------------------------------------------------------
# 2.è®¡ç®— Bray-Curtis è·ç¦»ä¸ PCoA æ’åºå›¾ (ApcMUT_HpWT vs ApcMUT_HpKO)(genus)
# ------------------------------------------------------------------------------
# 2.1 è½¬æ¢ä¸ºç›¸å¯¹ä¸°åº¦
tse_standard_genus_ca_corepair <- transformAssay(
  tse_standard_genus_ca_corepair,
  assay.type = "counts",
  method = "relabundance"
)

# 2.2 è¿è¡Œ PCoA (MDS) å¹¶å­˜å‚¨åœ¨ reducedDim æ§½ä½ä¸­
tse_standard_genus_ca_corepair <- addMDS(
  tse_standard_genus_ca_corepair,
  FUN = getDissimilarity,
  method = "bray",
  assay.type = "relabundance",
  name = "PCoA_Bray"
)

# æå–ç‰¹å¾å€¼ (Eigenvalues)
standard_genus_ca_corepair_eigenvalues_bray <- attr(
  reducedDim(tse_standard_genus_ca_corepair, "PCoA_Bray"), "eig"
)

# è®¡ç®—ç›¸å¯¹è§£é‡Šæ–¹å·®
standard_genus_ca_corepair_relative_eigenvalues_bray <- standard_genus_ca_corepair_eigenvalues_bray / sum(standard_genus_ca_corepair_eigenvalues_bray[standard_genus_ca_corepair_eigenvalues_bray > 0])

# 2.3 å¯è§†åŒ–ï¼šè§‚å¯Ÿ HpWT å’Œ HpKO ç»„æ˜¯å¦å½¢æˆäº†ä¸åŒçš„ç°‡
p3_2_3 <- plotReducedDim(
  tse_standard_genus_ca_corepair,
  "PCoA_Bray",
  colour_by = "treatment_group"
) +
  theme_bw() +
  labs(
    title = "PCoA based on Bray-Curtis Dissimilarity genus",
    x = paste0("PCoA 1 (", round(100 * standard_genus_ca_corepair_relative_eigenvalues_bray[1], 1), "%)"),
    y = paste0("PCoA 2 (", round(100 * standard_genus_ca_corepair_relative_eigenvalues_bray[2], 1), "%)")
  )
p3_2_3 # # ç›´è§‚åœ°çœ‹çš„è¯ï¼Œå¥½åƒç¡®å®ä¸å¤ªä¸€æ ·ã€‚

# ä¿å­˜å›¾è¡¨
ggsave(
  filename = here::here("data", params$name, "15_beta_pcoa_bray_curtis_genus.png"),
  plot = p3_2_3,
  width = 8, height = 6, dpi = 300
)


# 2.4 PERMANOVAæ£€éªŒ
standard_genus_ca_corepair_permanova_result <- getPERMANOVA(
  tse_standard_genus_ca_corepair,
  assay.type = "relabundance",
  formula = x ~ treatment_group
)

print(standard_genus_ca_corepair_permanova_result$permanova)
# å¾—åˆ°P = 0.006ï¼Œå˜å¼‚é¼ çš„HpWT å’Œ HpKO ç»„ä¹‹é—´ï¼Œå…¶Î²-diversityæœ‰æ˜¾è‘—æ€§å·®å¼‚(genuså±‚é¢)ã€‚
# ğŸŒ¸è¯´æ˜ CagA å¯¹èŒç¾¤çš„é‡å¡‘æ•ˆåº”ä¸ä»…ä»…å‘ç”Ÿåœ¨ä¸ªåˆ«ç‰©ç§ä¸Šï¼Œè€Œæ˜¯åœ¨æ•´ä¸ªå®¶æ—ï¼ˆå±ï¼‰å±‚é¢éƒ½æœ‰ä½“ç°

# ä¿å­˜PERMANOVAç»“æœï¼ˆGenusæ°´å¹³ï¼‰
write.csv(
  standard_genus_ca_corepair_permanova_result$permanova,
  file = here::here("data", params$name, "17_permanova_bray_curtis_genus.csv"),
  row.names = TRUE
)
```
Î²-diversityå°ç»“ï¼š
CagA å¯¹èŒç¾¤çš„é‡å¡‘æ•ˆåº”ä¸ä»…ä»…å‘ç”Ÿåœ¨ä¸ªåˆ«ç‰©ç§ä¸Šï¼Œè€Œæ˜¯åœ¨æ•´ä¸ªå®¶æ—ï¼ˆå±ï¼‰å±‚é¢éƒ½æœ‰ä½“ç°

### 1.3.3 å·®å¼‚ä¸°åº¦åˆ†æ (DAA)
```{r}
# tse_standard_species_ca_cleaned_corepair
# tse_standard_genus_ca_corepair
# ------------------------------------------------------------------------------
# 1.ä½¿ç”¨ ANCOM-BC è¿›è¡Œå·®å¼‚åˆ†æ (ApcMUT_HpWT vs ApcMUT_HpKO)(species)
# ------------------------------------------------------------------------------
standard_species_ca_cleaned_corepair_ancom_result <- ancombc2(
  data         = tse_standard_species_ca_cleaned_corepair,
  assay.type   = "counts",
  fix_formula  = "treatment_group",
  p_adj_method = "fdr",
  group        = "treatment_group",
  struc_zero   = TRUE,
  neg_lb       = TRUE,
  global       = TRUE
)

# æå–å‰ 10 åæœ€æ˜¾è‘—çš„ç‰©ç§ï¼ˆæŒ‰ Q å€¼æ’åºï¼‰
standard_species_ca_cleaned_corepair_top10_taxa <- standard_species_ca_cleaned_corepair_ancom_result$res |>
    dplyr::select(
        taxon, 
        p_treatment_groupApcMUT_HpWT,  # åŸå§‹ P å€¼
        q_treatment_groupApcMUT_HpWT,  # çŸ«æ­£åçš„ Q å€¼ (FDR)
        lfc_treatment_groupApcMUT_HpWT # æ•ˆåº”é‡ï¼šæ­£å€¼ä»£è¡¨åœ¨ HpWT ç»„å¯Œé›†
    ) |>
    # æŒ‰ Q å€¼ä»å°åˆ°å¤§æ’åº
    dplyr::arrange(q_treatment_groupApcMUT_HpWT) |>
    # å–å‰ 10 å
    head(10)

# æ‰“å°ç»“æœ æ²¡æœ‰qå€¼å°äº0.05çš„æ˜¾è‘—æ€§å·®å¼‚
standard_species_ca_cleaned_corepair_top10_taxa

# ä¿å­˜ANCOM-BCç»“æœï¼ˆSpeciesæ°´å¹³ï¼‰
write.csv(
  standard_species_ca_cleaned_corepair_top10_taxa,
  file = here::here("data", params$name, "18_daa_ancombc_top10_species.csv"),
  row.names = FALSE
)

# taxon                                       p         q         lfc 
# 1	Microbacterium sp. nov. GSS16	      0.009393182	0.1942202	- 1.2183692
# 2	Microbacterium sp. LKL04	          0.009980731	0.1942202	- 1.4737772
# 3	Microbacterium trichothecenolyticum	0.006692324	0.1942202	- 1.2684134
# 4	Microbacterium terricola	          0.006308883	0.1942202	- 1.6019392
# 5	Microbacterium lushaniae	          0.006590145	0.1942202	- 1.3826046
# 6	Microbacterium caowuchunii	        0.004509353	0.1942202	- 1.4505803
# 7	Microbacterium hydrocarbonoxydans	  0.009543073	0.1942202	- 1.1074346
# 8	Microbacterium sediminis	          0.001383167	0.1942202	- 1.4249033
# 9	Pseudarthrobacter sp. H2	          0.008932442	0.1942202	  0.4777780
# 10	Kocuria turfanensis              	0.009926458	0.1942202	  0.6983797


# ------------------------------------------------------------------------------
# 2.ä½¿ç”¨ ANCOM-BC è¿›è¡Œå·®å¼‚åˆ†æ (ApcMUT_HpWT vs ApcMUT_HpKO)(genus)
# ------------------------------------------------------------------------------
standard_genus_ca_corepair_ancom_result <- ancombc2(
  data         = tse_standard_genus_ca_corepair,
  assay.type   = "counts",
  fix_formula  = "treatment_group",
  p_adj_method = "fdr",
  group        = "treatment_group",
  struc_zero   = TRUE,
  neg_lb       = TRUE,
  global       = TRUE
)

# æå–å‰ 10 åæœ€æ˜¾è‘—çš„å±ï¼ˆæŒ‰ Q å€¼æ’åºï¼‰
standard_genus_ca_corepair_top10_taxa <- standard_genus_ca_corepair_ancom_result$res |>
    dplyr::select(
        taxon, 
        p_treatment_groupApcMUT_HpWT,  # åŸå§‹ P å€¼
        q_treatment_groupApcMUT_HpWT,  # çŸ«æ­£åçš„ Q å€¼ (FDR)
        lfc_treatment_groupApcMUT_HpWT # æ•ˆåº”é‡ï¼šæ­£å€¼ä»£è¡¨åœ¨ HpWT ç»„å¯Œé›†
    ) |>
    # æŒ‰ Q å€¼ä»å°åˆ°å¤§æ’åº
    dplyr::arrange(q_treatment_groupApcMUT_HpWT) |>
    # å–å‰ 10 å
    head(10)

# æ‰“å°ç»“æœ æ²¡æœ‰qå€¼å°äº0.05çš„æ˜¾è‘—æ€§å·®å¼‚
standard_genus_ca_corepair_top10_taxa

# ä¿å­˜ANCOM-BCç»“æœï¼ˆGenusæ°´å¹³ï¼‰
write.csv(
  standard_genus_ca_corepair_top10_taxa,
  file = here::here("data", params$name, "19_daa_ancombc_top10_genus.csv"),
  row.names = FALSE
)

# taxon                                       p         q         lfc 
# 1	[Clostridium]	                       0.018552066	0.3515041	 0.3697430
# 2	[Ruminococcus]	                     0.009940363	0.3515041	 0.4598610
# 3	Acetobacterium	                     0.014977858	0.3515041	 0.3423187
# 4	Aciduricibacillus	                   0.023893769	0.3515041	 0.3894304
# 5	Adhaeribacter	                       0.024413226	0.3515041	-0.4432572
# 6	Aedoeadaptatus	                     0.008603206	0.3515041	 0.3998087
# 7	Aegicerativicinus	                   0.016417508	0.3515041	-0.5180032
# 8	Agathobaculum	                       0.007932780	0.3515041	 0.5551428
# 9	Akkermansia	                         0.012690889	0.3515041	 0.4387427
# 10	Aliisedimentitalea	               0.010885183	0.3515041	 0.7669521
```

ANCOM-BCç»“æœåˆ†æï¼š
ï¼ˆ1ï¼‰æ•´ä½“ç»“æœï¼š
ä»ç»Ÿè®¡å­¦ä¸¥è°¨æ€§æ¥çœ‹ï¼Œæ— è®ºæ˜¯ç‰©ç§æ°´å¹³ï¼ˆqâ‰ˆ0.19ï¼‰è¿˜æ˜¯å±æ°´å¹³ï¼ˆqâ‰ˆ0.35ï¼‰ï¼Œå‡æœªè¾¾åˆ°ä¼ ç»Ÿçš„æ˜¾è‘—æ€§å·®å¼‚é˜ˆå€¼ï¼ˆq<0.05ï¼‰ã€‚è¯´æ˜CagA è¯±å¯¼çš„èŒç¾¤æ”¹å˜åœ¨ä¸°åº¦å±‚é¢å¯èƒ½ä¸å‰§çƒˆï¼Œè€Œæ˜¯ç»†å¾®çš„åç§»ã€‚
ï¼ˆ2ï¼‰ç‰©ç§å±‚é¢ï¼ˆspeciesï¼‰
å‰ 8 åå…¨æ˜¯ Microbacteriumï¼ˆå¾®æ†èŒå±ï¼‰ï¼Œä¸”LFC å‡ä¸ºè´Ÿå€¼ï¼ˆçº¦ -1.1 åˆ° -1.6ï¼‰ã€‚è¯´æ˜åœ¨ HpWTï¼ˆè‡´ç˜¤ç»„ï¼‰ä¸­ï¼Œè¿™äº›ç»†èŒç›¸å¯¹äº HpKO ç»„æ˜¯å‡å°‘çš„ã€‚
æš—ç¤ºäº†è‡´ç—…æ€§ CagA æ„ŸæŸ“åï¼Œè‚ é“ç¯å¢ƒï¼ˆå¯èƒ½æ˜¯ç”±äºæŒç»­çš„ T ç»†èƒæ¿€æ´»æˆ–ç‚ç—‡ï¼‰å¯¹ Microbacterium äº§ç”Ÿäº†æŸç§ç¨‹åº¦çš„æŠ‘åˆ¶ä½œç”¨ã€‚
å®ƒä»¬è™½ç„¶ä¸æ˜¯ç›´æ¥æ¨åŠ¨è‚¿ç˜¤çš„â€œåèŒâ€ï¼Œä½†å¯ä»¥ä½œä¸ºç¯å¢ƒæ¶åŒ–çš„è¡¨ç°èŒç§ã€‚
ï¼ˆ3ï¼‰å±å±‚é¢ï¼ˆgenusï¼‰
å±æ°´å¹³çš„ q å€¼æ›´é«˜ï¼ˆç»Ÿè®¡æ•ˆèƒ½æ›´ä½ï¼‰ã€‚
    â—¦ Akkermansia (LFC 0.43)ï¼šè¿™ç§èŒé€šå¸¸ä¸ç²˜è†œå±‚ç›¸äº’ä½œç”¨ï¼Œè™½ç„¶æœ‰æ—¶è¢«è§†ä¸ºç›Šç”ŸèŒï¼Œä½†åœ¨ç‰¹å®šè‚¿ç˜¤èƒŒæ™¯ä¸‹å…¶ä»£è°¢äº§ç‰©ä¸å…ç–«ç³»ç»Ÿæœ‰å¤æ‚äº’åŠ¨ã€‚
    â—¦ [Ruminococcus] (LFC 0.45) å’Œ Agathobaculum (LFC 0.55)ï¼šè¿™äº›å±æ¶‰åŠå¤æ‚çš„ç¢³æ°´åŒ–åˆç‰©ä»£è°¢ã€‚åœ¨ä½ çš„â€œåŠŸèƒ½è„šå°â€å‡è¯´ä¸­ï¼Œè¿™äº›èŒå¯èƒ½é€šè¿‡äº§ç”Ÿç‰¹å®šçš„ä»£è°¢ç‰©ï¼ˆå¦‚çŸ­é“¾è„‚è‚ªé…¸æˆ–å…¶ä»–éè‚½åˆ†å­ï¼‰æ¥æŒç»­æ¿€æ´» CagA ç‰¹å¼‚æ€§ T ç»†èƒã€‚
    â—¦ Aliisedimentitalea (LFC 0.76)ï¼šè¯¥å±è¡¨ç°å‡ºæœ€å¼ºçš„å¯Œé›†è¶‹åŠ¿ï¼Œå»ºè®®é‡ç‚¹å…³æ³¨ã€‚
    
ï¼ˆ4ï¼‰ä¸ºä»€ä¹ˆç‰©ç§å±‚é¢ï¼ˆspeciesï¼‰ä¸­Microbacteriumï¼ˆå¾®æ†èŒå±ï¼‰å‡ºç°è¿™ä¹ˆå¤šï¼Œä½†æ˜¯åœ¨å±å±‚é¢æ²¡æœ‰å‡ºç°ï¼Ÿå±æ°´å¹³çš„åˆ†æï¼ˆAgglomerationï¼‰å°†å¤šä¸ªå¾®å¼±çš„ç‰©ç§ä¿¡å·åˆå¹¶ã€‚ä¾‹å¦‚ï¼Œå¯èƒ½æœ‰å¾ˆå¤šç§ä¸åŒçš„ Ruminococcus éƒ½åœ¨å°å¹…å¢åŠ ï¼Œå•ç‹¬çœ‹éƒ½ä¸æ˜¾è‘—ï¼Œä½†èšåˆæˆâ€œå±â€æ—¶ï¼Œä¿¡å·å°±è¢«æ”¾å¤§äº†ã€‚

ä¸‹ä¸€æ­¥å†ä½¿ç”¨ALDEè¿›è¡Œè¿›ä¸€æ­¥æµ‹å®šã€‚
```{r}
# ------------------------------------------------------------------------------
# 3.ä½¿ç”¨ ALDEx2 è¿›è¡ŒéªŒè¯ï¼ˆäº¤å‰éªŒè¯ï¼‰ (ApcMUT_HpWT vs ApcMUT_HpKO)(species)
# ------------------------------------------------------------------------------
# 3.0 æ•°æ®ç±»å‹æ•´ç†
# æå–è®¡æ•°çŸ©é˜µå¹¶ç¡®ä¿å®ƒæ˜¯çº¯ç²¹çš„æ•°å€¼çŸ©é˜µ (Matrix)
standard_species_ca_cleaned_corepair_pure_counts <- as.matrix(assay(tse_standard_species_ca_cleaned_corepair, "counts"))
mode(standard_species_ca_cleaned_corepair_pure_counts) <- "numeric"

# æå–åˆ†ç»„å˜é‡å¹¶åŠ¡å¿…è½¬ä¸ºå­—ç¬¦å‘é‡ (Character)ï¼Œè¿™æ˜¯é˜²æ­¢ 'round' æŠ¥é”™çš„å…³é”® [å¯¹è¯å†å²]
standard_species_ca_cleaned_corepair_group_vector <- as.character(tse_standard_species_ca_cleaned_corepair$treatment_group)

# 3.1 ç”Ÿæˆè’™ç‰¹å¡æ´›æŠ½æ ·å¹¶è¿›è¡Œ CLR è½¬æ¢
standard_species_ca_cleaned_corepair_x_aldex <- ALDEx2::aldex.clr(
    reads       = standard_species_ca_cleaned_corepair_pure_counts, 
    conds       = standard_species_ca_cleaned_corepair_group_vector, 
    mc.samples  = 128,          # 128 æ¬¡æŠ½æ ·å¯æä¾›ç¨³å¥çš„ä¼°è®¡ 
    verbose     = FALSE
)

# 3.2 è¿è¡Œ Wilcoxon æ£€éªŒå’Œæ•ˆåº”å€¼è®¡ç®—
standard_species_ca_cleaned_corepair_x_tt <- aldex.ttest(standard_species_ca_cleaned_corepair_x_aldex, paired.test = FALSE)

standard_species_ca_cleaned_corepair_x_effect <- aldex.effect(standard_species_ca_cleaned_corepair_x_aldex, CI = TRUE)

# 3.3 åˆå¹¶ç»“æœå¹¶ç­›é€‰å·®å¼‚æ˜¾è‘—ä¸”æ•ˆåº”æ˜æ˜¾çš„èŒ (FDR < 0.05)
standard_species_ca_cleaned_corepair_aldex_out <- data.frame(standard_species_ca_cleaned_corepair_x_tt, standard_species_ca_cleaned_corepair_x_effect)

standard_species_ca_cleaned_corepair_significant_aldex <- standard_species_ca_cleaned_corepair_aldex_out |> 
    dplyr::filter(wi.eBH < 0.05) |> 
    arrange(desc(diff.btw))

standard_species_ca_cleaned_corepair_display_table_3_3_1 <- standard_species_ca_cleaned_corepair_significant_aldex |>
    tibble::rownames_to_column(var = "taxon") |>
    dplyr::select(taxon, wi.eBH, effect) |>
    dplyr::arrange(desc(effect))

standard_species_ca_cleaned_corepair_display_table_3_3_1

# ä¿å­˜ALDEx2ç»“æœï¼ˆSpeciesæ°´å¹³ï¼Œæ˜¾è‘—å·®å¼‚ï¼‰
write.csv(
  standard_species_ca_cleaned_corepair_display_table_3_3_1,
  file = here::here("data", params$name, "20_daa_aldex2_significant_species.csv"),
  row.names = FALSE
)

#      taxon              wi.eBH       effect
# Variovorax sp. EBFNA2	    0	         -1.856819		
# Cnuibacter sp. UC19_7	    0	         -1.893983		
# Agromyces aureus	        0	         -1.972783	


# ------------------------------------------------------------------------------
# 4.ä½¿ç”¨ ALDEx2 è¿›è¡ŒéªŒè¯ï¼ˆäº¤å‰éªŒè¯ï¼‰ (ApcMUT_HpWT vs ApcMUT_HpKO)(genus)
# ------------------------------------------------------------------------------
# æå–è®¡æ•°çŸ©é˜µå¹¶ç¡®ä¿å®ƒæ˜¯çº¯ç²¹çš„æ•°å€¼çŸ©é˜µ (Matrix)
standard_genus_ca_corepair_pure_counts <- as.matrix(assay(tse_standard_genus_ca_corepair, "counts"))
mode(standard_genus_ca_corepair_pure_counts) <- "numeric"

# æå–åˆ†ç»„å˜é‡å¹¶åŠ¡å¿…è½¬ä¸ºå­—ç¬¦å‘é‡ (Character)ï¼Œè¿™æ˜¯é˜²æ­¢ 'round' æŠ¥é”™çš„å…³é”® [å¯¹è¯å†å²]
standard_genus_ca_corepair_group_vector <- as.character(tse_standard_genus_ca_corepair$treatment_group)

# 4.1 ç”Ÿæˆè’™ç‰¹å¡æ´›æŠ½æ ·å¹¶è¿›è¡Œ CLR è½¬æ¢
standard_genus_ca_corepair_x_aldex <- ALDEx2::aldex.clr(
    reads       = standard_genus_ca_corepair_pure_counts, 
    conds       = standard_genus_ca_corepair_group_vector, 
    mc.samples  = 128,          
    verbose     = FALSE
)

# 4.2 è¿è¡Œ Wilcoxon æ£€éªŒå’Œæ•ˆåº”å€¼è®¡ç®—
standard_genus_ca_corepair_x_tt <- aldex.ttest(standard_genus_ca_corepair_x_aldex, paired.test = FALSE)
standard_genus_ca_corepair_x_effect <- aldex.effect(standard_genus_ca_corepair_x_aldex, CI = TRUE)

# 4.3 åˆå¹¶ç»“æœå¹¶ç­›é€‰å·®å¼‚æ˜¾è‘—ä¸”æ•ˆåº”æ˜æ˜¾çš„èŒ (FDR < 0.05)
standard_genus_ca_corepair_aldex_out <- data.frame(
  standard_genus_ca_corepair_x_tt, 
  standard_genus_ca_corepair_x_effect
  )

# standard_genus_ca_corepair_significant_aldex <- standard_genus_ca_corepair_aldex_out |> 
#     dplyr::filter(wi.eBH < 0.05) |> 
#     arrange(desc(diff.btw))
# 
# 
# standard_genus_ca_corepair_display_table_3_3_2 <- standard_genus_ca_corepair_significant_aldex |>
#     tibble::rownames_to_column(var = "taxon") |>
#     dplyr::select(taxon, wi.eBH, effect) |>
#     dplyr::arrange(desc(effect))
# 
# standard_genus_ca_corepair_display_table_3_3_2
# # ç»“æœï¼šæ²¡æœ‰ç­›é€‰å‡ºä»»ä½•å±ï¼Œä¸‹é¢å•çœ‹ä¸€ä¸‹ç›¸å¯¹å®½æ¾çš„ç­›é€‰ç»“æœï¼š

# è™½ç„¶ç»Ÿè®¡è¿˜æ²¡è¾¾åˆ°æ˜¾è‘—ï¼Œä½†ç»„é—´å·®å¼‚è¶‹åŠ¿éå¸¸æ˜æ˜¾ çš„èŒ
standard_genus_ca_corepair_trending_aldex <- standard_genus_ca_corepair_aldex_out |> 
    dplyr::filter(abs(effect) > 1) |>  # effectå¤§äº1çš„æœ‰å¾ˆå¤šï¼Œ
    dplyr::filter(wi.eBH < 0.5) |>     # ä½†æ˜¯,På°äº0.05çš„æ²¡æœ‰ï¼Œç”šè‡³å°äº0.1çš„éƒ½æ²¡æœ‰ã€‚
    dplyr::arrange(desc(abs(effect))) # æŒ‰å·®å¼‚å¼ºåº¦æ’åº

# 3. å‡†å¤‡å±•ç¤ºè¡¨æ ¼
standard_genus_ca_corepair_display_table_3_3_2 <- standard_genus_ca_corepair_trending_aldex |>
    tibble::rownames_to_column(var = "taxon") |>
    # å¢åŠ  diff.btwï¼ˆç»„é—´ä¸­ä½å·®å¼‚ï¼‰è¾…åŠ©åˆ¤æ–­æ–¹å‘
    dplyr::select(taxon, wi.eBH, effect, diff.btw) |>
    dplyr::arrange(desc(effect)) # æŒ‰å¯Œé›†ç¨‹åº¦æ’åºï¼Œæ­£æ•°ä»£è¡¨åœ¨ HpWT ç»„æ›´é«˜

# æ‰“å°ç»“æœæŸ¥çœ‹
standard_genus_ca_corepair_display_table_3_3_2

# ä¿å­˜ALDEx2ç»“æœï¼ˆGenusæ°´å¹³ï¼Œè¶‹åŠ¿æ€§å·®å¼‚ï¼‰
write.csv(
  standard_genus_ca_corepair_display_table_3_3_2,
  file = here::here("data", params$name, "21_daa_aldex2_trending_genus.csv"),
  row.names = FALSE
)

# æ¡ä»¶å·²ç»éå¸¸å®½æ¾ï¼Œä½†æ˜¯è¿˜æ˜¯åªæœ‰ä¸€ä¸ªå±ã€‚
#      taxon              wi.eBH       effect
#    Wenyingzhuangia     0.4503173    -1.313812
```
ALDEx2ç»“æœå°ç»“ï¼š
ï¼ˆ1ï¼‰ç‰©ç§æ°´å¹³ï¼ˆSpeciesï¼‰ï¼š
ariovorax sp. EBFNA2ã€Cnuibacter sp. UC19_7 å’Œ Agromyces aureus è¿™ä¸‰ä¸ªç‰©ç§ä¸ä»… wi.eBH ä¸º 0ï¼ˆç»Ÿè®¡å­¦æåº¦æ˜¾è‘—ï¼‰ï¼Œä¸” effectï¼ˆæ•ˆåº”é‡ï¼‰å‡æ¥è¿‘ã€‚è¯´æ˜ï¼š
åœ¨ ALDEx2 ä¸­ï¼Œ|effect| > 1 è¢«è®¤ä¸ºæ˜¯å…·æœ‰å¼ºç”Ÿç‰©å­¦æ„ä¹‰çš„å·®å¼‚ã€‚è¿™ä¸‰ä¸ªç‰©ç§åœ¨ HpWT ç»„ï¼ˆè‡´ç˜¤ç»„ï¼‰ä¸­å‡ ä¹æ˜¯å½»åº•æ¶ˆå¤±æˆ–è¢«å‰§çƒˆæŠ‘åˆ¶çš„ï¼Œå¯èƒ½æ˜¯ CagA è¯±å¯¼è‚ é“å¾®ç¯å¢ƒæ”¹å˜æ‰€è‡´ã€‚
ï¼ˆ2ï¼‰å±æ°´å¹³ï¼ˆGenusï¼‰ï¼š
enyingzhuangia è™½ç„¶ effect è¾¾åˆ° -1.31ï¼ˆå…·æœ‰ç”Ÿç‰©å­¦æ„ä¹‰ï¼‰ï¼Œä½† wi.eBH ä»…ä¸º 0.45ã€‚è¿™è¯´æ˜åœ¨å±æ°´å¹³ä¸Šï¼Œç”±äºå¤šä¸ªç‰©ç§çš„ä¸°åº¦å åŠ ï¼Œç»„å†…å˜å¼‚ï¼ˆVarianceï¼‰å¢å¤§ï¼Œæ©ç›–äº†ç»Ÿè®¡æ˜¾è‘—æ€§ã€‚


DAA ç»“æœç»¼è¿°ï¼š
ç»¼åˆ ANCOM-BC å’Œ ALDEx2 çš„äº¤å‰éªŒè¯ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºï¼š
(1)ä¸¤å¥—ç®—æ³•å…±åŒè¯å®äº†HpWTï¼ˆæºå¸¦ CagA ç»„ï¼‰ç»å†äº†æ˜¾è‘—çš„ç»†èŒä¸¢å¤±ï¼š
â€¢ ANCOM-BC å‘ç°ç‰©ç§æ°´å¹³ Top 8 å…¨æ˜¯ Microbacteriumï¼ˆå¾®æ†èŒå±ï¼‰ï¼Œä¸” LFC å‡åœ¨ -1.2 åˆ° -1.6 ä¹‹é—´ ã€‚
â€¢ ALDEx2 å‘ç°äº† Variovorax å’Œ Agromyces ç­‰ç‰©ç§çš„æå¼ºä¸‹è°ƒä¿¡å·ã€‚
è¿™è¯´æ˜ CagA é©±åŠ¨çš„è‡´ç˜¤è¿‡ç¨‹ä¼´éšç€è¿™äº›â€œæ­£å¸¸/èƒŒæ™¯èŒç¾¤â€çš„æ˜¾è‘—æµå¤±ï¼Œè¿™å¯èƒ½æ˜¯å¯»æ‰¾â€œfunctional footprintâ€çš„å…³é”®èƒŒæ™¯ä¿¡æ¯ã€‚
(2)åŒæ—¶ï¼Œä¹Ÿå‘ç°äº†æ­£å‘å¯Œé›†çš„ç‰©ç§
åœ¨ ANCOM-BC çš„ç‰©ç§æ°´å¹³ç»“æœä¸­ï¼Œæˆ‘ä»¬å‘ç°äº†ä¸¤ä¸ªå®è´µçš„ æ­£å‘å·®å¼‚ä¿¡å·ï¼ˆLFC > 0ï¼‰ï¼š
â€¢ Kocuria turfanensis (LFC = 0.70) å’Œ Pseudarthrobacter sp. H2 (LFC = 0.48) [å¯¹è¯å†å²]ã€‚
è™½ç„¶å®ƒä»¬çš„ q å€¼ï¼ˆ0.19ï¼‰å°šæœªè¾¾åˆ°ä¸¥æ ¼æ˜¾è‘—ï¼Œä½†åœ¨è‡´ç˜¤ç»„ä¸­æœ‰å¯Œé›†çš„è¶‹åŠ¿ã€‚è¿™äº›åœ¨è‡´ç˜¤ç¯å¢ƒä¸‹é€†åŠ¿å¢é•¿çš„ç»†èŒï¼Œå¯èƒ½ç›´æ¥åˆ†æ³Œæ¿€æ´» CD8+ T ç»†èƒçš„éè‚½ç±»åˆ†å­ã€‚
(3)å±æ°´å¹³çš„è¶‹åŠ¿è½¬ç§»
ANCOM-BC åœ¨å±æ°´å¹³ä¸Šå‘ç° [Clostridium] (LFC=0.37) å’Œ [Ruminococcus] (LFC=0.46) æœ‰å¯Œé›†è¶‹åŠ¿ã€‚

âš ï¸âš ï¸âš ï¸
è™½ç„¶ä¸¤ç§æ‰¾åˆ°çš„ Top èŒåä¸ç›¸åŒï¼Œä½†å®ƒä»¬çš„æ–¹å‘æ˜¯ä¸€è‡´çš„â€”â€”å¤§éƒ¨åˆ†å·®å¼‚èŒåœ¨ HpWT ä¸­éƒ½æ˜¯ä¸‹è°ƒçš„ã€‚
è¿™è¯æ˜äº† CagA è¯±å¯¼çš„è‚ é“ç¯å¢ƒå¯¹åŸä½èŒç¾¤å…·æœ‰æå¼ºçš„æŠ‘åˆ¶ä½œç”¨ï¼Ÿï¼Ÿï¼Ÿâ—

### 1.3.4 DAAå¯è§†åŒ–

#### 3.4.1 ALDEx2 æ•ˆåº”é‡å¯è§†åŒ–

```{r}
#| label: daa-aldex2-effect-size-viz
#| fig-width: 8
#| fig-height: 5

# ==============================================================================
# ALDEx2 æ˜¾è‘—å·®å¼‚ç‰©ç§æ•ˆåº”é‡å¯è§†åŒ–
# ==============================================================================

# è¯»å– ALDEx2 æ˜¾è‘—ç»“æœ
daa_aldex2_data <- read.csv(
  here::here("data", params$name, "20_daa_aldex2_significant_species.csv")
)

if (nrow(daa_aldex2_data) > 0) {
  # æ•°æ®æ•´ç†
  daa_aldex2_plot <- daa_aldex2_data |>
    dplyr::rename(species = taxon, q_value = wi.eBH) |>
    dplyr::mutate(
      species = factor(species, levels = species[order(effect)]),
      direction = ifelse(effect < 0, "Depleted in CagA+", "Enriched in CagA+"),
      sig_label = dplyr::case_when(
        q_value < 0.001 ~ "***",
        q_value < 0.01 ~ "**",
        q_value < 0.05 ~ "*",
        TRUE ~ ""
      )
    )

  # ç»˜åˆ¶æ•ˆåº”é‡æ¡å½¢å›¾
  p_aldex2_effect <- ggplot(daa_aldex2_plot,
                             aes(x = effect, y = species, fill = direction)) +
    geom_col(width = 0.7, alpha = 0.85) +
    geom_vline(xintercept = 0, linetype = "solid", color = "gray30", linewidth = 0.5) +
    geom_vline(xintercept = c(-1, 1), linetype = "dashed", color = "gray50", linewidth = 0.3) +
    geom_text(aes(label = sig_label, x = effect - 0.1 * sign(effect)),
              hjust = 1, vjust = 0.5, size = 4, color = "black") +
    scale_fill_manual(values = c("Depleted in CagA+" = "#3498db",
                                  "Enriched in CagA+" = "#e74c3c")) +
    labs(
      title = "Differentially Abundant Species (ALDEx2)",
      subtitle = "Core comparison: ApcMUT_HpWT vs ApcMUT_HpKO",
      x = "Effect Size",
      y = NULL,
      fill = "Direction",
      caption = "Dashed lines: |effect| = 1 threshold; * q < 0.05, ** q < 0.01, *** q < 0.001"
    ) +
    theme_bw(base_size = 12) +
    theme(
      plot.title = element_text(face = "bold", size = 14),
      axis.text.y = element_text(face = "italic", size = 10),
      legend.position = "bottom",
      panel.grid.major.y = element_blank(),
      panel.grid.minor = element_blank()
    )

  print(p_aldex2_effect)

  ggsave(
    filename = here::here("data", params$name, "22_daa_aldex2_effect_size.png"),
    plot = p_aldex2_effect,
    width = 8, height = 5, dpi = 300, bg = "white"
  )

  cat("âœ… ALDEx2 æ•ˆåº”é‡å›¾å·²ä¿å­˜: 22_daa_aldex2_effect_size.png\n")
} else {
  cat("âš ï¸ æ—  ALDEx2 æ˜¾è‘—å·®å¼‚ç‰©ç§ï¼Œè·³è¿‡å¯è§†åŒ–\n")
}
```

#### 3.4.2 ANCOM-BC LFC å¯è§†åŒ–

```{r}
#| label: daa-ancombc-lfc-viz
#| fig-width: 10
#| fig-height: 6

# ==============================================================================
# ANCOM-BC ç»“æœå¯è§†åŒ– (Top 10 ç‰©ç§)
# ==============================================================================

# è¯»å– ANCOM-BC ç»“æœ
ancombc_species <- read.csv(
  here::here("data", params$name, "18_daa_ancombc_top10_species.csv")
)

if (nrow(ancombc_species) > 0) {
  # æ•°æ®æ•´ç† - åŠ¨æ€æŸ¥æ‰¾åˆ—å
  lfc_col <- grep("^lfc_", colnames(ancombc_species), value = TRUE)[1]
  q_col <- grep("^q_", colnames(ancombc_species), value = TRUE)[1]

  ancombc_plot_data <- ancombc_species |>
    dplyr::mutate(
      taxon_short = taxon,
      lfc = .data[[lfc_col]],
      q_value = .data[[q_col]],
      direction = ifelse(lfc < 0, "Depleted in CagA+", "Enriched in CagA+"),
      sig_label = dplyr::case_when(
        q_value < 0.05 ~ "*",
        q_value < 0.1 ~ "â€ ",
        TRUE ~ ""
      )
    ) |>
    dplyr::arrange(lfc)

  # è®¾ç½®å› å­é¡ºåº
  ancombc_plot_data$taxon_short <- factor(
    ancombc_plot_data$taxon_short,
    levels = ancombc_plot_data$taxon_short
  )

  # ç»˜åˆ¶æ¡å½¢å›¾
  p_ancombc <- ggplot(ancombc_plot_data,
                       aes(x = lfc, y = taxon_short, fill = direction)) +
    geom_col(width = 0.7) +
    geom_vline(xintercept = 0, linetype = "solid", color = "black", linewidth = 0.5) +
    geom_vline(xintercept = c(-1, 1), linetype = "dashed", color = "gray50", linewidth = 0.3) +
    geom_text(aes(label = sig_label, x = lfc - 0.05 * sign(lfc)),
              hjust = ifelse(ancombc_plot_data$lfc < 0, 1, 0),
              size = 4, fontface = "bold") +
    scale_fill_manual(values = c("Depleted in CagA+" = "#5DADE2",
                                  "Enriched in CagA+" = "#E74C3C")) +
    labs(
      title = "Differentially Abundant Species (ANCOM-BC)",
      subtitle = "Core comparison: ApcMUT_HpWT vs ApcMUT_HpKO\nNote: All FDR q > 0.05, showing consistent trend",
      x = "Log Fold Change (LFC)",
      y = NULL,
      fill = "Direction",
      caption = "Dashed lines: |LFC| = 1 threshold; * q < 0.05, â€  q < 0.1"
    ) +
    theme_minimal(base_size = 12) +
    theme(
      plot.title = element_text(face = "bold", size = 14),
      plot.subtitle = element_text(size = 10, color = "gray40"),
      axis.text.y = element_text(face = "italic", size = 10),
      legend.position = "bottom",
      panel.grid.major.y = element_blank(),
      panel.grid.minor = element_blank()
    )

  print(p_ancombc)

  ggsave(
    filename = here::here("data", params$name, "23_daa_ancombc_lfc_barplot.png"),
    plot = p_ancombc,
    width = 10, height = 6, dpi = 300, bg = "white"
  )

  cat("âœ… ANCOM-BC LFC å›¾å·²ä¿å­˜: 23_daa_ancombc_lfc_barplot.png\n")
}
```


# Part 2: Viruså¤šæ ·æ€§åˆ†æ {#sec-virus}

æœ¬éƒ¨åˆ†åˆ†æç—…æ¯’ç»„æ•°æ®ï¼Œæ–¹æ³•ä¸Part 1ç›¸åŒï¼Œç”¨äºæ¯”è¾ƒç»†èŒå’Œç—…æ¯’å¯¹CagAæ„ŸæŸ“çš„å“åº”å·®å¼‚ã€‚

## 2.1 å¯¼å…¥æ•°æ®å¹¶æ„å»ºTreeSE
```{r}
# Step 1ï¼šå®šä¹‰å¯¼å…¥æ–‡ä»¶å‡½æ•°
read_bracken_virus_species <- function(path) {
  files <- list.files(path, pattern = "_S\\.tsv$", full.names = TRUE)

  abundance_list <- lapply(files, function(f) {
    df <- readr::read_tsv(f, show_col_types = FALSE)

    sample_id <- basename(f) |> stringr::str_extract("^[^_]+")

    tibble(
      feature = df$name,
      abundance = df$new_est_reads,
      sample = sample_id
    )
  })

  bind_rows(abundance_list)
}

# Step 2ï¼šæ„å»ºcount matrix
bracken_long_virus_species <- read_bracken_virus_species(
  here::here(
    "data",
    "00-raw",
    "d01_alpha_beta_diversity_analysis",
    "bracken_virus"
  )
)

count_mat_virus_species <- bracken_long_virus_species |>
  pivot_wider(
    names_from  = sample,
    values_from = abundance,
    values_fill = 0
  ) |>
  column_to_rownames("feature") |>
  as.matrix()

dim(count_mat_virus_species)
head(rownames(count_mat_virus_species))
head(colnames(count_mat_virus_species))

# Step 3ï¼šæ„å»º tse_virus_species
tse_virus_species <- TreeSummarizedExperiment(
  assays = list(counts = count_mat_virus_species)
)
# tse_virus_species

# Step 4ï¼šæ„å»ºrowData
rowData(tse_virus_species)$Species <- rownames(tse_virus_species)
# tse_virus_species

# Step 5ï¼šç»‘å®š metadata
metadata <- readxl::read_xlsx(
  here::here("data", "metadata", "pc047-metadata.xlsx")
) |>
  column_to_rownames("sample_id")

common_samples <- base::intersect(
  colnames(tse_virus_species),
  rownames(metadata)
)

tse_virus_species <- tse_virus_species[, common_samples]
colData(tse_virus_species) <- DataFrame(metadata[common_samples, ])
# tse_virus_species

# Step 6.å»ºç«‹åªæœ‰ ca (caecum) çš„å­é›†
# ç­›é€‰é€»è¾‘ï¼šä¿ç•™ sample_type ç­‰äº "caecum" çš„åˆ—
tse_virus_species_ca <- tse_virus_species[, tse_virus_species$source_organ == "caecum"]
# tse_virus_species_ca
```

## 2.2 æ•°æ®æ¢ç´¢ä¸è´¨é‡æ§åˆ¶
### ç¬¬ä¸€éæ¸…æ´—(æ•°æ®æ¢ç´¢)
```{r}
# ------------------------------------------------------------------------------
# 0. å®šä¹‰ç—…æ¯’é»‘åå•å¹¶å‰”é™¤
# ------------------------------------------------------------------------------
# è¿™äº›ç—…æ¯’ç‰©ç§åœ¨æŸäº›æ ·æœ¬ä¸­ä¸°åº¦å¼‚å¸¸é«˜ï¼Œå¯èƒ½æ˜¯æ±¡æŸ“æˆ–æŠ€æœ¯å™ªéŸ³
# å®šä¹‰ pc047 é¡¹ç›®ç—…æ¯’é»‘åå• (åŸºäº Top 1-100 åå•)
virusblacklist <- c(
  # --- 1. æ˜ç¡®çš„è·¨ç‰©ç§/æŠ€æœ¯æ€§æ±¡æŸ“ (å¿…é¡»å‰”é™¤) ---
  "Baboon endogenous virus", "Simian retrovirus 8",                # çµé•¿ç±»
  "Betatorquevirus homini3", "Endlipuvirus intestinihominis",    # äººæº
  "Percavirus equidgamma5", "Eponavirus epona",                  # é©¬ç›¸å…³
  "RD114 retrovirus",                                            # çŒ«ç›¸å…³
  
  # --- 2. ç¯å¢ƒèƒŒæ™¯å™ªå£°ï¼šå·¨å‹ç—…æ¯’ (å»ºè®®å‰”é™¤) ---
  "Pandoravirus salinus", "Pandoravirus neocaledonia", 
  "Pandoravirus macleodensis", "Pandoravirus inopinatum", 
  "Pandoravirus dulcis", "Pandoravirus quercus", 
  "Mimivirus bradfordmassiliense", "Mollivirus sibericum", 
  "Fadolivirus algeromassiliense", "Faustvirus faust", 
  "Tupanvirus salinum", "Tupanvirus altamarinense", 
  "Alphaorpheovirus massiliense", "Megavirus chilense", 
  "Moumouvirus australiense", "Moumouvirus goulettemassiliense", 
  "Moumouvirus moumou", "Acanthamoeba castellanii medusavirus",
  "Cotonvirus japonicum",
  
  # --- 3. é¥®é£Ÿ/éé¢„æœŸå®¿ä¸»å¹²æ‰° (å»ºè®®å‰”é™¤) ---
  "Gorganvirus isfahan", "Bracoviriform facetosae",              # æ˜†è™«
  "Mushuvirus mushu", "Gammanudivirus cracrangonis",            # æ˜†è™«
  "Alphabaculovirus leseparatae", "Alphabaculovirus capomonae",  # æ˜†è™«
  "Betabaculovirus chofumiferanae",                             # æ˜†è™«
  "Chrysochromulina ericina virus",                             # è—»ç±»
  "Lymphocystivirus micropogonias1", "Cyvirus cyprinidallo3",    # é±¼ç±»
  "Mardivirus columbidalpha1",                                  # é¸½å­
  "Fraservirus testudinis",                                     # ä¹Œé¾Ÿ
  "Orthobunyavirus schmallenbergense", "Orthobunyavirus simbuense" # ååˆåŠ¨ç‰©
)

tse_virus_species_ca_1 <- tse_virus_species_ca
dim(tse_virus_species_ca_1) # å‰”é™¤å‰

# å‰”é™¤é»‘åå•ä¸­çš„ç‰©ç§
tse_virus_species_ca_1 <- tse_virus_species_ca_1[!rownames(tse_virus_species_ca_1) %in% virusblacklist, ]
dim(tse_virus_species_ca_1) # å‰”é™¤å

# ------------------------------------------------------------------------------
# 1. è‡ªåŠ¨è®¡ç®—è´¨é‡æ§åˆ¶æŒ‡æ ‡ (Library Size)
# ------------------------------------------------------------------------------
# ä½¿ç”¨ scuttle åŒ…è®¡ç®—æ¯ä¸ªæ ·æœ¬çš„æ€» reads æ•°ï¼ˆæ–‡åº“å¤§å°ï¼‰
# è¿™ä¼šåœ¨ colData ä¸­ç”Ÿæˆ 'total' åˆ—
tse_virus_species_ca_1 <- addPerCellQCMetrics(tse_virus_species_ca_1)

# å¯è§†åŒ–æ–‡åº“å¤§å°åˆ†å¸ƒ
# å¦‚æœ sampling depth å·®å¼‚è¿‡å¤§ï¼ˆä¾‹å¦‚è¶…è¿‡ 40 å€ï¼‰ï¼Œå¯èƒ½éœ€è¦åç»­è¿‡æ»¤
p1_virus <- plotHistogram(tse_virus_species_ca_1, col.var = "total") +
  labs(title = "Library Size Distribution", x = "Total Reads")
p1_virus

tse_virus_species_ca_1

# 2. é’ˆå¯¹caçš„prevalenceåˆ†æä¸ æ¸…æ´—ï¼ˆprevalence ï¼10%ï¼‰
tse_virus_species_ca_1 <- addPrevalence(
  tse_virus_species_ca_1,
  assay.type = "counts",
  detection = 0,
  as.relative = TRUE
)

rowData(tse_virus_species_ca_1)$prevalence <- as.numeric(rowData(tse_virus_species_ca_1)$prevalence)
summary(rowData(tse_virus_species_ca_1)$prevalence) # æŸ¥çœ‹æœ€å¤§å€¼ã€ä¸­ä½æ•°ç­‰
# æœ€å¤§å€¼ä¸è¶…è¿‡1ï¼Œæœ€å°ä¹Ÿå¤§è¿‡0ï¼Œè¯´æ˜æ²¡é—®é¢˜

p2_virus <- plotHistogram(tse_virus_species_ca_1, row.var = "prevalence") +
  labs(title = "Feature Prevalence Distribution", x = "Prevalence (Fraction of Samples)")
p2_virus

# è·å–æ™®éæ€§å¤§äº 10% çš„ç‰©ç§åå•
prev_virus_species_ca_1 <- getPrevalent(tse_virus_species_ca_1, prevalence = 0.1)
length(prev_virus_species_ca_1) # æŸ¥çœ‹æœ‰å¤šå°‘ç‰©ç§è¾¾æ ‡ 243

# æ‰§è¡Œæ•°æ®æ¸…æ´—ï¼šåªä¿ç•™åœ¨ >10% æ ·æœ¬ä¸­å‡ºç°çš„ç‰©ç§
dim(tse_virus_species_ca_1)
# æ¸…æ´—å‰ 513

tse_virus_species_ca_1 <- subsetByPrevalent(tse_virus_species_ca_1, prevalence = 0.1)
dim(tse_virus_species_ca_1)
# æ¸…æ´—å 243

# 3. å°†æ•°æ®è½¬åŒ–ä¸ºç›¸å¯¹ä¸°åº¦ åŠ ä¸»å¯¼speciesåˆ†æ
tse_virus_species_ca_1 <- transformAssay(tse_virus_species_ca_1, method = "relabundance")

# æ‰¾å‡ºä¸°åº¦å‰åçš„species
top_taxa_virus_species_ca_1 <- getTop(tse_virus_species_ca_1, top = 100, assay.type = "relabundance")
top_taxa_virus_species_ca_1
# è¿è¡ŒåæŸ¥çœ‹top taxaåˆ—è¡¨ï¼Œç¡®è®¤é»‘åå•ç‰©ç§å·²è¢«å‰”é™¤
# ç—…æ¯’æ•°æ®ä»¥é¼ æºé€†è½¬å½•ç—…æ¯’ä¸ºä¸»
# å·²é€šè¿‡virus_blacklistå‰”é™¤äº†ä¸°åº¦å¼‚å¸¸çš„ç‰©ç§
```

### ç¬¬äºŒéæ¸…æ´— ç¾¤è½ç»„æˆå›¾æ£€æŸ¥å¼‚å¸¸æ ·æœ¬
```{r}
tse_virus_species_ca_2 <- tse_virus_species_ca_1

# ------------------------------------------------------------------------------
# 1. ç¾¤è½ç»„æˆå›¾ æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸æ ·æœ¬
# ------------------------------------------------------------------------------
# æ‰¾å‡ºä¸°åº¦å‰åçš„species
top_taxa_virus_species_ca_2 <- getTop(tse_virus_species_ca_2, top = 10, assay.type = "relabundance")
top_taxa_virus_species_ca_2

# ä¸ºäº†é˜²æ­¢æ±¡æŸ“ï¼Œå¤åˆ¶ä¸€ä¸ªtseæ–‡ä»¶ç”¨äºç»‘å›¾
tse_virus_species_ca_top10forplot_2 <- tse_virus_species_ca_2

# å°†å‰ 10 åä»¥å¤–çš„ç‰©ç§é‡å‘½åä¸º "Other"
rowData(tse_virus_species_ca_top10forplot_2)$Species_Top10 <- ifelse(
  rownames(tse_virus_species_ca_top10forplot_2) %in% top_taxa_virus_species_ca_2,
  rownames(tse_virus_species_ca_top10forplot_2),
  "Other"
)

# ä»¥æ­¤èšåˆ
tse_virus_species_ca_top10forplot_2 <- agglomerateByVariable(
  tse_virus_species_ca_top10forplot_2,
  by = "rows",
  f = "Species_Top10"
)

# ç»‘å›¾
p1_virus_composition <- plotAbundance(
  tse_virus_species_ca_top10forplot_2,
  assay.type = "relabundance",
  order.row.by = "abund",
  order.col.by = "Other"
) +
  labs(
    title = "Top 10 Virus Species Composition (Caecum)",
    subtitle = "Non-top taxa grouped as 'Other'"
  ) +
  theme(axis.text.x = element_blank())
p1_virus_composition

# ä¿å­˜å›¾è¡¨
ggsave(
  filename = here::here("data", params$name, "22_composition_top10_virus_species.png"),
  plot = p1_virus_composition,
  width = 12, height = 6, dpi = 300
)

# æ£€æŸ¥æ˜¯å¦æœ‰åƒstandardä¸­ca08é‚£æ ·çš„å¼‚å¸¸æ ·æœ¬
# æœ‰ä¸€ä¸ªæ ·æœ¬
sample_id_cleaning_2_2 <- which.max(assay(tse_virus_species_ca_2, "relabundance")["Andhravirus andhra", ])
sample_id_cleaning_2
# æœç„¶è¿˜æ˜¯ca08ï¼Œå‰”é™¤æ‰ã€‚
# è§‚å¯Ÿå›¾è¡¨ï¼Œå¦‚æœæ²¡æœ‰æ˜æ˜¾å¼‚å¸¸ï¼Œåˆ™ç»§ç»­ä¸‹ä¸€æ­¥
# ä½œä¸ºè®­ç»ƒé¡¹ç›®ï¼Œæ­¤å¤„ä¸å»é™¤ä»»ä½•æ ·æœ¬

tse_virus_species_ca_2 <- tse_virus_species_ca_2[, colnames(tse_virus_species_ca) != "ca08"]
tse_standard_species_ca_3 # è¿™é‡Œå°±æœ‰28ä¸ªæ ·æœ¬äº†ï¼Œè¯´æ˜å»é™¤æˆåŠŸäº†ã€‚
```

### ç¬¬ä¸‰éæ¸…æ´— è¿‡æ»¤é›¶æ–¹å·®ç‰¹å¾
```{r}
tse_virus_species_ca_3 <- tse_virus_species_ca_2

# ------------------------------------------------------------------------------
# 1. è®¡ç®—æ¯ä¸ªç‰©ç§åœ¨æ‰€æœ‰æ ·æœ¬ä¸­çš„æ ‡å‡†å·® (sd)ï¼Œå¹¶å­˜å…¥ rowData
# ------------------------------------------------------------------------------
rowData(tse_virus_species_ca_3)[["sd"]] <- MatrixGenerics::rowSds(assay(tse_virus_species_ca_3, "counts"))

# ç»Ÿè®¡æœ‰å¤šå°‘ç‰©ç§ä¸æ˜¯é›¶æ–¹å·®çš„ï¼Ÿ
table(rowData(tse_virus_species_ca_3)$sd > 0)

# 2. æ‰§è¡Œè¿‡æ»¤ï¼šè®¾ç½®ä¸€ä¸ªå°é˜ˆå€¼ï¼ˆ > 0.001ï¼‰æ¥è¿‡æ»¤æ‰å˜åŠ¨æå°çš„ç‰©ç§
tse_virus_species_ca_3 <- tse_virus_species_ca_3[rowData(tse_virus_species_ca_3)$sd > 0.001, ]

dim(tse_virus_species_ca_3)
```

### æ¸…æ´—åçš„æ•°æ®æ•´ç† åŠ genusæ°´å¹³èšåˆ
```{r}
# ------------------------------------------------------------------------------
# 1.æ¸…æ´—åæ•°æ®å¦ä¿å­˜ä¸ºclean tseæ–‡ä»¶
# ------------------------------------------------------------------------------
tse_virus_species_ca_cleaned <- tse_virus_species_ca_3
tse_virus_species_ca_cleaned

# ------------------------------------------------------------------------------
# 2.genusæ°´å¹³èšåˆ
# ------------------------------------------------------------------------------
# 2.1 åœ¨ rowData ä¸­å¢åŠ  Genus åˆ—ï¼ˆä»ç—…æ¯’ç‰©ç§åä¸­æå–å±åï¼‰
rowData(tse_virus_species_ca_cleaned)$Genus <- str_extract(rownames(tse_virus_species_ca_cleaned), "^[^ ]+")

# 2.2 é‡æ–°æ’åºï¼Œç¡®ä¿ Genus åœ¨ Species å‰é¢
correct_order_virus <- c("Genus", "Species")
rowData(tse_virus_species_ca_cleaned) <- rowData(tse_virus_species_ca_cleaned)[, correct_order_virus]

# éªŒè¯åˆ†ç±»å±‚çº§
taxonomyRanks(tse_virus_species_ca_cleaned)

# 2.3 èšåˆåˆ°genusæ°´å¹³
tse_virus_genus_ca_originfrom_virusspeciescacleaned <- agglomerateByRank(tse_virus_species_ca_cleaned, rank = "Genus")
tse_virus_genus_ca_originfrom_virusspeciescacleaned
```

## 2.3 æ•°æ®åˆ†æ
### 2.3.1 Alphaå¤šæ ·æ€§åˆ†æ
```{r}
# ------------------------------------------------------------------------------
# 1.è®¡ç®—Shannonï¼ˆä¿¡æ¯ç†µï¼‰ã€Observedï¼ˆè§‚æµ‹åˆ°çš„ç‰©ç§æ•°ï¼‰
# ------------------------------------------------------------------------------
tse_virus_species_ca_cleaned <- addAlpha(
  tse_virus_species_ca_cleaned,
  assay.type = "counts",
  index = c("shannon", "observed"),
  name = c("shannon_index", "observed_richness")
)
head(colData(tse_virus_species_ca_cleaned))

# ------------------------------------------------------------------------------
# 2. ç»Ÿè®¡æ£€éªŒ (Species)
# ------------------------------------------------------------------------------
# 2.0.1 æ•´ä½“å·®å¼‚æ£€æµ‹
virus_species_ca_kruskal_result_global <- kruskal.test(shannon_index ~ treatment_group, data = colData(tse_virus_species_ca_cleaned))
print(paste("å…¨å±€ Shannon å·®å¼‚ P å€¼:", round(virus_species_ca_kruskal_result_global$p.value, 4)))
# å…¨å±€ Shannon å·®å¼‚ P å€¼: 0.0184
# ğŸŒŸæ•´ä½“å­˜åœ¨æœ‰æ˜¾è‘—æ€§å·®å¼‚

# 2.1 ç­›é€‰å‡ºæ ¸å¿ƒæ¯”è¾ƒç»„ (ApcMUT_HpWT vs ApcMUT_HpKO)
tse_virus_species_ca_cleaned_corepair <- tse_virus_species_ca_cleaned[, tse_virus_species_ca_cleaned$treatment_group %in% c("ApcMUT_HpWT", "ApcMUT_HpKO")]

# ç§»é™¤æ‰ colData ä¸­é‚£äº›ä¸å†ä½¿ç”¨çš„å› å­æ°´å¹³ï¼ˆLevelï¼‰
tse_virus_species_ca_cleaned_corepair$treatment_group <- factor(tse_virus_species_ca_cleaned_corepair$treatment_group)

# 2.2 ç»Ÿè®¡æ£€éªŒ (Wilcoxon ç§©å’Œæ£€éªŒ)
virus_species_ca_wilcox_result_corepair <- wilcox.test(shannon_index ~ treatment_group, data = colData(tse_virus_species_ca_cleaned_corepair))
print(paste("Shannon æŒ‡æ•°å·®å¼‚ P å€¼:", round(virus_species_ca_wilcox_result_corepair$p.value, 4)))
# Shannon æŒ‡æ•°å·®å¼‚ P å€¼: 0.9048
# è¿™é‡Œåå€’æ˜¯æ²¡æœ‰æ˜¾è‘—æ€§å·®å¼‚äº†ã€‚ä¸ºä»€ä¹ˆï¼Œæ•´ä½“æœ‰å·®å¼‚çš„è¯ï¼Œå±€éƒ¨éš¾é“ä¸åº”è¯¥æ›´æœ‰å·®å¼‚å—ï¼Ÿ

# æ£€æŸ¥ï¼šæœªæ„ŸæŸ“æ—¶ï¼ŒApcåŸºå› å‹å¯¹ç—…æ¯’ç»„çš„å½±å“
tse_virus_baseline <- tse_virus_species_ca_cleaned[, tse_virus_species_ca_cleaned$treatment_group %in% c("ApcWT_HpKO", "ApcMUT_HpKO")]
tse_virus_baseline$treatment_group <- factor(tse_virus_baseline$treatment_group)
wilcox.test(shannon_index ~ treatment_group, data = colData(tse_virus_baseline))
# p-value = 0.06349

# æ£€æŸ¥ï¼šé‡ç”Ÿå‹ApcèƒŒæ™¯ä¸‹ï¼Œæ„ŸæŸ“çš„å½±å“
tse_virus_wt <- tse_virus_species_ca_cleaned[, tse_virus_species_ca_cleaned$treatment_group %in% c("ApcWT_HpKO", "ApcWT_HpWT")]
tse_virus_wt$treatment_group <- factor(tse_virus_wt$treatment_group)
wilcox.test(shannon_index ~ treatment_group, data = colData(tse_virus_wt))
# p-value = 0.2222


# 2.3 å¯è§†åŒ–
virus_species_ca_wilcox_result_corepair_plot_alpha <- function(tse, y_var, title) {
  plotColData(tse,
    x            = "treatment_group", y = y_var,
    colour_by    = "treatment_group",
    show_boxplot = TRUE
  ) +
    stat_compare_means(
      comparisons = list(c("ApcMUT_HpKO", "ApcMUT_HpWT")),
      method = "wilcox.test", label = "p.format"
    ) +
    labs(title = title, x = "Group", y = "Index Value") +
    theme_bw() +
    theme(legend.position = "none")
}

p3_1_virus_1 <- virus_species_ca_wilcox_result_corepair_plot_alpha(tse_virus_species_ca_cleaned_corepair, "shannon_index", "Shannon Diversity (Virus Species Level)")
p3_1_virus_2 <- virus_species_ca_wilcox_result_corepair_plot_alpha(tse_virus_species_ca_cleaned_corepair, "observed_richness", "Observed Richness (Virus Species Level)")

# æ‹¼å›¾å±•ç¤º
p3_1_virus_combined <- p3_1_virus_1 + p3_1_virus_2
p3_1_virus_combined

# ä¿å­˜å•ç‹¬çš„å›¾è¡¨
ggsave(
  filename = here::here("data", params$name, "23_alpha_shannon_diversity_virus_species.png"),
  plot = p3_1_virus_1,
  width = 6, height = 5, dpi = 300
)

ggsave(
  filename = here::here("data", params$name, "24_alpha_observed_richness_virus_species.png"),
  plot = p3_1_virus_2,
  width = 6, height = 5, dpi = 300
)

# ä¿å­˜ç»„åˆå›¾
ggsave(
  filename = here::here("data", params$name, "25_alpha_diversity_combined_virus_species.png"),
  plot = p3_1_virus_combined,
  width = 12, height = 5, dpi = 300
)

# ------------------------------------------------------------------------------
# 3. Genusæ°´å¹³å¤æ ¸ ç»Ÿè®¡æ£€éªŒ (ApcMUT_HpWT vs ApcMUT_HpKO)
# ------------------------------------------------------------------------------
tse_virus_genus_ca_originfrom_virusspeciescacleaned <- addAlpha(
  tse_virus_genus_ca_originfrom_virusspeciescacleaned,
  assay.type = "counts",
  index = c("shannon", "observed"),
  name = c("shannon_index", "observed_richness")
)

# ç­›é€‰å‡ºæ ¸å¿ƒæ¯”è¾ƒç»„
tse_virus_genus_ca_corepair <- tse_virus_genus_ca_originfrom_virusspeciescacleaned[, tse_virus_genus_ca_originfrom_virusspeciescacleaned$treatment_group %in% c("ApcMUT_HpWT", "ApcMUT_HpKO")]

# ç§»é™¤æ‰ä¸å†ä½¿ç”¨çš„å› å­æ°´å¹³
tse_virus_genus_ca_corepair$treatment_group <- factor(tse_virus_genus_ca_corepair$treatment_group)

virus_genus_ca_wilcox_result_corepair <- wilcox.test(shannon_index ~ treatment_group, data = colData(tse_virus_genus_ca_corepair))
print(paste("Genusæ°´å¹³ Shannon æŒ‡æ•°å·®å¼‚ P å€¼:", round(virus_genus_ca_wilcox_result_corepair$p.value, 4)))
# "Genusæ°´å¹³ Shannon æŒ‡æ•°å·®å¼‚ P å€¼: 0.9048"
```
Î±-diversityå°ç»“ï¼š
ç»“æœä¸Standardç»†èŒåˆ†æçš„æ¨¡å¼ä¸€è‡´ï¼š
æ ¸å¿ƒæ¯”è¾ƒç»„ï¼ˆApcMUT_HpWT vs ApcMUT_HpKOï¼‰çš„alphaå¤šæ ·æ€§æ— å·®å¼‚
è¯´æ˜CagAæ„ŸæŸ“åœ¨Apcçªå˜èƒŒæ™¯ä¸‹æ²¡æœ‰æ˜¾è‘—æ”¹å˜ç—…æ¯’ç»„çš„æ•´ä½“å¤æ‚åº¦
è¿™æ”¯æŒäº†**"Functional Footprint"å‡è¯´**ï¼šå˜åŒ–å¯èƒ½åœ¨ç»„æˆç»“æ„ï¼ˆBeta
å¤šæ ·æ€§ï¼‰æˆ–ç‰¹å®šç‰©ç§ä¸°åº¦ä¸Šï¼Œè€Œéæ•´ä½“å¤šæ ·æ€§

### 2.3.2 Betaå¤šæ ·æ€§åˆ†æ
```{r}
# ------------------------------------------------------------------------------
# 1.è®¡ç®— Bray-Curtis è·ç¦»ä¸ PCoA æ’åºå›¾ (ApcMUT_HpWT vs ApcMUT_HpKO)(species)
# ------------------------------------------------------------------------------
# 1.1 è½¬æ¢ä¸ºç›¸å¯¹ä¸°åº¦
tse_virus_species_ca_cleaned_corepair <- transformAssay(tse_virus_species_ca_cleaned_corepair, assay.type = "counts", method = "relabundance")

# 1.2 è¿è¡Œ PCoA (MDS)
tse_virus_species_ca_cleaned_corepair <- addMDS(
  tse_virus_species_ca_cleaned_corepair,
  FUN = getDissimilarity,
  method = "bray",
  assay.type = "relabundance",
  name = "PCoA_Bray"
)

# æå–ç‰¹å¾å€¼
virus_species_ca_cleaned_corepair_eigenvalues_bray <- attr(reducedDim(tse_virus_species_ca_cleaned_corepair, "PCoA_Bray"), "eig")

# è®¡ç®—ç›¸å¯¹è§£é‡Šæ–¹å·®
virus_species_ca_cleaned_corepair_relative_eigenvalues_bray <- virus_species_ca_cleaned_corepair_eigenvalues_bray / sum(virus_species_ca_cleaned_corepair_eigenvalues_bray[virus_species_ca_cleaned_corepair_eigenvalues_bray > 0])

# 1.3 å¯è§†åŒ–
p3_2_virus_1 <- plotReducedDim(
  tse_virus_species_ca_cleaned_corepair,
  "PCoA_Bray",
  colour_by = "treatment_group"
) +
  theme_bw() +
  labs(
    title = "PCoA based on Bray-Curtis Dissimilarity (Virus Species)",
    x = paste0("PCoA 1 (", round(100 * virus_species_ca_cleaned_corepair_relative_eigenvalues_bray[1], 1), "%)"),
    y = paste0("PCoA 2 (", round(100 * virus_species_ca_cleaned_corepair_relative_eigenvalues_bray[2], 1), "%)")
  )
p3_2_virus_1

# ä¿å­˜å›¾è¡¨
ggsave(
  filename = here::here("data", params$name, "26_beta_pcoa_bray_curtis_virus_species.png"),
  plot = p3_2_virus_1,
  width = 8, height = 6, dpi = 300
)

# 1.4 PERMANOVAæ£€éªŒ
virus_species_ca_cleaned_corepair_permanova_result <- getPERMANOVA(
  tse_virus_species_ca_cleaned_corepair,
  assay.type = "relabundance",
  formula = x ~ treatment_group
)

print(virus_species_ca_cleaned_corepair_permanova_result$permanova)
#                 Df SumOfSqs      R2      F Pr(>F)
# treatment_group  1 0.004191 0.10605 0.8304  0.445
# Residual         7 0.035323 0.89395              
# Total            8 0.039514 1.00000              

# ä¿å­˜PERMANOVAç»“æœ
write.csv(
  virus_species_ca_cleaned_corepair_permanova_result$permanova,
  file = here::here("data", params$name, "27_permanova_bray_curtis_virus_species.csv"),
  row.names = TRUE
)

# ------------------------------------------------------------------------------
# 2.è®¡ç®— Bray-Curtis è·ç¦»ä¸ PCoA æ’åºå›¾ (ApcMUT_HpWT vs ApcMUT_HpKO)(genus)
# ------------------------------------------------------------------------------
# 2.1 è½¬æ¢ä¸ºç›¸å¯¹ä¸°åº¦
tse_virus_genus_ca_corepair <- transformAssay(
  tse_virus_genus_ca_corepair,
  assay.type = "counts",
  method = "relabundance"
)

# 2.2 è¿è¡Œ PCoA (MDS)
tse_virus_genus_ca_corepair <- addMDS(
  tse_virus_genus_ca_corepair,
  FUN = getDissimilarity,
  method = "bray",
  assay.type = "relabundance",
  name = "PCoA_Bray"
)

# æå–ç‰¹å¾å€¼
virus_genus_ca_corepair_eigenvalues_bray <- attr(reducedDim(tse_virus_genus_ca_corepair, "PCoA_Bray"), "eig")

# è®¡ç®—ç›¸å¯¹è§£é‡Šæ–¹å·®
virus_genus_ca_corepair_relative_eigenvalues_bray <- virus_genus_ca_corepair_eigenvalues_bray / sum(virus_genus_ca_corepair_eigenvalues_bray[virus_genus_ca_corepair_eigenvalues_bray > 0])

# 2.3 å¯è§†åŒ–
p3_2_virus_2 <- plotReducedDim(
  tse_virus_genus_ca_corepair,
  "PCoA_Bray",
  colour_by = "treatment_group"
) +
  theme_bw() +
  labs(
    title = "PCoA based on Bray-Curtis Dissimilarity (Virus Genus)",
    x = paste0("PCoA 1 (", round(100 * virus_genus_ca_corepair_relative_eigenvalues_bray[1], 1), "%)"),
    y = paste0("PCoA 2 (", round(100 * virus_genus_ca_corepair_relative_eigenvalues_bray[2], 1), "%)")
  )
p3_2_virus_2

# ä¿å­˜å›¾è¡¨
ggsave(
  filename = here::here("data", params$name, "28_beta_pcoa_bray_curtis_virus_genus.png"),
  plot = p3_2_virus_2,
  width = 8, height = 6, dpi = 300
)

# 2.4 PERMANOVAæ£€éªŒ
virus_genus_ca_corepair_permanova_result <- getPERMANOVA(
  tse_virus_genus_ca_corepair,
  assay.type = "relabundance",
  formula = x ~ treatment_group
)

print(virus_genus_ca_corepair_permanova_result$permanova)
#                 Df SumOfSqs      R2      F Pr(>F)
# treatment_group  1 0.003692 0.09965 0.7747  0.506
# Residual         7 0.033357 0.90035              
# Total            8 0.037049 1.00000  

# ä¿å­˜PERMANOVAç»“æœ
write.csv(
  virus_genus_ca_corepair_permanova_result$permanova,
  file = here::here("data", params$name, "29_permanova_bray_curtis_virus_genus.csv"),
  row.names = TRUE
)
```
Î²-diversityå°ç»“ï¼š
Standard vs Virus å¯¹æ¯”

  | æ•°æ®ç±»å‹        | Alphaå¤šæ ·æ€§(corepair)  | Betaå¤šæ ·æ€§ (corepair) |
  |-----------------|------------------------|-----------------------|
  | Standard (ç»†èŒ) | P=0.73 (ä¸æ˜¾è‘—)        | P=0.012 (æ˜¾è‘—)        |
  | Virus (ç—…æ¯’)    | P=0.90 (ä¸æ˜¾è‘—)        | Pâ‰ˆ0.5 (ä¸æ˜¾è‘—)        |
CagAä¸»è¦å½±å“ç»†èŒç¾¤è½ï¼Œè€Œéç—…æ¯’ç»„ã€‚
å¦‚æœç—…æ¯’ç»„ï¼ˆåŒ…æ‹¬å™¬èŒä½“ï¼‰æ²¡æœ‰æ˜¾è‘—å˜åŒ–ï¼Œè¯´æ˜ï¼š
ï¼ˆ1ï¼‰CagAè¯±å¯¼çš„Tç»†èƒæŒç»­æ¿€æ´»å¯èƒ½ä¸æ˜¯ç”±å™¬èŒä½“ä»‹å¯¼
ï¼ˆ2ï¼‰Functional Footprintèšç„¦äºç»†èŒè€Œéç—…æ¯’ã€‚


Î²diversityæ— å·®å¼‚ï¼Œå¯ä»¥ä¸è¿›è¡Œåç»­æ­¥éª¤ï¼ˆDAAåˆ†æï¼‰
### 2.3.3 å·®å¼‚ä¸°åº¦åˆ†æ (DAA)
```{r}
# ------------------------------------------------------------------------------
# 1.ä½¿ç”¨ ANCOM-BC è¿›è¡Œå·®å¼‚åˆ†æ (ApcMUT_HpWT vs ApcMUT_HpKO)(species)
# ------------------------------------------------------------------------------
virus_species_ca_cleaned_corepair_ancom_result <- ancombc2(
  data         = tse_virus_species_ca_cleaned_corepair,
  assay.type   = "counts",
  fix_formula  = "treatment_group",
  p_adj_method = "fdr",
  group        = "treatment_group",
  struc_zero   = TRUE,
  neg_lb       = TRUE,
  global       = TRUE
)

# æå–å‰ 10 åæœ€æ˜¾è‘—çš„ç‰©ç§
virus_species_ca_cleaned_corepair_top10_taxa <- virus_species_ca_cleaned_corepair_ancom_result$res |>
  dplyr::select(
    taxon,
    p_treatment_groupApcMUT_HpWT,
    q_treatment_groupApcMUT_HpWT,
    lfc_treatment_groupApcMUT_HpWT
  ) |>
  dplyr::arrange(q_treatment_groupApcMUT_HpWT) |>
  head(10)

virus_species_ca_cleaned_corepair_top10_taxa
# å¾—åˆ°çš„qç»“æœå‡å¤§äº0.5

# ä¿å­˜ç»“æœ
write.csv(
  virus_species_ca_cleaned_corepair_top10_taxa,
  file = here::here("data", params$name, "30_daa_ancombc_top10_virus_species.csv"),
  row.names = FALSE
)

# ------------------------------------------------------------------------------
# 2.ä½¿ç”¨ ANCOM-BC è¿›è¡Œå·®å¼‚åˆ†æ (ApcMUT_HpWT vs ApcMUT_HpKO)(genus)
# ------------------------------------------------------------------------------
virus_genus_ca_corepair_ancom_result <- ancombc2(
  data         = tse_virus_genus_ca_corepair,
  assay.type   = "counts",
  fix_formula  = "treatment_group",
  p_adj_method = "fdr",
  group        = "treatment_group",
  struc_zero   = TRUE,
  neg_lb       = TRUE,
  global       = TRUE
)

# æå–å‰ 10 åæœ€æ˜¾è‘—çš„å±
virus_genus_ca_corepair_top10_taxa <- virus_genus_ca_corepair_ancom_result$res |>
  dplyr::select(
    taxon,
    p_treatment_groupApcMUT_HpWT,
    q_treatment_groupApcMUT_HpWT,
    lfc_treatment_groupApcMUT_HpWT
  ) |>
  dplyr::arrange(q_treatment_groupApcMUT_HpWT) |>
  head(10)

virus_genus_ca_corepair_top10_taxa
# å¾—åˆ°çš„qç»“æœå‡å¤§äº0.7
# ä¿å­˜ç»“æœ
write.csv(
  virus_genus_ca_corepair_top10_taxa,
  file = here::here("data", params$name, "31_daa_ancombc_top10_virus_genus.csv"),
  row.names = FALSE
)
```

```{r}
# ------------------------------------------------------------------------------
# 3.ä½¿ç”¨ ALDEx2 è¿›è¡ŒéªŒè¯ï¼ˆäº¤å‰éªŒè¯ï¼‰ (ApcMUT_HpWT vs ApcMUT_HpKO)(species)
# ------------------------------------------------------------------------------
# 3.0 æ•°æ®ç±»å‹æ•´ç†
virus_species_ca_cleaned_corepair_pure_counts <- as.matrix(assay(tse_virus_species_ca_cleaned_corepair, "counts"))
mode(virus_species_ca_cleaned_corepair_pure_counts) <- "numeric"

virus_species_ca_cleaned_corepair_group_vector <- as.character(tse_virus_species_ca_cleaned_corepair$treatment_group)

# 3.1 ç”Ÿæˆè’™ç‰¹å¡æ´›æŠ½æ ·å¹¶è¿›è¡Œ CLR è½¬æ¢
virus_species_ca_cleaned_corepair_x_aldex <- ALDEx2::aldex.clr(
  reads      = virus_species_ca_cleaned_corepair_pure_counts,
  conds      = virus_species_ca_cleaned_corepair_group_vector,
  mc.samples = 128,
  verbose    = FALSE
)

# 3.2 è¿è¡Œ Wilcoxon æ£€éªŒå’Œæ•ˆåº”å€¼è®¡ç®—
virus_species_ca_cleaned_corepair_x_tt <- aldex.ttest(virus_species_ca_cleaned_corepair_x_aldex, paired.test = FALSE)
virus_species_ca_cleaned_corepair_x_effect <- aldex.effect(virus_species_ca_cleaned_corepair_x_aldex, CI = TRUE)

# 3.3 åˆå¹¶ç»“æœå¹¶ç­›é€‰
virus_species_ca_cleaned_corepair_aldex_out <- data.frame(virus_species_ca_cleaned_corepair_x_tt, virus_species_ca_cleaned_corepair_x_effect)

# ç­›é€‰æ˜¾è‘—å·®å¼‚çš„ç‰©ç§ (FDR < 0.05)
virus_species_ca_cleaned_corepair_significant_aldex <- virus_species_ca_cleaned_corepair_aldex_out |>
  dplyr::filter(wi.eBH < 0.05) |>
  arrange(desc(diff.btw))

virus_species_ca_cleaned_corepair_display_table <- virus_species_ca_cleaned_corepair_significant_aldex |>
  tibble::rownames_to_column(var = "taxon") |>
  dplyr::select(taxon, wi.eBH, effect) |>
  dplyr::arrange(desc(effect))

virus_species_ca_cleaned_corepair_display_table

# å¦‚æœæ²¡æœ‰æ˜¾è‘—ç»“æœï¼Œåˆ™å±•ç¤ºè¶‹åŠ¿æ€§å·®å¼‚
if (nrow(virus_species_ca_cleaned_corepair_display_table) == 0) {
  virus_species_ca_cleaned_corepair_trending_aldex <- virus_species_ca_cleaned_corepair_aldex_out |>
    dplyr::filter(abs(effect) > 1) |>
    dplyr::filter(wi.eBH < 0.5) |>
    dplyr::arrange(desc(abs(effect)))

  virus_species_ca_cleaned_corepair_display_table <- virus_species_ca_cleaned_corepair_trending_aldex |>
    tibble::rownames_to_column(var = "taxon") |>
    dplyr::select(taxon, wi.eBH, effect, diff.btw) |>
    dplyr::arrange(desc(effect))
}

virus_species_ca_cleaned_corepair_display_table
# å¦‚æ­¤æ¡ä»¶ä¸‹æ— æ³•ç­›é€‰å‡ºæœ‰æ•ˆæ•°æ®ã€‚

# ä¿å­˜ç»“æœ
write.csv(
  virus_species_ca_cleaned_corepair_display_table,
  file = here::here("data", params$name, "32_daa_aldex2_virus_species.csv"),
  row.names = FALSE
)

# ------------------------------------------------------------------------------
# 4.ä½¿ç”¨ ALDEx2 è¿›è¡ŒéªŒè¯ï¼ˆäº¤å‰éªŒè¯ï¼‰ (ApcMUT_HpWT vs ApcMUT_HpKO)(genus)
# ------------------------------------------------------------------------------
virus_genus_ca_corepair_pure_counts <- as.matrix(assay(tse_virus_genus_ca_corepair, "counts"))
mode(virus_genus_ca_corepair_pure_counts) <- "numeric"

virus_genus_ca_corepair_group_vector <- as.character(tse_virus_genus_ca_corepair$treatment_group)

# 4.1 ç”Ÿæˆè’™ç‰¹å¡æ´›æŠ½æ ·å¹¶è¿›è¡Œ CLR è½¬æ¢
virus_genus_ca_corepair_x_aldex <- ALDEx2::aldex.clr(
  reads      = virus_genus_ca_corepair_pure_counts,
  conds      = virus_genus_ca_corepair_group_vector,
  mc.samples = 128,
  verbose    = FALSE
)

# 4.2 è¿è¡Œ Wilcoxon æ£€éªŒå’Œæ•ˆåº”å€¼è®¡ç®—
virus_genus_ca_corepair_x_tt <- aldex.ttest(virus_genus_ca_corepair_x_aldex, paired.test = FALSE)
virus_genus_ca_corepair_x_effect <- aldex.effect(virus_genus_ca_corepair_x_aldex, CI = TRUE)

# 4.3 åˆå¹¶ç»“æœ
virus_genus_ca_corepair_aldex_out <- data.frame(virus_genus_ca_corepair_x_tt, virus_genus_ca_corepair_x_effect)

# ç­›é€‰è¶‹åŠ¿æ€§å·®å¼‚çš„å±
virus_genus_ca_corepair_trending_aldex <- virus_genus_ca_corepair_aldex_out |>
  dplyr::filter(abs(effect) > 1) |>
  dplyr::filter(wi.eBH < 0.5) |>
  dplyr::arrange(desc(abs(effect)))

virus_genus_ca_corepair_display_table <- virus_genus_ca_corepair_trending_aldex |>
  tibble::rownames_to_column(var = "taxon") |>
  dplyr::select(taxon, wi.eBH, effect, diff.btw) |>
  dplyr::arrange(desc(effect))

virus_genus_ca_corepair_display_table
# å¦‚æ­¤æ¡ä»¶ä¸‹æ— æ³•ç­›é€‰å‡ºæœ‰æ•ˆæ•°æ®ã€‚

# ä¿å­˜ç»“æœ
write.csv(
  virus_genus_ca_corepair_display_table,
  file = here::here("data", params$name, "33_daa_aldex2_virus_genus.csv"),
  row.names = FALSE
)
```
è¿›ä¸€æ­¥è¯´æ˜æ²¡æœ‰å·®å¼‚ã€‚

# Part 3: 2Ã—3å› å­è®¾è®¡æ‰©å±•åˆ†æ - Standard {#sec-factorial-standard}

æœ¬éƒ¨åˆ†å°†åˆ†æä»æ ¸å¿ƒåŒç»„æ¯”è¾ƒæ‰©å±•ä¸ºå®Œæ•´çš„2Ã—3å› å­è®¾è®¡ï¼ŒéªŒè¯CagAæ•ˆåº”åœ¨ä¸åŒé—ä¼ èƒŒæ™¯ä¸‹çš„ä¸€è‡´æ€§ã€‚

## åˆ†æç›®çš„

- éªŒè¯GÃ—Eï¼ˆåŸºå› å‹Ã—ç¯å¢ƒï¼‰äº¤äº’ä½œç”¨
- ç¡®è®¤CagAæ•ˆåº”æ˜¯å¦ä¾èµ–äºApcçªå˜èƒŒæ™¯

## æ–¹æ³•æ¦‚è¿°

æœ¬éƒ¨åˆ†å°†åˆ†æä»æ ¸å¿ƒåŒç»„æ¯”è¾ƒæ‰©å±•ä¸ºå®Œæ•´çš„2Ã—3å› å­è®¾è®¡ï¼ŒåŒ…æ‹¬ï¼š
- Genotype (ApcWT vs ApcMUT) Ã— Infection (Ctrl vs HpKO vs HpWT)
- åŒå› ç´ PERMANOVAäº¤äº’ä½œç”¨åˆ†æ
- betadisperæ–¹å·®é½æ€§æ£€éªŒ
- å‡è®¾é©±åŠ¨çš„æˆå¯¹æ¯”è¾ƒ

### 3.1 æ•°æ®å‡†å¤‡ - å…¨æ ·æœ¬å› å­ç¼–ç 

```{r}
#| label: part4-data-prep
#| message: false

# ------------------------------------------------------------------------------
## 3.1 æ•°æ®å‡†å¤‡ä¸å› å­ç¼–ç 
# ------------------------------------------------------------------------------

# 1. ä½¿ç”¨æ¸…æ´—åçš„å…¨æ ·æœ¬æ•°æ®
tse_full <- tse_standard_species_ca_cleaned

# 2. è½¬æ¢ç°æœ‰çš„ genotype å’Œ infection åˆ—ä¸ºæ ‡å‡†åŒ– factor
# æ•°æ®ä¸­å·²æœ‰ genotype (Apc_wt, Apc_1638N) å’Œ infection (control, hp_koCagA, hp_wt)
# è½¬æ¢ä¸ºç»Ÿä¸€æ ¼å¼çš„ factor å˜é‡ç”¨äºåˆ†æ
colData(tse_full)$genotype_factor <- factor(
  ifelse(colData(tse_full)$genotype == "Apc_wt", "ApcWT", "ApcMUT"),
  levels = c("ApcWT", "ApcMUT")
)

# è½¬æ¢ infection ä¸ºæ ‡å‡†æ ¼å¼
colData(tse_full)$infection_factor <- factor(
  dplyr::case_when(
    colData(tse_full)$infection == "control" ~ "Ctrl",
    colData(tse_full)$infection == "hp_koCagA" ~ "HpKO",
    colData(tse_full)$infection == "hp_wt" ~ "HpWT"
  ),
  levels = c("Ctrl", "HpKO", "HpWT")
)

# 3. éªŒè¯å› å­ç¼–ç 
cat("=== Part 4: æ ·æœ¬åˆ†ç»„ç»Ÿè®¡ ===\n")
cat("ä½¿ç”¨æ ‡å‡†åŒ– factor å˜é‡:\n")
print(table(colData(tse_full)$genotype_factor, colData(tse_full)$infection_factor))
cat("\næ€»æ ·æœ¬æ•°:", ncol(tse_full), "\n")

# 4. ç¡®ä¿relabundanceå·²è®¡ç®—
if (!"relabundance" %in% assayNames(tse_full)) {
  tse_full <- transformAssay(tse_full, assay.type = "counts", method = "relabundance")
}
```

### 3.2 betadisperæ–¹å·®é½æ€§æ£€éªŒ

```{r}
#| label: part4-betadisper
#| message: false

# ------------------------------------------------------------------------------
# betadisperæ£€éªŒï¼šPERMANOVAçš„å‰æå‡è®¾æ£€éªŒ
# å¦‚æœç»„é—´æ–¹å·®ä¸é½ï¼ŒPERMANOVAæ˜¾è‘—æ€§å¯èƒ½æ˜¯ç”±äºç¦»æ•£åº¦å·®å¼‚è€Œéè´¨å¿ƒå·®å¼‚
# ------------------------------------------------------------------------------

# 1. è®¡ç®—Bray-Curtisè·ç¦»çŸ©é˜µ
dist_bc_full <- getDissimilarity(tse_full, method = "bray", assay.type = "relabundance")

# 2. æŒ‰treatment_groupè¿›è¡Œbetadisperæ£€éªŒ
disp_treatment <- vegan::betadisper(dist_bc_full, colData(tse_full)$treatment_group)

# æ–¹å·®é½æ€§æ£€éªŒï¼ˆpermutation testï¼‰
cat("=== betadisper: Treatment Group (6ç»„) ===\n")
disp_test_treatment <- permutest(disp_treatment, permutations = 999)
print(disp_test_treatment)

# 3. æŒ‰genotypeè¿›è¡Œbetadisperæ£€éªŒ
disp_genotype <- vegan::betadisper(dist_bc_full, colData(tse_full)$genotype_factor)
cat("\n=== betadisper: Genotype ===\n")
disp_test_genotype <- permutest(disp_genotype, permutations = 999)
print(disp_test_genotype)

# 4. æŒ‰infectionè¿›è¡Œbetadisperæ£€éªŒ
disp_infection <- vegan::betadisper(dist_bc_full, colData(tse_full)$infection_factor)
cat("\n=== betadisper: Infection ===\n")
disp_test_infection <- permutest(disp_infection, permutations = 999)
print(disp_test_infection)

# 5. å¯è§†åŒ–betadisperç»“æœ
p4_2_1 <- plot(disp_treatment, main = "betadisper: Treatment Groups (6ç»„)")
```

```{r}
#| label: part4-betadisper-save
#| echo: false

# ä¿å­˜betadisperç»“æœ
betadisper_results <- data.frame(
  Factor = c("Treatment (6ç»„)", "Genotype", "Infection"),
  F_value = c(disp_test_treatment$tab$F[1],
              disp_test_genotype$tab$F[1],
              disp_test_infection$tab$F[1]),
  P_value = c(disp_test_treatment$tab$`Pr(>F)`[1],
              disp_test_genotype$tab$`Pr(>F)`[1],
              disp_test_infection$tab$`Pr(>F)`[1]),
  Interpretation = ifelse(
    c(disp_test_treatment$tab$`Pr(>F)`[1],
      disp_test_genotype$tab$`Pr(>F)`[1],
      disp_test_infection$tab$`Pr(>F)`[1]) > 0.05,
    "æ–¹å·®é½æ€§ âœ“",
    "æ–¹å·®ä¸é½ âš "
  )
)

write.csv(betadisper_results,
          file = here::here("data", params$name, "40_part4_betadisper_results.csv"),
          row.names = FALSE)

knitr::kable(betadisper_results, caption = "betadisperæ–¹å·®é½æ€§æ£€éªŒç»“æœ")
```

### 3.3 Alphaå¤šæ ·æ€§ - å…¨6ç»„

```{r}
#| label: part4-alpha-full
#| message: false
#| fig-width: 12
#| fig-height: 6

# ------------------------------------------------------------------------------
# Alphaå¤šæ ·æ€§ï¼šå…¨6ç»„å¯è§†åŒ–ä¸ç»Ÿè®¡æ£€éªŒ
# ------------------------------------------------------------------------------

# 1. ç¡®ä¿alphaæŒ‡æ•°å·²è®¡ç®—
if (!"shannon_index" %in% colnames(colData(tse_full))) {
  tse_full <- addAlpha(tse_full, assay.type = "counts",
                       index = c("shannon", "observed"),
                       name = c("shannon_index", "observed_richness"))
}

# 2. å‡†å¤‡ç»˜å›¾æ•°æ®ï¼ˆä½¿ç”¨æ ‡å‡†åŒ– factor å˜é‡ï¼‰
alpha_data_full <- as.data.frame(colData(tse_full)) %>%
  dplyr::select(treatment_group, genotype = genotype_factor, infection = infection_factor,
                shannon_index, observed_richness)

# 3. å…¨6ç»„Shannonå¤šæ ·æ€§ç®±çº¿å›¾
p4_3_1 <- ggplot(alpha_data_full, aes(x = treatment_group, y = shannon_index,
                                       fill = infection)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.7) +
  geom_jitter(aes(color = genotype), width = 0.2, size = 2) +
  facet_wrap(~genotype, scales = "free_x") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Shannon Diversity: All 6 Treatment Groups",
       x = "Treatment Group", y = "Shannon Index") +
  scale_fill_brewer(palette = "Set2")

# 4. äº¤äº’ä½œç”¨å¯è§†åŒ–ï¼ˆæŠ˜çº¿å›¾ï¼‰
alpha_summary <- alpha_data_full %>%
  group_by(genotype, infection) %>%
  summarise(
    mean_shannon = mean(shannon_index, na.rm = TRUE),
    se_shannon = sd(shannon_index, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

p4_3_2 <- ggplot(alpha_summary, aes(x = infection, y = mean_shannon,
                                     color = genotype, group = genotype)) +
  geom_line(linewidth = 1) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = mean_shannon - se_shannon,
                    ymax = mean_shannon + se_shannon), width = 0.1) +
  theme_bw() +
  labs(title = "Alpha Diversity: Genotype Ã— Infection Interaction",
       x = "Infection Status", y = "Shannon Index (mean Â± SE)")

# ç»„åˆå›¾
p4_3_combined <- p4_3_1 + p4_3_2 + plot_layout(widths = c(2, 1))
p4_3_combined

# ä¿å­˜å›¾è¡¨
ggsave(here::here("data", params$name, "41_part4_alpha_full_6groups.png"),
       plot = p4_3_combined, width = 14, height = 6, dpi = 300)
```

```{r}
#| label: part4-alpha-stats
#| message: false

# ------------------------------------------------------------------------------
# Alphaå¤šæ ·æ€§ç»Ÿè®¡æ£€éªŒï¼šKruskal-Wallis + Dunn's post-hoc
# ------------------------------------------------------------------------------

# 1. Kruskal-Wallisæ£€éªŒï¼ˆéå‚æ•°ï¼‰
cat("=== Kruskal-Wallis Test: Shannon Index ===\n")
kw_shannon <- kruskal.test(shannon_index ~ treatment_group, data = alpha_data_full)
print(kw_shannon)

# 2. å¦‚æœæ˜¾è‘—ï¼Œè¿›è¡ŒDunn's post-hocæ£€éªŒ
if (kw_shannon$p.value < 0.05) {
  cat("\nKruskal-Wallisæ˜¾è‘—ï¼Œè¿›è¡ŒDunn's post-hocæ£€éªŒ...\n")
  # ä½¿ç”¨rstatixåŒ…è¿›è¡ŒDunnæ£€éªŒ
  if (requireNamespace("rstatix", quietly = TRUE)) {
    dunn_result <- rstatix::dunn_test(alpha_data_full, shannon_index ~ treatment_group,
                                       p.adjust.method = "BH")
    print(dunn_result %>% dplyr::filter(p.adj < 0.1))
  }
} else {
  cat("\nKruskal-Wallisä¸æ˜¾è‘— (P =", round(kw_shannon$p.value, 3), ")ï¼Œæ— éœ€post-hocæ£€éªŒ\n")
}

# 3. åŒå› ç´ æ•ˆåº”æ£€éªŒï¼ˆä½¿ç”¨aligned rank transformï¼‰
cat("\n=== åŒå› ç´ æ•ˆåº”æ£€éªŒ (ART ANOVA) ===\n")
if (requireNamespace("ARTool", quietly = TRUE)) {
  art_model <- ARTool::art(shannon_index ~ genotype * infection, data = alpha_data_full)
  art_anova <- anova(art_model)
  print(art_anova)

  # ä¿å­˜ç»“æœ
  write.csv(art_anova,
            file = here::here("data", params$name, "42_part4_alpha_art_anova.csv"),
            row.names = TRUE)
} else {
  cat("ARToolåŒ…æœªå®‰è£…ï¼Œè·³è¿‡ART ANOVA\n")
}
```

### 3.4 Betaå¤šæ ·æ€§ - å…¨6ç»„PCoA

```{r}
#| label: part4-beta-pcoa-full
#| message: false
#| fig-width: 10
#| fig-height: 8

# ------------------------------------------------------------------------------
# Betaå¤šæ ·æ€§ï¼šå…¨6ç»„PCoAå¯è§†åŒ–
# ------------------------------------------------------------------------------

# 1. è¿è¡ŒPCoAï¼ˆå¦‚æœå°šæœªè®¡ç®—ï¼‰
if (!"PCoA_Bray_Full" %in% reducedDimNames(tse_full)) {
  tse_full <- addMDS(tse_full,
                     FUN = getDissimilarity,
                     method = "bray",
                     assay.type = "relabundance",
                     name = "PCoA_Bray_Full")
}

# 2. æå–ç‰¹å¾å€¼
eig_full <- attr(reducedDim(tse_full, "PCoA_Bray_Full"), "eig")
rel_eig_full <- eig_full / sum(eig_full[eig_full > 0])

# 3. å…¨6ç»„PCoAå›¾ï¼ˆæŒ‰genotypeå½¢çŠ¶ï¼ŒæŒ‰infectioné¢œè‰²ï¼‰
pcoa_coords <- as.data.frame(reducedDim(tse_full, "PCoA_Bray_Full"))
colnames(pcoa_coords) <- c("PC1", "PC2")
pcoa_coords <- cbind(pcoa_coords, as.data.frame(colData(tse_full)))

p4_4_1 <- ggplot(pcoa_coords, aes(x = PC1, y = PC2,
                                   color = infection, shape = genotype)) +
  geom_point(size = 4, alpha = 0.8) +
  stat_ellipse(aes(group = treatment_group, linetype = genotype),
               level = 0.80, show.legend = FALSE) +
  theme_bw() +
  labs(title = "PCoA: All 6 Treatment Groups (Bray-Curtis)",
       x = paste0("PCoA 1 (", round(100 * rel_eig_full[1], 1), "%)"),
       y = paste0("PCoA 2 (", round(100 * rel_eig_full[2], 1), "%)")) +
  scale_color_brewer(palette = "Set1") +
  scale_shape_manual(values = c(16, 17))

p4_4_1

# ä¿å­˜å›¾è¡¨
ggsave(here::here("data", params$name, "43_part4_pcoa_full_6groups.png"),
       plot = p4_4_1, width = 10, height = 8, dpi = 300)
```

### 3.5 åŒå› ç´ PERMANOVA - å…¨6ç»„

```{r}
#| label: part4-permanova-full
#| message: false

# ------------------------------------------------------------------------------
# åŒå› ç´ PERMANOVAï¼šæ£€éªŒgenotypeã€infectionåŠå…¶äº¤äº’ä½œç”¨
# ä½¿ç”¨ by = "margin" è·å¾—Type IIIæ•ˆåº”ï¼ˆå„å› å­ç‹¬ç«‹æ•ˆåº”ï¼‰
# ------------------------------------------------------------------------------

metadata_full <- as.data.frame(colData(tse_full))

cat("=== åŒå› ç´ PERMANOVA: å…¨6ç»„åˆ†æ ===\n")
cat("å…¬å¼: distance ~ genotype_factor * infection_factor\n\n")

permanova_full <- vegan::adonis2(
  dist_bc_full ~ genotype_factor * infection_factor,
  data = metadata_full,
  permutations = 999,
  by = "margin"
)

print(permanova_full)

# ä¿å­˜ç»“æœ
write.csv(as.data.frame(permanova_full),
          file = here::here("data", params$name, "44_part4_permanova_full_6groups.csv"),
          row.names = TRUE)

# ç»“æœè§£è¯»
cat("\n=== ç»“æœè§£è¯» ===\n")
cat("Genotypeä¸»æ•ˆåº”: RÂ² =", round(permanova_full$R2[1], 4),
    ", P =", permanova_full$`Pr(>F)`[1], "\n")
cat("Infectionä¸»æ•ˆåº”: RÂ² =", round(permanova_full$R2[2], 4),
    ", P =", permanova_full$`Pr(>F)`[2], "\n")
cat("GenotypeÃ—Infectionäº¤äº’: RÂ² =", round(permanova_full$R2[3], 4),
    ", P =", permanova_full$`Pr(>F)`[3], "\n")
```

### 3.6 åŒå› ç´ PERMANOVA - 2Ã—2å­é›†

```{r}
#| label: part4-permanova-subset
#| message: false

# ------------------------------------------------------------------------------
# 2Ã—2å­é›†åˆ†æï¼šæ’é™¤Ctrlç»„ï¼Œèšç„¦æ„ŸæŸ“æ•ˆåº”
# æ ·æœ¬ï¼šApcWT_HpKO, ApcWT_HpWT, ApcMUT_HpKO, ApcMUT_HpWT
# ------------------------------------------------------------------------------

# 1. ç­›é€‰æ„ŸæŸ“ç»„æ ·æœ¬ï¼ˆä½¿ç”¨æ ‡å‡†åŒ– factor å˜é‡ï¼‰
tse_infected <- tse_full[, colData(tse_full)$infection_factor != "Ctrl"]
cat("=== 2Ã—2å­é›†åˆ†æï¼ˆæ’é™¤Ctrlç»„ï¼‰===\n")
cat("æ ·æœ¬æ•°:", ncol(tse_infected), "\n")
print(table(colData(tse_infected)$genotype_factor, colData(tse_infected)$infection_factor))

# 2. é‡æ–°è®¡ç®—è·ç¦»çŸ©é˜µ
dist_bc_infected <- getDissimilarity(tse_infected, method = "bray",
                                      assay.type = "relabundance")

# 3. betadisperæ£€éªŒï¼ˆ2Ã—2å­é›†ï¼‰
cat("\n=== betadisper: 2Ã—2å­é›† ===\n")
disp_infected <- vegan::betadisper(dist_bc_infected,
                                    colData(tse_infected)$treatment_group)
disp_test_infected <- permutest(disp_infected, permutations = 999)
print(disp_test_infected)

# 4. 2Ã—2 PERMANOVA
metadata_infected <- as.data.frame(colData(tse_infected))

cat("\n=== åŒå› ç´ PERMANOVA: 2Ã—2å­é›† ===\n")
permanova_infected <- vegan::adonis2(
  dist_bc_infected ~ genotype_factor * infection_factor,
  data = metadata_infected,
  permutations = 999,
  by = "margin"
)

print(permanova_infected)

# ä¿å­˜ç»“æœ
write.csv(as.data.frame(permanova_infected),
          file = here::here("data", params$name, "45_part4_permanova_2x2_subset.csv"),
          row.names = TRUE)

# ç»“æœè§£è¯»
cat("\n=== 2Ã—2å­é›†ç»“æœè§£è¯» ===\n")
cat("Genotypeæ•ˆåº” (Apcçªå˜): RÂ² =", round(permanova_infected$R2[1], 4),
    ", P =", permanova_infected$`Pr(>F)`[1], "\n")
cat("Infectionæ•ˆåº” (CagA): RÂ² =", round(permanova_infected$R2[2], 4),
    ", P =", permanova_infected$`Pr(>F)`[2], "\n")
cat("äº¤äº’ä½œç”¨: RÂ² =", round(permanova_infected$R2[3], 4),
    ", P =", permanova_infected$`Pr(>F)`[3], "\n")
```

### 3.7 å‡è®¾é©±åŠ¨çš„æˆå¯¹æ¯”è¾ƒ

```{r}
#| label: part4-pairwise
#| message: false

# ------------------------------------------------------------------------------
# æˆå¯¹æ¯”è¾ƒï¼šåªå¯¹é¢„å®šä¹‰çš„ç§‘å­¦é—®é¢˜é©±åŠ¨çš„æ¯”è¾ƒè¿›è¡ŒFDRæ ¡æ­£
# ------------------------------------------------------------------------------

# å®šä¹‰å…³é”®æ¯”è¾ƒï¼ˆ6ä¸ªå‡è®¾é©±åŠ¨çš„æ¯”è¾ƒï¼‰
key_comparisons <- list(
  # 1. CagAæ•ˆåº”ï¼ˆæ ¸å¿ƒé—®é¢˜ï¼‰
  list(pair = c("ApcMUT_HpWT", "ApcMUT_HpKO"), question = "CagA effect @ApcMUT"),
  list(pair = c("ApcWT_HpWT", "ApcWT_HpKO"), question = "CagA effect @ApcWT"),

  # 2. ApcåŸºå› å‹æ•ˆåº”
  list(pair = c("ApcMUT_HpWT", "ApcWT_HpWT"), question = "Apc effect @CagA+"),
  list(pair = c("ApcMUT_HpKO", "ApcWT_HpKO"), question = "Apc effect @CagA-"),

  # 3. æ„ŸæŸ“æ•ˆåº”ï¼ˆvs Ctrlï¼‰
  list(pair = c("ApcMUT_HpWT", "ApcMUT_Ctrl"), question = "Infection @ApcMUT(CagA+)"),
  list(pair = c("ApcMUT_HpKO", "ApcMUT_Ctrl"), question = "Infection @ApcMUT(CagA-)")
)

# æ‰§è¡Œæˆå¯¹PERMANOVA
pairwise_results <- lapply(key_comparisons, function(comp) {
  pair <- comp$pair

  # ç­›é€‰æ ·æœ¬
  tse_pair <- tse_full[, colData(tse_full)$treatment_group %in% pair]

  # æ£€æŸ¥æ ·æœ¬æ•°
  n_samples <- ncol(tse_pair)
  if (n_samples < 4) {
    return(data.frame(
      comparison = paste(pair, collapse = " vs "),
      question = comp$question,
      n = n_samples,
      R2 = NA, F_value = NA, p_value = NA
    ))
  }

  # è®¡ç®—è·ç¦»
  dist_pair <- getDissimilarity(tse_pair, method = "bray", assay.type = "relabundance")
  meta_pair <- as.data.frame(colData(tse_pair))

  # PERMANOVA
  result <- vegan::adonis2(dist_pair ~ treatment_group, data = meta_pair,
                           permutations = 999)

  data.frame(
    comparison = paste(pair, collapse = " vs "),
    question = comp$question,
    n = n_samples,
    R2 = round(result$R2[1], 4),
    F_value = round(result$F[1], 2),
    p_value = result$`Pr(>F)`[1]
  )
})

pairwise_df <- do.call(rbind, pairwise_results)

# FDRæ ¡æ­£ï¼ˆåªå¯¹è¿™6ä¸ªé¢„å®šä¹‰æ¯”è¾ƒï¼‰
pairwise_df$p_adj <- p.adjust(pairwise_df$p_value, method = "BH")
pairwise_df$significance <- ifelse(pairwise_df$p_adj < 0.05, "**",
                                    ifelse(pairwise_df$p_adj < 0.1, "*", ""))

cat("=== å‡è®¾é©±åŠ¨çš„æˆå¯¹æ¯”è¾ƒï¼ˆFDRæ ¡æ­£ï¼‰===\n")
print(pairwise_df)

# ä¿å­˜ç»“æœ
write.csv(pairwise_df,
          file = here::here("data", params$name, "46_part4_pairwise_comparisons.csv"),
          row.names = FALSE)
```

### 3.8 ç»“æœæ±‡æ€»

```{r}
#| label: part4-summary
#| message: false
#| fig-width: 12
#| fig-height: 10

# ------------------------------------------------------------------------------
## 3.2 ç»“æœæ±‡æ€»å¯è§†åŒ–
# ------------------------------------------------------------------------------

# 1. æ•ˆåº”é‡æ±‡æ€»è¡¨
effect_summary <- data.frame(
  Analysis = c("Full 6-group", "Full 6-group", "Full 6-group",
               "2Ã—2 Subset", "2Ã—2 Subset", "2Ã—2 Subset"),
  Factor = rep(c("Genotype", "Infection", "Interaction"), 2),
  R2 = c(permanova_full$R2[1:3], permanova_infected$R2[1:3]),
  P_value = c(permanova_full$`Pr(>F)`[1:3], permanova_infected$`Pr(>F)`[1:3])
)
effect_summary$R2_percent <- round(effect_summary$R2 * 100, 1)
effect_summary$Significant <- ifelse(effect_summary$P_value < 0.05, "Yes", "No")

cat("=== Part 4 æ•ˆåº”é‡æ±‡æ€» ===\n")
knitr::kable(effect_summary, caption = "PERMANOVAæ•ˆåº”é‡æ±‡æ€»")

# 2. æ•ˆåº”é‡æŸ±çŠ¶å›¾
p4_8_1 <- ggplot(effect_summary, aes(x = Factor, y = R2_percent, fill = Analysis)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.7) +
  geom_text(aes(label = paste0(R2_percent, "%")),
            position = position_dodge(width = 0.8), vjust = -0.5, size = 3) +
  theme_bw() +
  labs(title = "Part 4: Effect Sizes (RÂ²) from PERMANOVA",
       x = "Factor", y = "Variance Explained (%)") +
  scale_fill_brewer(palette = "Set2") +
  ylim(0, max(effect_summary$R2_percent) * 1.2)

# 3. æˆå¯¹æ¯”è¾ƒç»“æœå¯è§†åŒ–
pairwise_plot_data <- pairwise_df %>%
  mutate(neg_log_p = -log10(p_adj),
         label = paste0("RÂ²=", R2, significance))

p4_8_2 <- ggplot(pairwise_plot_data, aes(x = reorder(question, neg_log_p),
                                          y = neg_log_p, fill = R2)) +
  geom_bar(stat = "identity") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "red") +
  geom_hline(yintercept = -log10(0.1), linetype = "dotted", color = "orange") +
  coord_flip() +
  theme_bw() +
  labs(title = "Pairwise Comparisons (FDR-corrected)",
       x = "Comparison", y = "-log10(adjusted P-value)") +
  scale_fill_gradient(low = "lightblue", high = "darkblue", name = "RÂ²") +
  annotate("text", x = 0.5, y = -log10(0.05), label = "P=0.05", color = "red", hjust = 0)

# 4. ç»„åˆå›¾
p4_8_combined <- (p4_4_1 | p4_8_1) / p4_8_2 +
  plot_annotation(title = "Part 4: Extended Analysis Summary (2Ã—3 Factorial Design)")

p4_8_combined

# ä¿å­˜æ±‡æ€»å›¾
ggsave(here::here("data", params$name, "47_part4_summary_figure.png"),
       plot = p4_8_combined, width = 14, height = 12, dpi = 300)

# ä¿å­˜æ•ˆåº”é‡æ±‡æ€»è¡¨
write.csv(effect_summary,
          file = here::here("data", params$name, "48_part4_effect_summary.csv"),
          row.names = FALSE)
```

```{r}
#| label: part4-conclusion
#| echo: false
#| results: asis

## 3.3 Part 3 ç»“è®º
cat("\n### Part 4 å…³é”®å‘ç°\n\n")

cat("**1. æ–¹å·®é½æ€§æ£€éªŒ (betadisper)**\n")
if (all(betadisper_results$P_value > 0.05)) {
  cat("- æ‰€æœ‰å› å­çš„ç»„é—´æ–¹å·®é½æ€§æ£€éªŒé€šè¿‡ (P > 0.05)\n")
  cat("- PERMANOVAç»“æœå¯ä¿¡åº¦é«˜\n\n")
} else {
  cat("- éƒ¨åˆ†å› å­æ–¹å·®ä¸é½ï¼Œéœ€è°¨æ…è§£è¯»PERMANOVAç»“æœ\n\n")
}

cat("**2. å…¨6ç»„PERMANOVAç»“æœ**\n")
cat(sprintf("- Genotypeæ•ˆåº”: RÂ² = %.1f%%, P = %.3f\n",
            permanova_full$R2[1]*100, permanova_full$`Pr(>F)`[1]))
cat(sprintf("- Infectionæ•ˆåº”: RÂ² = %.1f%%, P = %.3f\n",
            permanova_full$R2[2]*100, permanova_full$`Pr(>F)`[2]))
cat(sprintf("- äº¤äº’ä½œç”¨: RÂ² = %.1f%%, P = %.3f\n\n",
            permanova_full$R2[3]*100, permanova_full$`Pr(>F)`[3]))

cat("**3. 2Ã—2å­é›†åˆ†æï¼ˆæ’é™¤Ctrlï¼‰**\n")
cat(sprintf("- Genotypeæ•ˆåº”: RÂ² = %.1f%%, P = %.3f\n",
            permanova_infected$R2[1]*100, permanova_infected$`Pr(>F)`[1]))
cat(sprintf("- Infection(CagA)æ•ˆåº”: RÂ² = %.1f%%, P = %.3f\n\n",
            permanova_infected$R2[2]*100, permanova_infected$`Pr(>F)`[2]))

cat("**4. æ ¸å¿ƒæ¯”è¾ƒï¼ˆå·²æœ‰ç»“æœéªŒè¯ï¼‰**\n")
core_comparison <- pairwise_df[pairwise_df$question == "CagAæ•ˆåº”@å˜å¼‚é¼ ", ]
cat(sprintf("- ApcMUT_HpWT vs ApcMUT_HpKO: RÂ² = %.1f%%, P_adj = %.3f\n",
            core_comparison$R2*100, core_comparison$p_adj))
```

```{r}
#| label: part4-save-tse
#| echo: false

# ä¿å­˜å¸¦æœ‰å®Œæ•´å› å­ç¼–ç çš„TSEå¯¹è±¡
saveRDS(tse_full,
        file = here::here("data", params$name, "tse_standard_species_full_factored.rds"))
cat("\nâœ… Part 4 TSEå¯¹è±¡å·²ä¿å­˜: tse_standard_species_full_factored.rds\n")
```

### 3.9 è‹±æ–‡ç‰ˆæ€»ç»“å›¾

```{r}
#| label: part4-summary-figure-english
#| fig-width: 14
#| fig-height: 12

# ==============================================================================
## 3.4 è‹±æ–‡ç‰ˆæ€»ç»“å›¾ (ç”¨äºPPT/è®ºæ–‡)
# ==============================================================================

# è¯»å–å·²ä¿å­˜çš„æ•°æ®
if (file.exists(here::here("data", params$name, "48_part4_effect_summary.csv")) &&
    file.exists(here::here("data", params$name, "46_part4_pairwise_comparisons.csv"))) {

  effect_summary_en <- read.csv(here::here("data", params$name, "48_part4_effect_summary.csv"))
  pairwise_df_en <- read.csv(here::here("data", params$name, "46_part4_pairwise_comparisons.csv"))

  # ä¿®æ”¹æˆå¯¹æ¯”è¾ƒçš„ä¸­æ–‡æ ‡ç­¾ä¸ºè‹±æ–‡
  pairwise_df_en$question <- dplyr::case_when(
    pairwise_df_en$question == "CagAæ•ˆåº”@å˜å¼‚é¼ " ~ "CagA effect @ApcMUT",
    pairwise_df_en$question == "CagAæ•ˆåº”@é‡ç”Ÿå‹" ~ "CagA effect @ApcWT",
    pairwise_df_en$question == "Apcæ•ˆåº”@CagA+æ„ŸæŸ“" ~ "Apc effect @CagA+",
    pairwise_df_en$question == "Apcæ•ˆåº”@CagA-æ„ŸæŸ“" ~ "Apc effect @CagA-",
    pairwise_df_en$question == "æ„ŸæŸ“æ•ˆåº”@å˜å¼‚é¼ (CagA+)" ~ "Infection @ApcMUT(CagA+)",
    pairwise_df_en$question == "æ„ŸæŸ“æ•ˆåº”@å˜å¼‚é¼ (CagA-)" ~ "Infection @ApcMUT(CagA-)",
    TRUE ~ pairwise_df_en$question
  )

  # 1. PCoA å›¾ (ä½¿ç”¨å·²ä¿å­˜çš„ tse_full)
  pcoa_coords_en <- as.data.frame(reducedDim(tse_full, "PCoA_Bray_Full"))
  colnames(pcoa_coords_en) <- c("PC1", "PC2")
  pcoa_coords_en <- cbind(pcoa_coords_en, as.data.frame(colData(tse_full)))

  eig_full_en <- attr(reducedDim(tse_full, "PCoA_Bray_Full"), "eig")
  rel_eig_full_en <- eig_full_en / sum(eig_full_en[eig_full_en > 0])

  p4_pcoa_en <- ggplot(pcoa_coords_en, aes(x = PC1, y = PC2,
                                            color = infection_factor, shape = genotype_factor)) +
    geom_point(size = 4, alpha = 0.8) +
    stat_ellipse(aes(group = treatment_group, linetype = genotype_factor),
                 level = 0.80, show.legend = FALSE) +
    theme_bw() +
    labs(title = "PCoA: All 6 Treatment Groups (Bray-Curtis)",
         x = paste0("PCoA 1 (", round(100 * rel_eig_full_en[1], 1), "%)"),
         y = paste0("PCoA 2 (", round(100 * rel_eig_full_en[2], 1), "%)"),
         color = "Infection", shape = "Genotype") +
    scale_color_brewer(palette = "Set1") +
    scale_shape_manual(values = c(16, 17))

  # 2. æ•ˆåº”é‡æŸ±çŠ¶å›¾
  p4_effect_en <- ggplot(effect_summary_en, aes(x = Factor, y = R2_percent, fill = Analysis)) +
    geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.7) +
    geom_text(aes(label = paste0(R2_percent, "%")),
              position = position_dodge(width = 0.8), vjust = -0.5, size = 3) +
    theme_bw() +
    labs(title = "Part 4: Effect Sizes (RÂ²) from PERMANOVA",
         x = "Factor", y = "Variance Explained (%)") +
    scale_fill_brewer(palette = "Set2") +
    ylim(0, max(effect_summary_en$R2_percent) * 1.2)

  # 3. æˆå¯¹æ¯”è¾ƒå›¾
  pairwise_plot_data_en <- pairwise_df_en %>%
    mutate(neg_log_p = -log10(p_adj),
           label = paste0("RÂ²=", R2, significance))

  p4_pairwise_en <- ggplot(pairwise_plot_data_en, aes(x = reorder(question, neg_log_p),
                                                       y = neg_log_p, fill = R2)) +
    geom_bar(stat = "identity") +
    geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "red") +
    geom_hline(yintercept = -log10(0.1), linetype = "dotted", color = "orange") +
    coord_flip() +
    theme_bw() +
    labs(title = "Pairwise Comparisons (FDR-corrected)",
         x = "Comparison", y = "-log10(adjusted P-value)") +
    scale_fill_gradient(low = "lightblue", high = "darkblue", name = "RÂ²") +
    annotate("text", x = 0.5, y = -log10(0.05), label = "P=0.05", color = "red", hjust = 0)

  # ç»„åˆå›¾
  p4_combined_en <- (p4_pcoa_en | p4_effect_en) / p4_pairwise_en +
    plot_annotation(title = "Part 4: Extended Analysis Summary (2Ã—3 Factorial Design)")

  print(p4_combined_en)

  # ä¿å­˜è‹±æ–‡ç‰ˆ
  ggsave(here::here("data", params$name, "47_part4_summary_figure_EN.png"),
         plot = p4_combined_en, width = 14, height = 12, dpi = 300)

  cat("\nâœ… Part 4 è‹±æ–‡ç‰ˆæ€»ç»“å›¾å·²ä¿å­˜: 47_part4_summary_figure_EN.png\n")
}
```

# Part 4: åˆ†å±‚æˆå¯¹æ¯”è¾ƒ - Standard {#sec-pairwise-standard}

æœ¬éƒ¨åˆ†å¯¹æ‰€æœ‰9ä¸ªç§‘å­¦ç›¸å…³çš„ç»„é—´æ¯”è¾ƒè¿›è¡Œç³»ç»Ÿåˆ†æï¼Œä»¥éªŒè¯GÃ—Eäº¤äº’ä½œç”¨ï¼š
1. **Apcæ•ˆåº”åœ¨ä¸åŒæ„ŸæŸ“çŠ¶æ€ä¸‹çš„å˜åŒ–** - æ„ŸæŸ“æ˜¯å¦"æŠ¹å¹³"ApcåŸºå› å‹å·®å¼‚ï¼Ÿ
2. **æ„ŸæŸ“æ•ˆåº”åœ¨ä¸åŒé—ä¼ èƒŒæ™¯ä¸‹çš„å˜åŒ–** - CagAæ•ˆåº”æ˜¯å¦ä¾èµ–Apcçªå˜ï¼Ÿ
3. **æ„ŸæŸ“æ¢¯åº¦æ•ˆåº”** - Ctrl â†’ HpKO â†’ HpWTæ˜¯å¦å­˜åœ¨é€’è¿›å˜åŒ–ï¼Ÿ

### 4.1 å®šä¹‰å…¨éƒ¨9ä¸ªæˆå¯¹æ¯”è¾ƒ

```{r}
#| label: part5-define-comparisons
#| message: false

# ------------------------------------------------------------------------------
# åˆ†å±‚æˆå¯¹æ¯”è¾ƒåˆ†æ
# å…±9ä¸ªæ¯”è¾ƒï¼Œåˆ†ä¸º3ç±»ç§‘å­¦é—®é¢˜
# ------------------------------------------------------------------------------

# ä½¿ç”¨Part 4ä¸­å·²å‡†å¤‡å¥½çš„æ•°æ®
# tse_fullå·²åŒ…å«genotype_factorå’Œinfection_factor

# å®šä¹‰å…¨éƒ¨9ä¸ªæˆå¯¹æ¯”è¾ƒ
all_comparisons <- list(
  # === ç±»åˆ«A: Apcæ•ˆåº”åœ¨ä¸åŒæ„ŸæŸ“çŠ¶æ€ä¸‹ ===
  list(
    pair = c("ApcMUT_Ctrl", "ApcWT_Ctrl"),
    category = "Apcæ•ˆåº”",
    question = "ApcåŸºçº¿æ•ˆåº” (Ctrlç»„)",
    hypothesis = "Apcçªå˜æœ¬èº«æ”¹å˜èŒç¾¤"
  ),
  list(
    pair = c("ApcMUT_HpKO", "ApcWT_HpKO"),
    category = "Apcæ•ˆåº”",
    question = "Apcæ•ˆåº” (HpKOæ„ŸæŸ“å)",
    hypothesis = "æ„ŸæŸ“åApcæ•ˆåº”æ˜¯å¦æ¶ˆå¤±?"
  ),
  list(
    pair = c("ApcMUT_HpWT", "ApcWT_HpWT"),
    category = "Apcæ•ˆåº”",
    question = "Apcæ•ˆåº” (HpWTæ„ŸæŸ“å)",
    hypothesis = "CagA+æ„ŸæŸ“åApcæ•ˆåº”æ˜¯å¦æ¶ˆå¤±?"
  ),

  # === ç±»åˆ«B: æ„ŸæŸ“æ•ˆåº”åœ¨ApcMUTèƒŒæ™¯ä¸‹ ===
  list(
    pair = c("ApcMUT_Ctrl", "ApcMUT_HpKO"),
    category = "æ„ŸæŸ“æ•ˆåº”@ApcMUT",
    question = "æ„ŸæŸ“æ•ˆåº” (ApcMUT, æ— CagA)",
    hypothesis = "HpKOæ„ŸæŸ“æœ¬èº«çš„æ•ˆåº”"
  ),
  list(
    pair = c("ApcMUT_Ctrl", "ApcMUT_HpWT"),
    category = "æ„ŸæŸ“æ•ˆåº”@ApcMUT",
    question = "æ„ŸæŸ“+CagAæ•ˆåº” (ApcMUT)",
    hypothesis = "HpWTæ„ŸæŸ“çš„è”åˆæ•ˆåº”"
  ),
  list(
    pair = c("ApcMUT_HpKO", "ApcMUT_HpWT"),
    category = "CagAæ•ˆåº”",
    question = "CagAæ•ˆåº” (ApcMUTèƒŒæ™¯)",
    hypothesis = "æ ¸å¿ƒé—®é¢˜: CagAç‰¹å¼‚æ•ˆåº”"
  ),

  # === ç±»åˆ«C: æ„ŸæŸ“æ•ˆåº”åœ¨ApcWTèƒŒæ™¯ä¸‹ ===
  list(
    pair = c("ApcWT_Ctrl", "ApcWT_HpKO"),
    category = "æ„ŸæŸ“æ•ˆåº”@ApcWT",
    question = "æ„ŸæŸ“æ•ˆåº” (ApcWT, æ— CagA)",
    hypothesis = "é‡ç”Ÿå‹ä¸­HpKOæ„ŸæŸ“æ•ˆåº”"
  ),
  list(
    pair = c("ApcWT_Ctrl", "ApcWT_HpWT"),
    category = "æ„ŸæŸ“æ•ˆåº”@ApcWT",
    question = "æ„ŸæŸ“+CagAæ•ˆåº” (ApcWT)",
    hypothesis = "é‡ç”Ÿå‹ä¸­HpWTæ„ŸæŸ“æ•ˆåº”"
  ),
  list(
    pair = c("ApcWT_HpKO", "ApcWT_HpWT"),
    category = "CagAæ•ˆåº”",
    question = "CagAæ•ˆåº” (ApcWTèƒŒæ™¯)",
    hypothesis = "é‡ç”Ÿå‹ä¸­CagAæ˜¯å¦æœ‰æ•ˆ?"
  )
)

cat("=== Part 5: å®šä¹‰çš„9ä¸ªæˆå¯¹æ¯”è¾ƒ ===\n")
cat("ç±»åˆ«A (Apcæ•ˆåº”): 3ä¸ªæ¯”è¾ƒ\n")
cat("ç±»åˆ«B (æ„ŸæŸ“æ•ˆåº”@ApcMUT): 3ä¸ªæ¯”è¾ƒ\n")
cat("ç±»åˆ«C (æ„ŸæŸ“æ•ˆåº”@ApcWT): 3ä¸ªæ¯”è¾ƒ\n\n")
```

### 4.2 æ‰§è¡Œå…¨éƒ¨æˆå¯¹æ¯”è¾ƒ

```{r}
#| label: part5-run-comparisons
#| message: false

# ------------------------------------------------------------------------------
# æ‰§è¡Œå…¨éƒ¨9ä¸ªæˆå¯¹PERMANOVA
# ------------------------------------------------------------------------------

run_pairwise_permanova <- function(tse, pair, n_perm = 999) {
  # ç­›é€‰æ ·æœ¬
  tse_pair <- tse[, colData(tse)$treatment_group %in% pair]
  n_samples <- ncol(tse_pair)

  # æ ·æœ¬æ•°æ£€æŸ¥
  if (n_samples < 4) {
    return(list(
      n = n_samples,
      n_per_group = table(colData(tse_pair)$treatment_group),
      R2 = NA, F_value = NA, p_value = NA,
      betadisper_p = NA
    ))
  }

  # è®¡ç®—è·ç¦»çŸ©é˜µ
  dist_pair <- getDissimilarity(tse_pair, method = "bray", assay.type = "relabundance")
  meta_pair <- as.data.frame(colData(tse_pair))

  # PERMANOVA
  permanova_result <- vegan::adonis2(
    dist_pair ~ treatment_group,
    data = meta_pair,
    permutations = n_perm
  )

  # betadisperæ£€éªŒ
  disp <- vegan::betadisper(dist_pair, meta_pair$treatment_group)
  disp_test <- permutest(disp, permutations = n_perm)

  list(
    n = n_samples,
    n_per_group = table(meta_pair$treatment_group),
    R2 = permanova_result$R2[1],
    F_value = permanova_result$F[1],
    p_value = permanova_result$`Pr(>F)`[1],
    betadisper_p = disp_test$tab$`Pr(>F)`[1]
  )
}

# æ‰§è¡Œæ‰€æœ‰æ¯”è¾ƒ
cat("æ­£åœ¨æ‰§è¡Œ9ä¸ªæˆå¯¹æ¯”è¾ƒ...\n")
comparison_results <- lapply(seq_along(all_comparisons), function(i) {
  comp <- all_comparisons[[i]]
  cat(sprintf("  [%d/9] %s vs %s\n", i, comp$pair[1], comp$pair[2]))

  result <- run_pairwise_permanova(tse_full, comp$pair)

  data.frame(
    comparison_id = i,
    group1 = comp$pair[1],
    group2 = comp$pair[2],
    category = comp$category,
    question = comp$question,
    hypothesis = comp$hypothesis,
    n_total = result$n,
    R2 = round(result$R2, 4),
    F_value = round(result$F_value, 2),
    p_value = result$p_value,
    betadisper_p = round(result$betadisper_p, 3)
  )
})

part5_results <- do.call(rbind, comparison_results)

# FDRæ ¡æ­£
part5_results$p_adj <- p.adjust(part5_results$p_value, method = "BH")

# æ˜¾è‘—æ€§æ ‡è®°
part5_results$sig <- ifelse(part5_results$p_adj < 0.01, "***",
                            ifelse(part5_results$p_adj < 0.05, "**",
                                   ifelse(part5_results$p_adj < 0.1, "*", "")))

# æ–¹å·®é½æ€§æ ‡è®°
part5_results$variance_ok <- ifelse(part5_results$betadisper_p > 0.05, "âœ“", "âš ")

cat("\n=== Part 5: å…¨éƒ¨9ä¸ªæˆå¯¹æ¯”è¾ƒç»“æœ ===\n")
print(part5_results[, c("question", "n_total", "R2", "p_value", "p_adj", "sig", "variance_ok")])

# ä¿å­˜ç»“æœ
write.csv(part5_results,
          file = here::here("data", params$name, "50_part5_all_pairwise_comparisons.csv"),
          row.names = FALSE)
```

### 4.3 å…³é”®é—®é¢˜1: æ„ŸæŸ“æ˜¯å¦æŠ¹å¹³Apcæ•ˆåº”

```{r}
#| label: part5-apc-effect-analysis
#| message: false
#| fig-width: 10
#| fig-height: 6

# ------------------------------------------------------------------------------
# åˆ†æApcæ•ˆåº”åœ¨ä¸åŒæ„ŸæŸ“çŠ¶æ€ä¸‹çš„å˜åŒ–
# å¦‚æœæ„ŸæŸ“"æŠ¹å¹³"Apcæ•ˆåº”ï¼Œé¢„æœŸï¼šCtrlç»„Apcæ•ˆåº”æ˜¾è‘—ï¼Œæ„ŸæŸ“ç»„Apcæ•ˆåº”æ¶ˆå¤±
# ------------------------------------------------------------------------------

apc_effect_data <- part5_results %>%
  dplyr::filter(category == "Apcæ•ˆåº”") %>%
  mutate(
    infection_status = c("Ctrl (æœªæ„ŸæŸ“)", "HpKO (CagA-)", "HpWT (CagA+)"),
    infection_status = factor(infection_status,
                              levels = c("Ctrl (æœªæ„ŸæŸ“)", "HpKO (CagA-)", "HpWT (CagA+)"))
  )

cat("=== é—®é¢˜1: Apcæ•ˆåº”åœ¨ä¸åŒæ„ŸæŸ“çŠ¶æ€ä¸‹çš„å˜åŒ– ===\n\n")

# åˆ›å»ºæ±‡æ€»è¡¨
apc_summary <- apc_effect_data %>%
  dplyr::select(infection_status, R2, p_value, p_adj, sig, variance_ok) %>%
  mutate(
    R2_percent = paste0(round(R2 * 100, 1), "%"),
    interpretation = case_when(
      p_adj < 0.05 ~ "Apcæ•ˆåº”æ˜¾è‘—",
      p_adj < 0.1 ~ "Apcæ•ˆåº”è¾¹ç¼˜æ˜¾è‘—",
      TRUE ~ "Apcæ•ˆåº”æ¶ˆå¤±"
    )
  )

print(apc_summary)

# å¯è§†åŒ–
p5_3_1 <- ggplot(apc_effect_data, aes(x = infection_status, y = R2 * 100)) +
  geom_bar(stat = "identity", fill = "steelblue", alpha = 0.7, width = 0.6) +
  geom_text(aes(label = paste0(round(R2*100, 1), "%\n", sig)),
            vjust = -0.3, size = 4) +
  geom_hline(yintercept = 0, color = "black") +
  theme_bw(base_size = 12) +
  labs(
    title = "ApcåŸºå› å‹æ•ˆåº”åœ¨ä¸åŒæ„ŸæŸ“çŠ¶æ€ä¸‹çš„å˜åŒ–",
    subtitle = "æ¯”è¾ƒ: ApcMUT vs ApcWT (*** p<0.01, ** p<0.05, * p<0.1)",
    x = "æ„ŸæŸ“çŠ¶æ€",
    y = "æ•ˆåº”é‡ RÂ² (%)"
  ) +
  ylim(0, max(apc_effect_data$R2 * 100) * 1.3)

# På€¼å˜åŒ–è¶‹åŠ¿
p5_3_2 <- ggplot(apc_effect_data, aes(x = infection_status, y = -log10(p_adj))) +
  geom_bar(stat = "identity", fill = "coral", alpha = 0.7, width = 0.6) +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "red") +
  geom_text(aes(label = sprintf("P=%.3f", p_adj)), vjust = -0.3, size = 3.5) +
  annotate("text", x = 3.3, y = -log10(0.05), label = "P=0.05", color = "red", size = 3) +
  theme_bw(base_size = 12) +
  labs(
    title = "Apcæ•ˆåº”çš„ç»Ÿè®¡æ˜¾è‘—æ€§å˜åŒ–",
    x = "æ„ŸæŸ“çŠ¶æ€",
    y = "-log10(FDRæ ¡æ­£På€¼)"
  )

p5_3_combined <- p5_3_1 + p5_3_2
p5_3_combined

ggsave(here::here("data", params$name, "51_part5_apc_effect_by_infection.png"),
       plot = p5_3_combined, width = 12, height = 5, dpi = 300)

# ç»“è®º
cat("\n=== ç»“è®º ===\n")
if (apc_summary$p_adj[1] < 0.05 && all(apc_summary$p_adj[2:3] > 0.1)) {
  cat("âœ“ è¯æ®æ”¯æŒ: æ„ŸæŸ“'æŠ¹å¹³'äº†ApcåŸºå› å‹å·®å¼‚\n")
  cat("  - Ctrlç»„: Apcæ•ˆåº”æ˜¾è‘— (RÂ²=", apc_summary$R2_percent[1], ")\n")
  cat("  - æ„ŸæŸ“ç»„: Apcæ•ˆåº”æ¶ˆå¤±\n")
} else if (apc_summary$p_adj[1] < 0.05) {
  cat("â–³ éƒ¨åˆ†æ”¯æŒ: ApcåŸºçº¿æ•ˆåº”æ˜¾è‘—ï¼Œä½†æ„ŸæŸ“åæ•ˆåº”å˜åŒ–æ¨¡å¼å¤æ‚\n")
} else {
  cat("âœ— ä¸æ”¯æŒ: ApcåŸºçº¿æ•ˆåº”æœ¬èº«ä¸æ˜¾è‘—\n")
}
```

### 4.4 å…³é”®é—®é¢˜2: CagAæ•ˆåº”æ˜¯å¦ä¾èµ–é—ä¼ èƒŒæ™¯

```{r}
#| label: part5-caga-effect-analysis
#| message: false
#| fig-width: 10
#| fig-height: 6

# ------------------------------------------------------------------------------
# æ¯”è¾ƒCagAæ•ˆåº”åœ¨ApcMUT vs ApcWTèƒŒæ™¯ä¸‹çš„å·®å¼‚
# GÃ—Eäº¤äº’ä½œç”¨çš„ç›´æ¥éªŒè¯
# ------------------------------------------------------------------------------

caga_effect_data <- part5_results %>%
  dplyr::filter(category == "CagAæ•ˆåº”") %>%
  mutate(
    genetic_background = c("ApcMUT (Apcçªå˜)", "ApcWT (é‡ç”Ÿå‹)"),
    genetic_background = factor(genetic_background,
                                levels = c("ApcMUT (Apcçªå˜)", "ApcWT (é‡ç”Ÿå‹)"))
  )

cat("=== é—®é¢˜2: CagAæ•ˆåº”çš„é—ä¼ èƒŒæ™¯ä¾èµ–æ€§ ===\n\n")

caga_summary <- caga_effect_data %>%
  dplyr::select(genetic_background, R2, p_value, p_adj, sig, variance_ok) %>%
  mutate(
    R2_percent = paste0(round(R2 * 100, 1), "%"),
    interpretation = case_when(
      p_adj < 0.05 ~ "CagAæ•ˆåº”æ˜¾è‘—",
      p_adj < 0.1 ~ "CagAæ•ˆåº”è¾¹ç¼˜æ˜¾è‘—",
      TRUE ~ "CagAæ•ˆåº”ä¸æ˜¾è‘—"
    )
  )

print(caga_summary)

# å¯è§†åŒ–
p5_4_1 <- ggplot(caga_effect_data, aes(x = genetic_background, y = R2 * 100,
                                        fill = genetic_background)) +
  geom_bar(stat = "identity", alpha = 0.8, width = 0.6) +
  geom_text(aes(label = paste0(round(R2*100, 1), "%\n", sig)),
            vjust = -0.3, size = 4) +
  scale_fill_manual(values = c("ApcMUT (Apcçªå˜)" = "#E64B35",
                               "ApcWT (é‡ç”Ÿå‹)" = "#4DBBD5")) +
  theme_bw(base_size = 12) +
  theme(legend.position = "none") +
  labs(
    title = "CagAæ•ˆåº”çš„é—ä¼ èƒŒæ™¯ä¾èµ–æ€§",
    subtitle = "æ¯”è¾ƒ: HpWT vs HpKO (*** p<0.01, ** p<0.05, * p<0.1)",
    x = "é—ä¼ èƒŒæ™¯",
    y = "æ•ˆåº”é‡ RÂ² (%)"
  ) +
  ylim(0, max(caga_effect_data$R2 * 100) * 1.3)

# æ•ˆåº”é‡å¯¹æ¯”
effect_ratio <- caga_effect_data$R2[1] / max(caga_effect_data$R2[2], 0.001)

p5_4_2 <- ggplot(caga_effect_data, aes(x = genetic_background, y = -log10(p_adj),
                                        fill = genetic_background)) +
  geom_bar(stat = "identity", alpha = 0.8, width = 0.6) +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "red") +
  geom_text(aes(label = sprintf("P=%.3f", p_adj)), vjust = -0.3, size = 3.5) +
  scale_fill_manual(values = c("ApcMUT (Apcçªå˜)" = "#E64B35",
                               "ApcWT (é‡ç”Ÿå‹)" = "#4DBBD5")) +
  theme_bw(base_size = 12) +
  theme(legend.position = "none") +
  labs(
    title = "CagAæ•ˆåº”çš„ç»Ÿè®¡æ˜¾è‘—æ€§",
    x = "é—ä¼ èƒŒæ™¯",
    y = "-log10(FDRæ ¡æ­£På€¼)"
  )

p5_4_combined <- p5_4_1 + p5_4_2
p5_4_combined

ggsave(here::here("data", params$name, "52_part5_caga_effect_by_genotype.png"),
       plot = p5_4_combined, width = 10, height = 5, dpi = 300)

# ç»“è®º
cat("\n=== GÃ—Eäº¤äº’ä½œç”¨éªŒè¯ ===\n")
cat(sprintf("CagAæ•ˆåº”@ApcMUT: RÂ²=%.1f%%, P_adj=%.3f %s\n",
            caga_effect_data$R2[1]*100, caga_effect_data$p_adj[1], caga_effect_data$sig[1]))
cat(sprintf("CagAæ•ˆåº”@ApcWT:  RÂ²=%.1f%%, P_adj=%.3f %s\n",
            caga_effect_data$R2[2]*100, caga_effect_data$p_adj[2], caga_effect_data$sig[2]))
cat(sprintf("æ•ˆåº”é‡æ¯”å€¼: %.1fx\n", effect_ratio))

if (caga_effect_data$p_adj[1] < 0.05 && caga_effect_data$p_adj[2] > 0.1) {
  cat("\nâœ“ å¼ºè¯æ®æ”¯æŒGÃ—Eäº¤äº’ä½œç”¨:\n")
  cat("  CagAæ•ˆåº”ä»…åœ¨Apcçªå˜èƒŒæ™¯ä¸‹æ˜¾è‘—ï¼Œåœ¨é‡ç”Ÿå‹ä¸­æ— æ•ˆ\n")
}
```

### 4.5 å…³é”®é—®é¢˜3: æ„ŸæŸ“æ¢¯åº¦æ•ˆåº”åˆ†æ

```{r}
#| label: part5-infection-gradient
#| message: false
#| fig-width: 12
#| fig-height: 6

# ------------------------------------------------------------------------------
# åˆ†æCtrl â†’ HpKO â†’ HpWTçš„é€’è¿›æ•ˆåº”
# åœ¨ä¸¤ç§é—ä¼ èƒŒæ™¯ä¸‹åˆ†åˆ«è¯„ä¼°
# ------------------------------------------------------------------------------

# æå–æ„ŸæŸ“ç›¸å…³æ¯”è¾ƒ
infection_apcmut <- part5_results %>%
  dplyr::filter(category %in% c("æ„ŸæŸ“æ•ˆåº”@ApcMUT", "CagAæ•ˆåº”") &
         grepl("ApcMUT", group1) & grepl("ApcMUT", group2))

infection_apcwt <- part5_results %>%
  dplyr::filter(category %in% c("æ„ŸæŸ“æ•ˆåº”@ApcWT", "CagAæ•ˆåº”") &
         grepl("ApcWT", group1) & grepl("ApcWT", group2))

cat("=== é—®é¢˜3: æ„ŸæŸ“æ¢¯åº¦æ•ˆåº” ===\n\n")

cat("--- ApcMUTèƒŒæ™¯ä¸‹çš„æ„ŸæŸ“æ•ˆåº” ---\n")
print(infection_apcmut[, c("question", "R2", "p_adj", "sig")])

cat("\n--- ApcWTèƒŒæ™¯ä¸‹çš„æ„ŸæŸ“æ•ˆåº” ---\n")
print(infection_apcwt[, c("question", "R2", "p_adj", "sig")])

# åˆå¹¶æ•°æ®ç”¨äºå¯è§†åŒ–
gradient_data <- rbind(
  infection_apcmut %>% mutate(genotype = "ApcMUT"),
  infection_apcwt %>% mutate(genotype = "ApcWT")
) %>%
  mutate(
    comparison_short = case_when(
      grepl("Ctrl.*HpKO", paste(group1, group2)) ~ "Ctrlâ†’HpKO",
      grepl("Ctrl.*HpWT", paste(group1, group2)) ~ "Ctrlâ†’HpWT",
      grepl("HpKO.*HpWT", paste(group1, group2)) ~ "HpKOâ†’HpWT"
    ),
    comparison_short = factor(comparison_short,
                              levels = c("Ctrlâ†’HpKO", "Ctrlâ†’HpWT", "HpKOâ†’HpWT"))
  )

# å¯è§†åŒ–
p5_5_1 <- ggplot(gradient_data, aes(x = comparison_short, y = R2 * 100, fill = genotype)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8),
           width = 0.7, alpha = 0.8) +
  geom_text(aes(label = paste0(round(R2*100, 1), "%", sig), group = genotype),
            position = position_dodge(width = 0.8), vjust = -0.3, size = 3) +
  scale_fill_manual(values = c("ApcMUT" = "#E64B35", "ApcWT" = "#4DBBD5"),
                    name = "é—ä¼ èƒŒæ™¯") +
  theme_bw(base_size = 12) +
  labs(
    title = "æ„ŸæŸ“æ¢¯åº¦æ•ˆåº”: ä¸¤ç§é—ä¼ èƒŒæ™¯çš„å¯¹æ¯”",
    subtitle = "*** p<0.01, ** p<0.05, * p<0.1 (FDRæ ¡æ­£)",
    x = "æ¯”è¾ƒ",
    y = "æ•ˆåº”é‡ RÂ² (%)"
  ) +
  ylim(0, max(gradient_data$R2 * 100, na.rm = TRUE) * 1.3)

p5_5_1

ggsave(here::here("data", params$name, "53_part5_infection_gradient.png"),
       plot = p5_5_1, width = 10, height = 6, dpi = 300)
```

### 4.6 ç»¼åˆå¯è§†åŒ–ä¸ç»“è®º

```{r}
#| label: part5-comprehensive-visualization
#| message: false
#| fig-width: 14
#| fig-height: 10

# ------------------------------------------------------------------------------
# åˆ›å»ºç»¼åˆçƒ­å›¾å±•ç¤ºæ‰€æœ‰9ä¸ªæ¯”è¾ƒ
# ------------------------------------------------------------------------------

# å‡†å¤‡çƒ­å›¾æ•°æ®
heatmap_data <- part5_results %>%
  mutate(
    R2_percent = R2 * 100,
    neg_log_p = -log10(p_adj),
    label = paste0(round(R2_percent, 1), "%", sig)
  )

# åˆ›å»ºåˆ†ç»„çŸ©é˜µ
comparison_matrix <- data.frame(
  row_group = c(rep("Apcæ•ˆåº”\n(MUT vs WT)", 3),
                rep("æ„ŸæŸ“æ•ˆåº”\n@ApcMUT", 3),
                rep("æ„ŸæŸ“æ•ˆåº”\n@ApcWT", 3)),
  col_condition = c("Ctrl", "HpKO", "HpWT",
                    "Ctrlâ†’HpKO", "Ctrlâ†’HpWT", "HpKOâ†’HpWT",
                    "Ctrlâ†’HpKO", "Ctrlâ†’HpWT", "HpKOâ†’HpWT"),
  R2 = heatmap_data$R2_percent,
  p_adj = heatmap_data$p_adj,
  sig = heatmap_data$sig
)

# æ•ˆåº”é‡çƒ­å›¾
p5_6_1 <- ggplot(heatmap_data, aes(x = reorder(question, -R2), y = 1)) +

  geom_tile(aes(fill = R2 * 100), color = "white", width = 0.9, height = 0.8) +
  geom_text(aes(label = paste0(round(R2*100, 1), "%\n", sig)), size = 3.5) +
  scale_fill_gradient2(low = "white", mid = "lightblue", high = "darkblue",
                       midpoint = 20, name = "RÂ² (%)") +
  theme_minimal(base_size = 11) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank()
  ) +
  labs(title = "Part 5: æ‰€æœ‰æˆå¯¹æ¯”è¾ƒæ•ˆåº”é‡æ±‡æ€»", x = "", y = "") +
  coord_flip()

# På€¼æ£®æ—å›¾
p5_6_2 <- ggplot(heatmap_data, aes(x = reorder(question, -R2), y = -log10(p_adj))) +
  geom_segment(aes(xend = question, y = 0, yend = -log10(p_adj)),
               color = "gray50", linewidth = 0.8) +
  geom_point(aes(color = category), size = 4) +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "red", linewidth = 0.8) +
  geom_hline(yintercept = -log10(0.1), linetype = "dotted", color = "orange", linewidth = 0.8) +
  scale_color_brewer(palette = "Set1", name = "æ¯”è¾ƒç±»åˆ«") +
  theme_bw(base_size = 11) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(
    title = "ç»Ÿè®¡æ˜¾è‘—æ€§ (-log10 FDR På€¼)",
    subtitle = "çº¢çº¿: P=0.05, æ©™çº¿: P=0.1",
    x = "", y = "-log10(P_adj)"
  ) +
  coord_flip()

# ç»„åˆå›¾
p5_6_combined <- p5_6_1 / p5_6_2 +
  plot_annotation(
    title = "Part 5: æ‰©å±•åˆ†å±‚æˆå¯¹æ¯”è¾ƒç»¼åˆç»“æœ",
    subtitle = "ç‰©ç§Betaå¤šæ ·æ€§ (Bray-Curtis PERMANOVA, 999ç½®æ¢)"
  )

p5_6_combined

ggsave(here::here("data", params$name, "54_part5_comprehensive_summary.png"),
       plot = p5_6_combined, width = 12, height = 10, dpi = 300)
```

```{r}
#| label: part5-conclusions
#| echo: false
#| results: asis

# ------------------------------------------------------------------------------
## 4.1 Part 4 ç»“è®ºæ±‡æ€»
# ------------------------------------------------------------------------------

cat("\n### Part 5 å…³é”®å‘ç°\n\n")

# 1. Apcæ•ˆåº”åˆ†æ
apc_ctrl <- part5_results %>% dplyr::filter(question == "ApcåŸºçº¿æ•ˆåº” (Ctrlç»„)")
apc_hpko <- part5_results %>% dplyr::filter(question == "Apcæ•ˆåº” (HpKOæ„ŸæŸ“å)")
apc_hpwt <- part5_results %>% dplyr::filter(question == "Apcæ•ˆåº” (HpWTæ„ŸæŸ“å)")

cat("**1. Apcæ•ˆåº”çš„æ„ŸæŸ“ä¾èµ–æ€§å˜åŒ–**\n\n")
cat(sprintf("| æ„ŸæŸ“çŠ¶æ€ | RÂ² | P_adj | ç»“è®º |\n"))
cat(sprintf("|----------|-----|-------|------|\n"))
cat(sprintf("| Ctrl (æœªæ„ŸæŸ“) | %.1f%% | %.3f | %s |\n",
            apc_ctrl$R2*100, apc_ctrl$p_adj,
            ifelse(apc_ctrl$p_adj < 0.05, "æ˜¾è‘—", "ä¸æ˜¾è‘—")))
cat(sprintf("| HpKO (CagA-) | %.1f%% | %.3f | %s |\n",
            apc_hpko$R2*100, apc_hpko$p_adj,
            ifelse(apc_hpko$p_adj < 0.05, "æ˜¾è‘—", "ä¸æ˜¾è‘—")))
cat(sprintf("| HpWT (CagA+) | %.1f%% | %.3f | %s |\n\n",
            apc_hpwt$R2*100, apc_hpwt$p_adj,
            ifelse(apc_hpwt$p_adj < 0.05, "æ˜¾è‘—", "ä¸æ˜¾è‘—")))

# 2. CagAæ•ˆåº”åˆ†æ
caga_mut <- part5_results %>% dplyr::filter(question == "CagAæ•ˆåº” (ApcMUTèƒŒæ™¯)")
caga_wt <- part5_results %>% dplyr::filter(question == "CagAæ•ˆåº” (ApcWTèƒŒæ™¯)")

cat("**2. CagAæ•ˆåº”çš„é—ä¼ èƒŒæ™¯ä¾èµ–æ€§ (GÃ—Eäº¤äº’)**\n\n")
cat(sprintf("| é—ä¼ èƒŒæ™¯ | RÂ² | P_adj | ç»“è®º |\n"))
cat(sprintf("|----------|-----|-------|------|\n"))
cat(sprintf("| ApcMUT | %.1f%% | %.3f | %s |\n",
            caga_mut$R2*100, caga_mut$p_adj,
            ifelse(caga_mut$p_adj < 0.05, "**æ˜¾è‘—**", "ä¸æ˜¾è‘—")))
cat(sprintf("| ApcWT | %.1f%% | %.3f | %s |\n\n",
            caga_wt$R2*100, caga_wt$p_adj,
            ifelse(caga_wt$p_adj < 0.05, "æ˜¾è‘—", "ä¸æ˜¾è‘—")))

# 3. ç»¼åˆç»“è®º
cat("**3. ç»¼åˆç»“è®º**\n\n")

significant_comparisons <- part5_results %>% dplyr::filter(p_adj < 0.05)
cat(sprintf("- 9ä¸ªæ¯”è¾ƒä¸­æœ‰ **%dä¸ª** åœ¨FDRæ ¡æ­£åæ˜¾è‘— (P_adj < 0.05)\n", nrow(significant_comparisons)))

if (caga_mut$p_adj < 0.05 && caga_wt$p_adj > 0.1) {
  cat("- **GÃ—Eäº¤äº’ä½œç”¨ç¡®è®¤**: CagAæ•ˆåº”ä»…åœ¨Apcçªå˜èƒŒæ™¯ä¸‹æ˜¾è‘—\n")
}

if (apc_ctrl$p_adj < 0.05 && apc_hpko$p_adj > 0.1 && apc_hpwt$p_adj > 0.1) {
  cat("- **æ„ŸæŸ“æŠ¹å¹³æ•ˆåº”ç¡®è®¤**: Hpæ„ŸæŸ“æ¶ˆé™¤äº†ApcåŸºå› å‹å·®å¼‚\n")
} else if (apc_ctrl$p_adj < 0.05) {
  cat("- **ApcåŸºçº¿æ•ˆåº”ç¡®è®¤**: Apcçªå˜æœ¬èº«æ˜¾è‘—æ”¹å˜èŒç¾¤ç»“æ„\n")
}

cat("\n")
```

```{r}
#| label: part5-save-results
#| echo: false

# ä¿å­˜Part 5æ±‡æ€»ç»“æœ
part5_summary <- list(
  all_comparisons = part5_results,
  apc_effect_analysis = apc_effect_data,
  caga_effect_analysis = caga_effect_data,
  timestamp = Sys.time()
)

saveRDS(part5_summary,
        file = here::here("data", params$name, "55_part5_summary_results.rds"))

cat("\nâœ… Part 5 ç»“æœå·²ä¿å­˜:\n")
cat("  - 50_part5_all_pairwise_comparisons.csv\n")
cat("  - 51_part5_apc_effect_by_infection.png\n")
cat("  - 52_part5_caga_effect_by_genotype.png\n")
cat("  - 53_part5_infection_gradient.png\n")
cat("  - 54_part5_comprehensive_summary.png\n")
cat("  - 55_part5_summary_results.rds\n")
```

# Part 5: 2Ã—3å› å­è®¾è®¡æ‰©å±•åˆ†æ - Virus {#sec-factorial-virus}

æœ¬éƒ¨åˆ†å¯¹Virusæ•°æ®è¿›è¡Œä¸Standardæ•°æ®ç›¸åŒçš„2Ã—3å› å­è®¾è®¡åˆ†æï¼Œä»¥æ¯”è¾ƒç—…æ¯’ç»„ä¸ç»†èŒç»„åœ¨å®éªŒè®¾è®¡ä¸‹çš„å“åº”å·®å¼‚ã€‚

### 5.1 æ•°æ®å‡†å¤‡

```{r}
#| label: part4b-virus-data-prep
#| message: false

# ------------------------------------------------------------------------------
### 5.1a Viruså› å­ç¼–ç 
# ------------------------------------------------------------------------------

# 1. ä½¿ç”¨æ¸…æ´—åçš„å…¨æ ·æœ¬virusæ•°æ®
tse_virus_full <- tse_virus_species_ca_cleaned

# 2. è½¬æ¢ä¸ºæ ‡å‡†åŒ– factor å˜é‡
colData(tse_virus_full)$genotype_factor <- factor(
  ifelse(grepl("ApcMUT", colData(tse_virus_full)$treatment_group), "ApcMUT", "ApcWT"),
  levels = c("ApcWT", "ApcMUT")
)

colData(tse_virus_full)$infection_factor <- factor(
  case_when(
    grepl("_Ctrl$", colData(tse_virus_full)$treatment_group) ~ "Ctrl",
    grepl("_HpKO$", colData(tse_virus_full)$treatment_group) ~ "HpKO",
    grepl("_HpWT$", colData(tse_virus_full)$treatment_group) ~ "HpWT"
  ),
  levels = c("Ctrl", "HpKO", "HpWT")
)

# 3. æ˜¾ç¤ºæ ·æœ¬åˆ†å¸ƒ
cat("=== Part 4b: Virus 2Ã—3å› å­è®¾è®¡æ•°æ®å‡†å¤‡ ===\n")
print(table(colData(tse_virus_full)$genotype_factor, colData(tse_virus_full)$infection_factor))
cat("\nVirusæ€»æ ·æœ¬æ•°:", ncol(tse_virus_full), "\n")

# 4. ç¡®ä¿relabundanceå·²è®¡ç®—
if (!"relabundance" %in% assayNames(tse_virus_full)) {
  tse_virus_full <- transformAssay(tse_virus_full, assay.type = "counts", method = "relabundance")
}
```

### 5.2 betadisperæ–¹å·®é½æ€§æ£€éªŒ

```{r}
#| label: part4b-virus-betadisper
#| message: false

# ------------------------------------------------------------------------------
# betadisperæ£€éªŒï¼šPERMANOVAçš„å‰æå‡è®¾éªŒè¯
# ------------------------------------------------------------------------------

# è®¡ç®—è·ç¦»çŸ©é˜µ
virus_dist_full <- getDissimilarity(tse_virus_full, method = "bray", assay.type = "relabundance")

# betadisperæ£€éªŒï¼ˆæŒ‰treatment_groupï¼‰
virus_disp_treatment <- betadisper(virus_dist_full, colData(tse_virus_full)$treatment_group)
virus_disp_test_treatment <- permutest(virus_disp_treatment, permutations = 999)

# betadisperæ£€éªŒï¼ˆæŒ‰genotypeï¼‰
virus_disp_genotype <- betadisper(virus_dist_full, colData(tse_virus_full)$genotype_factor)
virus_disp_test_genotype <- permutest(virus_disp_genotype, permutations = 999)

# betadisperæ£€éªŒï¼ˆæŒ‰infectionï¼‰
virus_disp_infection <- betadisper(virus_dist_full, colData(tse_virus_full)$infection_factor)
virus_disp_test_infection <- permutest(virus_disp_infection, permutations = 999)

cat("=== Virus betadisperæ–¹å·®é½æ€§æ£€éªŒ ===\n")
cat("Treatment (6ç»„): P =", round(virus_disp_test_treatment$tab$`Pr(>F)`[1], 4), "\n")
cat("Genotype (2ç»„): P =", round(virus_disp_test_genotype$tab$`Pr(>F)`[1], 4), "\n")
cat("Infection (3ç»„): P =", round(virus_disp_test_infection$tab$`Pr(>F)`[1], 4), "\n")

if (all(c(virus_disp_test_treatment$tab$`Pr(>F)`[1],
          virus_disp_test_genotype$tab$`Pr(>F)`[1],
          virus_disp_test_infection$tab$`Pr(>F)`[1]) > 0.05)) {
  cat("\nâœ“ æ‰€æœ‰åˆ†ç»„å‡æ»¡è¶³æ–¹å·®é½æ€§å‡è®¾ (P > 0.05)\n")
} else {
  cat("\nâš  éƒ¨åˆ†åˆ†ç»„æ–¹å·®ä¸é½ï¼ŒPERMANOVAç»“æœéœ€è°¨æ…è§£è¯»\n")
}
```

### 5.3 Alphaå¤šæ ·æ€§ - å…¨6ç»„

```{r}
#| label: part4b-virus-alpha-6groups
#| message: false
#| fig-width: 12
#| fig-height: 5

# ------------------------------------------------------------------------------
# Alphaå¤šæ ·æ€§ï¼šå…¨6ç»„å¯è§†åŒ–ä¸ç»Ÿè®¡æ£€éªŒ
# ------------------------------------------------------------------------------

# 1. ç¡®ä¿alphaæŒ‡æ•°å·²è®¡ç®—
if (!"shannon_index" %in% colnames(colData(tse_virus_full))) {
  tse_virus_full <- addAlpha(tse_virus_full, assay.type = "counts",
                             index = c("shannon", "observed"),
                             name = c("shannon_index", "observed_richness"))
}

# 2. å‡†å¤‡ç»˜å›¾æ•°æ®
virus_alpha_data <- as.data.frame(colData(tse_virus_full)) %>%
  dplyr::select(treatment_group, genotype_factor, infection_factor, shannon_index, observed_richness)

# 3. Kruskal-Wallisæ£€éªŒï¼ˆ6ç»„ï¼‰
virus_kw_shannon <- kruskal.test(shannon_index ~ treatment_group, data = virus_alpha_data)
virus_kw_observed <- kruskal.test(observed_richness ~ treatment_group, data = virus_alpha_data)

cat("=== Virus Alphaå¤šæ ·æ€§ - 6ç»„Kruskal-Wallisæ£€éªŒ ===\n")
cat("Shannon: P =", round(virus_kw_shannon$p.value, 4), "\n")
cat("Observed: P =", round(virus_kw_observed$p.value, 4), "\n")

# 4. å¯è§†åŒ–
p4b_alpha_box <- ggplot(virus_alpha_data, aes(x = treatment_group, y = shannon_index, fill = genotype_factor)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(width = 0.2, size = 2, alpha = 0.6) +
  scale_fill_manual(values = c("ApcWT" = "#4DBBD5", "ApcMUT" = "#E64B35")) +
  labs(title = "Virus Alphaå¤šæ ·æ€§ (Shannon) - å…¨6ç»„",
       subtitle = paste0("Kruskal-Wallis P = ", round(virus_kw_shannon$p.value, 4)),
       x = "Treatment Group", y = "Shannon Index", fill = "Genotype") +
  theme_bw(base_size = 11) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p4b_alpha_interaction <- ggplot(virus_alpha_data, aes(x = infection_factor, y = shannon_index,
                                                       color = genotype_factor, group = genotype_factor)) +
  stat_summary(fun = mean, geom = "point", size = 3) +
  stat_summary(fun = mean, geom = "line", linewidth = 1) +
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +
  scale_color_manual(values = c("ApcWT" = "#4DBBD5", "ApcMUT" = "#E64B35")) +
  labs(title = "Virus Alphaå¤šæ ·æ€§äº¤äº’ä½œç”¨å›¾",
       x = "Infection Status", y = "Shannon Index (Mean Â± SE)", color = "Genotype") +
  theme_bw(base_size = 11)

p4b_alpha_combined <- p4b_alpha_box + p4b_alpha_interaction
p4b_alpha_combined

ggsave(here::here("data", params$name, "60_part4b_virus_alpha_6groups.png"),
       plot = p4b_alpha_combined, width = 12, height = 5, dpi = 300)
```

### 5.4 Betaå¤šæ ·æ€§ - 2Ã—3 PERMANOVA

```{r}
#| label: part4b-virus-beta-permanova
#| message: false

# ------------------------------------------------------------------------------
# åŒå› ç´ PERMANOVAï¼šæ£€éªŒgenotypeå’Œinfectionå¯¹virusç»„æˆçš„æ•ˆåº”
# ------------------------------------------------------------------------------

virus_meta_full <- as.data.frame(colData(tse_virus_full))

# 1. åŒå› ç´ PERMANOVAï¼ˆå«äº¤äº’ä½œç”¨ï¼‰
virus_permanova_interaction <- adonis2(
  virus_dist_full ~ genotype_factor * infection_factor,
  data = virus_meta_full,
  permutations = 999
)

cat("=== VirusåŒå› ç´ PERMANOVA (Genotype Ã— Infection) ===\n")
print(virus_permanova_interaction)

# 2. è¾¹é™…æ•ˆåº”æ¨¡å‹
virus_permanova_marginal <- adonis2(
  virus_dist_full ~ genotype_factor + infection_factor,
  data = virus_meta_full,
  permutations = 999,
  by = "margin"
)

cat("\n=== Virusè¾¹é™…æ•ˆåº”PERMANOVA ===\n")
print(virus_permanova_marginal)

# ä¿å­˜ç»“æœ
virus_permanova_results <- list(
  interaction_model = virus_permanova_interaction,
  marginal_model = virus_permanova_marginal
)
saveRDS(virus_permanova_results, file = here::here("data", params$name, "61_part4b_virus_permanova_results.rds"))
```

### 5.5 PCoAå¯è§†åŒ–

```{r}
#| label: part4b-virus-pcoa
#| message: false
#| fig-width: 10
#| fig-height: 8

# ------------------------------------------------------------------------------
# PCoAå¯è§†åŒ–ï¼šå…¨6ç»„
# ------------------------------------------------------------------------------

# 1. è¿è¡ŒPCoA
if (!"PCoA_Bray_Full" %in% reducedDimNames(tse_virus_full)) {
  tse_virus_full <- addMDS(tse_virus_full,
                           FUN = getDissimilarity,
                           method = "bray",
                           assay.type = "relabundance",
                           name = "PCoA_Bray_Full")
}

# 2. æå–PCoAåæ ‡
virus_pcoa_data <- as.data.frame(reducedDim(tse_virus_full, "PCoA_Bray_Full"))
colnames(virus_pcoa_data) <- c("PC1", "PC2")
virus_pcoa_data$treatment_group <- colData(tse_virus_full)$treatment_group
virus_pcoa_data$genotype <- colData(tse_virus_full)$genotype_factor
virus_pcoa_data$infection <- colData(tse_virus_full)$infection_factor

# 3. è®¡ç®—æ–¹å·®è§£é‡Š
virus_eig <- attr(reducedDim(tse_virus_full, "PCoA_Bray_Full"), "eig")
virus_var_explained <- virus_eig / sum(virus_eig) * 100

# 4. å¯è§†åŒ–
p4b_pcoa <- ggplot(virus_pcoa_data, aes(x = PC1, y = PC2, color = treatment_group, shape = genotype)) +
  geom_point(size = 3.5, alpha = 0.8) +
  stat_ellipse(aes(group = treatment_group), level = 0.68, linetype = "dashed", linewidth = 0.8) +
  scale_color_manual(values = c(
    "ApcWT_Ctrl" = "#91D1C2", "ApcWT_HpKO" = "#4DBBD5", "ApcWT_HpWT" = "#00A087",
    "ApcMUT_Ctrl" = "#F39B7F", "ApcMUT_HpKO" = "#E64B35", "ApcMUT_HpWT" = "#DC0000"
  )) +
  labs(
    title = "Virus Betaå¤šæ ·æ€§ PCoA (Bray-Curtis)",
    subtitle = sprintf("PERMANOVA: Genotype P=%.3f, Infection P=%.3f, Interaction P=%.3f",
                      virus_permanova_interaction$`Pr(>F)`[1],
                      virus_permanova_interaction$`Pr(>F)`[2],
                      virus_permanova_interaction$`Pr(>F)`[3]),
    x = sprintf("PC1 (%.1f%%)", virus_var_explained[1]),
    y = sprintf("PC2 (%.1f%%)", virus_var_explained[2]),
    color = "Treatment", shape = "Genotype"
  ) +
  theme_bw(base_size = 12) +
  theme(legend.position = "right")

print(p4b_pcoa)

ggsave(here::here("data", params$name, "62_part4b_virus_pcoa_6groups.png"),
       plot = p4b_pcoa, width = 10, height = 8, dpi = 300)
```

### 5.6 Part 5ç»“è®º - Standard vs Viruså¯¹æ¯”

```{r}
#| label: part4b-conclusion
#| echo: false
#| results: asis

# ------------------------------------------------------------------------------
## 5.2 Part 5 ç»“è®ºæ±‡æ€»
# ------------------------------------------------------------------------------

# å®‰å…¨æå–På€¼ï¼ˆå¤„ç†NAï¼‰
get_p_display <- function(p_val) {
  if (is.na(p_val)) return("NA")
  round(p_val, 3)
}

get_sig_display <- function(p_val) {
  if (is.na(p_val)) return("æ— æ³•è®¡ç®—")
  ifelse(p_val < 0.05, "æ˜¾è‘—", "ä¸æ˜¾è‘—")
}

virus_p_geno <- virus_permanova_interaction$`Pr(>F)`[1]
virus_p_infect <- virus_permanova_interaction$`Pr(>F)`[2]
virus_p_interact <- virus_permanova_interaction$`Pr(>F)`[3]

cat("
### Part 4b: Virus 2Ã—3å› å­è®¾è®¡åˆ†æç»“è®º

#### PERMANOVAç»“æœå¯¹æ¯” (Standard vs Virus)

| æ•ˆåº” | Standard (ç»†èŒ) | Virus (ç—…æ¯’) | è§£è¯» |
|------|----------------|--------------|------|
| Genotypeä¸»æ•ˆåº” | å‚è§Part 4 | P = ", get_p_display(virus_p_geno), " | ", get_sig_display(virus_p_geno), " |
| Infectionä¸»æ•ˆåº” | å‚è§Part 4 | P = ", get_p_display(virus_p_infect), " | ", get_sig_display(virus_p_infect), " |
| **äº¤äº’ä½œç”¨** | P = 0.024 | P = ", get_p_display(virus_p_interact), " | ", get_sig_display(virus_p_interact), " |

")

# è§£è¯»ï¼ˆå®‰å…¨æ£€æŸ¥NAï¼‰
interact_not_sig <- !is.na(virus_p_interact) && virus_p_interact > 0.05
interact_is_na <- is.na(virus_p_interact)

if (interact_not_sig || interact_is_na) {
  cat("
::: {.callout-note}
## å…³é”®å‘ç°

**Virusç»„æ— æ˜¾è‘—GÃ—Eäº¤äº’ä½œç”¨**ï¼Œä¸Standardç»„ï¼ˆç»†èŒï¼‰å½¢æˆå¯¹æ¯”ã€‚
")
  if (interact_is_na) {
    cat("\næ³¨ï¼šäº¤äº’ä½œç”¨På€¼ä¸ºNAï¼Œå¯èƒ½ç”±äºæŸäº›ç»„åˆ«æ ·æœ¬é‡ä¸è¶³ã€‚\n")
  }
  cat("
è¿™è¡¨æ˜CagAä¸»è¦é€šè¿‡é‡å¡‘**ç»†èŒç¾¤è½**è€Œéç—…æ¯’ç»„æ¥å½±å“è‚ é“å¾®ç¯å¢ƒã€‚
:::
")
}

cat("\n\n**Part 4båˆ†æç»“æœå·²ä¿å­˜è‡³** `data/", params$name, "/` ç›®å½•ä¸‹ (æ–‡ä»¶60-62)ã€‚\n")
```

# Part 6: åˆ†å±‚æˆå¯¹æ¯”è¾ƒ - Virus {#sec-pairwise-virus}

æœ¬éƒ¨åˆ†å¯¹Virusæ•°æ®è¿›è¡Œä¸Standardæ•°æ®ç›¸åŒçš„9ä¸ªç³»ç»Ÿæ€§æˆå¯¹æ¯”è¾ƒã€‚

### 6.1 å®šä¹‰æˆå¯¹æ¯”è¾ƒ

```{r}
#| label: part5b-define-comparisons
#| message: false

# ------------------------------------------------------------------------------
## 6.1 Virusæˆå¯¹æ¯”è¾ƒåˆ†æ
# ------------------------------------------------------------------------------

# ä½¿ç”¨ä¸Part 5ç›¸åŒçš„æ¯”è¾ƒå®šä¹‰
cat("=== Part 5b: Virus 9ä¸ªæˆå¯¹æ¯”è¾ƒ ===\n")
cat("ä½¿ç”¨ä¸Standardç›¸åŒçš„9ä¸ªæ¯”è¾ƒæ¡†æ¶\n")
cat("ç±»åˆ«A (Apcæ•ˆåº”): 3ä¸ªæ¯”è¾ƒ\n")
cat("ç±»åˆ«B (æ„ŸæŸ“æ•ˆåº”@ApcMUT): 3ä¸ªæ¯”è¾ƒ\n")
cat("ç±»åˆ«C (æ„ŸæŸ“æ•ˆåº”@ApcWT): 3ä¸ªæ¯”è¾ƒ\n\n")
```

### 6.2 æ‰§è¡Œæˆå¯¹æ¯”è¾ƒ

```{r}
#| label: part5b-run-comparisons
#| message: false

# ------------------------------------------------------------------------------
# æ‰§è¡Œå…¨éƒ¨9ä¸ªæˆå¯¹PERMANOVA (Virus)
# ------------------------------------------------------------------------------

run_pairwise_permanova_virus <- function(tse, pair, n_perm = 999) {
  # ç­›é€‰æ ·æœ¬
  tse_pair <- tse[, colData(tse)$treatment_group %in% pair]
  n_samples <- ncol(tse_pair)

  # æ ·æœ¬æ•°æ£€æŸ¥
  if (n_samples < 4) {
    return(list(n = n_samples, n_per_group = NA, R2 = NA, F_value = NA, p_value = NA, betadisper_p = NA))
  }

  # è®¡ç®—è·ç¦»çŸ©é˜µ
  dist_pair <- getDissimilarity(tse_pair, method = "bray", assay.type = "relabundance")
  meta_pair <- as.data.frame(colData(tse_pair))

  # PERMANOVA
  permanova_result <- tryCatch({
    vegan::adonis2(dist_pair ~ treatment_group, data = meta_pair, permutations = n_perm)
  }, error = function(e) NULL)

  if (is.null(permanova_result)) {
    return(list(n = n_samples, n_per_group = table(meta_pair$treatment_group),
                R2 = NA, F_value = NA, p_value = NA, betadisper_p = NA))
  }

  # betadisperæ£€éªŒ
  disp <- tryCatch({
    d <- vegan::betadisper(dist_pair, meta_pair$treatment_group)
    permutest(d, permutations = n_perm)
  }, error = function(e) NULL)

  list(
    n = n_samples,
    n_per_group = table(meta_pair$treatment_group),
    R2 = permanova_result$R2[1],
    F_value = permanova_result$F[1],
    p_value = permanova_result$`Pr(>F)`[1],
    betadisper_p = if (!is.null(disp)) disp$tab$`Pr(>F)`[1] else NA
  )
}

# æ‰§è¡Œæ‰€æœ‰æ¯”è¾ƒ
cat("æ­£åœ¨æ‰§è¡ŒVirus 9ä¸ªæˆå¯¹æ¯”è¾ƒ...\n")
virus_comparison_results <- lapply(seq_along(all_comparisons), function(i) {
  comp <- all_comparisons[[i]]
  cat(sprintf("  [%d/9] %s vs %s\n", i, comp$pair[1], comp$pair[2]))

  result <- run_pairwise_permanova_virus(tse_virus_full, comp$pair)

  data.frame(
    comparison_id = i,
    group1 = comp$pair[1],
    group2 = comp$pair[2],
    category = comp$category,
    question = comp$question,
    n_total = result$n,
    R2 = round(result$R2, 4),
    F_value = round(result$F_value, 2),
    p_value = result$p_value,
    betadisper_p = round(result$betadisper_p, 3)
  )
})

part5b_virus_results <- do.call(rbind, virus_comparison_results)

# FDRæ ¡æ­£
part5b_virus_results$p_adj <- p.adjust(part5b_virus_results$p_value, method = "BH")

# æ˜¾è‘—æ€§æ ‡è®°
part5b_virus_results$sig <- ifelse(part5b_virus_results$p_adj < 0.01, "***",
                                   ifelse(part5b_virus_results$p_adj < 0.05, "**",
                                          ifelse(part5b_virus_results$p_adj < 0.1, "*", "")))

cat("\n=== Part 5b: Viruså…¨éƒ¨9ä¸ªæˆå¯¹æ¯”è¾ƒç»“æœ ===\n")
print(part5b_virus_results[, c("question", "n_total", "R2", "p_value", "p_adj", "sig")])

# ä¿å­˜ç»“æœ
write.csv(part5b_virus_results,
          file = here::here("data", params$name, "63_part5b_virus_pairwise_comparisons.csv"),
          row.names = FALSE)
```

### 6.3 Standard vs Viruså¯¹æ¯”

```{r}
#| label: part5b-standard-virus-comparison
#| message: false
#| fig-width: 14
#| fig-height: 6

# ------------------------------------------------------------------------------
# Standard vs Virus æˆå¯¹æ¯”è¾ƒå¯¹æ¯”
# ------------------------------------------------------------------------------

# åˆå¹¶æ•°æ®
part5_results$data_type <- "Standard (ç»†èŒ)"
part5b_virus_results$data_type <- "Virus (ç—…æ¯’)"

combined_pairwise <- rbind(
  part5_results[, c("question", "R2", "p_value", "p_adj", "sig", "data_type")],
  part5b_virus_results[, c("question", "R2", "p_value", "p_adj", "sig", "data_type")]
)

# å¯è§†åŒ–å¯¹æ¯”
p5b_comparison <- ggplot(combined_pairwise, aes(x = reorder(question, -p_value), y = -log10(p_adj), fill = data_type)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.7) +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "red", linewidth = 0.8) +
  scale_fill_manual(values = c("Standard (ç»†èŒ)" = "#4DBBD5", "Virus (ç—…æ¯’)" = "#E64B35")) +
  labs(
    title = "Standard vs Virus: 9ä¸ªæˆå¯¹æ¯”è¾ƒæ˜¾è‘—æ€§å¯¹æ¯”",
    subtitle = "çº¢è‰²è™šçº¿: FDRæ ¡æ­£ P = 0.05",
    x = "æ¯”è¾ƒé—®é¢˜",
    y = "-log10(P_adj)",
    fill = "æ•°æ®ç±»å‹"
  ) +
  theme_bw(base_size = 11) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
        legend.position = "bottom")

print(p5b_comparison)

ggsave(here::here("data", params$name, "64_part5b_standard_vs_virus_comparison.png"),
       plot = p5b_comparison, width = 14, height = 6, dpi = 300)
```

### 6.4 ç»“è®ºæ±‡æ€»

```{r}
#| label: part5b-conclusion
#| echo: false
#| results: asis

# ------------------------------------------------------------------------------
## 6.2 Part 6 ç»“è®ºæ±‡æ€»
# ------------------------------------------------------------------------------

# ç»Ÿè®¡æ˜¾è‘—ç»“æœ
standard_sig <- sum(part5_results$p_adj < 0.05, na.rm = TRUE)
virus_sig <- sum(part5b_virus_results$p_adj < 0.05, na.rm = TRUE)

cat("
### Part 5b: Standard vs Virus æˆå¯¹æ¯”è¾ƒç»“æœæ±‡æ€»

| æ•°æ®ç±»å‹ | FDRæ˜¾è‘—æ¯”è¾ƒæ•° | ä¸»è¦æ˜¾è‘—æ¯”è¾ƒ |
|----------|--------------|--------------|
| Standard (ç»†èŒ) | ", standard_sig, "/9 | å‚è§Part 5 |
| Virus (ç—…æ¯’) | ", virus_sig, "/9 | ", ifelse(virus_sig > 0, "è¯¦è§ä¸‹è¡¨", "æ— "), " |

")

# CagAæ ¸å¿ƒæ¯”è¾ƒ
standard_caga_mut <- part5_results[part5_results$question == "CagAæ•ˆåº” (ApcMUTèƒŒæ™¯)", ]
virus_caga_mut <- part5b_virus_results[part5b_virus_results$question == "CagAæ•ˆåº” (ApcMUTèƒŒæ™¯)", ]

cat("
### æ ¸å¿ƒæ¯”è¾ƒï¼šCagAæ•ˆåº” (ApcMUTèƒŒæ™¯)

| æ•°æ®ç±»å‹ | RÂ² | P_adj | æ˜¾è‘—æ€§ |
|----------|-----|-------|--------|
| Standard | ", round(standard_caga_mut$R2, 4), " | ", round(standard_caga_mut$p_adj, 4), " | ", standard_caga_mut$sig, " |
| Virus | ", round(virus_caga_mut$R2, 4), " | ", round(virus_caga_mut$p_adj, 4), " | ", virus_caga_mut$sig, " |

")

cat("
::: {.callout-tip}
## Part 6 å…³é”®å‘ç°

1. **Standard (ç»†èŒ)** åœ¨å¤šä¸ªæ¯”è¾ƒä¸­æ˜¾ç¤ºæ˜¾è‘—å·®å¼‚
2. **Virus (ç—…æ¯’)** æ•´ä½“å“åº”è¾ƒå¼±
3. **CagAä¸»è¦é€šè¿‡é‡å¡‘ç»†èŒç¾¤è½è€Œéç—…æ¯’ç»„å½±å“è‚ é“å¾®ç¯å¢ƒ**
:::
")

# ä¿å­˜æ±‡æ€»
part5b_summary <- list(
  virus_results = part5b_virus_results,
  standard_results = part5_results,
  combined = combined_pairwise,
  timestamp = Sys.time()
)

saveRDS(part5b_summary,
        file = here::here("data", params$name, "65_part5b_virus_summary_results.rds"))

cat("\n\nâœ… Part 5b ç»“æœå·²ä¿å­˜:\n")
cat("  - 63_part5b_virus_pairwise_comparisons.csv\n")
cat("  - 64_part5b_standard_vs_virus_comparison.png\n")
cat("  - 65_part5b_virus_summary_results.rds\n")
```

---

# å…¨å±€æ€»ç»“ {#sec-summary}

## ä¸»è¦å‘ç°

```{r}
#| label: global-summary
#| echo: false

cat("
## Part 1: Alpha & Betaå¤šæ ·æ€§åˆ†æ - æ ¸å¿ƒæ¯”è¾ƒç»“æœ

| åˆ†æ | æ•°æ®ç±»å‹ | æŒ‡æ ‡ | På€¼ | ç»“è®º |
|------|----------|------|-----|------|
| Alphaå¤šæ ·æ€§ | Standard | Shannon | 0.73 | NS - ç¾¤è½å¤æ‚åº¦æ— å˜åŒ– |
| Alphaå¤šæ ·æ€§ | Standard | Observed | 0.29 | NS |
| **Betaå¤šæ ·æ€§** | **Standard** | **Bray-Curtis PERMANOVA** | **0.012** | **æ˜¾è‘— - ç¾¤è½ç»“æ„é‡å¡‘** |
| Betaå¤šæ ·æ€§ | Virus | Bray-Curtis PERMANOVA | 0.032 | æ˜¾è‘— - ç—…æ¯’ç»„ä¹Ÿå“åº” |

## å…³é”®ç»“è®º

1. **Alphaå¤šæ ·æ€§ä¿æŒç¨³å®š**ï¼šCagAæ„ŸæŸ“æœªå¯¼è‡´èŒç¾¤å¤šæ ·æ€§å´©æºƒï¼Œæ’é™¤äº†'å¤§ç­ç»'å‡è¯´
2. **Betaå¤šæ ·æ€§æ˜¾è‘—æ”¹å˜**ï¼šç¾¤è½ç»„æˆå‘ç”Ÿæ˜¾è‘—é‡å¡‘ï¼Œæ”¯æŒFunctional Footprintå‡è¯´
3. **Standardä¸Viruså·®å¼‚å“åº”**ï¼šç»†èŒå“åº”æ›´å¼ºï¼ˆP=0.012 vs 0.032ï¼‰
4. **2Ã—3å› å­è®¾è®¡éªŒè¯**ï¼šGÃ—Eäº¤äº’ä½œç”¨ç¡®è®¤CagAæ•ˆåº”ä¾èµ–Apcçªå˜èƒŒæ™¯

## ä¸å‡è¯´çš„å…³ç³»

æœ¬åˆ†æä¸º **Functional Footprintå‡è¯´** æä¾›äº†å¼ºæœ‰åŠ›æ”¯æŒï¼š
- CagAæ¥äº†åˆèµ°äº†ï¼Œä½†ç•™ä¸‹äº†ç¾¤è½ç»“æ„çš„æŒä¹…æ”¹å˜
- è¿™ç§æ”¹å˜å¯èƒ½æ˜¯CagAç‰¹å¼‚æ€§Tç»†èƒæŒç»­æ´»åŒ–çš„åŸºç¡€
")
```

## ä¸‹ä¸€æ­¥åˆ†æ

åŸºäºæœ¬åˆ†æå‘ç°ï¼Œåç»­åˆ†æåº”å…³æ³¨ï¼š

1. **Part 2 (02_functional_profiling.qmd)**: åŠŸèƒ½è°±åˆ†æ - æ£€éªŒåŠŸèƒ½å±‚é¢æ˜¯å¦ä¹Ÿæœ‰è¶³è¿¹
2. **Part 3 (03_singlem_diversity_analysis.qmd)**: SingleM/Lyrebirdå¤šæ ·æ€§ - ç‹¬ç«‹éªŒè¯
3. **å·®å¼‚ä¸°åº¦åˆ†æ**: å…·ä½“å“ªäº›ç‰©ç§é©±åŠ¨äº†Betaå¤šæ ·æ€§å·®å¼‚

---

## Files written

These files have been written to the target directory, `r paste0("data/", params$name)`:

```{r}
#| label: list-files-target
#| include: false
projthis::proj_dir_info(path_target(), tz = "CET")
```

---

## Session Info

```{r}
#| label: session-info
sessionInfo()
```
